<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Coatings Estimator — The Concrete Protector</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<link rel="manifest" href="data:application/json,%7B%22name%22%3A%22Coatings%20Estimator%22%2C%22short_name%22%3A%22CE%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%2309090b%22%2C%22theme_color%22%3A%22%23f59e0b%22%7D">
<meta name="theme-color" content="#f59e0b">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
/* ═══════════════════════════════════════════════════════
   DESIGN SYSTEM
   ═══════════════════════════════════════════════════════ */
:root {
  /* Surface layers */
  --bg: #09090b;
  --s1: #111113;
  --s2: #18181b;
  --s3: #1f1f23;
  --s4: #27272a;
  /* Borders */
  --b1: rgba(255,255,255,.06);
  --b2: rgba(255,255,255,.1);
  --b3: rgba(255,255,255,.15);
  /* Text */
  --t1: #fafafa;
  --t2: #a1a1aa;
  --t3: #71717a;
  --t4: #52525b;
  /* Accent */
  --accent: #f59e0b;
  --accent2: #fbbf24;
  --accent-glow: rgba(245,158,11,.15);
  --accent-glow2: rgba(245,158,11,.08);
  /* Pipeline */
  --lead: #3b82f6;
  --lead-soft: rgba(59,130,246,.12);
  --est: #f97316;
  --est-soft: rgba(249,115,22,.12);
  --proj: #10b981;
  --proj-soft: rgba(16,185,129,.12);
  --comp: #ef4444;
  --comp-soft: rgba(239,68,68,.12);
  /* Semantic */
  --success: #10b981;
  --danger: #ef4444;
  --info: #3b82f6;
  /* Glass */
  --glass: rgba(255,255,255,.03);
  --glass2: rgba(255,255,255,.05);
  /* Radius */
  --r-sm: 8px;
  --r-md: 12px;
  --r-lg: 16px;
  --r-xl: 20px;
  /* Shadow */
  --shadow-sm: 0 1px 2px rgba(0,0,0,.3);
  --shadow-md: 0 4px 12px rgba(0,0,0,.4);
  --shadow-lg: 0 8px 32px rgba(0,0,0,.5);
  --shadow-glow: 0 0 40px rgba(245,158,11,.06);
}

/* ═══════════════════════════════════════════════════════
   RESET
   ═══════════════════════════════════════════════════════ */
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Inter',system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--t1);line-height:1.6;min-height:100vh;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--s4);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--t4)}
::selection{background:rgba(245,158,11,.25);color:var(--t1)}

/* ═══════════════════════════════════════════════════════
   HEADER
   ═══════════════════════════════════════════════════════ */
.hdr{
  position:sticky;top:0;z-index:100;
  background:rgba(9,9,11,.82);
  backdrop-filter:blur(20px) saturate(1.4);
  -webkit-backdrop-filter:blur(20px) saturate(1.4);
  border-bottom:1px solid var(--b1);
  padding:0 32px;
}
.hi{
  max-width:1280px;margin:0 auto;
  display:flex;align-items:center;justify-content:space-between;
  height:56px;gap:16px;
}
.hdr-left{display:flex;align-items:center;gap:12px;cursor:pointer;-webkit-user-select:none;user-select:none}
.hdr-logo{
  width:32px;height:32px;border-radius:8px;
  background:linear-gradient(135deg,var(--accent),#d97706);
  display:flex;align-items:center;justify-content:center;
  font-weight:800;font-size:14px;color:#000;
  box-shadow:0 0 20px rgba(245,158,11,.2);
  flex-shrink:0;
}
.hdr h1{font-size:15px;font-weight:700;letter-spacing:-.3px;color:var(--t1)}
.hdr .sub{font-size:11px;color:var(--t3);font-weight:400;letter-spacing:.2px}
.hdr-right{display:flex;align-items:center;gap:6px}
.hdr-btn{
  padding:6px 14px;border-radius:var(--r-sm);
  font-size:12px;font-weight:500;cursor:pointer;
  transition:all .15s ease;border:1px solid var(--b2);
  background:var(--glass2);color:var(--t2);
  font-family:inherit;
}
.hdr-btn:hover{background:var(--b2);color:var(--t1);border-color:var(--b3)}
.hdr-btn.primary{
  background:linear-gradient(135deg,var(--accent),#d97706);
  border-color:transparent;color:#000;font-weight:600;
}
.hdr-btn.primary:hover{filter:brightness(1.1);box-shadow:0 0 20px rgba(245,158,11,.25)}

/* ═══════════════════════════════════════════════════════
   BREADCRUMB
   ═══════════════════════════════════════════════════════ */
.breadcrumb{
  max-width:1280px;margin:0 auto;padding:12px 32px 0;
  display:flex;align-items:center;gap:6px;flex-wrap:wrap;
  font-size:12px;color:var(--t4);
}
.breadcrumb span{cursor:pointer;transition:color .15s;padding:2px 0}
.breadcrumb span:hover{color:var(--accent)}
.breadcrumb .sep{opacity:.3;cursor:default;font-size:10px}
.breadcrumb .sep:hover{color:var(--t4)}
.breadcrumb .current{color:var(--t2);cursor:default;font-weight:500}
.breadcrumb .current:hover{color:var(--t2)}

/* ═══════════════════════════════════════════════════════
   LAYOUT
   ═══════════════════════════════════════════════════════ */
.mc{max-width:1280px;margin:0 auto;padding:24px 32px 100px}
.screen{display:none;animation:screenIn .3s ease}
.screen.ac{display:block}
@keyframes screenIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

/* ═══════════════════════════════════════════════════════
   SECTION HEADERS
   ═══════════════════════════════════════════════════════ */
.sh{margin-bottom:24px}
.sh h2{font-size:22px;font-weight:700;letter-spacing:-.5px;margin-bottom:4px}
.sh p{font-size:13px;color:var(--t3);max-width:600px;font-weight:400}

/* ═══════════════════════════════════════════════════════
   HOME — FOLDER CARDS
   ═══════════════════════════════════════════════════════ */
.folder-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:32px}
.folder{
  position:relative;overflow:hidden;
  background:var(--s2);
  border:1px solid var(--b1);
  border-radius:var(--r-lg);
  padding:24px 22px;
  cursor:pointer;
  transition:all .2s ease;
}
.folder:hover{
  transform:translateY(-2px);
  box-shadow:var(--shadow-lg);
  border-color:var(--b2);
}
.folder::before{
  content:'';position:absolute;top:0;left:0;right:0;height:2px;
  opacity:.8;transition:opacity .2s;
}
.folder:hover::before{opacity:1}
.folder .f-glow{
  position:absolute;top:-40px;right:-40px;width:120px;height:120px;
  border-radius:50%;filter:blur(50px);opacity:.15;pointer-events:none;
  transition:opacity .3s;
}
.folder:hover .f-glow{opacity:.25}
.folder .f-icon{
  width:40px;height:40px;border-radius:var(--r-md);
  display:flex;align-items:center;justify-content:center;
  font-size:18px;margin-bottom:14px;
  backdrop-filter:blur(8px);
}
.folder .f-count{
  font-family:'JetBrains Mono',monospace;
  font-size:28px;font-weight:700;letter-spacing:-1px;
  margin-bottom:2px;
}
.folder .f-label{font-size:13px;font-weight:600;margin-bottom:2px}
.folder .f-sub{font-size:11px;color:var(--t4);font-weight:400}

.folder.lead::before{background:linear-gradient(90deg,var(--lead),transparent)}
.folder.lead .f-glow{background:var(--lead)}
.folder.lead .f-icon{background:var(--lead-soft);color:var(--lead)}
.folder.lead .f-count{color:var(--lead)}
.folder.lead .f-label{color:var(--lead)}
.folder.lead:hover{border-color:rgba(59,130,246,.25)}

.folder.est::before{background:linear-gradient(90deg,var(--est),transparent)}
.folder.est .f-glow{background:var(--est)}
.folder.est .f-icon{background:var(--est-soft);color:var(--est)}
.folder.est .f-count{color:var(--est)}
.folder.est .f-label{color:var(--est)}
.folder.est:hover{border-color:rgba(249,115,22,.25)}

.folder.proj::before{background:linear-gradient(90deg,var(--proj),transparent)}
.folder.proj .f-glow{background:var(--proj)}
.folder.proj .f-icon{background:var(--proj-soft);color:var(--proj)}
.folder.proj .f-count{color:var(--proj)}
.folder.proj .f-label{color:var(--proj)}
.folder.proj:hover{border-color:rgba(16,185,129,.25)}

.folder.comp::before{background:linear-gradient(90deg,var(--comp),transparent)}
.folder.comp .f-glow{background:var(--comp)}
.folder.comp .f-icon{background:var(--comp-soft);color:var(--comp)}
.folder.comp .f-count{color:var(--comp)}
.folder.comp .f-label{color:var(--comp)}
.folder.comp:hover{border-color:rgba(239,68,68,.25)}

.folder.inactive{opacity:.35;border-style:dashed}
.folder.inactive:hover{opacity:.6}
.inactive-label{
  font-size:11px;font-weight:500;text-transform:uppercase;
  letter-spacing:1.5px;color:var(--t4);margin-bottom:8px;padding-left:2px;
}

/* ═══════════════════════════════════════════════════════
   CARDS
   ═══════════════════════════════════════════════════════ */
.cd{
  background:var(--s2);
  border:1px solid var(--b1);
  border-radius:var(--r-lg);
  padding:22px;margin-bottom:14px;
  transition:border-color .15s;
}
.cd:hover{border-color:var(--b2)}
.ct{
  font-size:12px;font-weight:600;letter-spacing:.5px;text-transform:uppercase;
  color:var(--t3);margin-bottom:16px;
  display:flex;align-items:center;gap:8px;
}
.ct .ic{
  width:28px;height:28px;border-radius:var(--r-sm);
  display:flex;align-items:center;justify-content:center;
  font-size:14px;flex-shrink:0;
}
.io{background:var(--accent-glow);color:var(--accent)}
.ig{background:var(--proj-soft);color:var(--proj)}
.ib{background:var(--lead-soft);color:var(--lead)}
.ir{background:var(--comp-soft);color:var(--comp)}
.ior{background:var(--est-soft);color:var(--est)}

/* ═══════════════════════════════════════════════════════
   FORM INPUTS
   ═══════════════════════════════════════════════════════ */
.fg{margin-bottom:14px}
.fg label{
  display:block;font-size:11px;font-weight:500;
  text-transform:uppercase;letter-spacing:.8px;
  color:var(--t3);margin-bottom:6px;
}
.fg input,.fg select,.fg textarea{
  width:100%;
  background:var(--s1);
  border:1px solid var(--b1);
  border-radius:var(--r-sm);
  color:var(--t1);
  font-family:'Inter',system-ui,sans-serif;
  font-size:14px;font-weight:400;
  padding:10px 14px;
  transition:all .15s ease;
  resize:vertical;
}
.fg input::placeholder,.fg textarea::placeholder{color:var(--t4)}
.fg input:focus,.fg select:focus,.fg textarea:focus{
  outline:none;border-color:var(--accent);
  box-shadow:0 0 0 3px var(--accent-glow),var(--shadow-sm);
  background:var(--s2);
}
.fg select{cursor:pointer}
.fg textarea{min-height:72px;line-height:1.5}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
.g4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}

/* ═══════════════════════════════════════════════════════
   SEARCH
   ═══════════════════════════════════════════════════════ */
.search-bar{margin-bottom:0}
.search-bar input{
  width:100%;
  background:var(--s2);
  border:1px solid var(--b1);
  border-radius:var(--r-md);
  padding:11px 14px 11px 40px;
  color:var(--t1);font-size:14px;
  font-family:'Inter',system-ui,sans-serif;
  transition:all .15s;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%2352525b' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85zm-5.242.156a5 5 0 1 1 0-10 5 5 0 0 1 0 10z'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:14px center;
}
.search-bar input:focus{
  outline:none;border-color:var(--accent);
  box-shadow:0 0 0 3px var(--accent-glow);background-color:var(--s3);
}

/* ═══════════════════════════════════════════════════════
   LIST ITEMS
   ═══════════════════════════════════════════════════════ */
.list-item{
  display:flex;align-items:center;justify-content:space-between;
  padding:14px 18px;
  background:var(--s2);border:1px solid var(--b1);
  border-radius:var(--r-md);margin-bottom:6px;
  cursor:pointer;transition:all .15s ease;
}
.list-item:hover{
  background:var(--s3);border-color:var(--b2);
  transform:translateX(2px);
}
.li-left{display:flex;align-items:center;gap:14px;min-width:0}
.li-avatar{
  width:38px;height:38px;border-radius:10px;
  display:flex;align-items:center;justify-content:center;
  font-size:13px;font-weight:700;flex-shrink:0;letter-spacing:-.5px;
}
.li-avatar.lead{background:var(--lead-soft);color:var(--lead)}
.li-avatar.est{background:var(--est-soft);color:var(--est)}
.li-avatar.proj{background:var(--proj-soft);color:var(--proj)}
.li-avatar.comp{background:var(--comp-soft);color:var(--comp)}
.li-name{font-weight:600;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.li-meta{font-size:12px;color:var(--t3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:1px}
.li-right{text-align:right;flex-shrink:0;margin-left:16px}
.li-amount{font-family:'JetBrains Mono',monospace;font-weight:600;font-size:14px;color:var(--accent)}
.li-badge{
  display:inline-block;font-size:10px;font-weight:600;
  text-transform:uppercase;letter-spacing:.5px;
  padding:2px 8px;border-radius:6px;margin-top:4px;
}
.li-badge.lead{background:var(--lead-soft);color:var(--lead)}
.li-badge.est{background:var(--est-soft);color:var(--est)}
.li-badge.proj{background:var(--proj-soft);color:var(--proj)}
.li-badge.comp{background:var(--comp-soft);color:var(--comp)}

/* ═══════════════════════════════════════════════════════
   STATUS PILLS
   ═══════════════════════════════════════════════════════ */
.status-bar{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.status-pill{
  font-size:12px;font-weight:500;
  padding:6px 16px;border-radius:100px;
  cursor:pointer;transition:all .15s;
  border:1px solid var(--b2);
  background:transparent;color:var(--t3);
  font-family:inherit;
}
.status-pill:hover{background:var(--glass2);color:var(--t2)}
.status-pill.active{font-weight:600}
.status-pill.active.lead{background:var(--lead-soft);color:var(--lead);border-color:rgba(59,130,246,.3)}
.status-pill.active.est{background:var(--est-soft);color:var(--est);border-color:rgba(249,115,22,.3)}
.status-pill.active.proj{background:var(--proj-soft);color:var(--proj);border-color:rgba(16,185,129,.3)}
.status-pill.active.comp{background:var(--comp-soft);color:var(--comp);border-color:rgba(239,68,68,.3)}

.active-toggle{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--t3);font-weight:500}
.toggle{position:relative;width:36px;height:20px;flex-shrink:0}
.toggle input{opacity:0;width:0;height:0}
.toggle .slider{
  position:absolute;inset:0;
  background:var(--s4);
  border-radius:20px;cursor:pointer;
  transition:all .2s ease;
}
.toggle .slider::before{
  content:'';position:absolute;
  width:16px;height:16px;left:2px;top:2px;
  background:var(--t3);border-radius:50%;
  transition:all .2s ease;
}
.toggle input:checked+.slider{background:var(--accent)}
.toggle input:checked+.slider::before{transform:translateX(16px);background:#fff}

/* ═══════════════════════════════════════════════════════
   SYSTEM CARDS
   ═══════════════════════════════════════════════════════ */
.sys-card{
  background:var(--s2);border:1px solid var(--b1);
  border-radius:var(--r-md);padding:16px 20px;
  margin-bottom:8px;cursor:pointer;transition:all .15s;
  display:flex;justify-content:space-between;align-items:center;
  border-left:3px solid var(--b1);
}
.sys-card:hover{background:var(--s3);border-color:var(--b2);transform:translateX(2px)}
.sys-card.has-product{border-left-color:var(--accent)}
.sys-area{font-size:14px;font-weight:600}
.sys-detail{font-size:12px;color:var(--t3);margin-top:2px}
.sys-right{text-align:right;flex-shrink:0;margin-left:20px}
.sys-price{font-family:'JetBrains Mono',monospace;font-size:16px;font-weight:700;color:var(--accent)}
.sys-cost{font-size:11px;color:var(--t4);margin-top:2px}

/* ═══════════════════════════════════════════════════════
   ESTIMATE TOTAL BAR
   ═══════════════════════════════════════════════════════ */
.est-total{
  background:linear-gradient(135deg,var(--s2),var(--s3));
  border:1px solid var(--b2);
  border-radius:var(--r-lg);
  padding:22px 26px;margin-bottom:18px;
  display:flex;justify-content:space-between;align-items:center;
  flex-wrap:wrap;gap:16px;
  position:relative;overflow:hidden;
}
.est-total::before{
  content:'';position:absolute;top:0;left:0;right:0;height:2px;
  background:linear-gradient(90deg,var(--accent),transparent);
}
.est-total-left{font-size:12px;font-weight:500;color:var(--t3);text-transform:uppercase;letter-spacing:.8px}
.est-total-amount{
  font-family:'JetBrains Mono',monospace;
  font-size:28px;font-weight:700;color:var(--accent);
  letter-spacing:-1px;
  text-shadow:0 0 40px rgba(245,158,11,.15);
}
.est-total-detail{font-size:12px;color:var(--t4);margin-top:4px}

/* ═══════════════════════════════════════════════════════
   PRODUCT SELECTOR
   ═══════════════════════════════════════════════════════ */
.prod-option{
  display:flex;justify-content:space-between;align-items:center;
  padding:12px 16px;
  background:var(--s1);border:1px solid var(--b1);
  border-radius:var(--r-sm);margin-bottom:4px;
  cursor:pointer;transition:all .15s;
}
.prod-option:hover{background:var(--s3);border-color:var(--b2)}
.prod-option.sel{
  background:var(--accent-glow2);
  border-color:rgba(245,158,11,.25);
  box-shadow:0 0 0 1px rgba(245,158,11,.1);
}
.prod-name{font-weight:500;font-size:13px}
.prod-sku{font-size:11px;color:var(--t4);font-family:'JetBrains Mono',monospace;margin-top:1px}
.prod-prices{text-align:right;font-size:12px}
.prod-prices .cost{color:var(--comp);font-family:'JetBrains Mono',monospace;font-weight:600}
.prod-prices .sell{color:var(--t3);font-family:'JetBrains Mono',monospace;font-size:11px;margin-top:1px}
.series-filter{display:flex;gap:4px;margin-bottom:14px;flex-wrap:wrap}
.sf-btn{
  font-size:11px;font-weight:500;letter-spacing:.3px;
  padding:5px 12px;border:1px solid var(--b1);
  border-radius:100px;background:transparent;color:var(--t3);
  cursor:pointer;transition:all .15s;font-family:inherit;
}
.sf-btn:hover{background:var(--glass2);color:var(--t2);border-color:var(--b2)}
.sf-btn.ac{background:var(--accent-glow);color:var(--accent);border-color:rgba(245,158,11,.3)}

/* ═══════════════════════════════════════════════════════
   STAT CARDS
   ═══════════════════════════════════════════════════════ */
.sg{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-bottom:16px}
.sx{
  background:var(--s2);border:1px solid var(--b1);
  border-radius:var(--r-md);padding:16px;text-align:center;
  transition:border-color .15s;
}
.sx:hover{border-color:var(--b2)}
.sx.hl{border-color:rgba(245,158,11,.2);background:var(--accent-glow2)}
.sx .sl{font-size:10px;font-weight:500;text-transform:uppercase;letter-spacing:.8px;color:var(--t4);margin-bottom:6px}
.sx .sv{font-family:'JetBrains Mono',monospace;font-size:20px;font-weight:700;letter-spacing:-.5px}
.sx.hl .sv{color:var(--accent)}

/* ═══════════════════════════════════════════════════════
   BUTTONS
   ═══════════════════════════════════════════════════════ */
.btn{
  padding:8px 18px;border-radius:var(--r-sm);
  font-size:12px;font-weight:500;cursor:pointer;
  transition:all .15s ease;border:1px solid;
  font-family:inherit;white-space:nowrap;
}
.btn-primary{
  background:linear-gradient(135deg,var(--accent),#d97706);
  border-color:transparent;color:#000;font-weight:600;
}
.btn-primary:hover{filter:brightness(1.1);box-shadow:0 0 20px rgba(245,158,11,.2)}
.btn-success{background:var(--proj-soft);border-color:rgba(16,185,129,.25);color:var(--proj)}
.btn-success:hover{background:rgba(16,185,129,.2);border-color:rgba(16,185,129,.4)}
.btn-danger{background:var(--comp-soft);border-color:rgba(239,68,68,.2);color:var(--comp)}
.btn-danger:hover{background:rgba(239,68,68,.15);border-color:rgba(239,68,68,.3)}
.btn-ghost{background:transparent;border-color:var(--b2);color:var(--t3)}
.btn-ghost:hover{background:var(--glass2);color:var(--t2);border-color:var(--b3)}
.btn-row{display:flex;gap:8px;flex-wrap:wrap}

/* ═══════════════════════════════════════════════════════
   MODALS
   ═══════════════════════════════════════════════════════ */
.modal-overlay{
  display:none;position:fixed;inset:0;
  background:rgba(0,0,0,.6);
  backdrop-filter:blur(8px);
  -webkit-backdrop-filter:blur(8px);
  z-index:200;align-items:center;justify-content:center;
}
.modal-overlay.active{display:flex}
.modal{
  background:var(--s2);border:1px solid var(--b2);
  border-radius:var(--r-xl);padding:28px;
  max-width:440px;width:90%;
  box-shadow:var(--shadow-lg);
}
.modal h3{font-size:16px;font-weight:700;margin-bottom:14px}

/* ═══════════════════════════════════════════════════════
   TOAST
   ═══════════════════════════════════════════════════════ */
.toast{
  position:fixed;bottom:24px;right:24px;
  background:var(--s3);border:1px solid var(--b2);
  border-radius:var(--r-md);padding:12px 18px;
  box-shadow:var(--shadow-lg);z-index:1000;
  transform:translateY(120%);opacity:0;
  transition:all .3s cubic-bezier(.4,0,.2,1);
  max-width:320px;
}
.toast.show{transform:translateY(0);opacity:1}
.toast .tt{font-size:12px;font-weight:600;color:var(--accent)}
.toast .tm{font-size:12px;color:var(--t3);margin-top:2px}

/* ═══════════════════════════════════════════════════════
   EMPTY STATE
   ═══════════════════════════════════════════════════════ */
.empty{text-align:center;padding:48px 24px;color:var(--t4)}
.empty .empty-icon{font-size:40px;margin-bottom:12px;opacity:.3}
.empty .empty-text{font-size:14px;color:var(--t3)}

/* ═══════════════════════════════════════════════════════
   REPAIR / ADDON ROWS
   ═══════════════════════════════════════════════════════ */
.ra-row{
  display:flex;align-items:center;gap:10px;
  padding:10px 14px;
  background:var(--s1);border:1px solid var(--b1);
  border-radius:var(--r-sm);margin-bottom:4px;
  transition:all .15s;
}
.ra-row.on{background:var(--accent-glow2);border-color:rgba(245,158,11,.2)}
.ra-toggle{flex-shrink:0}
.ra-toggle input{width:16px;height:16px;accent-color:var(--accent);cursor:pointer}
.ra-info{flex:1;min-width:0}
.ra-name{font-weight:500;font-size:13px}
.ra-sku{font-size:11px;color:var(--t4);font-family:'JetBrains Mono',monospace}
.ra-fields{display:flex;align-items:center;gap:8px;flex-shrink:0}
.ra-fields input,.ra-fields select{
  width:80px;padding:5px 8px;font-size:12px;
  background:var(--s2);border:1px solid var(--b1);
  border-radius:var(--r-sm);color:var(--t1);
  font-family:'JetBrains Mono',monospace;
  text-align:right;
}
.ra-fields input:focus,.ra-fields select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 2px var(--accent-glow)}
.ra-cost{font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--t3);min-width:70px;text-align:right;flex-shrink:0}
.ra-unit{font-size:11px;color:var(--t4);white-space:nowrap}

/* ═══════════════════════════════════════════════════════
   PIPELINE SUMMARY
   ═══════════════════════════════════════════════════════ */
.pipeline-summary{
  display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;
  margin-bottom:28px;
}
.ps-card{
  background:var(--s2);border:1px solid var(--b1);
  border-radius:var(--r-md);padding:18px;
  position:relative;overflow:hidden;
}
.ps-card::before{
  content:'';position:absolute;top:0;left:0;right:0;height:2px;
  opacity:.6;
}
.ps-card.lead::before{background:var(--lead)}
.ps-card.est::before{background:var(--est)}
.ps-card.proj::before{background:var(--proj)}
.ps-card.comp::before{background:var(--comp)}
.ps-label{font-size:10px;font-weight:500;text-transform:uppercase;letter-spacing:.8px;color:var(--t4);margin-bottom:4px}
.ps-value{font-family:'JetBrains Mono',monospace;font-size:18px;font-weight:700;letter-spacing:-.5px;color:var(--accent)}
.ps-sub{font-size:11px;color:var(--t4);margin-top:2px}

/* ═══════════════════════════════════════════════════════
   INLINE EDIT
   ═══════════════════════════════════════════════════════ */
.inline-edit{
  display:flex;align-items:center;gap:8px;margin-bottom:4px;
}
.inline-edit input{
  background:transparent;border:none;border-bottom:1px dashed var(--b2);
  color:var(--t1);font-size:22px;font-weight:700;letter-spacing:-.5px;
  padding:2px 4px;font-family:'Inter',system-ui,sans-serif;
  transition:border-color .15s;
  width:100%;max-width:400px;
}
.inline-edit input:focus{outline:none;border-bottom-color:var(--accent)}
.inline-edit input::placeholder{color:var(--t4)}

/* ═══════════════════════════════════════════════════════
   ORDER LIST TABLE
   ═══════════════════════════════════════════════════════ */
.ol-table{width:100%;border-collapse:collapse;font-size:13px}
.ol-table th{text-align:left;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.8px;color:var(--t4);padding:8px 12px;border-bottom:1px solid var(--b2)}
.ol-table td{padding:10px 12px;border-bottom:1px solid var(--b1);color:var(--t2)}
.ol-table tr:hover td{background:var(--glass2)}
.ol-table .mono{font-family:'JetBrains Mono',monospace;font-weight:600}
.ol-table .accent{color:var(--accent)}
.ol-table .right{text-align:right}
.ol-table .group-hdr td{background:var(--s3);color:var(--t1);font-weight:600;font-size:12px;border-bottom:1px solid var(--b2)}
.ol-total td{font-weight:700;color:var(--t1);border-top:2px solid var(--accent);border-bottom:none}

/* ═══════════════════════════════════════════════════════
   TAB BAR (estimate sub-tabs)
   ═══════════════════════════════════════════════════════ */
.tab-bar{display:flex;gap:2px;margin-bottom:18px;border-bottom:1px solid var(--b1);padding-bottom:0}
.tab-btn{
  padding:8px 18px;font-size:12px;font-weight:500;
  border:none;background:transparent;color:var(--t3);
  cursor:pointer;font-family:inherit;
  border-bottom:2px solid transparent;
  transition:all .15s;margin-bottom:-1px;
}
.tab-btn:hover{color:var(--t2)}
.tab-btn.ac{color:var(--accent);border-bottom-color:var(--accent);font-weight:600}

/* ═══════════════════════════════════════════════════════
   SIGNATURE PAD
   ═══════════════════════════════════════════════════════ */
.sig-wrap{
  background:var(--s1);border:1px solid var(--b2);border-radius:var(--r-md);
  padding:4px;margin-bottom:12px;
}
.sig-wrap canvas{width:100%;border-radius:var(--r-sm);cursor:crosshair;touch-action:none}
.sig-label{font-size:11px;color:var(--t4);text-align:center;padding:4px;letter-spacing:.5px}

/* ═══════════════════════════════════════════════════════
   REPORTING
   ═══════════════════════════════════════════════════════ */
.rpt-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:24px}
.rpt-card{
  background:var(--s2);border:1px solid var(--b1);border-radius:var(--r-lg);
  padding:22px;position:relative;overflow:hidden;
}
.rpt-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--accent),transparent);opacity:.5}
.rpt-card .rl{font-size:10px;font-weight:500;text-transform:uppercase;letter-spacing:.8px;color:var(--t4);margin-bottom:8px}
.rpt-card .rv{font-family:'JetBrains Mono',monospace;font-size:24px;font-weight:700;color:var(--accent);letter-spacing:-1px}
.rpt-card .rs{font-size:12px;color:var(--t3);margin-top:4px}
.bar-chart{margin-top:12px}
.bar-row{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.bar-label{font-size:12px;color:var(--t2);width:140px;flex-shrink:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.bar-track{flex:1;height:22px;background:var(--s1);border-radius:4px;overflow:hidden;position:relative}
.bar-fill{height:100%;border-radius:4px;background:linear-gradient(90deg,var(--accent),#d97706);transition:width .5s ease;min-width:2px}
.bar-val{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--t3);width:50px;text-align:right;flex-shrink:0}

/* ═══════════════════════════════════════════════════════
   WIDE MODAL
   ═══════════════════════════════════════════════════════ */
.modal.wide{max-width:700px}
.modal.xwide{max-width:900px;max-height:85vh;overflow-y:auto}

/* ═══════════════════════════════════════════════════════
   PRINT
   ═══════════════════════════════════════════════════════ */
@media print{
  .hdr,.breadcrumb,.btn-row,.hdr-right,.tab-bar,.search-bar,#newLeadBtn{display:none!important}
  body{background:#fff;color:#000}
  .mc{padding:0}
  .cd{border-color:#ddd;page-break-inside:avoid}
}

/* ═══════════════════════════════════════════════════════
   RESPONSIVE
   ═══════════════════════════════════════════════════════ */
@media(max-width:800px){
  .folder-grid{grid-template-columns:1fr 1fr}
  .g2,.g3,.g4{grid-template-columns:1fr}
  .mc{padding:20px 16px 80px}
  .hdr{padding:0 16px}
  .breadcrumb{padding:10px 16px 0}
}
@media(max-width:500px){
  .folder-grid{grid-template-columns:1fr}
  .est-total{flex-direction:column;text-align:center}
  .hi{height:auto;padding:12px 0}
}
</style>
</head>
<body>

<!-- HEADER -->
<div class="hdr"><div class="hi">
  <div class="hdr-left" onclick="goHome()">
    <div class="hdr-logo">CE</div>
    <div>
      <h1>Coatings Estimator</h1>
      <div class="sub">The Concrete Protector</div>
    </div>
  </div>
  <div class="hdr-right">
    <button class="hdr-btn" onclick="goReporting()">Reports</button>
    <button class="hdr-btn" onclick="openExport()">Export</button>
    <button class="hdr-btn" onclick="openImport()">Import</button>
  </div>
</div></div>

<div class="breadcrumb" id="breadcrumb"></div>

<div class="mc">

<!-- HOME -->
<div class="screen ac" id="scr-home">
  <div class="sh"><h2>Pipeline</h2><p>Your jobs at a glance. Click any folder to view records.</p></div>
  <div class="pipeline-summary" id="pipelineSummary"></div>
  <div class="folder-grid" id="activeFolders"></div>
  <div class="inactive-label">Archived</div>
  <div class="folder-grid" id="inactiveFolders"></div>
</div>

<!-- LIST -->
<div class="screen" id="scr-list">
  <div class="sh" id="listHeader"></div>
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:10px">
    <div class="search-bar" style="flex:1;min-width:220px"><input type="text" id="searchInput" placeholder="Search by name, company, or address..." oninput="filterList()"></div>
    <button class="btn btn-primary" id="newLeadBtn" onclick="newRecord()">+ New Lead</button>
  </div>
  <div id="listItems"></div>
</div>

<!-- RECORD -->
<div class="screen" id="scr-record">
  <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px;flex-wrap:wrap;gap:12px">
    <div class="sh" style="margin-bottom:0;flex:1" id="recordHeader"></div>
    <div class="btn-row">
      <button class="btn btn-success" onclick="saveRecord()">Save</button>
      <button class="btn btn-danger" onclick="confirmDeleteRecord()">Delete</button>
    </div>
  </div>
  <div class="cd">
    <div class="ct"><span class="ic io">&#9881;</span> Status</div>
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
      <div class="status-bar" id="statusPills"></div>
      <div class="active-toggle"><span>Active</span><label class="toggle"><input type="checkbox" id="recActive" onchange="toggleActive()"><span class="slider"></span></label></div>
    </div>
  </div>
  <div class="cd">
    <div class="ct"><span class="ic ib">&#9786;</span> Contact</div>
    <div class="g2">
      <div class="fg"><label>First Name</label><input type="text" id="recFirst" placeholder="First name"></div>
      <div class="fg"><label>Last Name</label><input type="text" id="recLast" placeholder="Last name"></div>
    </div>
    <div class="g2">
      <div class="fg"><label>Company</label><input type="text" id="recCompany" placeholder="Company name"></div>
      <div class="fg"><label>Email</label><input type="email" id="recEmail" placeholder="email@example.com"></div>
    </div>
    <div class="g3">
      <div class="fg"><label>Phone</label><input type="tel" id="recPhone" placeholder="(555) 123-4567"></div>
      <div class="fg"><label>Type</label><select id="recPhoneType"><option value="cell">Cell</option><option value="home">Home</option><option value="office">Office</option></select></div>
      <div class="fg"><label>Best Time to Call</label><input type="text" id="recBestTime" placeholder="e.g. After 5pm"></div>
    </div>
    <div class="fg"><label>Address</label><input type="text" id="recAddress" placeholder="Street address"></div>
    <div class="g3">
      <div class="fg"><label>City</label><input type="text" id="recCity" placeholder="City"></div>
      <div class="fg"><label>State</label><input type="text" id="recState" placeholder="State"></div>
      <div class="fg"><label>Zip</label><input type="text" id="recZip" placeholder="Zip code"></div>
    </div>
    <div class="fg"><label>Notes</label><textarea id="recNotes" placeholder="Additional notes..."></textarea></div>
  </div>
  <div class="cd">
    <div class="ct" style="justify-content:space-between"><div style="display:flex;align-items:center;gap:8px"><span class="ic ior">&#9998;</span> Estimates</div><button class="btn btn-primary" onclick="newEstimate()">+ New Estimate</button></div>
    <div id="estimatesList"></div>
  </div>
</div>

<!-- ESTIMATE -->
<div class="screen" id="scr-estimate">
  <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px;flex-wrap:wrap;gap:12px">
    <div style="flex:1">
      <div class="inline-edit"><input type="text" id="estNameInput" placeholder="Estimate name..." oninput="updateEstName()"></div>
      <p style="font-size:13px;color:var(--t3)" id="estSubline"></p>
    </div>
    <div class="btn-row">
      <button class="btn btn-primary" onclick="generateProposal()">PDF Proposal</button>
      <button class="btn btn-success" onclick="saveEstimate()">Save</button>
      <button class="btn btn-danger" onclick="confirmDeleteEstimate()">Delete Estimate</button>
    </div>
  </div>
  <div class="est-total" id="estTotalBar"></div>
  <div class="tab-bar" id="estTabs">
    <button class="tab-btn ac" onclick="switchEstTab('areas')">Areas</button>
    <button class="tab-btn" onclick="switchEstTab('orderlist')">Order List</button>
    <button class="tab-btn" onclick="switchEstTab('contract')">Contract</button>
  </div>
  <div id="estTabAreas">
    <div class="cd">
      <div class="ct" style="justify-content:space-between"><div style="display:flex;align-items:center;gap:8px"><span class="ic ig">&#9874;</span> Areas</div><button class="btn btn-primary" onclick="newSystem()">+ Add Area</button></div>
      <div id="systemsList"></div>
    </div>
  </div>
  <div id="estTabOrderlist" style="display:none">
    <div class="cd"><div class="ct"><span class="ic io">&#9776;</span> Materials Order List</div><div id="orderListContent"></div></div>
  </div>
  <div id="estTabContract" style="display:none">
    <div class="cd">
      <div class="ct"><span class="ic ib">&#9998;</span> Contract</div>
      <div class="fg"><label>Terms & Conditions</label><textarea id="contractTerms" rows="6" placeholder="Enter contract terms...">This proposal is valid for 30 days from the date shown. A 50% deposit is required to schedule the project. Balance due upon completion. All work carries a manufacturer warranty on materials used. The Concrete Protector guarantees workmanship for a period of one (1) year from date of installation. Customer is responsible for proper maintenance as outlined in care instructions provided at completion.</textarea></div>
      <div class="g2">
        <div>
          <div class="fg"><label>Contractor Signature</label></div>
          <div class="sig-wrap"><canvas id="sigContractor" width="400" height="150"></canvas><div class="sig-label">Sign above</div></div>
          <button class="btn btn-ghost" onclick="clearSig('sigContractor')" style="margin-bottom:12px">Clear</button>
        </div>
        <div>
          <div class="fg"><label>Customer Signature</label></div>
          <div class="sig-wrap"><canvas id="sigCustomer" width="400" height="150"></canvas><div class="sig-label">Sign above</div></div>
          <button class="btn btn-ghost" onclick="clearSig('sigCustomer')" style="margin-bottom:12px">Clear</button>
        </div>
      </div>
      <div class="btn-row"><button class="btn btn-primary" onclick="generateContract()">Download Contract PDF</button></div>
    </div>
  </div>
</div>

<!-- SYSTEM EDITOR -->
<div class="screen" id="scr-system">
  <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px;flex-wrap:wrap;gap:12px">
    <div class="sh" style="margin-bottom:0;flex:1" id="sysHeader"></div>
    <div class="btn-row">
      <button class="btn btn-success" onclick="saveSystem()">Save</button>
      <button class="btn btn-danger" onclick="confirmDeleteSystem()">Remove</button>
    </div>
  </div>
  <div class="cd">
    <div class="ct"><span class="ic io">&#9634;</span> Dimensions</div>
    <div class="g3">
      <div class="fg"><label>Area Name</label><input type="text" id="sysArea" placeholder="e.g. Driveway, Patio, Garage" oninput="calcSystem()"></div>
      <div class="fg"><label>Length (ft)</label><input type="number" id="sysLength" value="0" min="0" step="1" oninput="calcSystem()"></div>
      <div class="fg"><label>Width (ft)</label><input type="number" id="sysWidth" value="1" min="0" step="1" oninput="calcSystem()"></div>
    </div>
    <div class="g3">
      <div class="fg"><label>Square Feet</label><input type="number" id="sysSqft" value="0" min="0" step="1" oninput="calcSystem(true)"></div>
      <div class="fg"><label>Sell Rate ($/sqft)</label><input type="number" id="sysSellRate" value="0" min="0" step="0.01" oninput="calcSystem()"></div>
      <div class="fg"><label>System Price</label>
        <div style="font-family:'JetBrains Mono',monospace;font-size:24px;font-weight:700;color:var(--accent);padding:6px 0;letter-spacing:-1px" id="sysPrice">$0.00</div>
      </div>
    </div>
  </div>
  <div class="sg" id="sysStats"></div>
  <div class="cd">
    <div class="ct"><span class="ic ior">&#9733;</span> Product System</div>
    <div class="series-filter" id="seriesFilter"></div>
    <div style="max-height:400px;overflow-y:auto;padding-right:4px" id="prodList"></div>
  </div>
  <div class="cd">
    <div class="ct"><span class="ic ig">&#9708;</span> Top Coat</div>
    <div id="tcList"></div>
  </div>
  <div class="cd">
    <div class="ct"><span class="ic ir">&#9881;</span> Repairs</div>
    <div id="repairList"></div>
  </div>
  <div class="cd">
    <div class="ct"><span class="ic ib">&#9737;</span> Add-ons</div>
    <div id="addonList"></div>
  </div>
  <div class="cd">
    <div class="ct"><span class="ic ior">&#9998;</span> Notes</div>
    <div class="fg" style="margin-bottom:0"><textarea id="sysNotes" placeholder="Notes for this area..." oninput="calcSystem()"></textarea></div>
  </div>
</div>

<!-- REPORTING -->
<div class="screen" id="scr-reporting">
  <div class="sh"><h2>Reports & Analytics</h2><p>Business performance at a glance.</p></div>
  <div class="rpt-grid" id="rptCards"></div>
  <div class="cd"><div class="ct"><span class="ic io">&#9733;</span> Top Systems</div><div id="rptTopSystems"></div></div>
  <div class="cd"><div class="ct"><span class="ic ig">&#9650;</span> Pipeline Breakdown</div><div id="rptPipelineBreakdown"></div></div>
  <div class="cd"><div class="ct"><span class="ic ib">&#9673;</span> Recent Activity</div><div id="rptRecent"></div></div>
</div>

</div>

<!-- MODALS -->
<div class="modal-overlay" id="confirmModal" onclick="if(event.target===this)closeConfirm()">
  <div class="modal">
    <h3 id="confirmTitle">Confirm</h3>
    <p style="font-size:13px;color:var(--t3);margin-bottom:20px;line-height:1.5" id="confirmMsg"></p>
    <div class="btn-row"><button class="btn btn-danger" id="confirmYes">Delete</button><button class="btn btn-ghost" onclick="closeConfirm()">Cancel</button></div>
  </div>
</div>
<div class="modal-overlay" id="exportModal" onclick="if(event.target===this)closeExport()">
  <div class="modal">
    <h3>Export Data</h3>
    <p style="font-size:13px;color:var(--t3);margin-bottom:20px;line-height:1.5">Download all records as a JSON file for backup or transfer.</p>
    <div class="btn-row"><button class="btn btn-primary" onclick="doExport()">Download</button><button class="btn btn-ghost" onclick="closeExport()">Cancel</button></div>
  </div>
</div>
<div class="modal-overlay" id="importModal" onclick="if(event.target===this)closeImport()">
  <div class="modal">
    <h3>Import Data</h3>
    <p style="font-size:13px;color:var(--t3);margin-bottom:16px;line-height:1.5">Load a previously exported JSON file. This will <strong style="color:var(--comp)">replace</strong> all current data.</p>
    <div class="fg"><input type="file" id="importFile" accept=".json" style="font-size:13px"></div>
    <div class="btn-row"><button class="btn btn-primary" onclick="doImport()">Import</button><button class="btn btn-ghost" onclick="closeImport()">Cancel</button></div>
  </div>
</div>
<div class="toast" id="toast"><div class="tt" id="toastT"></div><div class="tm" id="toastM"></div></div>

<script>
'use strict';

// ═══════════════════════════════════════════════════════════
// PRODUCT DATA
// ═══════════════════════════════════════════════════════════
const PRODUCTS=[
  {id:'c101',sku:'C-101',name:'Rustic Concrete Wood (Exterior)',series:'C-Series',cat:'Rustic & Stone',cost:1.15,low:8.00,mid:14.00},
  {id:'c102',sku:'C-102',name:'Rustic Concrete Wood (Interior)',series:'C-Series',cat:'Rustic & Stone',cost:1.43,low:8.00,mid:14.00},
  {id:'c103',sku:'C-103',name:'Grand Flagstone (Exterior)',series:'C-Series',cat:'Rustic & Stone',cost:1.15,low:8.00,mid:14.00},
  {id:'c104',sku:'C-104',name:'Grand Flagstone (Interior)',series:'C-Series',cat:'Rustic & Stone',cost:1.43,low:8.00,mid:14.00},
  {id:'c105',sku:'C-105',name:'Tuscan Slate (Exterior)',series:'C-Series',cat:'Rustic & Stone',cost:1.15,low:8.00,mid:14.00},
  {id:'c106',sku:'C-106',name:'Tuscan Slate (Interior)',series:'C-Series',cat:'Rustic & Stone',cost:1.43,low:8.00,mid:14.00},
  {id:'m201',sku:'M-201',name:'Metallic Marble Stain Gloss',series:'M-Series',cat:'Metallic & Marble',cost:3.13,low:8.50,mid:15.00},
  {id:'m202',sku:'M-202',name:'Metallic Marble Stain Satin',series:'M-Series',cat:'Metallic & Marble',cost:3.21,low:8.50,mid:15.00},
  {id:'m203',sku:'M-203',name:'Metallic Marble Stain Finish',series:'M-Series',cat:'Metallic & Marble',cost:2.73,low:8.50,mid:15.00},
  {id:'m204',sku:'M-204',name:'Italian Marble Epoxy Finish',series:'M-Series',cat:'Metallic & Marble',cost:2.76,low:9.00,mid:15.00},
  {id:'m205',sku:'M-205',name:'Italian Marble Epoxy Gloss',series:'M-Series',cat:'Metallic & Marble',cost:3.16,low:9.00,mid:15.00},
  {id:'m206',sku:'M-206',name:'Italian Marble Epoxy Satin',series:'M-Series',cat:'Metallic & Marble',cost:3.25,low:9.00,mid:15.00},
  {id:'g301',sku:'G-301',name:'Graniflex Flake Broadcast PP-90',series:'G-Series',cat:'Graniflex',cost:2.57,low:7.00,mid:9.00},
  {id:'g302',sku:'G-302',name:'Graniflex Flake Broadcast',series:'G-Series',cat:'Graniflex',cost:2.52,low:7.00,mid:9.00},
  {id:'g303',sku:'G-303',name:'Graniflex Flake Neat Coat',series:'G-Series',cat:'Graniflex',cost:2.06,low:7.00,mid:9.00},
  {id:'g304',sku:'G-304',name:'Graniflex Flake P-Thane',series:'G-Series',cat:'Graniflex',cost:2.38,low:7.00,mid:9.00},
  {id:'g305',sku:'G-305',name:'Graniflex 1-Quartz Broadcast',series:'G-Series',cat:'Graniflex',cost:2.82,low:7.50,mid:10.00},
  {id:'g306',sku:'G-306',name:'Graniflex 1-Quartz Broadcast',series:'G-Series',cat:'Graniflex',cost:2.77,low:7.50,mid:10.00},
  {id:'g307',sku:'G-307',name:'Graniflex 1-Quartz Neat',series:'G-Series',cat:'Graniflex',cost:2.19,low:7.50,mid:10.00},
  {id:'g308',sku:'G-308',name:'Graniflex 1-Quartz P-Thane',series:'G-Series',cat:'Graniflex',cost:2.59,low:7.50,mid:10.00},
  {id:'g309',sku:'G-309',name:'Graniflex 2-Quartz Broadcast',series:'G-Series',cat:'Graniflex',cost:3.54,low:8.50,mid:12.00},
  {id:'g310',sku:'G-310',name:'Graniflex 2-Quartz Broadcast',series:'G-Series',cat:'Graniflex',cost:3.08,low:8.50,mid:12.00},
  {id:'g311',sku:'G-311',name:'Marble-Flex PP-90',series:'G-Series',cat:'Graniflex',cost:2.85,low:8.50,mid:12.00},
  {id:'e401',sku:'E-401',name:'Protector-Flake P-Thane',series:'E-Series',cat:'Protector',cost:1.91,low:5.50,mid:7.50},
  {id:'e402',sku:'E-402',name:'Protector-Flake PP-90',series:'E-Series',cat:'Protector',cost:2.10,low:5.50,mid:7.50},
  {id:'e403',sku:'E-403',name:'Protector-Flake Neat Coat',series:'E-Series',cat:'Protector',cost:1.44,low:5.50,mid:7.50},
  {id:'e404',sku:'E-404',name:'Resinous 123 Floor',series:'E-Series',cat:'Protector',cost:1.05,low:3.00,mid:5.00},
  {id:'i501',sku:'I-501',name:'SCP Polish (Chemicals)',series:'I-Series',cat:'Specialty',cost:0.31,low:2.50,mid:9.00},
  {id:'i502',sku:'I-502',name:'Poly-Hard Super-Nova',series:'I-Series',cat:'Specialty',cost:2.85,low:8.00,mid:16.00},
  {id:'i503',sku:'I-503',name:'Poly-Hard Quartz PP-90',series:'I-Series',cat:'Specialty',cost:3.06,low:8.50,mid:16.00},
];
const TOPCOATS=[
  {id:'tc-none',name:'None',cost:0,desc:'No additional top coat'},
  {id:'ut4451',sku:'UT-4451',name:'Protectorthane (Interior)',cost:0.37,desc:'Interior polyurethane'},
  {id:'tj3113',sku:'TJ-3113',name:'Acrylic Floor Finish',cost:0.02,desc:'Economical acrylic'},
  {id:'ut4501',sku:'UT-4501',name:'WB 421 Gloss Urethane',cost:0.42,desc:'Water-based high-gloss'},
  {id:'ut4499',sku:'UT-4499',name:'WB 221 Satin Urethane',cost:0.50,desc:'Water-based satin'},
  {id:'en6303',sku:'EN-6303',name:'Epoxy Neat Coat',cost:0.79,desc:'Smooth epoxy finish'},
  {id:'ut4515',sku:'UT-4515',name:'Perfect Poly 90',cost:0.65,desc:'Premium polyaspartic'},
];
const REPAIRS=[
  {id:'si1652',sku:'SI-1652',name:'Quick Patch',cost:0.32,unit:'sqft'},
  {id:'em6018',sku:'EM-6018',name:'Protector-Flex Joint Fill',cost:1.06,unit:'lnft'},
  {id:'mpp2001',sku:'MPP-2001',name:'MPP 80 Joint Fill',cost:2.00,unit:'lnft'},
  {id:'mpp1019',sku:'MPP-1019',name:'Bulk: MPP 80 Joint Fill',cost:0.70,unit:'lnft'},
  {id:'r701',sku:'R-701',name:'LRB/TAV Patch & Joint Fill',cost:1.76,unit:'lnft'},
];
const ADDONS=[
  {id:'a601',sku:'A-601',name:'Surface Preparation / Removal',cost:0.25,low:1.00,mid:3.00,unit:'sqft'},
  {id:'a602',sku:'A-602',name:'LRB Flood Coat',cost:2.34,low:1.50,mid:3.00,unit:'sqft'},
  {id:'a603',sku:'A-603',name:'Penetrating Hydrophobic Sealer',cost:0.17,low:0.50,mid:1.00,unit:'sqft'},
  {id:'a604',sku:'A-604',name:'Hydro-Polish',cost:0.04,low:0.15,mid:0.50,unit:'sqft'},
  {id:'a605',sku:'A-605',name:'Easy Cove 4"',cost:6.41,low:13.00,mid:18.00,unit:'lnft'},
  {id:'a606',sku:'A-606',name:'Easy Cove 6"',cost:8.61,low:14.00,mid:18.00,unit:'lnft'},
  {id:'a607',sku:'A-607',name:'Flooring Logo',cost:17.00,low:40.00,mid:65.00,unit:'each'},
];
// Ingredient breakdowns per system (coverage = sqft per unit)
const INGREDIENTS={
  'c101':[{name:'Concrete Stain Base',sku:'CS-100',coverage:250,unit:'gal',costPer:45},{name:'Wood Grain Tool Kit',sku:'TK-WG',coverage:500,unit:'kit',costPer:85},{name:'Antiquing Wash',sku:'AW-100',coverage:300,unit:'gal',costPer:35},{name:'Exterior Acrylic Sealer',sku:'SL-200',coverage:250,unit:'gal',costPer:68}],
  'c102':[{name:'Concrete Stain Base',sku:'CS-100',coverage:250,unit:'gal',costPer:45},{name:'Wood Grain Tool Kit',sku:'TK-WG',coverage:500,unit:'kit',costPer:85},{name:'Antiquing Wash',sku:'AW-100',coverage:300,unit:'gal',costPer:35},{name:'Interior Acrylic Sealer',sku:'SL-201',coverage:200,unit:'gal',costPer:78}],
  'c103':[{name:'Concrete Stain Base',sku:'CS-100',coverage:250,unit:'gal',costPer:45},{name:'Flagstone Pattern Tool',sku:'TK-FS',coverage:500,unit:'kit',costPer:95},{name:'Antiquing Wash',sku:'AW-100',coverage:300,unit:'gal',costPer:35},{name:'Exterior Acrylic Sealer',sku:'SL-200',coverage:250,unit:'gal',costPer:68}],
  'c104':[{name:'Concrete Stain Base',sku:'CS-100',coverage:250,unit:'gal',costPer:45},{name:'Flagstone Pattern Tool',sku:'TK-FS',coverage:500,unit:'kit',costPer:95},{name:'Antiquing Wash',sku:'AW-100',coverage:300,unit:'gal',costPer:35},{name:'Interior Acrylic Sealer',sku:'SL-201',coverage:200,unit:'gal',costPer:78}],
  'c105':[{name:'Concrete Stain Base',sku:'CS-100',coverage:250,unit:'gal',costPer:45},{name:'Slate Stamp Set',sku:'TK-SS',coverage:500,unit:'kit',costPer:90},{name:'Antiquing Wash',sku:'AW-100',coverage:300,unit:'gal',costPer:35},{name:'Exterior Acrylic Sealer',sku:'SL-200',coverage:250,unit:'gal',costPer:68}],
  'c106':[{name:'Concrete Stain Base',sku:'CS-100',coverage:250,unit:'gal',costPer:45},{name:'Slate Stamp Set',sku:'TK-SS',coverage:500,unit:'kit',costPer:90},{name:'Antiquing Wash',sku:'AW-100',coverage:300,unit:'gal',costPer:35},{name:'Interior Acrylic Sealer',sku:'SL-201',coverage:200,unit:'gal',costPer:78}],
  'm201':[{name:'Epoxy Primer',sku:'EP-100',coverage:200,unit:'gal',costPer:95},{name:'Metallic Marble Stain',sku:'MM-201',coverage:160,unit:'gal',costPer:135},{name:'High-Gloss Urethane',sku:'UT-4501',coverage:350,unit:'gal',costPer:148}],
  'm202':[{name:'Epoxy Primer',sku:'EP-100',coverage:200,unit:'gal',costPer:95},{name:'Metallic Marble Stain',sku:'MM-201',coverage:160,unit:'gal',costPer:135},{name:'Satin Urethane',sku:'UT-4499',coverage:350,unit:'gal',costPer:155}],
  'm203':[{name:'Epoxy Primer',sku:'EP-100',coverage:200,unit:'gal',costPer:95},{name:'Metallic Marble Stain',sku:'MM-201',coverage:160,unit:'gal',costPer:135},{name:'Acrylic Finish',sku:'TJ-3113',coverage:400,unit:'gal',costPer:42}],
  'm204':[{name:'Epoxy Primer',sku:'EP-100',coverage:200,unit:'gal',costPer:95},{name:'Italian Marble Epoxy',sku:'IM-204',coverage:100,unit:'gal',costPer:165},{name:'Acrylic Finish',sku:'TJ-3113',coverage:400,unit:'gal',costPer:42}],
  'm205':[{name:'Epoxy Primer',sku:'EP-100',coverage:200,unit:'gal',costPer:95},{name:'Italian Marble Epoxy',sku:'IM-204',coverage:100,unit:'gal',costPer:165},{name:'High-Gloss Urethane',sku:'UT-4501',coverage:350,unit:'gal',costPer:148}],
  'm206':[{name:'Epoxy Primer',sku:'EP-100',coverage:200,unit:'gal',costPer:95},{name:'Italian Marble Epoxy',sku:'IM-204',coverage:100,unit:'gal',costPer:165},{name:'Satin Urethane',sku:'UT-4499',coverage:350,unit:'gal',costPer:155}],
  'g301':[{name:'Graniflex Base',sku:'GF-100',coverage:50,unit:'kit',costPer:89},{name:'Vinyl Flake (Broadcast)',sku:'FK-100',coverage:40,unit:'bucket',costPer:55},{name:'Perfect Poly 90',sku:'UT-4515',coverage:350,unit:'gal',costPer:228}],
  'g302':[{name:'Graniflex Base',sku:'GF-100',coverage:50,unit:'kit',costPer:89},{name:'Vinyl Flake (Broadcast)',sku:'FK-100',coverage:40,unit:'bucket',costPer:55},{name:'Epoxy Neat Coat',sku:'EN-6303',coverage:160,unit:'gal',costPer:126}],
  'g303':[{name:'Graniflex Base',sku:'GF-100',coverage:50,unit:'kit',costPer:89},{name:'Vinyl Flake (Neat Coat)',sku:'FK-101',coverage:80,unit:'bucket',costPer:55},{name:'Epoxy Neat Coat',sku:'EN-6303',coverage:160,unit:'gal',costPer:126}],
  'g304':[{name:'Graniflex Base',sku:'GF-100',coverage:50,unit:'kit',costPer:89},{name:'Vinyl Flake (Broadcast)',sku:'FK-100',coverage:40,unit:'bucket',costPer:55},{name:'Protectorthane',sku:'UT-4451',coverage:350,unit:'gal',costPer:130}],
  'g305':[{name:'Graniflex Base',sku:'GF-100',coverage:50,unit:'kit',costPer:89},{name:'Quartz Aggregate (#1)',sku:'QZ-100',coverage:25,unit:'bag',costPer:28},{name:'Epoxy Neat Coat',sku:'EN-6303',coverage:160,unit:'gal',costPer:126},{name:'Perfect Poly 90',sku:'UT-4515',coverage:350,unit:'gal',costPer:228}],
  'g306':[{name:'Graniflex Base',sku:'GF-100',coverage:50,unit:'kit',costPer:89},{name:'Quartz Aggregate (#1)',sku:'QZ-100',coverage:25,unit:'bag',costPer:28},{name:'Epoxy Neat Coat',sku:'EN-6303',coverage:160,unit:'gal',costPer:126}],
  'g307':[{name:'Graniflex Base',sku:'GF-100',coverage:50,unit:'kit',costPer:89},{name:'Quartz Aggregate (Neat)',sku:'QZ-101',coverage:50,unit:'bag',costPer:28},{name:'Epoxy Neat Coat',sku:'EN-6303',coverage:160,unit:'gal',costPer:126}],
  'g308':[{name:'Graniflex Base',sku:'GF-100',coverage:50,unit:'kit',costPer:89},{name:'Quartz Aggregate (#1)',sku:'QZ-100',coverage:25,unit:'bag',costPer:28},{name:'Protectorthane',sku:'UT-4451',coverage:350,unit:'gal',costPer:130}],
  'g309':[{name:'Graniflex Base',sku:'GF-100',coverage:50,unit:'kit',costPer:89},{name:'Quartz Aggregate (#2)',sku:'QZ-200',coverage:20,unit:'bag',costPer:32},{name:'Epoxy Neat Coat',sku:'EN-6303',coverage:160,unit:'gal',costPer:126},{name:'Perfect Poly 90',sku:'UT-4515',coverage:350,unit:'gal',costPer:228}],
  'g310':[{name:'Graniflex Base',sku:'GF-100',coverage:50,unit:'kit',costPer:89},{name:'Quartz Aggregate (#2)',sku:'QZ-200',coverage:20,unit:'bag',costPer:32},{name:'Epoxy Neat Coat',sku:'EN-6303',coverage:160,unit:'gal',costPer:126}],
  'g311':[{name:'Graniflex Base',sku:'GF-100',coverage:50,unit:'kit',costPer:89},{name:'Marble-Flex Flake',sku:'FK-300',coverage:40,unit:'bucket',costPer:65},{name:'Perfect Poly 90',sku:'UT-4515',coverage:350,unit:'gal',costPer:228}],
  'e401':[{name:'Protector Epoxy',sku:'PE-100',coverage:160,unit:'gal',costPer:125},{name:'Vinyl Flake (Broadcast)',sku:'FK-100',coverage:40,unit:'bucket',costPer:55},{name:'Protectorthane',sku:'UT-4451',coverage:350,unit:'gal',costPer:130}],
  'e402':[{name:'Protector Epoxy',sku:'PE-100',coverage:160,unit:'gal',costPer:125},{name:'Vinyl Flake (Broadcast)',sku:'FK-100',coverage:40,unit:'bucket',costPer:55},{name:'Perfect Poly 90',sku:'UT-4515',coverage:350,unit:'gal',costPer:228}],
  'e403':[{name:'Protector Epoxy',sku:'PE-100',coverage:160,unit:'gal',costPer:125},{name:'Vinyl Flake (Neat Coat)',sku:'FK-101',coverage:80,unit:'bucket',costPer:55},{name:'Epoxy Neat Coat',sku:'EN-6303',coverage:160,unit:'gal',costPer:126}],
  'e404':[{name:'Resinous 123 Epoxy',sku:'R123',coverage:200,unit:'gal',costPer:110},{name:'Acrylic Floor Finish',sku:'TJ-3113',coverage:400,unit:'gal',costPer:42}],
  'i501':[{name:'SCP Densifier',sku:'SCP-D',coverage:200,unit:'gal',costPer:32},{name:'SCP Guard',sku:'SCP-G',coverage:400,unit:'gal',costPer:28}],
  'i502':[{name:'Poly-Hard Base',sku:'PH-100',coverage:100,unit:'gal',costPer:165},{name:'Super-Nova Metallic',sku:'SN-100',coverage:150,unit:'gal',costPer:120},{name:'Perfect Poly 90',sku:'UT-4515',coverage:350,unit:'gal',costPer:228}],
  'i503':[{name:'Poly-Hard Base',sku:'PH-100',coverage:100,unit:'gal',costPer:165},{name:'Quartz Aggregate (#1)',sku:'QZ-100',coverage:25,unit:'bag',costPer:28},{name:'Perfect Poly 90',sku:'UT-4515',coverage:350,unit:'gal',costPer:228}],
};
const STATUSES=[{id:'lead',label:'Lead',color:'lead'},{id:'estimate',label:'Estimate',color:'est'},{id:'project',label:'Project',color:'proj'},{id:'completed',label:'Completed',color:'comp'}];
const FOLDER_ICONS={lead:'&#9993;',estimate:'&#9997;',project:'&#9874;',completed:'&#10003;'};

// ═══════════════════════════════════════════════════════════
// STATE
// ═══════════════════════════════════════════════════════════
const DB_KEY='ce_database';
function loadDB(){try{return JSON.parse(localStorage.getItem(DB_KEY))||{records:[]}}catch{return{records:[]}}}
function saveDB(d){localStorage.setItem(DB_KEY,JSON.stringify(d))}
function uid(){return Date.now().toString(36)+Math.random().toString(36).slice(2,8)}
const fmt=v=>'$'+v.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
let db=loadDB();
let nav={screen:'home',folderStatus:null,folderActive:true,recordId:null,estimateId:null,systemId:null};
let seriesFilter='All';

// ═══════════════════════════════════════════════════════════
// NAVIGATION
// ═══════════════════════════════════════════════════════════
function showScreen(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('ac'));document.getElementById('scr-'+id).classList.add('ac');window.scrollTo({top:0,behavior:'smooth'})}
function goHome(){nav={screen:'home',folderStatus:null,folderActive:true,recordId:null,estimateId:null,systemId:null};renderBreadcrumb();renderHome();showScreen('home')}
function goFolder(s,a){nav.screen='list';nav.folderStatus=s;nav.folderActive=a;nav.recordId=null;nav.estimateId=null;nav.systemId=null;renderBreadcrumb();renderList();showScreen('list')}
function goRecord(id){nav.screen='record';nav.recordId=id;nav.estimateId=null;nav.systemId=null;renderBreadcrumb();renderRecord();showScreen('record')}
function goEstimate(id){nav.screen='estimate';nav.estimateId=id;nav.systemId=null;renderBreadcrumb();renderEstimate();showScreen('estimate')}
function goSystem(id){nav.screen='system';nav.systemId=id;renderBreadcrumb();renderSystem();showScreen('system')}
function goReporting(){nav={screen:'reporting',folderStatus:null,folderActive:true,recordId:null,estimateId:null,systemId:null};renderBreadcrumb();renderReporting();showScreen('reporting')}
let estTab='areas';
function switchEstTab(tab){
  estTab=tab;
  document.querySelectorAll('#estTabs .tab-btn').forEach(b=>b.classList.remove('ac'));
  document.querySelector('#estTabs .tab-btn[onclick*="'+tab+'"]').classList.add('ac');
  document.getElementById('estTabAreas').style.display=tab==='areas'?'':'none';
  document.getElementById('estTabOrderlist').style.display=tab==='orderlist'?'':'none';
  document.getElementById('estTabContract').style.display=tab==='contract'?'':'none';
  if(tab==='orderlist')renderOrderList();
  if(tab==='contract')initSignaturePads();
}

function renderBreadcrumb(){
  const el=document.getElementById('breadcrumb');
  let p=['<span onclick="goHome()">Home</span>'];
  if(nav.folderStatus){const st=STATUSES.find(s=>s.id===nav.folderStatus);p.push('<span class="sep">&#8250;</span>','<span onclick="goFolder(\''+nav.folderStatus+'\','+nav.folderActive+')">'+(nav.folderActive?'':'Inactive ')+st.label+'s</span>')}
  if(nav.recordId){const r=db.records.find(r=>r.id===nav.recordId);if(r){p.push('<span class="sep">&#8250;</span>','<span onclick="goRecord(\''+r.id+'\')">'+(r.firstName||r.lastName?r.firstName+' '+r.lastName:'Unnamed').trim()+'</span>')}}
  if(nav.estimateId){const r=db.records.find(r=>r.id===nav.recordId);const e=r?r.estimates.find(e=>e.id===nav.estimateId):null;if(e){p.push('<span class="sep">&#8250;</span>','<span onclick="goEstimate(\''+e.id+'\')">'+(e.name||'Estimate')+'</span>')}}
  if(nav.systemId){const r=db.records.find(r=>r.id===nav.recordId);const e=r?r.estimates.find(e=>e.id===nav.estimateId):null;const s=e?e.systems.find(s=>s.id===nav.systemId):null;if(s)p.push('<span class="sep">&#8250;</span>','<span class="current">'+(s.areaName||'New Area')+'</span>')}
  if(nav.screen==='reporting')p.push('<span class="sep">&#8250;</span>','<span class="current">Reports</span>');
  el.innerHTML=p.join('');
}

// ═══════════════════════════════════════════════════════════
// COST HELPERS
// ═══════════════════════════════════════════════════════════
function calcSysCosts(sys){
  const sqft=sys.sqft||0;
  const sr=sys.sellRate||0;
  const prod=PRODUCTS.find(p=>p.id===sys.productId);
  const tc=TOPCOATS.find(t=>t.id===sys.topcoatId);
  let sellTotal=sqft*sr;
  let costTotal=(prod?prod.cost*sqft:0)+(tc?tc.cost*sqft:0);
  // Repairs
  if(sys.repairs){Object.entries(sys.repairs).forEach(([id,r])=>{if(r.on){const def=REPAIRS.find(x=>x.id===id);if(def){const qty=r.qty||0;costTotal+=def.cost*qty;sellTotal+=((r.sell||0)*qty)}}})}
  // Add-ons
  if(sys.addons){Object.entries(sys.addons).forEach(([id,a])=>{if(a.on){const def=ADDONS.find(x=>x.id===id);if(def){const qty=a.qty||0;costTotal+=def.cost*qty;sellTotal+=((a.sell||0)*qty)}}})}
  return{sell:sellTotal,cost:costTotal,profit:sellTotal-costTotal,margin:sellTotal>0?((sellTotal-costTotal)/sellTotal*100):0};
}
function calcEstCosts(est){
  let sell=0,cost=0;
  est.systems.forEach(sys=>{const c=calcSysCosts(sys);sell+=c.sell;cost+=c.cost});
  return{sell,cost,profit:sell-cost,margin:sell>0?((sell-cost)/sell*100):0,sqft:est.systems.reduce((s,sys)=>s+(sys.sqft||0),0)};
}
function calcRecCosts(rec){
  let sell=0,cost=0;
  rec.estimates.forEach(est=>{const c=calcEstCosts(est);sell+=c.sell;cost+=c.cost});
  return{sell,cost};
}

// ═══════════════════════════════════════════════════════════
// HOME
// ═══════════════════════════════════════════════════════════
function renderHome(){
  const c={};const vals={};STATUSES.forEach(s=>{c[s.id]={active:0,inactive:0};vals[s.id]=0});
  db.records.forEach(r=>{if(c[r.status]){c[r.status][r.active?'active':'inactive']++;if(r.active)vals[r.status]+=calcRecCosts(r).sell}});
  const totalPipeline=Object.values(vals).reduce((s,v)=>s+v,0);
  const totalRecords=db.records.filter(r=>r.active).length;
  document.getElementById('pipelineSummary').innerHTML=
    '<div class="ps-card"><div class="ps-label">Total Pipeline</div><div class="ps-value">'+fmt(totalPipeline)+'</div><div class="ps-sub">'+totalRecords+' active record'+(totalRecords!==1?'s':'')+'</div></div>'+
    STATUSES.filter(s=>vals[s.id]>0).map(s=>'<div class="ps-card '+s.color+'"><div class="ps-label">'+s.label+'s</div><div class="ps-value">'+fmt(vals[s.id])+'</div><div class="ps-sub">'+c[s.id].active+' record'+(c[s.id].active!==1?'s':'')+'</div></div>').join('');
  document.getElementById('activeFolders').innerHTML=STATUSES.map(s=>'<div class="folder '+s.color+'" onclick="goFolder(\''+s.id+'\',true)"><div class="f-glow"></div><div class="f-icon">'+FOLDER_ICONS[s.id]+'</div><div class="f-count">'+c[s.id].active+'</div><div class="f-label">'+s.label+'s</div><div class="f-sub">active records</div></div>').join('');
  document.getElementById('inactiveFolders').innerHTML=STATUSES.map(s=>'<div class="folder '+s.color+' inactive" onclick="goFolder(\''+s.id+'\',false)"><div class="f-icon">'+FOLDER_ICONS[s.id]+'</div><div class="f-count">'+c[s.id].inactive+'</div><div class="f-label">Inactive '+s.label+'s</div></div>').join('');
}

// ═══════════════════════════════════════════════════════════
// LIST
// ═══════════════════════════════════════════════════════════
function renderList(){
  const st=STATUSES.find(s=>s.id===nav.folderStatus);
  const prefix=nav.folderActive?'':'Inactive ';
  document.getElementById('listHeader').innerHTML='<h2>'+prefix+st.label+'s</h2><p>'+getListDesc(st.id,nav.folderActive)+'</p>';
  document.getElementById('newLeadBtn').style.display=(nav.folderStatus==='lead'&&nav.folderActive)?'':'none';
  document.getElementById('searchInput').value='';filterList();
}
function getListDesc(s,a){if(!a)return'Archived records.';return{lead:'New contacts and inquiries.',estimate:'Leads with quotes ready for review.',project:'Jobs on your calendar.',completed:'Finished jobs.'}[s]||''}
function filterList(){
  const q=(document.getElementById('searchInput').value||'').toLowerCase();
  const items=db.records.filter(r=>r.status===nav.folderStatus&&r.active===nav.folderActive);
  const f=q?items.filter(r=>[r.firstName,r.lastName,r.company,r.address,r.city,r.email].join(' ').toLowerCase().includes(q)):items;
  if(!f.length){document.getElementById('listItems').innerHTML='<div class="empty"><div class="empty-icon">&#128194;</div><div class="empty-text">No records here yet.</div></div>';return}
  document.getElementById('listItems').innerHTML=f.map(r=>{
    const name=(r.firstName||'')+' '+(r.lastName||'');
    const ini=((r.firstName||'?')[0]+(r.lastName||'?')[0]).toUpperCase();
    const ec=r.estimates.length;
    const tot=calcRecCosts(r).sell;
    const meta=[r.company,r.city&&r.state?r.city+', '+r.state:r.city||r.state,ec?ec+' estimate'+(ec>1?'s':''):''].filter(Boolean).join(' \u00b7 ');
    return'<div class="list-item" onclick="goRecord(\''+r.id+'\')"><div class="li-left"><div class="li-avatar '+r.status+'">'+ini+'</div><div><div class="li-name">'+name.trim()+'</div><div class="li-meta">'+meta+'</div></div></div><div class="li-right">'+(tot>0?'<div class="li-amount">'+fmt(tot)+'</div>':'')+'<div class="li-badge '+r.status+'">'+r.status+'</div></div></div>'
  }).join('');
}

// ═══════════════════════════════════════════════════════════
// RECORD
// ═══════════════════════════════════════════════════════════
function getRecord(){return db.records.find(r=>r.id===nav.recordId)}
function renderRecord(){
  const rec=getRecord();if(!rec){goHome();return}
  const name=((rec.firstName||'')+' '+(rec.lastName||'')).trim()||'New Lead';
  document.getElementById('recordHeader').innerHTML='<h2>'+name+'</h2>'+(rec.company?'<p>'+rec.company+'</p>':'');
  document.getElementById('statusPills').innerHTML=STATUSES.map(s=>'<button class="status-pill '+s.color+(rec.status===s.id?' active':'')+'" onclick="changeStatus(\''+s.id+'\')">'+s.label+'</button>').join('');
  document.getElementById('recActive').checked=rec.active;
  document.getElementById('recFirst').value=rec.firstName||'';
  document.getElementById('recLast').value=rec.lastName||'';
  document.getElementById('recCompany').value=rec.company||'';
  document.getElementById('recEmail').value=rec.email||'';
  document.getElementById('recPhone').value=rec.phone||'';
  document.getElementById('recPhoneType').value=rec.phoneType||'cell';
  document.getElementById('recBestTime').value=rec.bestTimeToCall||'';
  document.getElementById('recAddress').value=rec.address||'';
  document.getElementById('recCity').value=rec.city||'';
  document.getElementById('recState').value=rec.state||'';
  document.getElementById('recZip').value=rec.zip||'';
  document.getElementById('recNotes').value=rec.notes||'';
  renderEstimatesList(rec);
}
function renderEstimatesList(rec){
  if(!rec.estimates.length){document.getElementById('estimatesList').innerHTML='<div class="empty"><div class="empty-icon">&#9997;</div><div class="empty-text">No estimates yet. Create one to start quoting.</div></div>';return}
  document.getElementById('estimatesList').innerHTML=rec.estimates.map(est=>{
    const ec=calcEstCosts(est);
    const areas=est.systems.map(s=>s.areaName||'Unnamed').join(', ');
    return'<div class="sys-card'+(ec.sell>0?' has-product':'')+'" onclick="goEstimate(\''+est.id+'\')"><div><div class="sys-area">'+(est.name||'Estimate')+'</div><div class="sys-detail">'+est.systems.length+' area'+(est.systems.length!==1?'s':'')+' \u00b7 '+ec.sqft.toLocaleString()+' sqft'+(areas?' \u00b7 '+areas:'')+'</div></div><div class="sys-right"><div class="sys-price">'+fmt(ec.sell)+'</div>'+(ec.cost>0?'<div class="sys-cost">Cost '+fmt(ec.cost)+'</div>':'')+'</div></div>'
  }).join('');
}
function saveRecord(){
  const rec=getRecord();if(!rec)return;
  rec.firstName=document.getElementById('recFirst').value.trim();
  rec.lastName=document.getElementById('recLast').value.trim();
  rec.company=document.getElementById('recCompany').value.trim();
  rec.email=document.getElementById('recEmail').value.trim();
  rec.phone=document.getElementById('recPhone').value.trim();
  rec.phoneType=document.getElementById('recPhoneType').value;
  rec.bestTimeToCall=document.getElementById('recBestTime').value.trim();
  rec.address=document.getElementById('recAddress').value.trim();
  rec.city=document.getElementById('recCity').value.trim();
  rec.state=document.getElementById('recState').value.trim();
  rec.zip=document.getElementById('recZip').value.trim();
  rec.notes=document.getElementById('recNotes').value.trim();
  rec.updatedAt=new Date().toISOString();
  saveDB(db);renderBreadcrumb();toast('Saved','Record updated.');
}
function changeStatus(s){const rec=getRecord();if(!rec)return;rec.status=s;rec.active=true;rec.updatedAt=new Date().toISOString();saveDB(db);nav.folderStatus=s;nav.folderActive=true;renderRecord();renderBreadcrumb();toast('Moved','Now in '+STATUSES.find(x=>x.id===s).label+'s.')}
function toggleActive(){const rec=getRecord();if(!rec)return;rec.active=document.getElementById('recActive').checked;rec.updatedAt=new Date().toISOString();saveDB(db);nav.folderActive=rec.active;renderBreadcrumb();toast(rec.active?'Active':'Archived',rec.active?'Record is active.':'Moved to inactive.')}
function newRecord(){const rec={id:uid(),status:'lead',active:true,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),firstName:'',lastName:'',company:'',email:'',phone:'',phoneType:'cell',bestTimeToCall:'',address:'',city:'',state:'',zip:'',notes:'',estimates:[]};db.records.unshift(rec);saveDB(db);goRecord(rec.id);toast('New Lead','Enter contact details.')}
function confirmDeleteRecord(){openConfirm('Delete Record','Permanently delete this record and all estimates?',()=>{db.records=db.records.filter(r=>r.id!==nav.recordId);saveDB(db);goFolder(nav.folderStatus,nav.folderActive);toast('Deleted','Record removed.')})}

// ═══════════════════════════════════════════════════════════
// ESTIMATE
// ═══════════════════════════════════════════════════════════
function getEstimate(){const rec=getRecord();return rec?rec.estimates.find(e=>e.id===nav.estimateId):null}
function renderEstimate(){
  const est=getEstimate();const rec=getRecord();if(!est||!rec){goRecord(nav.recordId);return}
  const rn=((rec.firstName||'')+' '+(rec.lastName||'')).trim()||'Client';
  document.getElementById('estNameInput').value=est.name||'';
  document.getElementById('estSubline').textContent=rn;
  estTab='areas';switchEstTab('areas');
  const ec=calcEstCosts(est);
  document.getElementById('estTotalBar').innerHTML='<div><div class="est-total-left">Estimate Total</div><div class="est-total-detail">'+est.systems.length+' area'+(est.systems.length!==1?'s':'')+' \u00b7 '+ec.sqft.toLocaleString()+' sqft</div></div><div style="text-align:right"><div class="est-total-amount">'+fmt(ec.sell)+'</div><div class="est-total-detail">Cost '+fmt(ec.cost)+' \u00b7 Margin '+ec.margin.toFixed(1)+'%</div></div>';
  if(!est.systems.length){document.getElementById('systemsList').innerHTML='<div class="empty"><div class="empty-icon">&#9874;</div><div class="empty-text">Add an area to start building this estimate.</div></div>';return}
  document.getElementById('systemsList').innerHTML=est.systems.map((sys,i)=>{
    const sc=calcSysCosts(sys);
    const prod=PRODUCTS.find(p=>p.id===sys.productId);
    const d=[sys.sqft?sys.sqft.toLocaleString()+' sqft':'',prod?prod.name:'No system',sys.sellRate?'$'+sys.sellRate.toFixed(2)+'/sqft':''].filter(Boolean).join(' \u00b7 ');
    return'<div class="sys-card'+(prod?' has-product':'')+'" onclick="goSystem(\''+sys.id+'\')"><div><div class="sys-area">'+(sys.areaName||'Area '+(i+1))+'</div><div class="sys-detail">'+d+'</div></div><div class="sys-right"><div class="sys-price">'+fmt(sc.sell)+'</div>'+(sc.cost>0?'<div class="sys-cost">Cost '+fmt(sc.cost)+'</div>':'')+'</div></div>'
  }).join('');
}
function updateEstName(){const est=getEstimate();if(est)est.name=document.getElementById('estNameInput').value.trim()}
function newEstimate(){const rec=getRecord();if(!rec)return;saveRecord();const c=rec.estimates.length+1;const est={id:uid(),name:'Estimate #'+c,createdAt:new Date().toISOString(),systems:[]};rec.estimates.push(est);rec.updatedAt=new Date().toISOString();if(rec.status==='lead'){rec.status='estimate';nav.folderStatus='estimate'}saveDB(db);goEstimate(est.id);toast('Created','Add areas to start quoting.')}
function saveEstimate(){saveDB(db);toast('Saved','Estimate saved.')}
function confirmDeleteEstimate(){const rec=getRecord();if(!rec)return;openConfirm('Delete Estimate','Delete this estimate and all areas?',()=>{rec.estimates=rec.estimates.filter(e=>e.id!==nav.estimateId);rec.updatedAt=new Date().toISOString();saveDB(db);goRecord(nav.recordId);toast('Deleted','Estimate removed.')})}

// ═══════════════════════════════════════════════════════════
// SYSTEM EDITOR
// ═══════════════════════════════════════════════════════════
function getSystem(){const est=getEstimate();return est?est.systems.find(s=>s.id===nav.systemId):null}
function renderSystem(){
  const sys=getSystem();if(!sys){goEstimate(nav.estimateId);return}
  // Initialize repairs/addons if missing
  if(!sys.repairs){sys.repairs={}}
  if(!sys.addons){sys.addons={}}
  document.getElementById('sysHeader').innerHTML='<h2>'+(sys.areaName||'New Area')+'</h2><p>Select a product system and set your sell rate.</p>';
  document.getElementById('sysArea').value=sys.areaName||'';
  document.getElementById('sysLength').value=sys.length||0;
  document.getElementById('sysWidth').value=sys.width||1;
  document.getElementById('sysSqft').value=sys.sqft||0;
  document.getElementById('sysSellRate').value=sys.sellRate||0;
  document.getElementById('sysNotes').value=sys.notes||'';
  seriesFilter='All';renderSeriesFilter();renderProductList(sys);renderTopcoatList(sys);renderRepairList(sys);renderAddonList(sys);calcSystem();
}
function renderSeriesFilter(){const s=['All','C-Series','M-Series','G-Series','E-Series','I-Series'];document.getElementById('seriesFilter').innerHTML=s.map(x=>'<button class="sf-btn'+(x===seriesFilter?' ac':'')+'" onclick="setSeriesFilter(\''+x+'\')">'+x+'</button>').join('')}
function setSeriesFilter(s){seriesFilter=s;renderSeriesFilter();const sys=getSystem();if(sys)renderProductList(sys)}
function renderProductList(sys){
  const ps=seriesFilter==='All'?PRODUCTS:PRODUCTS.filter(p=>p.series===seriesFilter);
  document.getElementById('prodList').innerHTML=ps.map(p=>{const sel=sys.productId===p.id;return'<div class="prod-option'+(sel?' sel':'')+'" onclick="selectProduct(\''+p.id+'\')"><div><div class="prod-name">'+p.name+'</div><div class="prod-sku">'+p.sku+' \u00b7 '+p.cat+'</div></div><div class="prod-prices"><div class="cost">'+fmt(p.cost)+'/sf</div><div class="sell">Sell '+fmt(p.low)+'\u2013'+fmt(p.mid)+'</div></div></div>'}).join('');
}
function renderTopcoatList(sys){
  document.getElementById('tcList').innerHTML=TOPCOATS.map(t=>{const sel=(sys.topcoatId||'tc-none')===t.id;return'<div class="prod-option'+(sel?' sel':'')+'" onclick="selectTopcoat(\''+t.id+'\')"><div><div class="prod-name">'+t.name+'</div>'+(t.desc?'<div class="prod-sku">'+t.desc+'</div>':'')+'</div><div class="prod-prices"><div class="cost">'+(t.cost>0?fmt(t.cost)+'/sf':'\u2014')+'</div></div></div>'}).join('');
}
function selectProduct(id){const sys=getSystem();if(!sys)return;sys.productId=id;const p=PRODUCTS.find(p=>p.id===id);if(p&&!sys.sellRate){sys.sellRate=p.low;document.getElementById('sysSellRate').value=p.low.toFixed(2)}renderProductList(sys);calcSystem()}
function selectTopcoat(id){const sys=getSystem();if(!sys)return;sys.topcoatId=id==='tc-none'?null:id;renderTopcoatList(sys);calcSystem()}
function calcSystem(sqm){
  const sys=getSystem();if(!sys)return;
  const l=parseFloat(document.getElementById('sysLength').value)||0;
  const w=parseFloat(document.getElementById('sysWidth').value)||1;
  let sq=sqm?(parseFloat(document.getElementById('sysSqft').value)||0):(l*w);
  if(!sqm)document.getElementById('sysSqft').value=sq;
  const sr=parseFloat(document.getElementById('sysSellRate').value)||0;
  sys.areaName=document.getElementById('sysArea').value.trim();sys.length=l;sys.width=w;sys.sqft=sq;sys.sellRate=sr;sys.notes=document.getElementById('sysNotes').value.trim();
  const sc=calcSysCosts(sys);
  document.getElementById('sysPrice').textContent=fmt(sc.sell);
  document.getElementById('sysStats').innerHTML='<div class="sx hl"><div class="sl">Total Price</div><div class="sv">'+fmt(sc.sell)+'</div></div><div class="sx"><div class="sl">Material Cost</div><div class="sv" style="color:var(--comp)">'+fmt(sc.cost)+'</div></div><div class="sx"><div class="sl">Gross Profit</div><div class="sv" style="color:var(--success)">'+fmt(sc.profit)+'</div></div><div class="sx"><div class="sl">Margin</div><div class="sv" style="color:'+(sc.margin>=50?'var(--success)':sc.margin>=30?'var(--accent)':'var(--comp)')+'">'+sc.margin.toFixed(1)+'%</div></div>';
}
function renderRepairList(sys){
  document.getElementById('repairList').innerHTML=REPAIRS.map(r=>{
    const d=sys.repairs[r.id]||{on:false,qty:0,sell:0};
    return'<div class="ra-row'+(d.on?' on':'')+'">'+
      '<div class="ra-toggle"><input type="checkbox"'+(d.on?' checked':'')+' onchange="toggleRepair(\''+r.id+'\',this.checked)"></div>'+
      '<div class="ra-info"><div class="ra-name">'+r.name+'</div><div class="ra-sku">'+r.sku+' \u00b7 Cost '+fmt(r.cost)+'/'+r.unit+'</div></div>'+
      '<div class="ra-fields"'+(d.on?'':' style="opacity:.3;pointer-events:none"')+'>'+
        '<input type="number" value="'+(d.qty||0)+'" min="0" step="1" placeholder="Qty" onchange="updateRepair(\''+r.id+'\',\'qty\',this.value)">'+
        '<div class="ra-unit">'+r.unit+'</div>'+
        '<input type="number" value="'+(d.sell||0)+'" min="0" step="0.01" placeholder="Sell" onchange="updateRepair(\''+r.id+'\',\'sell\',this.value)">'+
        '<div class="ra-unit">$/'+r.unit+'</div>'+
      '</div>'+
      '<div class="ra-cost">'+fmt((d.sell||0)*(d.qty||0))+'</div>'+
    '</div>'
  }).join('');
}
function toggleRepair(id,on){
  const sys=getSystem();if(!sys)return;
  if(!sys.repairs[id])sys.repairs[id]={on:false,qty:0,sell:0};
  sys.repairs[id].on=on;
  renderRepairList(sys);calcSystem();
}
function updateRepair(id,field,val){
  const sys=getSystem();if(!sys)return;
  if(!sys.repairs[id])sys.repairs[id]={on:true,qty:0,sell:0};
  sys.repairs[id][field]=parseFloat(val)||0;
  renderRepairList(sys);calcSystem();
}
function renderAddonList(sys){
  document.getElementById('addonList').innerHTML=ADDONS.map(a=>{
    const d=sys.addons[a.id]||{on:false,qty:0,sell:a.low};
    return'<div class="ra-row'+(d.on?' on':'')+'">'+
      '<div class="ra-toggle"><input type="checkbox"'+(d.on?' checked':'')+' onchange="toggleAddon(\''+a.id+'\',this.checked)"></div>'+
      '<div class="ra-info"><div class="ra-name">'+a.name+'</div><div class="ra-sku">'+a.sku+' \u00b7 Cost '+fmt(a.cost)+'/'+a.unit+' \u00b7 Sell '+fmt(a.low)+'\u2013'+fmt(a.mid)+'</div></div>'+
      '<div class="ra-fields"'+(d.on?'':' style="opacity:.3;pointer-events:none"')+'>'+
        '<input type="number" value="'+(d.qty||0)+'" min="0" step="1" placeholder="Qty" onchange="updateAddon(\''+a.id+'\',\'qty\',this.value)">'+
        '<div class="ra-unit">'+a.unit+'</div>'+
        '<input type="number" value="'+(d.sell||a.low)+'" min="0" step="0.01" placeholder="Sell" onchange="updateAddon(\''+a.id+'\',\'sell\',this.value)">'+
        '<div class="ra-unit">$/'+a.unit+'</div>'+
      '</div>'+
      '<div class="ra-cost">'+fmt((d.sell||0)*(d.qty||0))+'</div>'+
    '</div>'
  }).join('');
}
function toggleAddon(id,on){
  const sys=getSystem();if(!sys)return;
  const def=ADDONS.find(a=>a.id===id);
  if(!sys.addons[id])sys.addons[id]={on:false,qty:0,sell:def?def.low:0};
  sys.addons[id].on=on;
  // Auto-fill qty with sqft for sqft-based add-ons
  if(on&&def&&def.unit==='sqft'&&!sys.addons[id].qty)sys.addons[id].qty=sys.sqft||0;
  renderAddonList(sys);calcSystem();
}
function updateAddon(id,field,val){
  const sys=getSystem();if(!sys)return;
  const def=ADDONS.find(a=>a.id===id);
  if(!sys.addons[id])sys.addons[id]={on:true,qty:0,sell:def?def.low:0};
  sys.addons[id][field]=parseFloat(val)||0;
  renderAddonList(sys);calcSystem();
}
function saveSystem(){calcSystem();saveDB(db);renderBreadcrumb();toast('Saved','Area saved.')}
function newSystem(){const est=getEstimate();if(!est)return;const sys={id:uid(),areaName:'',length:0,width:1,sqft:0,productId:null,sellRate:0,topcoatId:null,notes:'',repairs:{},addons:{}};est.systems.push(sys);saveDB(db);goSystem(sys.id)}
function confirmDeleteSystem(){const est=getEstimate();if(!est)return;openConfirm('Remove Area','Remove this area from the estimate?',()=>{est.systems=est.systems.filter(s=>s.id!==nav.systemId);saveDB(db);goEstimate(nav.estimateId);toast('Removed','Area removed.')})}

// ═══════════════════════════════════════════════════════════
// MODALS / TOAST / IMPORT-EXPORT
// ═══════════════════════════════════════════════════════════
function openConfirm(t,m,fn){document.getElementById('confirmTitle').textContent=t;document.getElementById('confirmMsg').textContent=m;document.getElementById('confirmYes').onclick=()=>{closeConfirm();fn()};document.getElementById('confirmModal').classList.add('active')}
function closeConfirm(){document.getElementById('confirmModal').classList.remove('active')}
function openExport(){document.getElementById('exportModal').classList.add('active')}
function closeExport(){document.getElementById('exportModal').classList.remove('active')}
function openImport(){document.getElementById('importModal').classList.add('active')}
function closeImport(){document.getElementById('importModal').classList.remove('active')}
function toast(t,m){const el=document.getElementById('toast');document.getElementById('toastT').textContent=t;document.getElementById('toastM').textContent=m;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),3000)}
function doExport(){const b=new Blob([JSON.stringify(db,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='coatings-estimator-'+new Date().toISOString().slice(0,10)+'.json';a.click();closeExport();toast('Exported','Download started.')}
function doImport(){const f=document.getElementById('importFile').files[0];if(!f){toast('Error','Select a file.');return}const r=new FileReader();r.onload=e=>{try{const d=JSON.parse(e.target.result);if(d.records&&Array.isArray(d.records)){db=d;saveDB(db);closeImport();goHome();toast('Imported',db.records.length+' records loaded.')}else{toast('Error','Invalid format.')}}catch{toast('Error','Could not parse file.')}};r.readAsText(f)}

// ═══════════════════════════════════════════════════════════
// ORDER LIST (Phase 2 — Ingredient Intelligence)
// ═══════════════════════════════════════════════════════════
function getSystemIngredients(sys){
  const items=[];
  const sqft=sys.sqft||0;
  if(!sqft)return items;
  // Product system ingredients
  const ings=INGREDIENTS[sys.productId];
  if(ings){ings.forEach(ing=>{
    const unitsNeeded=Math.ceil(sqft/ing.coverage);
    items.push({name:ing.name,sku:ing.sku,qty:unitsNeeded,unit:ing.unit,costPer:ing.costPer,totalCost:unitsNeeded*ing.costPer,source:'system',area:sys.areaName||'Unnamed'});
  })}
  // Top coat
  const tc=TOPCOATS.find(t=>t.id===sys.topcoatId);
  if(tc&&tc.cost>0){items.push({name:tc.name,sku:tc.sku||'',qty:Math.ceil(sqft/350),unit:'gal',costPer:tc.cost*350,totalCost:tc.cost*sqft,source:'topcoat',area:sys.areaName||'Unnamed'})}
  // Repairs
  if(sys.repairs){Object.entries(sys.repairs).forEach(([id,r])=>{if(r.on&&r.qty>0){const def=REPAIRS.find(x=>x.id===id);if(def)items.push({name:def.name,sku:def.sku,qty:r.qty,unit:def.unit,costPer:def.cost,totalCost:def.cost*r.qty,source:'repair',area:sys.areaName||'Unnamed'})}})}
  // Add-ons
  if(sys.addons){Object.entries(sys.addons).forEach(([id,a])=>{if(a.on&&a.qty>0){const def=ADDONS.find(x=>x.id===id);if(def)items.push({name:def.name,sku:def.sku,qty:a.qty,unit:def.unit,costPer:def.cost,totalCost:def.cost*a.qty,source:'addon',area:sys.areaName||'Unnamed'})}})}
  return items;
}
function renderOrderList(){
  const est=getEstimate();if(!est){return}
  if(!est.systems.length){document.getElementById('orderListContent').innerHTML='<div class="empty"><div class="empty-icon">&#9776;</div><div class="empty-text">Add areas with products to see the order list.</div></div>';return}
  // Collect all ingredients grouped by area
  let allItems=[];let totalCost=0;
  est.systems.forEach(sys=>{const items=getSystemIngredients(sys);allItems.push({area:sys.areaName||'Unnamed',sqft:sys.sqft,items});items.forEach(i=>totalCost+=i.totalCost)});
  // Aggregate duplicate items
  const agg={};allItems.forEach(g=>g.items.forEach(i=>{const k=i.sku||i.name;if(!agg[k])agg[k]={...i,qty:0,totalCost:0};agg[k].qty+=i.qty;agg[k].totalCost+=i.totalCost}));
  let html='<div style="margin-bottom:16px"><strong style="font-size:14px">By Area</strong></div><table class="ol-table">';
  html+='<tr><th>Item</th><th>SKU</th><th class="right">Qty</th><th>Unit</th><th class="right">Unit Cost</th><th class="right">Total</th></tr>';
  allItems.forEach(g=>{
    html+='<tr class="group-hdr"><td colspan="6">'+g.area+' \u2014 '+g.sqft.toLocaleString()+' sqft</td></tr>';
    g.items.forEach(i=>{html+='<tr><td>'+i.name+'</td><td class="mono">'+i.sku+'</td><td class="right mono">'+i.qty+'</td><td>'+i.unit+'</td><td class="right mono">'+fmt(i.costPer)+'</td><td class="right mono accent">'+fmt(i.totalCost)+'</td></tr>'});
  });
  html+='<tr class="ol-total"><td colspan="5">Total Material Cost</td><td class="right mono accent">'+fmt(totalCost)+'</td></tr></table>';
  // Aggregated purchase list
  html+='<div style="margin:24px 0 16px"><strong style="font-size:14px">Consolidated Purchase List</strong></div><table class="ol-table">';
  html+='<tr><th>Item</th><th>SKU</th><th class="right">Total Qty</th><th>Unit</th><th class="right">Est. Cost</th></tr>';
  Object.values(agg).sort((a,b)=>a.name.localeCompare(b.name)).forEach(i=>{html+='<tr><td>'+i.name+'</td><td class="mono">'+i.sku+'</td><td class="right mono">'+i.qty+'</td><td>'+i.unit+'</td><td class="right mono accent">'+fmt(i.totalCost)+'</td></tr>'});
  html+='<tr class="ol-total"><td colspan="4">Total</td><td class="right mono accent">'+fmt(totalCost)+'</td></tr></table>';
  document.getElementById('orderListContent').innerHTML=html;
}

// ═══════════════════════════════════════════════════════════
// PDF PROPOSAL (Phase 3)
// ═══════════════════════════════════════════════════════════
function generateProposal(){
  const rec=getRecord();const est=getEstimate();
  if(!rec||!est){toast('Error','No estimate to generate.');return}
  if(typeof window.jspdf==='undefined'){toast('Error','PDF library not loaded. Check internet connection.');return}
  const{jsPDF}=window.jspdf;
  const doc=new jsPDF();
  const pw=doc.internal.pageSize.getWidth();
  const rn=((rec.firstName||'')+' '+(rec.lastName||'')).trim()||'Client';
  const ec=calcEstCosts(est);
  const today=new Date().toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'});
  // Header bar
  doc.setFillColor(245,158,11);doc.rect(0,0,pw,32,'F');
  doc.setTextColor(0);doc.setFontSize(20);doc.setFont('helvetica','bold');
  doc.text('The Concrete Protector',14,16);
  doc.setFontSize(10);doc.setFont('helvetica','normal');
  doc.text('Decorative Concrete Coatings Proposal',14,24);
  doc.setFontSize(9);doc.text(today,pw-14,16,{align:'right'});
  doc.text((est.name||'Estimate'),pw-14,24,{align:'right'});
  // Client info
  let y=44;doc.setTextColor(60);doc.setFontSize(12);doc.setFont('helvetica','bold');doc.text('Prepared For:',14,y);
  y+=7;doc.setFont('helvetica','normal');doc.setFontSize(11);doc.setTextColor(30);
  doc.text(rn,14,y);y+=6;
  if(rec.company){doc.text(rec.company,14,y);y+=6}
  if(rec.address){doc.text(rec.address,14,y);y+=6}
  const loc=[rec.city,rec.state,rec.zip].filter(Boolean).join(', ');
  if(loc){doc.text(loc,14,y);y+=6}
  if(rec.phone){doc.text(rec.phone,14,y);y+=6}
  if(rec.email){doc.text(rec.email,14,y);y+=6}
  // Area table
  y+=8;doc.setFillColor(240,240,240);doc.rect(14,y,pw-28,8,'F');
  doc.setFontSize(9);doc.setFont('helvetica','bold');doc.setTextColor(80);
  doc.text('Area',16,y+6);doc.text('System',70,y+6);doc.text('Sqft',120,y+6,{align:'right'});
  doc.text('$/Sqft',145,y+6,{align:'right'});doc.text('Price',pw-16,y+6,{align:'right'});
  y+=12;doc.setFont('helvetica','normal');doc.setTextColor(30);
  est.systems.forEach((sys,i)=>{
    if(y>260){doc.addPage();y=20}
    const prod=PRODUCTS.find(p=>p.id===sys.productId);
    const sc=calcSysCosts(sys);
    doc.setFontSize(10);
    doc.text(sys.areaName||'Area '+(i+1),16,y);
    doc.text(prod?prod.name:'—',70,y);
    doc.text((sys.sqft||0).toLocaleString(),120,y,{align:'right'});
    doc.text('$'+(sys.sellRate||0).toFixed(2),145,y,{align:'right'});
    doc.setFont('helvetica','bold');doc.text(fmt(sc.sell),pw-16,y,{align:'right'});doc.setFont('helvetica','normal');
    y+=7;
    // Line items for repairs/addons
    const extras=[];
    if(sys.repairs){Object.entries(sys.repairs).forEach(([id,r])=>{if(r.on&&r.qty>0){const def=REPAIRS.find(x=>x.id===id);if(def)extras.push('  '+def.name+': '+r.qty+' '+def.unit+' @ $'+(r.sell||0).toFixed(2))}})}
    if(sys.addons){Object.entries(sys.addons).forEach(([id,a])=>{if(a.on&&a.qty>0){const def=ADDONS.find(x=>x.id===id);if(def)extras.push('  '+def.name+': '+a.qty+' '+def.unit+' @ $'+(a.sell||0).toFixed(2))}})}
    if(extras.length){doc.setFontSize(8);doc.setTextColor(120);extras.forEach(ex=>{doc.text(ex,18,y);y+=5});doc.setTextColor(30)}
    doc.setDrawColor(230);doc.line(14,y-2,pw-14,y-2);y+=3;
  });
  // Total
  y+=4;doc.setFillColor(245,158,11);doc.rect(100,y-5,pw-114,10,'F');
  doc.setFontSize(12);doc.setFont('helvetica','bold');doc.setTextColor(0);
  doc.text('TOTAL:',102,y+2);doc.text(fmt(ec.sell),pw-16,y+2,{align:'right'});
  // Terms
  y+=20;doc.setTextColor(80);doc.setFontSize(9);doc.setFont('helvetica','bold');
  doc.text('Terms & Conditions',14,y);y+=6;doc.setFont('helvetica','normal');doc.setFontSize(8);
  const terms=document.getElementById('contractTerms')?document.getElementById('contractTerms').value:'Proposal valid for 30 days. 50% deposit required to schedule.';
  const tlines=doc.splitTextToSize(terms,pw-28);
  tlines.forEach(l=>{if(y>280){doc.addPage();y=20}doc.text(l,14,y);y+=4});
  // Signature lines
  y+=12;if(y>250){doc.addPage();y=20}
  doc.setDrawColor(180);doc.setLineWidth(0.5);
  doc.line(14,y,90,y);doc.line(110,y,pw-14,y);
  y+=5;doc.setFontSize(8);doc.text('Contractor Signature / Date',14,y);doc.text('Customer Signature / Date',110,y);
  // Footer
  y+=12;doc.setFontSize(7);doc.setTextColor(160);
  doc.text('Generated by Coatings Estimator \u2014 The Concrete Protector \u2014 theconcreteprotector.com',pw/2,y,{align:'center'});
  const fn='TCP-Proposal-'+rn.replace(/\s+/g,'-')+'-'+new Date().toISOString().slice(0,10)+'.pdf';
  doc.save(fn);toast('Proposal Saved',fn);
}

// ═══════════════════════════════════════════════════════════
// CONTRACT / SIGNATURE (Phase 3)
// ═══════════════════════════════════════════════════════════
const sigPads={};
function initSignaturePads(){
  ['sigContractor','sigCustomer'].forEach(id=>{
    if(sigPads[id])return;
    const canvas=document.getElementById(id);if(!canvas)return;
    const ctx=canvas.getContext('2d');
    canvas.width=canvas.offsetWidth*2;canvas.height=canvas.offsetHeight*2;
    ctx.scale(2,2);ctx.strokeStyle='#fafafa';ctx.lineWidth=2;ctx.lineCap='round';ctx.lineJoin='round';
    let drawing=false;let lx=0,ly=0;
    function getPos(e){const r=canvas.getBoundingClientRect();const t=e.touches?e.touches[0]:e;return{x:t.clientX-r.left,y:t.clientY-r.top}}
    canvas.addEventListener('mousedown',e=>{drawing=true;const p=getPos(e);lx=p.x;ly=p.y});
    canvas.addEventListener('mousemove',e=>{if(!drawing)return;const p=getPos(e);ctx.beginPath();ctx.moveTo(lx,ly);ctx.lineTo(p.x,p.y);ctx.stroke();lx=p.x;ly=p.y});
    canvas.addEventListener('mouseup',()=>drawing=false);
    canvas.addEventListener('mouseleave',()=>drawing=false);
    canvas.addEventListener('touchstart',e=>{e.preventDefault();drawing=true;const p=getPos(e);lx=p.x;ly=p.y},{passive:false});
    canvas.addEventListener('touchmove',e=>{e.preventDefault();if(!drawing)return;const p=getPos(e);ctx.beginPath();ctx.moveTo(lx,ly);ctx.lineTo(p.x,p.y);ctx.stroke();lx=p.x;ly=p.y},{passive:false});
    canvas.addEventListener('touchend',()=>drawing=false);
    sigPads[id]={canvas,ctx};
  });
}
function clearSig(id){
  const pad=sigPads[id];
  if(pad){pad.ctx.clearRect(0,0,pad.canvas.width/2,pad.canvas.height/2)}
  else{const c=document.getElementById(id);if(c){const x=c.getContext('2d');x.clearRect(0,0,c.width,c.height)}}
}
function generateContract(){
  const rec=getRecord();const est=getEstimate();
  if(!rec||!est){toast('Error','No estimate selected.');return}
  if(typeof window.jspdf==='undefined'){toast('Error','PDF library not loaded.');return}
  const{jsPDF}=window.jspdf;const doc=new jsPDF();
  const pw=doc.internal.pageSize.getWidth();
  const rn=((rec.firstName||'')+' '+(rec.lastName||'')).trim()||'Client';
  const ec=calcEstCosts(est);
  const today=new Date().toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'});
  // Header
  doc.setFillColor(30,30,30);doc.rect(0,0,pw,28,'F');
  doc.setTextColor(245,158,11);doc.setFontSize(18);doc.setFont('helvetica','bold');
  doc.text('SERVICE CONTRACT',14,14);
  doc.setFontSize(10);doc.setTextColor(200,200,200);doc.setFont('helvetica','normal');
  doc.text('The Concrete Protector',14,22);doc.text(today,pw-14,14,{align:'right'});
  // Parties
  let y=40;doc.setTextColor(30);doc.setFontSize(11);doc.setFont('helvetica','bold');
  doc.text('Client:',14,y);doc.setFont('helvetica','normal');doc.text(rn+(rec.company?' \u2014 '+rec.company:''),50,y);
  y+=7;const addr=[rec.address,[rec.city,rec.state,rec.zip].filter(Boolean).join(', ')].filter(Boolean).join(', ');
  if(addr){doc.setFontSize(10);doc.text(addr,50,y);y+=7}
  // Scope table
  y+=6;doc.setFontSize(11);doc.setFont('helvetica','bold');doc.text('Scope of Work',14,y);y+=8;
  doc.setFillColor(245,245,245);doc.rect(14,y-4,pw-28,8,'F');
  doc.setFontSize(9);doc.setTextColor(80);doc.text('Area',16,y+2);doc.text('System',70,y+2);
  doc.text('Sqft',130,y+2,{align:'right'});doc.text('Price',pw-16,y+2,{align:'right'});y+=10;
  doc.setFont('helvetica','normal');doc.setTextColor(30);
  est.systems.forEach((sys,i)=>{
    const prod=PRODUCTS.find(p=>p.id===sys.productId);const sc=calcSysCosts(sys);
    doc.text(sys.areaName||'Area '+(i+1),16,y);doc.text(prod?prod.name:'\u2014',70,y);
    doc.text((sys.sqft||0).toLocaleString(),130,y,{align:'right'});
    doc.setFont('helvetica','bold');doc.text(fmt(sc.sell),pw-16,y,{align:'right'});doc.setFont('helvetica','normal');y+=7
  });
  y+=2;doc.setDrawColor(245,158,11);doc.setLineWidth(1);doc.line(100,y,pw-14,y);y+=6;
  doc.setFontSize(13);doc.setFont('helvetica','bold');doc.text('Contract Total: '+fmt(ec.sell),pw-16,y,{align:'right'});
  // Terms
  y+=14;doc.setFontSize(10);doc.text('Terms & Conditions',14,y);y+=7;
  doc.setFont('helvetica','normal');doc.setFontSize(8);doc.setTextColor(60);
  const terms=document.getElementById('contractTerms').value;
  doc.splitTextToSize(terms,pw-28).forEach(l=>{if(y>265){doc.addPage();y=20}doc.text(l,14,y);y+=4});
  // Signatures
  y+=10;if(y>230){doc.addPage();y=20}
  doc.setTextColor(30);doc.setFontSize(10);doc.setFont('helvetica','bold');doc.text('Signatures',14,y);y+=10;
  // Add signature images if drawn
  ['sigContractor','sigCustomer'].forEach((id,i)=>{
    const c=document.getElementById(id);
    if(c){try{const img=c.toDataURL('image/png');doc.addImage(img,i===0?14:110,y,75,28)}catch(e){}}
  });
  y+=32;doc.setDrawColor(180);doc.setLineWidth(0.5);
  doc.line(14,y,90,y);doc.line(110,y,pw-14,y);y+=5;
  doc.setFontSize(8);doc.setFont('helvetica','normal');doc.setTextColor(100);
  doc.text('Contractor Signature / Date',14,y);doc.text('Customer Signature / Date',110,y);
  y+=10;doc.setFontSize(7);doc.setTextColor(160);
  doc.text('Generated by Coatings Estimator \u2014 The Concrete Protector',pw/2,y,{align:'center'});
  const fn='TCP-Contract-'+rn.replace(/\s+/g,'-')+'-'+new Date().toISOString().slice(0,10)+'.pdf';
  doc.save(fn);toast('Contract Saved',fn);
}

// ═══════════════════════════════════════════════════════════
// REPORTING (Phase 5)
// ═══════════════════════════════════════════════════════════
function renderReporting(){
  const active=db.records.filter(r=>r.active);
  const completed=active.filter(r=>r.status==='completed');
  const projects=active.filter(r=>r.status==='project');
  const estimates=active.filter(r=>r.status==='estimate');
  const leads=active.filter(r=>r.status==='lead');
  let totalRevenue=0,totalPipeline=0,totalSqft=0,jobCount=completed.length;
  completed.forEach(r=>{const c=calcRecCosts(r);totalRevenue+=c.sell});
  active.forEach(r=>{const c=calcRecCosts(r);totalPipeline+=c.sell;r.estimates.forEach(e=>e.systems.forEach(s=>totalSqft+=s.sqft||0))});
  const avgJob=jobCount>0?totalRevenue/jobCount:0;
  document.getElementById('rptCards').innerHTML=
    '<div class="rpt-card"><div class="rl">Completed Revenue</div><div class="rv">'+fmt(totalRevenue)+'</div><div class="rs">'+jobCount+' completed job'+(jobCount!==1?'s':'')+'</div></div>'+
    '<div class="rpt-card"><div class="rl">Active Pipeline</div><div class="rv">'+fmt(totalPipeline)+'</div><div class="rs">'+active.length+' active record'+(active.length!==1?'s':'')+'</div></div>'+
    '<div class="rpt-card"><div class="rl">Avg Job Size</div><div class="rv">'+fmt(avgJob)+'</div><div class="rs">based on completed</div></div>'+
    '<div class="rpt-card"><div class="rl">Total Sqft Quoted</div><div class="rv">'+totalSqft.toLocaleString()+'</div><div class="rs">across all estimates</div></div>';
  // Top systems
  const sysCounts={};
  db.records.forEach(r=>r.estimates.forEach(e=>e.systems.forEach(s=>{if(s.productId){const p=PRODUCTS.find(p=>p.id===s.productId);if(p){if(!sysCounts[p.name])sysCounts[p.name]={count:0,sqft:0,revenue:0};sysCounts[p.name].count++;sysCounts[p.name].sqft+=s.sqft||0;sysCounts[p.name].revenue+=(s.sqft||0)*(s.sellRate||0)}}})));
  const topSys=Object.entries(sysCounts).sort((a,b)=>b[1].count-a[1].count).slice(0,8);
  const maxCount=topSys.length?topSys[0][1].count:1;
  if(topSys.length){
    document.getElementById('rptTopSystems').innerHTML='<div class="bar-chart">'+topSys.map(([name,d])=>
      '<div class="bar-row"><div class="bar-label">'+name+'</div><div class="bar-track"><div class="bar-fill" style="width:'+((d.count/maxCount)*100)+'%"></div></div><div class="bar-val">'+d.count+'x</div></div>'
    ).join('')+'</div>';
  }else{document.getElementById('rptTopSystems').innerHTML='<div class="empty"><div class="empty-text">No systems used yet.</div></div>'}
  // Pipeline breakdown
  const stages=[{label:'Leads',items:leads,color:'var(--lead)'},{label:'Estimates',items:estimates,color:'var(--est)'},{label:'Projects',items:projects,color:'var(--proj)'},{label:'Completed',items:completed,color:'var(--comp)'}];
  const maxStage=Math.max(...stages.map(s=>s.items.length),1);
  document.getElementById('rptPipelineBreakdown').innerHTML='<div class="bar-chart">'+stages.map(s=>{
    const val=s.items.reduce((sum,r)=>sum+calcRecCosts(r).sell,0);
    return'<div class="bar-row"><div class="bar-label">'+s.label+' ('+s.items.length+')</div><div class="bar-track"><div class="bar-fill" style="width:'+((s.items.length/maxStage)*100)+'%;background:'+s.color+'"></div></div><div class="bar-val">'+fmt(val)+'</div></div>'
  }).join('')+'</div>';
  // Recent activity
  const recent=db.records.slice().sort((a,b)=>new Date(b.updatedAt)-new Date(a.updatedAt)).slice(0,6);
  if(recent.length){
    document.getElementById('rptRecent').innerHTML=recent.map(r=>{
      const name=((r.firstName||'')+' '+(r.lastName||'')).trim()||'Unnamed';
      const ago=timeAgo(new Date(r.updatedAt));
      return'<div class="list-item" onclick="goFolder(\''+r.status+'\','+r.active+');setTimeout(()=>goRecord(\''+r.id+'\'),50)" style="margin-bottom:4px"><div class="li-left"><div class="li-avatar '+r.status+'">'+((r.firstName||'?')[0]+(r.lastName||'?')[0]).toUpperCase()+'</div><div><div class="li-name">'+name+'</div><div class="li-meta">'+ago+'</div></div></div><div class="li-right"><div class="li-badge '+r.status+'">'+r.status+'</div></div></div>'
    }).join('');
  }else{document.getElementById('rptRecent').innerHTML='<div class="empty"><div class="empty-text">No activity yet.</div></div>'}
}
function timeAgo(d){
  const s=Math.floor((Date.now()-d)/1e3);
  if(s<60)return'just now';if(s<3600)return Math.floor(s/60)+'m ago';
  if(s<86400)return Math.floor(s/3600)+'h ago';if(s<604800)return Math.floor(s/86400)+'d ago';
  return d.toLocaleDateString();
}

// ═══════════════════════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════════════════════
renderHome();renderBreadcrumb();
</script>
</body>
</html>
