<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Coatings Estimator — The Concrete Protector</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<link rel="manifest" href="data:application/json,%7B%22name%22%3A%22Coatings%20Estimator%22%2C%22short_name%22%3A%22CE%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%23f0f2f5%22%2C%22theme_color%22%3A%22%232563eb%22%7D">
<meta name="theme-color" content="#2563eb">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
/* ═══════════════════════════════════════════════════════
   DESIGN SYSTEM
   ═══════════════════════════════════════════════════════ */
:root {
  /* Surface layers */
  --bg: #f0f2f5;
  --s1: #e8eaef;
  --s2: #ffffff;
  --s3: #f5f6f8;
  --s4: #d1d5db;
  /* Borders */
  --b1: #e5e7eb;
  --b2: #d1d5db;
  --b3: #9ca3af;
  /* Text */
  --t1: #111827;
  --t2: #374151;
  --t3: #6b7280;
  --t4: #9ca3af;
  /* Accent */
  --accent: #2563eb;
  --accent2: #0ea5e9;
  --accent-glow: rgba(37,99,235,.10);
  --accent-glow2: rgba(37,99,235,.05);
  /* Pipeline */
  --lead: #2563eb;
  --lead-soft: rgba(37,99,235,.08);
  --est: #ea580c;
  --est-soft: rgba(234,88,12,.08);
  --proj: #16a34a;
  --proj-soft: rgba(22,163,74,.08);
  --comp: #dc2626;
  --comp-soft: rgba(220,38,38,.08);
  /* Semantic */
  --success: #16a34a;
  --danger: #dc2626;
  --info: #2563eb;
  /* Glass */
  --glass: rgba(0,0,0,.02);
  --glass2: rgba(0,0,0,.04);
  /* Radius */
  --r-sm: 8px;
  --r-md: 12px;
  --r-lg: 16px;
  --r-xl: 20px;
  /* Shadow */
  --shadow-sm: 0 1px 3px rgba(0,0,0,.06);
  --shadow-md: 0 4px 12px rgba(0,0,0,.08);
  --shadow-lg: 0 8px 24px rgba(0,0,0,.12);
  --shadow-glow: 0 0 40px rgba(37,99,235,.06);
  /* Transitions */
  --ease: cubic-bezier(.4,0,.2,1);
}
/* ═══════════════════════════════════════════════════════
   RESET
   ═══════════════════════════════════════════════════════ */
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Inter',system-ui,-apple-system,sans-serif;font-size:16px;background:var(--bg);color:var(--t1);line-height:1.6;min-height:100vh;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
::-webkit-scrollbar{width:8px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:#c1c5cd;border-radius:4px}
::-webkit-scrollbar-thumb:hover{background:#9ca3af}
::selection{background:rgba(37,99,235,.2);color:var(--t1)}
/* ═══════════════════════════════════════════════════════
   HEADER
   ═══════════════════════════════════════════════════════ */
.hdr{
  position:sticky;top:0;z-index:100;
  background:rgba(255,255,255,.88);
  backdrop-filter:blur(20px) saturate(1.2);
  -webkit-backdrop-filter:blur(20px) saturate(1.2);
  border-bottom:1px solid var(--b1);
  padding:0 32px;
}
.hi{
  max-width:1280px;margin:0 auto;
  display:flex;align-items:center;justify-content:space-between;
  height:56px;gap:16px;
}
.hdr-left{display:flex;align-items:center;gap:12px;cursor:pointer;-webkit-user-select:none;user-select:none}
.hdr-logo{
  width:32px;height:32px;border-radius:8px;
  background:linear-gradient(135deg,var(--accent),#2563eb);
  display:flex;align-items:center;justify-content:center;
  font-weight:800;font-size:14px;color:#fff;
  box-shadow:0 0 20px rgba(37,99,235,.25);
  flex-shrink:0;
}
.hdr h1{font-size:20px;font-weight:700;letter-spacing:-.3px;color:var(--t1)}
.hdr .sub{font-size:13px;color:var(--t3);font-weight:400;letter-spacing:.2px}
.hdr-right{display:flex;align-items:center;gap:6px}
.hdr-btn{
  padding:8px 18px;border-radius:var(--r-sm);
  font-size:14px;font-weight:500;cursor:pointer;
  transition:all .15s ease;border:1px solid var(--b2);
  background:var(--glass2);color:var(--t2);
  font-family:inherit;
}
.hdr-btn:hover{background:var(--b2);color:var(--t1);border-color:var(--b3)}
.hdr-btn.primary{
  background:linear-gradient(135deg,var(--accent),#2563eb);
  border-color:transparent;color:#fff;font-weight:600;
}
.hdr-btn.primary:hover{filter:brightness(1.1);box-shadow:0 0 20px rgba(37,99,235,.3)}

/* ═══════════════════════════════════════════════════════
   BREADCRUMB
   ═══════════════════════════════════════════════════════ */
.breadcrumb{
  max-width:1280px;margin:0 auto;padding:12px 32px 0;
  display:flex;align-items:center;gap:6px;flex-wrap:wrap;
  font-size:14px;color:var(--t4);
}
.breadcrumb span{cursor:pointer;transition:color .15s;padding:2px 0}
.breadcrumb span:hover{color:var(--accent)}
.breadcrumb .sep{opacity:.3;cursor:default;font-size:10px}
.breadcrumb .sep:hover{color:var(--t4)}
.breadcrumb .current{color:var(--t2);cursor:default;font-weight:500}
.breadcrumb .current:hover{color:var(--t2)}

/* ═══════════════════════════════════════════════════════
   LAYOUT
   ═══════════════════════════════════════════════════════ */
.mc{max-width:1280px;margin:0 auto;padding:24px 32px 100px}

/* Screen transitions */
.screen{animation:screenIn .2s ease-out}
@keyframes screenIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

/* ═══════════════════════════════════════════════════════
   SECTION HEADERS
   ═══════════════════════════════════════════════════════ */
.sh{margin-bottom:24px}
.sh h2{font-size:30px;font-weight:700;letter-spacing:-.5px;margin-bottom:6px}
.sh p{font-size:16px;color:var(--t3);max-width:600px;font-weight:400}

/* ═══════════════════════════════════════════════════════
   SIDEBAR
   ═══════════════════════════════════════════════════════ */
#sidebar{
  position:fixed;top:0;left:0;bottom:0;
  width:220px;background:var(--s1);
  border-right:1px solid var(--b1);
  z-index:150;display:flex;flex-direction:column;
  transition:width .2s ease;overflow:hidden;
}
#sidebar.collapsed{width:56px}
#sidebar .sb-header{
  padding:14px 16px;display:flex;align-items:center;gap:10px;
  border-bottom:1px solid var(--b1);min-height:57px;
}
#sidebar .sb-logo{
  width:32px;height:32px;border-radius:8px;flex-shrink:0;
  background:linear-gradient(135deg,var(--accent),#2563eb);
  display:flex;align-items:center;justify-content:center;
  font-weight:800;font-size:14px;color:#fff;
}
#sidebar .sb-title{white-space:nowrap;overflow:hidden;transition:opacity .2s}
#sidebar.collapsed .sb-title{opacity:0;width:0}
#sidebar .sb-title h2{font-size:15px;font-weight:700;line-height:1.3}
#sidebar .sb-title .sub{font-size:12px;color:var(--t3)}
#sidebar .sb-nav{flex:1;padding:8px 0;overflow-y:auto}
#sidebar .sb-item{
  display:flex;align-items:center;gap:12px;
  padding:10px 16px;cursor:pointer;
  color:var(--t3);font-size:15px;font-weight:500;
  transition:all .15s;white-space:nowrap;
  border-left:3px solid transparent;margin:1px 0;
}
#sidebar .sb-item:hover{color:var(--t1);background:var(--glass2)}
#sidebar .sb-item.active{
  color:var(--accent);background:var(--accent-glow2);
  border-left-color:var(--accent);
}
#sidebar .sb-item .sb-icon{width:20px;text-align:center;flex-shrink:0;font-size:15px}
#sidebar .sb-item .sb-label{overflow:hidden;transition:opacity .2s}
#sidebar.collapsed .sb-item .sb-label{opacity:0;width:0}
#sidebar .sb-divider{
  height:1px;padding:0!important;margin:8px 16px!important;
  background:var(--b1);border:none;cursor:default!important;
}
#sidebar .sb-divider:hover{background:var(--b1)!important;color:var(--t3)!important}
#sidebar .sb-footer{padding:8px;border-top:1px solid var(--b1)}
#sidebar .sb-toggle{
  display:flex;align-items:center;justify-content:center;
  width:100%;padding:8px;border:none;
  background:transparent;color:var(--t4);
  cursor:pointer;font-size:16px;border-radius:var(--r-sm);
  transition:all .15s;font-family:inherit;
}
#sidebar .sb-toggle:hover{background:var(--glass2);color:var(--t2)}
/* Sidebar layout offset */
.hdr,.breadcrumb,.mc{margin-left:220px;transition:margin-left .2s ease}
body.sb-collapsed .hdr,body.sb-collapsed .breadcrumb,body.sb-collapsed .mc{margin-left:56px}
.hamburger{
  display:none;background:none;border:none;color:var(--t2);
  font-size:20px;cursor:pointer;padding:4px 8px;margin-right:4px;
  border-radius:var(--r-sm);transition:all .15s;font-family:inherit;
}
.hamburger:hover{background:var(--glass2);color:var(--t1)}
.sb-overlay{
  display:none;position:fixed;inset:0;background:rgba(0,0,0,.3);
  z-index:140;
}
/* ═══════════════════════════════════════════════════════
   CARDS
   ═══════════════════════════════════════════════════════ */
.cd{
  background:var(--s2);
  border:1px solid var(--b1);
  border-radius:var(--r-lg);
  padding:22px;margin-bottom:14px;
  transition:border-color .15s;
}
.cd:hover{border-color:var(--b2)}
.ct{
  font-size:14px;font-weight:600;letter-spacing:.5px;text-transform:uppercase;
  color:var(--t3);margin-bottom:16px;
  display:flex;align-items:center;gap:8px;
}
.ct .ic{
  width:28px;height:28px;border-radius:var(--r-sm);
  display:flex;align-items:center;justify-content:center;
  font-size:14px;flex-shrink:0;
}
.io{background:var(--accent-glow);color:var(--accent)}
.ig{background:var(--proj-soft);color:var(--proj)}
.ib{background:var(--lead-soft);color:var(--lead)}
.ir{background:var(--comp-soft);color:var(--comp)}
.ior{background:var(--est-soft);color:var(--est)}

/* ═══════════════════════════════════════════════════════
   FORM INPUTS
   ═══════════════════════════════════════════════════════ */
.fg{margin-bottom:14px}
.fg label{
  display:block;font-size:13px;font-weight:600;
  text-transform:uppercase;letter-spacing:.8px;
  color:var(--t3);margin-bottom:6px;
}
.fg input,.fg select,.fg textarea{
  width:100%;
  background:var(--s1);
  border:1px solid var(--b1);
  border-radius:var(--r-sm);
  color:var(--t1);
  font-family:'Inter',system-ui,sans-serif;
  font-size:16px;font-weight:400;
  padding:12px 14px;
  transition:all .15s ease;
  resize:vertical;
}
.fg input::placeholder,.fg textarea::placeholder{color:var(--t4)}
.fg input:focus,.fg select:focus,.fg textarea:focus{
  outline:none;border-color:var(--accent);
  box-shadow:0 0 0 3px var(--accent-glow),var(--shadow-sm);
  background:var(--s2);
}
.fg select{cursor:pointer}
.fg textarea{min-height:72px;line-height:1.5}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
.g4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}

/* ═══════════════════════════════════════════════════════
   SEARCH
   ═══════════════════════════════════════════════════════ */
.search-bar{margin-bottom:0}
.search-bar input{
  width:100%;
  background:var(--s2);
  border:1px solid var(--b1);
  border-radius:var(--r-md);
  padding:14px 14px 14px 42px;
  color:var(--t1);font-size:16px;
  font-family:'Inter',system-ui,sans-serif;
  transition:all .15s;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%239ca3af' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85zm-5.242.156a5 5 0 1 1 0-10 5 5 0 0 1 0 10z'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:14px center;
}
.search-bar input:focus{
  outline:none;border-color:var(--accent);
  box-shadow:0 0 0 3px var(--accent-glow);background-color:var(--s3);
}

/* ═══════════════════════════════════════════════════════
   LIST ITEMS
   ═══════════════════════════════════════════════════════ */
.list-item{
  display:flex;align-items:center;justify-content:space-between;
  padding:16px 20px;
  background:var(--s2);border:1px solid var(--b1);
  border-radius:var(--r-md);margin-bottom:6px;
  cursor:pointer;transition:all .15s ease;
}
.list-item:hover{
  background:var(--s3);border-color:var(--b2);
  transform:translateX(2px);
}
.li-left{display:flex;align-items:center;gap:14px;min-width:0}
.li-avatar{
  width:38px;height:38px;border-radius:10px;
  display:flex;align-items:center;justify-content:center;
  font-size:13px;font-weight:700;flex-shrink:0;letter-spacing:-.5px;
}
.li-avatar.lead{background:var(--lead-soft);color:var(--lead)}
.li-avatar.est{background:var(--est-soft);color:var(--est)}
.li-avatar.proj{background:var(--proj-soft);color:var(--proj)}
.li-avatar.comp{background:var(--comp-soft);color:var(--comp)}
.li-name{font-weight:600;font-size:16px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.li-meta{font-size:14px;color:var(--t3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:2px}
.li-right{text-align:right;flex-shrink:0;margin-left:16px}
.li-amount{font-family:'JetBrains Mono',monospace;font-weight:600;font-size:16px;color:var(--accent)}
.li-badge{
  display:inline-block;font-size:12px;font-weight:600;
  text-transform:uppercase;letter-spacing:.5px;
  padding:2px 8px;border-radius:6px;margin-top:4px;
}
.li-badge.lead{background:var(--lead-soft);color:var(--lead)}
.li-badge.est{background:var(--est-soft);color:var(--est)}
.li-badge.proj{background:var(--proj-soft);color:var(--proj)}
.li-badge.comp{background:var(--comp-soft);color:var(--comp)}

/* ═══════════════════════════════════════════════════════
   STATUS PILLS
   ═══════════════════════════════════════════════════════ */
.status-bar{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.status-pill{
  font-size:14px;font-weight:500;
  padding:8px 20px;border-radius:100px;
  cursor:pointer;transition:all .15s;
  border:1px solid var(--b2);
  background:transparent;color:var(--t3);
  font-family:inherit;
}
.status-pill:hover{background:var(--glass2);color:var(--t2)}
.status-pill.active{font-weight:600}
.status-pill.active.lead{background:var(--lead-soft);color:var(--lead);border-color:rgba(37,99,235,.25)}
.status-pill.active.est{background:var(--est-soft);color:var(--est);border-color:rgba(234,88,12,.25)}
.status-pill.active.proj{background:var(--proj-soft);color:var(--proj);border-color:rgba(22,163,74,.25)}
.status-pill.active.comp{background:var(--comp-soft);color:var(--comp);border-color:rgba(220,38,38,.25)}

.active-toggle{display:flex;align-items:center;gap:8px;font-size:14px;color:var(--t3);font-weight:500}
.toggle{position:relative;width:36px;height:20px;flex-shrink:0}
.toggle input{opacity:0;width:0;height:0}
.toggle .slider{
  position:absolute;inset:0;
  background:#d1d5db;
  border-radius:20px;cursor:pointer;
  transition:all .2s ease;
}
.toggle .slider::before{
  content:'';position:absolute;
  width:16px;height:16px;left:2px;top:2px;
  background:#fff;border-radius:50%;
  transition:all .2s ease;
}
.toggle input:checked+.slider{background:var(--accent)}
.toggle input:checked+.slider::before{transform:translateX(16px);background:#fff}

/* ═══════════════════════════════════════════════════════
   BUTTONS
   ═══════════════════════════════════════════════════════ */
.btn{
  padding:10px 22px;border-radius:var(--r-sm);
  font-size:15px;font-weight:500;cursor:pointer;
  transition:all .15s ease;border:1px solid;
  font-family:inherit;white-space:nowrap;
}
.btn-primary{
  background:linear-gradient(135deg,var(--accent),#2563eb);
  border-color:transparent;color:#fff;font-weight:600;
}
.btn-primary:hover{filter:brightness(1.1);box-shadow:0 0 20px rgba(37,99,235,.3)}
.btn-success{background:var(--proj-soft);border-color:rgba(16,185,129,.25);color:var(--proj)}
.btn-success:hover{background:rgba(16,185,129,.2);border-color:rgba(16,185,129,.4)}
.btn-danger{background:var(--comp-soft);border-color:rgba(239,68,68,.2);color:var(--comp)}
.btn-danger:hover{background:rgba(239,68,68,.15);border-color:rgba(239,68,68,.3)}
.btn-ghost{background:transparent;border-color:var(--b2);color:var(--t3)}
.btn-ghost:hover{background:var(--glass2);color:var(--t2);border-color:var(--b3)}
.btn-row{display:flex;gap:8px;flex-wrap:wrap}

/* ═══════════════════════════════════════════════════════
   MODALS
   ═══════════════════════════════════════════════════════ */
.modal-overlay{
  display:none;position:fixed;inset:0;
  background:rgba(0,0,0,.4);
  backdrop-filter:blur(6px);
  -webkit-backdrop-filter:blur(6px);
  z-index:200;align-items:center;justify-content:center;
}
.modal-overlay.active{display:flex}
.modal{
  background:var(--s2);border:1px solid var(--b2);
  border-radius:var(--r-xl);padding:28px;
  max-width:440px;width:90%;
  box-shadow:var(--shadow-lg);
}
.modal h3{font-size:20px;font-weight:700;margin-bottom:14px}
.modal.wide{max-width:700px}
.modal.xwide{max-width:900px;max-height:85vh;overflow-y:auto}

/* ═══════════════════════════════════════════════════════
   TOAST
   ═══════════════════════════════════════════════════════ */
.toast{
  position:fixed;bottom:24px;right:24px;
  background:var(--s3);border:1px solid var(--b2);
  border-radius:var(--r-md);padding:12px 18px;
  box-shadow:var(--shadow-lg);z-index:1000;
  transform:translateY(120%);opacity:0;
  transition:all .3s cubic-bezier(.4,0,.2,1);
  max-width:320px;
}
.toast.show{transform:translateY(0);opacity:1}
.toast .tt{font-size:14px;font-weight:600;color:var(--accent)}
.toast .tm{font-size:14px;color:var(--t3);margin-top:2px}

/* ═══════════════════════════════════════════════════════
   EMPTY STATE
   ═══════════════════════════════════════════════════════ */
.empty{text-align:center;padding:48px 24px;color:var(--t4)}
.empty .empty-icon{font-size:40px;margin-bottom:12px;opacity:.3}
.empty .empty-text{font-size:16px;color:var(--t3)}

/* ═══════════════════════════════════════════════════════
   INLINE EDIT
   ═══════════════════════════════════════════════════════ */
.inline-edit{
  display:flex;align-items:center;gap:8px;margin-bottom:4px;
}
.inline-edit input{
  background:transparent;border:none;border-bottom:1px dashed var(--b2);
  color:var(--t1);font-size:28px;font-weight:700;letter-spacing:-.5px;
  padding:2px 4px;font-family:'Inter',system-ui,sans-serif;
  transition:border-color .15s;
  width:100%;max-width:400px;
}
.inline-edit input:focus{outline:none;border-bottom-color:var(--accent)}
.inline-edit input::placeholder{color:var(--t4)}

/* ═══════════════════════════════════════════════════════
   TAB BAR
   ═══════════════════════════════════════════════════════ */
.tab-bar{display:flex;gap:2px;margin-bottom:18px;border-bottom:1px solid var(--b1);padding-bottom:0}
.tab-btn{
  padding:10px 22px;font-size:14px;font-weight:500;
  border:none;background:transparent;color:var(--t3);
  cursor:pointer;font-family:inherit;
  border-bottom:2px solid transparent;
  transition:all .15s;margin-bottom:-1px;
}
.tab-btn:hover{color:var(--t2)}
.tab-btn.ac{color:var(--accent);border-bottom-color:var(--accent);font-weight:600}

/* ═══════════════════════════════════════════════════════
   SIGNATURE PAD
   ═══════════════════════════════════════════════════════ */
.sig-wrap{
  background:var(--s1);border:1px solid var(--b2);border-radius:var(--r-md);
  padding:4px;margin-bottom:12px;
}
.sig-wrap canvas{width:100%;border-radius:var(--r-sm);cursor:crosshair;touch-action:none}
.sig-label{font-size:13px;color:var(--t4);text-align:center;padding:4px;letter-spacing:.5px}

/* ═══════════════════════════════════════════════════════
   SETTINGS TABS
   ═══════════════════════════════════════════════════════ */
.settings-tabs{
  display:flex;gap:2px;border-bottom:2px solid var(--b1);
  overflow-x:auto;margin-bottom:24px;padding-bottom:0;
  -webkit-overflow-scrolling:touch;
}
.settings-tab{
  padding:10px 16px;cursor:pointer;white-space:nowrap;
  font-size:13px;font-weight:500;color:var(--t3);
  border-bottom:2px solid transparent;margin-bottom:-2px;
  transition:all .15s;background:none;border-top:none;border-left:none;border-right:none;
  font-family:inherit;display:flex;align-items:center;gap:6px;
}
.settings-tab:hover{color:var(--t2)}
.settings-tab.active{border-bottom-color:var(--accent);color:var(--accent);font-weight:600}
/* ═══════════════════════════════════════════════════════
   HOME — FOLDER CARDS
   ═══════════════════════════════════════════════════════ */
.folder-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:32px}
.folder{
  position:relative;overflow:hidden;
  background:var(--s2);
  border:1px solid var(--b1);
  border-radius:var(--r-lg);
  padding:24px 22px;
  cursor:pointer;
  transition:all .2s ease;
}
.folder:hover{
  transform:translateY(-2px);
  box-shadow:var(--shadow-lg);
  border-color:var(--b2);
}
.folder::before{
  content:'';position:absolute;top:0;left:0;right:0;height:2px;
  opacity:.8;transition:opacity .2s;
}
.folder:hover::before{opacity:1}
.folder .f-glow{
  position:absolute;top:-40px;right:-40px;width:120px;height:120px;
  border-radius:50%;filter:blur(50px);opacity:.15;pointer-events:none;
  transition:opacity .3s;
}
.folder:hover .f-glow{opacity:.25}
.folder .f-icon{
  width:40px;height:40px;border-radius:var(--r-md);
  display:flex;align-items:center;justify-content:center;
  font-size:18px;margin-bottom:14px;
  backdrop-filter:blur(8px);
}
.folder .f-count{
  font-family:'JetBrains Mono',monospace;
  font-size:32px;font-weight:700;letter-spacing:-1px;
  margin-bottom:2px;
}
.folder .f-label{font-size:15px;font-weight:600;margin-bottom:2px}
.folder .f-sub{font-size:13px;color:var(--t4);font-weight:400}

.folder.lead::before{background:linear-gradient(90deg,var(--lead),transparent)}
.folder.lead .f-glow{background:var(--lead)}
.folder.lead .f-icon{background:var(--lead-soft);color:var(--lead)}
.folder.lead .f-count{color:var(--lead)}
.folder.lead .f-label{color:var(--lead)}
.folder.lead:hover{border-color:rgba(37,99,235,.25)}

.folder.est::before{background:linear-gradient(90deg,var(--est),transparent)}
.folder.est .f-glow{background:var(--est)}
.folder.est .f-icon{background:var(--est-soft);color:var(--est)}
.folder.est .f-count{color:var(--est)}
.folder.est .f-label{color:var(--est)}
.folder.est:hover{border-color:rgba(249,115,22,.25)}

.folder.proj::before{background:linear-gradient(90deg,var(--proj),transparent)}
.folder.proj .f-glow{background:var(--proj)}
.folder.proj .f-icon{background:var(--proj-soft);color:var(--proj)}
.folder.proj .f-count{color:var(--proj)}
.folder.proj .f-label{color:var(--proj)}
.folder.proj:hover{border-color:rgba(16,185,129,.25)}

.folder.comp::before{background:linear-gradient(90deg,var(--comp),transparent)}
.folder.comp .f-glow{background:var(--comp)}
.folder.comp .f-icon{background:var(--comp-soft);color:var(--comp)}
.folder.comp .f-count{color:var(--comp)}
.folder.comp .f-label{color:var(--comp)}
.folder.comp:hover{border-color:rgba(239,68,68,.25)}

.folder.inactive{opacity:.35;border-style:dashed}
.folder.inactive:hover{opacity:.6}
.inactive-label{
  font-size:12px;font-weight:500;text-transform:uppercase;
  letter-spacing:1.5px;color:var(--t4);margin-bottom:8px;padding-left:2px;
}

/* ═══════════════════════════════════════════════════════
   HOME — WORKFLOW CARDS
   ═══════════════════════════════════════════════════════ */
.home-greeting{margin-bottom:4px}
.wf-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:24px}
.wf-card{
  background:var(--s2);border:1px solid var(--b1);
  border-radius:var(--r-lg);padding:20px;
  cursor:pointer;transition:all .2s;
  position:relative;overflow:hidden;
}
.wf-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
.wf-card:hover{transform:translateY(-2px);box-shadow:var(--shadow-lg);border-color:var(--b2)}
.wf-card .wf-num{
  font-family:'JetBrains Mono',monospace;
  font-size:36px;font-weight:700;letter-spacing:-1px;margin-bottom:2px;
}
.wf-card .wf-label{font-size:16px;font-weight:600;margin-bottom:10px}
.wf-card .wf-links{display:flex;flex-direction:column;gap:4px}
.wf-card .wf-link{
  font-size:14px;color:var(--t3);cursor:pointer;
  transition:color .15s;display:flex;justify-content:space-between;
}
.wf-card .wf-link:hover{color:var(--t1)}
.wf-card .wf-link .wf-val{font-family:'JetBrains Mono',monospace;font-weight:500}
.wf-card.lead::before{background:var(--lead)}
.wf-card.lead .wf-num,.wf-card.lead .wf-label{color:var(--lead)}
.wf-card.est::before{background:var(--est)}
.wf-card.est .wf-num,.wf-card.est .wf-label{color:var(--est)}
.wf-card.proj::before{background:var(--proj)}
.wf-card.proj .wf-num,.wf-card.proj .wf-label{color:var(--proj)}
.wf-card.comp::before{background:var(--comp)}
.wf-card.comp .wf-num,.wf-card.comp .wf-label{color:var(--comp)}
.perf-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.home-bottom{display:grid;grid-template-columns:1fr 1fr;gap:16px}

/* ═══════════════════════════════════════════════════════
   SYSTEM CARDS
   ═══════════════════════════════════════════════════════ */
.sys-card{
  background:var(--s2);border:1px solid var(--b1);
  border-radius:var(--r-md);padding:16px 20px;
  margin-bottom:8px;cursor:pointer;transition:all .15s;
  display:flex;justify-content:space-between;align-items:center;
  border-left:3px solid var(--b1);
}
.sys-card:hover{background:var(--s3);border-color:var(--b2);transform:translateX(2px)}
.sys-card.has-product{border-left-color:var(--accent)}
.sys-area{font-size:16px;font-weight:600}
.sys-detail{font-size:14px;color:var(--t3);margin-top:2px}
.sys-right{text-align:right;flex-shrink:0;margin-left:20px}
.sys-price{font-family:'JetBrains Mono',monospace;font-size:18px;font-weight:700;color:var(--accent)}
.sys-cost{font-size:13px;color:var(--t4);margin-top:2px}

/* ═══════════════════════════════════════════════════════
   ESTIMATE TOTAL BAR
   ═══════════════════════════════════════════════════════ */
.est-total{
  background:linear-gradient(135deg,var(--s2),var(--s3));
  border:1px solid var(--b2);
  border-radius:var(--r-lg);
  padding:22px 26px;margin-bottom:18px;
  display:flex;justify-content:space-between;align-items:center;
  flex-wrap:wrap;gap:16px;
  position:relative;overflow:hidden;
}
.est-total::before{
  content:'';position:absolute;top:0;left:0;right:0;height:2px;
  background:linear-gradient(90deg,var(--accent),transparent);
}
.est-total-left{font-size:14px;font-weight:500;color:var(--t3);text-transform:uppercase;letter-spacing:.8px}
.est-total-amount{
  font-family:'JetBrains Mono',monospace;
  font-size:32px;font-weight:700;color:var(--accent);
  letter-spacing:-1px;
}
.est-total-detail{font-size:14px;color:var(--t4);margin-top:4px}

/* ═══════════════════════════════════════════════════════
   PRODUCT SELECTOR
   ═══════════════════════════════════════════════════════ */
.prod-option{
  display:flex;justify-content:space-between;align-items:center;
  padding:12px 16px;
  background:var(--s1);border:1px solid var(--b1);
  border-radius:var(--r-sm);margin-bottom:4px;
  cursor:pointer;transition:all .15s;
}
.prod-option:hover{background:var(--s3);border-color:var(--b2)}
.prod-option.sel{
  background:var(--accent-glow2);
  border-color:rgba(37,99,235,.25);
  box-shadow:0 0 0 1px rgba(37,99,235,.1);
}
.prod-name{font-weight:500;font-size:15px}
.prod-sku{font-size:13px;color:var(--t4);font-family:'JetBrains Mono',monospace;margin-top:1px}
.prod-prices{text-align:right;font-size:14px}
.prod-prices .cost{color:var(--comp);font-family:'JetBrains Mono',monospace;font-weight:600}
.prod-prices .sell{color:var(--t3);font-family:'JetBrains Mono',monospace;font-size:11px;margin-top:1px}
.series-filter{display:flex;gap:4px;margin-bottom:14px;flex-wrap:wrap}
.sf-btn{
  font-size:13px;font-weight:500;letter-spacing:.3px;
  padding:7px 16px;border:1px solid var(--b1);
  border-radius:100px;background:transparent;color:var(--t3);
  cursor:pointer;transition:all .15s;font-family:inherit;
}
.sf-btn:hover{background:var(--glass2);color:var(--t2);border-color:var(--b2)}
.sf-btn.ac{background:var(--accent-glow);color:var(--accent);border-color:rgba(37,99,235,.3)}

/* ═══════════════════════════════════════════════════════
   STAT CARDS
   ═══════════════════════════════════════════════════════ */
.sg{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-bottom:16px}
.sx{
  background:var(--s2);border:1px solid var(--b1);
  border-radius:var(--r-md);padding:16px;text-align:center;
  transition:border-color .15s;
}
.sx:hover{border-color:var(--b2)}
.sx.hl{border-color:rgba(37,99,235,.2);background:var(--accent-glow2)}
.sx .sl{font-size:12px;font-weight:500;text-transform:uppercase;letter-spacing:.8px;color:var(--t4);margin-bottom:6px}
.sx .sv{font-family:'JetBrains Mono',monospace;font-size:24px;font-weight:700;letter-spacing:-.5px}
.sx.hl .sv{color:var(--accent)}

/* ═══════════════════════════════════════════════════════
   REPAIR / ADDON ROWS
   ═══════════════════════════════════════════════════════ */
.ra-row{
  display:flex;align-items:center;gap:10px;
  padding:10px 14px;
  background:var(--s1);border:1px solid var(--b1);
  border-radius:var(--r-sm);margin-bottom:4px;
  transition:all .15s;
}
.ra-row.on{background:var(--accent-glow2);border-color:rgba(37,99,235,.2)}
.ra-toggle{flex-shrink:0}
.ra-toggle input{width:16px;height:16px;accent-color:var(--accent);cursor:pointer}
.ra-info{flex:1;min-width:0}
.ra-name{font-weight:500;font-size:15px}
.ra-sku{font-size:13px;color:var(--t4);font-family:'JetBrains Mono',monospace}
.ra-fields{display:flex;align-items:center;gap:8px;flex-shrink:0}
.ra-fields input,.ra-fields select{
  width:85px;padding:6px 8px;font-size:14px;
  background:var(--s2);border:1px solid var(--b1);
  border-radius:var(--r-sm);color:var(--t1);
  font-family:'JetBrains Mono',monospace;
  text-align:right;
}
.ra-fields input:focus,.ra-fields select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 2px var(--accent-glow)}
.ra-cost{font-family:'JetBrains Mono',monospace;font-size:14px;color:var(--t3);min-width:70px;text-align:right;flex-shrink:0}
.ra-unit{font-size:13px;color:var(--t4);white-space:nowrap}

/* ═══════════════════════════════════════════════════════
   ORDER LIST TABLE
   ═══════════════════════════════════════════════════════ */
.ol-table{width:100%;border-collapse:collapse;font-size:15px}
.ol-table th{text-align:left;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.8px;color:var(--t4);padding:8px 12px;border-bottom:1px solid var(--b2)}
.ol-table td{padding:10px 12px;border-bottom:1px solid var(--b1);color:var(--t2)}
.ol-table tr:hover td{background:var(--glass2)}
.ol-table .mono{font-family:'JetBrains Mono',monospace;font-weight:600}
.ol-table .accent{color:var(--accent)}
.ol-table .right{text-align:right}
.ol-table .group-hdr td{background:var(--s3);color:var(--t1);font-weight:600;font-size:12px;border-bottom:1px solid var(--b2)}
.ol-total td{font-weight:700;color:var(--t1);border-top:2px solid var(--accent);border-bottom:none}

/* ═══════════════════════════════════════════════════════
   PIPELINE SUMMARY
   ═══════════════════════════════════════════════════════ */
.pipeline-summary{
  display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;
  margin-bottom:28px;
}
.ps-card{
  background:var(--s2);border:1px solid var(--b1);
  border-radius:var(--r-md);padding:18px;
  position:relative;overflow:hidden;
}
.ps-card::before{
  content:'';position:absolute;top:0;left:0;right:0;height:2px;
  opacity:.6;
}
.ps-card.lead::before{background:var(--lead)}
.ps-card.est::before{background:var(--est)}
.ps-card.proj::before{background:var(--proj)}
.ps-card.comp::before{background:var(--comp)}
.ps-label{font-size:12px;font-weight:500;text-transform:uppercase;letter-spacing:.8px;color:var(--t4);margin-bottom:4px}
.ps-value{font-family:'JetBrains Mono',monospace;font-size:22px;font-weight:700;letter-spacing:-.5px;color:var(--accent)}
.ps-sub{font-size:13px;color:var(--t4);margin-top:2px}

/* ═══════════════════════════════════════════════════════
   REPORTING
   ═══════════════════════════════════════════════════════ */
.rpt-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:24px}
.rpt-card{
  background:var(--s2);border:1px solid var(--b1);border-radius:var(--r-lg);
  padding:22px;position:relative;overflow:hidden;
}
.rpt-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--accent),transparent);opacity:.5}
.rpt-card .rl{font-size:12px;font-weight:500;text-transform:uppercase;letter-spacing:.8px;color:var(--t4);margin-bottom:8px}
.rpt-card .rv{font-family:'JetBrains Mono',monospace;font-size:28px;font-weight:700;color:var(--accent);letter-spacing:-1px}
.rpt-card .rs{font-size:14px;color:var(--t3);margin-top:4px}
.bar-chart{margin-top:12px}
.bar-row{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.bar-label{font-size:14px;color:var(--t2);width:140px;flex-shrink:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.bar-track{flex:1;height:22px;background:var(--s1);border-radius:4px;overflow:hidden;position:relative}
.bar-fill{height:100%;border-radius:4px;background:linear-gradient(90deg,var(--accent),#2563eb);transition:width .5s ease;min-width:2px}
.bar-val{font-family:'JetBrains Mono',monospace;font-size:13px;color:var(--t3);width:50px;text-align:right;flex-shrink:0}
/* ═══════════════════════════════════════════════════════
   CALENDAR & DISPATCH
   ═══════════════════════════════════════════════════════ */
.cal-grid{
  display:grid;grid-template-columns:repeat(7,1fr);
  gap:1px;background:var(--b1);
  border:1px solid var(--b1);border-radius:var(--r-md);overflow:hidden;
}
.cal-hdr{
  background:var(--s3);padding:8px 4px;text-align:center;
  font-size:11px;font-weight:600;color:var(--t3);text-transform:uppercase;letter-spacing:.5px;
}
.cal-cell{
  background:var(--s2);padding:6px;min-height:70px;cursor:pointer;
  transition:background .15s;position:relative;
}
.cal-cell:hover{background:var(--s3)}
.cal-cell.today{background:var(--accent-glow2)}
.cal-cell.selected{background:var(--accent-glow);box-shadow:inset 0 0 0 2px var(--accent)}
.cal-cell.other-month{opacity:.3}
.cal-day{font-size:12px;font-weight:600;color:var(--t2);margin-bottom:4px}
.cal-cell.today .cal-day{color:var(--accent);font-weight:700}
.cal-dots{display:flex;gap:3px;flex-wrap:wrap}
.cal-dot{width:6px;height:6px;border-radius:50%}
.cal-dot.project{background:var(--proj)}
.cal-dot.followup{background:#f59e0b}
.cal-dot.crew{background:var(--accent)}

/* Dispatch week view */
.dispatch-week{
  display:grid;grid-template-columns:60px repeat(7,1fr);
  gap:1px;background:var(--b1);
  border:1px solid var(--b1);border-radius:var(--r-md);overflow:hidden;
}
.dispatch-time{
  background:var(--s3);padding:4px;text-align:center;
  font-size:10px;color:var(--t4);font-family:'JetBrains Mono',monospace;
}
.dispatch-slot{
  background:var(--s2);min-height:40px;padding:2px;
  transition:background .15s;
}
.dispatch-slot:hover{background:var(--s3)}
.dispatch-slot.dragover{background:var(--accent-glow);box-shadow:inset 0 0 0 2px var(--accent)}

.dispatch-item{
  padding:4px 8px;border-radius:6px;font-size:11px;font-weight:500;
  cursor:grab;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}
.dispatch-item:active{cursor:grabbing;opacity:.8}
/* ═══════════════════════════════════════════════════════
   PRINT
   ═══════════════════════════════════════════════════════ */
@media print{
  .hdr,.breadcrumb,.btn-row,.hdr-right,.tab-bar,.search-bar,#newLeadBtn,#sidebar,.sb-overlay,#batchBar,#batchToggleBtn,.hamburger,.hdr-btn,#followUpCard button,#nextActionBar,.toggle,.active-toggle,#quickContactBtns,.toast-container,.settings-tabs{display:none!important}
  body{background:#fff!important;color:#000!important}
  .mc{padding:10px!important;margin-left:0!important}
  .cd{border-color:#ddd!important;page-break-inside:avoid;box-shadow:none!important;background:#fff!important}
  .screen{padding:0!important}
  .list-item{border-color:#ddd!important;background:#fff!important}
  .li-avatar,.li-badge,.status-pill{print-color-adjust:exact;-webkit-print-color-adjust:exact}
  .sys-card{page-break-inside:avoid}
  .est-total{background:#f5f5f5!important;print-color-adjust:exact;-webkit-print-color-adjust:exact}
  a{color:#000!important;text-decoration:none!important}
}
/* ═══════════════════════════════════════════════════════
   RESPONSIVE
   ═══════════════════════════════════════════════════════ */

/* --- Tablet / small desktop (900px) --- */
@media(max-width:900px){
  #sidebar{display:none}
  #sidebar.mobile-open{display:flex;width:220px;z-index:200}
  .sb-overlay.active{display:block}
  .hdr,.breadcrumb,.mc{margin-left:0!important}
  .hamburger{display:block}
  .wf-grid{grid-template-columns:1fr 1fr}
  .home-bottom{grid-template-columns:1fr}
  .perf-grid{grid-template-columns:repeat(3,1fr)}
  .settings-tabs{gap:0}
  .settings-tab{padding:8px 10px;font-size:12px}

  /* Dispatch board: horizontal scroll for week view */
  .dispatch-week{
    display:grid;
    grid-auto-flow:column;
    grid-auto-columns:minmax(140px,1fr);
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
    gap:6px;
    padding-bottom:6px;
  }
  .dispatch-item{padding:8px 10px}
  .dispatch-view-toggle .btn,
  .dispatch-view-toggle button{
    padding:6px 10px;
    font-size:12px;
  }
}

/* --- Narrow tablet / large phone (800px) --- */
@media(max-width:800px){
  .folder-grid{grid-template-columns:1fr 1fr}
  .g2,.g3,.g4{grid-template-columns:1fr}
  .mc{padding:20px 16px 80px}
  .hdr{padding:0 16px}
  .breadcrumb{padding:10px 16px 0}

  /* Button rows wrap cleanly */
  .btn-row{
    flex-wrap:wrap;
    gap:8px;
  }
  /* Section headings smaller */
  .sh h2{font-size:1.1rem}

  /* Record / detail cards: full width, tighter padding */
  .cd{width:100%;padding:16px}
  .record-card{width:100%;padding:14px}

  /* Modals wider on mobile */
  .modal{width:95%;max-width:95%;margin:20px auto}
}

/* --- Mobile bottom nav bar (600px) --- */
.mobile-bottom-nav{
  display:none;
}
@media(max-width:600px){
  .mobile-bottom-nav{
    display:flex;
    position:fixed;
    bottom:0;
    left:0;
    right:0;
    background:var(--s2);
    border-top:1px solid var(--b1);
    z-index:150;
    padding:6px 0;
    justify-content:space-around;
    align-items:center;
  }
  .mobile-bottom-nav button{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:2px;
    background:none;
    border:none;
    color:var(--t3);
    font-size:9px;
    font-weight:500;
    padding:4px 8px;
    cursor:pointer;
    font-family:inherit;
  }
  .mobile-bottom-nav button .nav-icon{
    font-size:18px;
  }
  .mobile-bottom-nav button.active{
    color:var(--accent);
  }
  .mc{
    padding-bottom:80px!important;
  }
}

/* --- Small phone (500px) --- */
@media(max-width:500px){
  .wf-grid{grid-template-columns:1fr}
  .folder-grid{grid-template-columns:1fr}
  .perf-grid{grid-template-columns:1fr}
  .est-total{flex-direction:column;text-align:center}
  .hi{height:auto;padding:12px 0}
  .settings-tabs{flex-wrap:nowrap;overflow-x:auto;-webkit-overflow-scrolling:touch}
  .settings-tab{padding:6px 8px;font-size:11px;white-space:nowrap}

  /* Buttons: smaller tap targets */
  .btn{padding:8px 14px}

  /* List items: tighter */
  .list-item{padding:10px 12px}

  /* Cards: reduced padding */
  .cd{padding:14px}

  /* Toast: bottom center on mobile */
  .toast-container,
  .toast{
    left:50%!important;
    right:auto!important;
    transform:translateX(-50%);
    bottom:90px!important;
    width:90%;
    max-width:360px;
    text-align:center;
  }

  /* Dispatch week: momentum scroll */
  .dispatch-week{
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
    scroll-snap-type:x mandatory;
  }
  .dispatch-week>*{
    scroll-snap-align:start;
  }

  /* Settings tabs: horizontal scroll, no wrap */
  .settings-tabs{
    display:flex;
    flex-wrap:nowrap;
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
    scrollbar-width:none;
    -ms-overflow-style:none;
  }
  .settings-tabs::-webkit-scrollbar{display:none}
}
</style>
</head>
<body>
<div id="app">
<!-- SIDEBAR -->
<nav id="sidebar">
  <div class="sb-header">
    <div class="sb-logo">CE</div>
    <div class="sb-title">
      <h2>Coatings Estimator</h2>
      <div class="sub">The Concrete Protector</div>
    </div>
  </div>
  <div class="sb-nav">
    <div class="sb-item active" data-screen="home" onclick="goHome()">
      <span class="sb-icon">&#9776;</span><span class="sb-label">Home</span>
    </div>
    <div class="sb-divider"></div>
    <div class="sb-item" data-screen="lead" onclick="goFolder('lead',true)">
      <span class="sb-icon">&#9993;</span><span class="sb-label">Leads</span>
    </div>
    <div class="sb-item" data-screen="estimate" onclick="goFolder('estimate',true)">
      <span class="sb-icon">&#9997;</span><span class="sb-label">Estimates</span>
    </div>
    <div class="sb-item" data-screen="project" onclick="goFolder('project',true)">
      <span class="sb-icon">&#9874;</span><span class="sb-label">Projects</span>
    </div>
    <div class="sb-item" data-screen="completed" onclick="goFolder('completed',true)">
      <span class="sb-icon">&#10003;</span><span class="sb-label">Completed</span>
    </div>
    <div class="sb-divider"></div>
    <div class="sb-item" data-screen="invoices-all" onclick="goAllInvoices()">
      <span class="sb-icon">&#128179;</span><span class="sb-label">Invoices <span id="invBadge"></span></span>
    </div>
    <div class="sb-item" data-screen="calendar" onclick="goCalendar()">
      <span class="sb-icon">&#128197;</span><span class="sb-label">Calendar</span>
    </div>
    <div class="sb-item" data-screen="reporting" onclick="goReporting()">
      <span class="sb-icon">&#128202;</span><span class="sb-label">Reports</span>
    </div>
    <div class="sb-item" data-screen="settings" onclick="goSettings()">
      <span class="sb-icon">&#9881;</span><span class="sb-label">Settings</span>
    </div>
  </div>
  <div class="sb-footer">
    <div class="sb-item" onclick="goProfileSelect()" style="opacity:.7;font-size:12px"><span class="sb-icon">&#128101;</span><span class="sb-label">Switch Profile</span></div>
    <button class="sb-toggle" onclick="toggleSidebar()" title="Collapse sidebar">&#9664;</button>
  </div>
</nav>
<div class="sb-overlay" id="sbOverlay" onclick="closeMobileSidebar()"></div>
<!-- HEADER -->
<div class="hdr"><div class="hi">
  <div class="hdr-left" onclick="goHome()">
    <button class="hamburger" onclick="event.stopPropagation();toggleMobileSidebar()">&#9776;</button>
    <div class="hdr-logo">CE</div>
    <div>
      <h1>Coatings Estimator</h1>
      <div class="sub">The Concrete Protector</div>
    </div>
  </div>
  <div class="hdr-right">
    <div id="offlineDot" style="display:none;align-items:center;gap:4px;padding:4px 10px;background:rgba(248,113,113,.15);border-radius:6px;font-size:11px;color:#f87171;font-weight:600"><span style="width:8px;height:8px;border-radius:50%;background:#f87171"></span>Offline</div>
    <div id="profileBadge"></div>
    <button class="hdr-btn" onclick="goReporting()">Reports</button>
    <button class="hdr-btn primary" onclick="newRecordFromHeader()">+ New Lead</button>
  </div>
</div></div>

<div class="breadcrumb" id="breadcrumb"></div>
<div class="mc">

<!-- HOME -->
<div class="screen" v-show="nav.screen==='home'" id="scr-home">
  <div class="home-greeting" id="homeGreeting"></div>
  <div style="margin-bottom:16px;position:relative"><input type="text" id="globalSearch" placeholder="Search all records..." oninput="globalSearchRender()" style="width:100%;padding-right:32px"><div id="globalSearchResults" style="display:none;position:absolute;top:100%;left:0;right:0;z-index:50;background:var(--s2);border:1px solid var(--b2);border-radius:10px;max-height:300px;overflow-y:auto;margin-top:4px;box-shadow:0 8px 24px rgba(0,0,0,.12)"></div></div>
  <div class="wf-grid" id="workflowCards"></div>
  <div id="overdueAlert"></div>
  <div id="followUpSection"></div>
  <div class="home-bottom">
    <div class="cd">
      <div class="ct"><span class="ic ib">&#9673;</span> Recent Activity</div>
      <div id="recentActivity"></div>
    </div>
    <div>
      <div class="cd">
        <div class="ct"><span class="ic io">&#128200;</span> Business Performance</div>
        <div class="perf-grid" id="perfCards"></div>
      </div>
      <div id="leadSourceChart" style="margin-bottom:24px"></div>
      <div style="margin-top:10px;padding-left:2px">
        <span style="font-size:11px;color:var(--t4);cursor:pointer" onclick="toggleArchived()">&#9660; View archived records</span>
        <div id="archivedSection" style="display:none;margin-top:10px">
          <div class="folder-grid" style="grid-template-columns:repeat(4,1fr)" id="inactiveFolders"></div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- LIST -->
<div class="screen" v-show="nav.screen==='list'" id="scr-list">
  <div class="sh" id="listHeader"></div>
  <div id="invoiceFilterBar" style="display:none;margin-bottom:12px">
    <div style="display:flex;gap:6px;flex-wrap:wrap">
      <button class="tab-btn ac" onclick="setInvFilter('all')">All</button>
      <button class="tab-btn" onclick="setInvFilter('invoiced')">Invoiced</button>
      <button class="tab-btn" onclick="setInvFilter('need')">Need Invoiced</button>
    </div>
  </div>
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:10px">
    <div class="search-bar" style="flex:1;min-width:220px"><input type="text" id="searchInput" placeholder="Search by name, company, or address..." oninput="filterList()"></div>
    <select id="tagFilter" onchange="filterList()" style="font-size:12px;padding:8px 10px;border-radius:8px;border:1px solid var(--brd);background:var(--s3);color:var(--t1)"><option value="">All Tags</option></select>
    <button class="btn btn-ghost" onclick="toggleBatchMode()" id="batchToggleBtn" style="font-size:12px">Select</button>
    <button class="btn btn-primary" id="newLeadBtn" onclick="newRecord()">+ New Lead</button>
  </div>
  <div id="listItems"></div>
  <div id="batchBar" style="display:none;position:fixed;bottom:0;left:0;right:0;background:var(--s2);border-top:2px solid var(--accent);padding:12px 20px;z-index:100;box-shadow:0 -4px 16px rgba(0,0,0,.12)">
    <div style="display:flex;align-items:center;justify-content:space-between;max-width:900px;margin:0 auto;flex-wrap:wrap;gap:10px">
      <span id="batchCount" style="font-size:13px;font-weight:600;color:var(--t1)">0 selected</span>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <select id="batchStatusTarget" style="font-size:12px;padding:6px 10px;border-radius:8px;border:1px solid var(--brd);background:var(--s3)"><option value="lead">Lead</option><option value="estimate">Estimate</option><option value="project">Project</option><option value="completed">Completed</option></select>
        <button class="btn btn-primary" onclick="batchMoveStatus()" style="font-size:12px;padding:6px 14px">Move</button>
        <button class="btn btn-ghost" onclick="batchArchive()" style="font-size:12px;padding:6px 14px">Archive</button>
        <button class="btn btn-danger" onclick="batchDelete()" style="font-size:12px;padding:6px 14px">Delete</button>
        <button class="btn btn-ghost" onclick="toggleBatchMode()" style="font-size:12px;padding:6px 14px">Cancel</button>
      </div>
    </div>
  </div>
</div>
<!-- RECORD -->
<div class="screen" v-show="nav.screen==='record'" id="scr-record">
  <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px;flex-wrap:wrap;gap:12px">
    <div class="sh" style="margin-bottom:0;flex:1" id="recordHeader"></div>
    <div class="btn-row">
      <button class="btn btn-success" onclick="saveRecord()">Save</button>
      <button class="btn btn-danger" onclick="confirmDeleteRecord()">Delete</button>
    </div>
  </div>
  <div id="duplicateWarning"></div>
  <div class="cd">
    <div class="ct"><span class="ic io">&#9881;</span> Status</div>
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
      <div class="status-bar" id="statusPills"></div>
      <div class="active-toggle"><span>Active</span><label class="toggle"><input type="checkbox" id="recActive" onchange="toggleActive()"><span class="slider"></span></label></div>
    </div>
    <div id="nextActionBar" style="margin-top:12px"></div>
  </div>
  <div class="cd" id="followUpCard">
    <div class="ct"><span class="ic io">&#128276;</span> Follow-Up Reminder</div>
    <div class="g2">
      <div class="fg"><label>Follow-Up Date</label><input type="date" id="recFollowUpDate" onchange="saveFollowUp()"></div>
      <div class="fg"><label>Note</label><input type="text" id="recFollowUpNote" placeholder="Call about garage quote..." onchange="saveFollowUp()"></div>
    </div>
    <div id="followUpStatus" style="margin-top:8px"></div>
  </div>
  <div class="cd" id="projectDetailsCard" style="display:none">
    <div class="ct"><span class="ic ig">&#9874;</span> Project Details</div>
    <div class="g2">
      <div class="fg"><label>Start Date</label><input type="date" id="recStartDate" onchange="saveProjectDates()"></div>
      <div class="fg"><label>End Date</label><input type="date" id="recEndDate" onchange="saveProjectDates()"></div>
    </div>
    <div class="g3">
      <div class="fg"><label>Start Time</label><input type="time" id="recScheduledTime" onchange="saveProjectDates()"></div>
      <div class="fg"><label>Duration (hrs)</label><input type="number" id="recScheduledDuration" min="0" max="24" step="0.5" placeholder="8" onchange="saveProjectDates()"></div>
      <div class="fg"><label>Assigned Crew</label><select id="recAssignedCrew" onchange="saveProjectDates()"><option value="">-- None --</option></select></div>
    </div>
    <div class="fg"><label>Project Notes</label><textarea id="recProjectNotes" placeholder="Scheduling notes, crew assignments..." onchange="saveProjectDates()"></textarea></div>
  </div>
  <div class="cd">
    <div class="ct"><span class="ic ib">&#9786;</span> Contact</div>
    <div class="g2">
      <div class="fg"><label>First Name</label><input type="text" id="recFirst" placeholder="First name" autocomplete="given-name" oninput="autoSaveRecord()"></div>
      <div class="fg"><label>Last Name</label><input type="text" id="recLast" placeholder="Last name" autocomplete="family-name" oninput="autoSaveRecord()"></div>
    </div>
    <div class="g2">
      <div class="fg"><label>Company</label><input type="text" id="recCompany" placeholder="Company name" autocomplete="organization" oninput="autoSaveRecord()"></div>
      <div class="fg"><label>Email</label><input type="email" id="recEmail" placeholder="email@example.com" autocomplete="email" oninput="autoSaveRecord()"></div>
    </div>
    <div class="g3">
      <div class="fg"><label>Phone</label><input type="tel" id="recPhone" placeholder="(555) 123-4567" autocomplete="tel" oninput="autoSaveRecord()"></div>
      <div class="fg"><label>Type</label><select id="recPhoneType" onchange="autoSaveRecord()"><option value="cell">Cell</option><option value="home">Home</option><option value="office">Office</option></select></div>
      <div class="fg"><label>Best Time to Call</label><input type="text" id="recBestTime" placeholder="e.g. After 5pm" oninput="autoSaveRecord()"></div>
    </div>
    <div id="quickContactBtns" style="display:flex;gap:8px;margin:8px 0 12px"></div>
    <div class="fg"><label>Address</label><input type="text" id="recAddress" placeholder="Street address" autocomplete="street-address" oninput="autoSaveRecord()"></div>
    <div class="g3">
      <div class="fg"><label>City</label><input type="text" id="recCity" placeholder="City" autocomplete="address-level2" oninput="autoSaveRecord()"></div>
      <div class="fg"><label>State</label><input type="text" id="recState" placeholder="ST" maxlength="2" style="text-transform:uppercase" autocomplete="address-level1" oninput="autoSaveRecord()"></div>
      <div class="fg"><label>Zip</label><input type="text" id="recZip" placeholder="Zip" inputmode="numeric" autocomplete="postal-code" oninput="autoSaveRecord()"></div>
    </div>
    <div class="fg"><label>Notes</label><textarea id="recNotes" placeholder="Additional notes..." oninput="autoSaveRecord()"></textarea></div>
    <div style="margin-top:8px"><label style="font-size:12px;font-weight:600;color:var(--t3)">Tags</label><div id="tagBar" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:4px;align-items:center"></div></div>
    <div class="g2" style="margin-top:8px">
      <div class="fg"><label>Lead Source</label><select id="recLeadSource" onchange="autoSaveRecord()"><option value="">-- Select --</option></select></div>
      <div class="fg"></div>
    </div>
  </div>
  <div class="cd">
    <div class="ct" style="justify-content:space-between"><div style="display:flex;align-items:center;gap:8px"><span class="ic ior">&#9998;</span> Estimates</div><div style="display:flex;gap:8px"><button class="btn btn-ghost" id="compareEstBtn" onclick="showEstimateComparison()" style="display:none;font-size:12px">Compare</button><button class="btn btn-primary" onclick="newEstimate()">+ New Estimate</button></div></div>
    <div id="estimatesList"></div>
  </div>
  <div class="cd">
    <div class="ct"><span class="ic io">&#128340;</span> Activity & Notes</div>
    <div style="display:flex;gap:8px;margin-bottom:12px"><input type="text" id="activityNoteInput" placeholder="Add a note..." style="flex:1" onkeydown="if(event.key==='Enter')addActivityNote()"><button class="btn btn-primary" onclick="addActivityNote()">Add</button></div>
    <div id="activityList" style="max-height:400px;overflow-y:auto"></div>
  </div>
</div>
<!-- ESTIMATE -->
<div class="screen" v-show="nav.screen==='estimate'" id="scr-estimate">
  <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px;flex-wrap:wrap;gap:12px">
    <div style="flex:1">
      <div style="display:flex;align-items:center;gap:10px"><div class="inline-edit"><input type="text" id="estNameInput" placeholder="Estimate name..." oninput="updateEstName()"></div><span id="quoteStatusBadge"></span></div>
      <p style="font-size:13px;color:var(--t3)" id="estSubline"></p>
    </div>
    <div class="btn-row" id="estActionBtns">
      <button class="btn btn-primary" onclick="generateProposal()">PDF Proposal</button>
      <button class="btn btn-ghost" onclick="emailProposal()">Email Quote</button>
      <button class="btn btn-ghost" onclick="textProposal()">Text Quote</button>
      <button class="btn btn-success" id="estSaveBtn" onclick="saveEstimate()">Save</button>
      <button class="btn btn-ghost" onclick="duplicateEstimate()">Duplicate</button>
      <button class="btn btn-ghost" onclick="saveAsTemplate()">Save Template</button>
      <button class="btn btn-ghost" onclick="generateApprovalPage()">Send for Approval</button>
      <button class="btn btn-ghost" onclick="generateClientPortal()">Client Portal</button>
      <button class="btn btn-ghost" onclick="window.print()">Print</button>
      <button class="btn btn-danger" onclick="confirmDeleteEstimate()">Delete</button>
    </div>
  </div>
  <div class="est-total" id="estTotalBar"></div>
  <div id="estSavedActions" style="display:none"></div>
  <div class="tab-bar" id="estTabs">
    <button class="tab-btn ac" onclick="switchEstTab('areas')">Areas</button>
    <button class="tab-btn" onclick="switchEstTab('orderlist')">Order List</button>
    <button class="tab-btn" onclick="switchEstTab('contract')">Contract</button>
    <button class="tab-btn" onclick="switchEstTab('invoices')">Invoices</button>
  </div>
  <div id="estTabAreas">
    <div class="cd">
      <div class="ct" style="justify-content:space-between"><div style="display:flex;align-items:center;gap:8px"><span class="ic ig">&#9874;</span> Areas</div><button class="btn btn-primary" onclick="newSystem()">+ Add Area</button></div>
      <div id="systemsList"></div>
    </div>
  </div>
  <div id="estTabOrderlist" style="display:none">
    <div class="cd"><div class="ct"><span class="ic io">&#9776;</span> Materials Order List</div><div id="orderListContent"></div></div>
  </div>
  <div id="estTabContract" style="display:none">
    <div class="cd">
      <div class="ct"><span class="ic ib">&#9998;</span> Contract</div>
      <div class="fg"><label>Terms & Conditions</label><textarea id="contractTerms" rows="6" placeholder="Enter contract terms...">This proposal is valid for 30 days from the date shown. A 50% deposit is required to schedule the project. Balance due upon completion. All work carries a manufacturer warranty on materials used. The Concrete Protector guarantees workmanship for a period of one (1) year from date of installation. Customer is responsible for proper maintenance as outlined in care instructions provided at completion.</textarea></div>
      <div class="g2">
        <div>
          <div class="fg"><label>Contractor Signature</label></div>
          <div class="sig-wrap"><canvas id="sigContractor" width="400" height="150"></canvas><div class="sig-label">Sign above</div></div>
          <button class="btn btn-ghost" onclick="clearSig('sigContractor')" style="margin-bottom:12px">Clear</button>
        </div>
        <div>
          <div class="fg"><label>Customer Signature</label></div>
          <div class="sig-wrap"><canvas id="sigCustomer" width="400" height="150"></canvas><div class="sig-label">Sign above</div></div>
          <button class="btn btn-ghost" onclick="clearSig('sigCustomer')" style="margin-bottom:12px">Clear</button>
        </div>
      </div>
      <div class="btn-row"><button class="btn btn-primary" onclick="generateContract()">Download Contract PDF</button></div>
    </div>
  </div>
  <div id="estTabInvoices" style="display:none">
    <div class="cd">
      <div class="ct" style="justify-content:space-between"><div style="display:flex;align-items:center;gap:8px"><span class="ic io">&#128179;</span> Invoices</div>
        <div class="btn-row"><button class="btn btn-primary" onclick="createInvoice('standard')">Create Invoice</button><button class="btn btn-ghost" onclick="createInvoice('deposit')">Deposit Invoice</button></div>
      </div>
      <div id="invoicesList"></div>
    </div>
  </div>
</div>
<!-- INVOICE -->
<div class="screen" v-show="nav.screen==='invoice'" id="scr-invoice">
  <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px;flex-wrap:wrap;gap:12px">
    <div style="flex:1">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:4px">
        <h2 id="invNumber" style="font-size:20px">INV-001</h2>
        <span id="invStatusBadge" class="li-badge"></span>
      </div>
      <p style="font-size:13px;color:var(--t3)" id="invSubline"></p>
    </div>
    <div class="btn-row" id="invActions"></div>
  </div>
  <div class="cd" id="invFromToCard">
    <div class="ct"><span class="ic io">&#128179;</span> Invoice Details</div>
    <div class="g2" style="margin-bottom:16px">
      <div><div style="font-size:11px;text-transform:uppercase;color:var(--t3);font-weight:600;margin-bottom:6px">From</div><div id="invFrom" style="font-size:13px;color:var(--t2);line-height:1.6"></div></div>
      <div><div style="font-size:11px;text-transform:uppercase;color:var(--t3);font-weight:600;margin-bottom:6px">Bill To</div><div id="invTo" style="font-size:13px;color:var(--t2);line-height:1.6"></div></div>
    </div>
    <div class="g3">
      <div class="fg"><label>Due Date</label><input type="date" id="invDueDate" onchange="updateInvoiceField('dueDate',this.value)"></div>
      <div class="fg"><label>Type</label><div id="invType" style="font-size:14px;padding:8px 0;color:var(--t2)"></div></div>
      <div class="fg"><label>Status</label><div id="invStatus" style="font-size:14px;padding:8px 0"></div></div>
    </div>
  </div>
  <div class="cd">
    <div class="ct" style="justify-content:space-between"><div style="display:flex;align-items:center;gap:8px"><span class="ic ig">&#9776;</span> Line Items</div><button class="btn btn-ghost" onclick="addLineItem()" style="font-size:12px;padding:4px 12px">+ Add Item</button></div>
    <div id="invLineItems"></div>
    <div id="invDiscount" style="padding:8px 0;border-top:1px solid var(--b1)"></div>
    <div class="sg" id="invTotals"></div>
  </div>
  <div class="cd">
    <div class="ct"><span class="ic ib">&#128176;</span> Payments</div>
    <div id="invPayments"></div>
    <div class="sg" id="invBalance"></div>
  </div>
  <div id="stripePayBtn" style="margin-bottom:14px"></div>
  <div class="cd">
    <div class="ct"><span class="ic ior">&#9998;</span> Notes</div>
    <div class="fg"><textarea id="invNotes" rows="3" placeholder="Invoice notes (visible on PDF)..." onchange="updateInvoiceField('notes',this.value)"></textarea></div>
  </div>
</div>
<!-- SYSTEM EDITOR -->
<div class="screen" v-show="nav.screen==='system'" id="scr-system">
  <div style="margin-bottom:8px"><a href="#" onclick="event.preventDefault();saveSystem();goEstimate(nav.estimateId)" style="font-size:12px;color:var(--accent);text-decoration:none">&larr; Back to Estimate</a></div>
  <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px;flex-wrap:wrap;gap:12px">
    <div class="sh" style="margin-bottom:0;flex:1" id="sysHeader"></div>
    <div class="btn-row">
      <button class="btn btn-success" onclick="saveSystem()">Save</button>
      <button class="btn btn-ghost" onclick="duplicateSystem()">Duplicate</button>
      <button class="btn btn-danger" onclick="confirmDeleteSystem()">Remove</button>
    </div>
  </div>
  <div class="cd">
    <div class="ct"><span class="ic io">&#9634;</span> Dimensions</div>
    <div class="g3">
      <div class="fg"><label>Area Name</label><input type="text" id="sysArea" placeholder="e.g. Driveway, Patio, Garage" oninput="calcSystem()"></div>
      <div class="fg"><label>Length (ft)</label><input type="number" id="sysLength" value="0" min="0" step="1" oninput="calcSystem()"></div>
      <div class="fg"><label>Width (ft)</label><input type="number" id="sysWidth" value="0" min="0" step="1" oninput="calcSystem()"></div>
    </div>
    <div class="g3">
      <div class="fg"><label>Square Feet</label><input type="number" id="sysSqft" value="0" min="0" step="1" oninput="calcSystem(true)"></div>
      <div class="fg"><label>Sell Rate ($/sqft)</label><input type="number" id="sysSellRate" value="0" min="0" step="0.01" oninput="calcSystem()"></div>
      <div class="fg"><label>System Price</label>
        <div style="font-family:'JetBrains Mono',monospace;font-size:24px;font-weight:700;color:var(--accent);padding:6px 0;letter-spacing:-1px" id="sysPrice">$0.00</div>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:8px;padding:4px 0"><input type="checkbox" id="sysTaxable" checked onchange="calcSystem()"><label for="sysTaxable" style="font-size:13px;color:var(--t2);cursor:pointer">Taxable (apply sales tax to this area)</label></div>
  </div>
  <div class="sg" id="sysStats"></div>
  <div class="cd">
    <div class="ct"><span class="ic ior">&#9733;</span> Product System</div>
    <div class="series-filter" id="seriesFilter"></div>
    <div style="max-height:400px;overflow-y:auto;padding-right:4px" id="prodList"></div>
  </div>
  <div class="cd">
    <div class="ct"><span class="ic ig">&#9708;</span> Top Coat</div>
    <div id="tcList"></div>
  </div>
  <div class="cd">
    <div class="ct"><span class="ic ir">&#9881;</span> Repairs</div>
    <div id="repairList"></div>
  </div>
  <div class="cd">
    <div class="ct"><span class="ic ib">&#9737;</span> Add-ons</div>
    <div id="addonList"></div>
  </div>
  <div class="cd">
    <div class="ct"><span class="ic ig">&#128203;</span> Custom Line Items</div>
    <div id="lineItemsList"></div>
    <button class="btn btn-primary" onclick="addSysLineItem()" style="margin-top:10px;font-size:12px;padding:6px 16px">+ Add Line Item</button>
  </div>
  <div class="cd">
    <div class="ct"><span class="ic ior">&#9998;</span> Notes</div>
    <div class="fg" style="margin-bottom:0"><textarea id="sysNotes" placeholder="Notes for this area..." oninput="calcSystem()"></textarea></div>
  </div>
</div>
<!-- REPORTING -->
<div class="screen" v-show="nav.screen==='reporting'" id="scr-reporting">
  <div class="sh">
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
      <div><h2>Reports &amp; Analytics</h2><p>Business performance at a glance.</p></div>
      <div class="btn-row">
        <button class="btn btn-ghost" onclick="exportReportCSV()">Export CSV</button>
        <button class="btn btn-ghost" onclick="exportReportPDF()">Export PDF</button>
      </div>
    </div>
  </div>
  <div class="rpt-grid" id="rptCards"></div>
  <div class="cd"><div class="ct"><span class="ic io">&#9733;</span> Top Systems</div><div id="rptTopSystems"></div></div>
  <div class="cd"><div class="ct"><span class="ic ig">&#9650;</span> Pipeline Breakdown</div><div id="rptPipelineBreakdown"></div></div>
  <div class="cd"><div class="ct"><span class="ic ior">&#128176;</span> Accounts Receivable</div><div class="sg" id="rptAR"></div></div>
  <div class="cd"><div class="ct"><span class="ic ib">&#128197;</span> Aging Report</div><div id="rptAging" style="overflow-x:auto"></div></div>
  <div class="cd"><div class="ct"><span class="ic ib">&#9673;</span> Recent Activity</div><div id="rptRecent"></div></div>
</div>
<!-- ALL INVOICES -->
<div class="screen" v-show="nav.screen==='invoices-all'" id="scr-invoices-all">
  <div class="sh"><h2>Invoices</h2><p>All invoices across your workspace.</p></div>
  <div class="sg" id="invSummary"></div>
  <div id="allInvoicesList"></div>
</div>
<!-- SETTINGS -->
<div class="screen" v-show="nav.screen==='settings'" id="scr-settings">
  <div class="sh"><h2>Settings</h2><p>Configure your company, proposals, integrations, and more.</p></div>

  <!-- Tab Navigation -->
  <div class="settings-tabs">
    <button class="settings-tab" :class="{active: settingsTab==='company'}" @click="switchSettingsTab('company')">&#127970; Company</button>
    <button class="settings-tab" :class="{active: settingsTab==='proposals'}" @click="switchSettingsTab('proposals')">&#9998; Proposals</button>
    <button class="settings-tab" :class="{active: settingsTab==='invoicing'}" @click="switchSettingsTab('invoicing')">&#128176; Invoicing</button>
    <button class="settings-tab" :class="{active: settingsTab==='pdf'}" @click="switchSettingsTab('pdf')">&#127912; PDF</button>
    <button class="settings-tab" :class="{active: settingsTab==='products'}" @click="switchSettingsTab('products')">&#9881; Products</button>
    <button class="settings-tab" :class="{active: settingsTab==='templates'}" @click="switchSettingsTab('templates')">&#128203; Templates</button>
    <button class="settings-tab" :class="{active: settingsTab==='leadsources'}" @click="switchSettingsTab('leadsources')">&#128161; Lead Sources</button>
    <button class="settings-tab" :class="{active: settingsTab==='team'}" @click="switchSettingsTab('team')">&#128101; Team</button>
    <button class="settings-tab" :class="{active: settingsTab==='integrations'}" @click="switchSettingsTab('integrations')">&#128279; Integrations</button>
    <button class="settings-tab" :class="{active: settingsTab==='data'}" @click="switchSettingsTab('data')">&#128202; Data</button>
  </div>

  <!-- Tab 1: Company -->
  <div v-show="settingsTab==='company'">
    <div class="cd">
      <div class="ct"><span class="ic io">&#127970;</span> Company Information</div>
      <div class="g2">
        <div class="fg"><label>Company Name</label><input type="text" v-model="settings.companyName" placeholder="Your company name"></div>
        <div class="fg"><label>Contact Name</label><input type="text" v-model="settings.contactName" placeholder="Your name"></div>
      </div>
      <div class="g2">
        <div class="fg"><label>Phone</label><input type="tel" v-model="settings.phone" placeholder="(555) 123-4567"></div>
        <div class="fg"><label>Email</label><input type="email" v-model="settings.email" placeholder="email@company.com"></div>
      </div>
      <div class="fg"><label>Address</label><input type="text" v-model="settings.address" placeholder="Street address"></div>
      <div class="g3">
        <div class="fg"><label>City</label><input type="text" v-model="settings.city" placeholder="City"></div>
        <div class="fg"><label>State</label><input type="text" v-model="settings.state" placeholder="State"></div>
        <div class="fg"><label>Zip</label><input type="text" v-model="settings.zip" placeholder="Zip code"></div>
      </div>
      <div class="fg" style="margin-top:8px">
        <label>Company Logo</label>
        <div style="margin-bottom:8px">
          <img v-if="settings.companyLogo" :src="settings.companyLogo" style="max-height:60px;max-width:200px;border-radius:6px;border:1px solid var(--b1)">
          <div v-else style="font-size:12px;color:var(--t4)">No logo uploaded</div>
        </div>
        <input type="file" id="setLogo" accept="image/*" onchange="handleLogoUpload(event)" style="font-size:13px">
        <button v-if="settings.companyLogo" class="btn btn-ghost" onclick="clearLogo()" style="font-size:11px;padding:3px 10px;margin-top:4px">Remove Logo</button>
      </div>
    </div>
  </div>

  <!-- Tab 2: Proposals -->
  <div v-show="settingsTab==='proposals'">
    <div class="cd">
      <div class="ct"><span class="ic ior">&#9998;</span> Proposal & Contract Defaults</div>
      <div class="fg"><label>Company Tagline</label><input type="text" v-model="settings.tagline" placeholder="e.g. Quality Coatings, Done Right"></div>
      <div class="g2">
        <div class="fg"><label>Proposal Valid (days)</label><input type="number" v-model.number="settings.proposalValidDays" min="1" max="365" style="max-width:100px"></div>
        <div class="fg"><label>Warranty Period (years)</label><input type="number" v-model.number="settings.warrantyYears" min="0" max="25" style="max-width:100px"></div>
      </div>
      <div class="fg"><label>Warranty Text</label><textarea v-model="settings.warrantyText" rows="2" placeholder="Workmanship warranty language..."></textarea></div>
      <div class="fg"><label>Default Terms & Conditions</label><textarea v-model="settings.terms" rows="5" placeholder="Terms will appear on proposals and contracts..."></textarea></div>
      <div class="g2">
        <div class="fg"><label>Tax Rate (%)</label><input type="number" v-model.number="settings.taxRate" min="0" step="0.1" style="max-width:120px"></div>
        <div class="fg"><label>Payment Terms</label>
          <select v-model="settings.paymentTerms">
            <option value="due_on_receipt">Due on Receipt</option>
            <option value="net15">Net 15</option>
            <option value="net30">Net 30</option>
            <option value="net60">Net 60</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- Tab 3: Invoicing -->
  <div v-show="settingsTab==='invoicing'">
    <div class="cd">
      <div class="ct"><span class="ic ig">&#128176;</span> Invoicing & Financial</div>
      <div class="g2">
        <div class="fg"><label>Deposit Percentage (%)</label><input type="number" v-model.number="settings.depositPercent" min="0" max="100" style="max-width:100px"></div>
        <div class="fg"><label>Late Fee (%)</label><input type="number" v-model.number="settings.lateFeePercent" min="0" max="100" step="0.5" style="max-width:100px"></div>
      </div>
      <div class="g3">
        <div class="fg"><label>Invoice Prefix</label><input type="text" v-model="settings.invoicePrefix" style="max-width:120px"></div>
        <div class="fg"><label>Number Padding</label><input type="number" v-model.number="settings.invoiceNumberPadding" min="1" max="6" style="max-width:80px"></div>
        <div class="fg"><label>Preview</label>
          <div style="padding:8px 12px;background:var(--s3);border-radius:8px;font-family:'JetBrains Mono',monospace;font-size:13px;color:var(--t2)">{{ (settings.invoicePrefix || 'INV-') + '1'.padStart(settings.invoiceNumberPadding || 3, '0') }}</div>
        </div>
      </div>
      <div class="g2">
        <div class="fg"><label>Labor Rate ($/hr)</label><input type="number" v-model.number="settings.laborRate" min="0" step="0.5" style="max-width:120px"></div>
        <div class="fg"><label>Target Margin (%)</label><input type="number" v-model.number="settings.targetMargin" min="0" max="100" step="1" style="max-width:120px"></div>
      </div>
      <p style="font-size:11px;color:var(--t4);margin-top:-4px">Labor rate and margin target are for reference — they do not auto-calculate pricing.</p>
    </div>
  </div>

  <!-- Tab 4: PDF -->
  <div v-show="settingsTab==='pdf'">
    <div class="cd">
      <div class="ct"><span class="ic ib">&#127912;</span> PDF Appearance</div>
      <div class="g3">
        <div class="fg"><label>Accent Color</label><input type="color" id="setPdfAccentColor" oninput="updateColorPreview()" style="width:48px;height:36px;padding:2px;cursor:pointer;border:1px solid var(--b1);border-radius:6px"></div>
        <div class="fg"><label>PDF Font</label>
          <select v-model="settings.pdfFontFamily">
            <option value="helvetica">Helvetica</option>
            <option value="times">Times</option>
            <option value="courier">Courier</option>
          </select>
        </div>
        <div class="fg"><label>File Prefix</label><input type="text" v-model="settings.pdfFilePrefix" style="max-width:120px"></div>
      </div>
      <div id="pdfColorPreview" style="height:8px;border-radius:4px;margin-top:-4px"></div>
    </div>
  </div>

  <!-- Tab 5: Products -->
  <div v-show="settingsTab==='products'">
    <div class="cd">
      <div class="ct"><span class="ic io">&#9881;</span> Custom Products & Services</div>
      <p style="font-size:12px;color:var(--t3);margin-bottom:12px">Add your own coating systems, topcoats, repairs, and add-ons. Built-in TCP products are always available.</p>
      <div class="tab-row" id="customCatTabs"></div>
      <div id="customItemsList" style="margin-top:12px"></div>
      <button class="btn btn-primary" onclick="addCustomItem()" style="margin-top:10px;font-size:12px;padding:6px 16px">+ Add Item</button>
    </div>
  </div>

  <!-- Tab 6: Templates -->
  <div v-show="settingsTab==='templates'">
    <div class="cd">
      <div class="ct"><span class="ic ior">&#128203;</span> Estimate Templates</div>
      <p style="font-size:12px;color:var(--t3);margin-bottom:12px">Save common job configurations as templates. Create new estimates from them in one click.</p>
      <div id="templateList"></div>
      <p style="font-size:11px;color:var(--t4);margin-top:8px">To save a template, open any estimate and click "Save as Template" in the action bar.</p>
    </div>
  </div>

  <!-- Tab 7: Lead Sources -->
  <div v-show="settingsTab==='leadsources'">
    <div class="cd">
      <div class="ct"><span class="ic ior">&#128161;</span> Lead Source Presets</div>
      <p style="font-size:12px;color:var(--t3);margin-bottom:12px">Configure where your leads come from. These appear as a dropdown when creating or editing records.</p>
      <div id="leadSourceList"></div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <input type="text" id="newLeadSource" placeholder="New lead source..." style="flex:1;padding:8px 12px;font-size:14px;border:1px solid var(--b1);border-radius:var(--r-sm);background:var(--s1);color:var(--t1);font-family:inherit" onkeydown="if(event.key==='Enter')addLeadSource()">
        <button class="btn btn-primary" onclick="addLeadSource()" style="font-size:12px;padding:6px 16px">+ Add</button>
      </div>
    </div>
  </div>

  <!-- Tab 8: Team / Crew -->
  <div v-show="settingsTab==='team'">
    <div class="cd">
      <div class="ct"><span class="ic ig">&#128101;</span> Crew Members</div>
      <p style="font-size:12px;color:var(--t3);margin-bottom:12px">Add your team for project scheduling and dispatch. Crew members can be assigned to projects on the calendar.</p>
      <div id="crewList"></div>
      <button class="btn btn-primary" onclick="addCrewMember()" style="margin-top:10px;font-size:12px;padding:6px 16px">+ Add Crew Member</button>
    </div>
  </div>

  <!-- Tab 9: Integrations -->
  <div v-show="settingsTab==='integrations'">
    <!-- EmailJS -->
    <div class="cd">
      <div class="ct"><span class="ic io">&#9993;</span> Email (EmailJS)</div>
      <p style="font-size:12px;color:var(--t3);margin-bottom:12px">Send proposals and invoices with PDF attachments. Free: 200 emails/month.</p>
      <div id="emailjsStatus" style="margin-bottom:12px"></div>
      <div class="fg"><label>Public Key</label><input type="text" v-model="settings.emailjsPublicKey" placeholder="e.g. abc123XYZ"></div>
      <div class="g2">
        <div class="fg"><label>Service ID</label><input type="text" v-model="settings.emailjsServiceId" placeholder="e.g. service_xxxxx"></div>
        <div class="fg"><label>Template ID</label><input type="text" v-model="settings.emailjsTemplateId" placeholder="e.g. template_xxxxx"></div>
      </div>
      <details style="margin-top:10px;font-size:12px;color:var(--t3)">
        <summary style="cursor:pointer;font-weight:600;color:var(--t2)">Setup Instructions</summary>
        <ol style="padding-left:18px;margin-top:8px;line-height:1.8" v-pre>
          <li>Go to <strong>emailjs.com</strong> and create a free account</li>
          <li>Add an <strong>Email Service</strong> (Gmail, Outlook, or SMTP)</li>
          <li>Create a <strong>Template</strong> with these variables:<br>
            <code style="font-size:11px;background:var(--s2);padding:2px 6px;border-radius:4px">{{to_email}}</code>
            <code style="font-size:11px;background:var(--s2);padding:2px 6px;border-radius:4px">{{to_name}}</code>
            <code style="font-size:11px;background:var(--s2);padding:2px 6px;border-radius:4px">{{from_name}}</code>
            <code style="font-size:11px;background:var(--s2);padding:2px 6px;border-radius:4px">{{reply_to}}</code>
            <code style="font-size:11px;background:var(--s2);padding:2px 6px;border-radius:4px">{{subject}}</code>
            <code style="font-size:11px;background:var(--s2);padding:2px 6px;border-radius:4px">{{message}}</code>
          </li>
          <li>In Template Settings &gt; Attachments, add a <strong>Dynamic Attachment</strong> named <code style="font-size:11px;background:var(--s2);padding:2px 6px;border-radius:4px">attachment</code></li>
          <li>Copy your <strong>Public Key</strong>, <strong>Service ID</strong>, and <strong>Template ID</strong> above</li>
        </ol>
      </details>
      <button class="btn btn-ghost" onclick="testEmailJS()" style="margin-top:10px;font-size:12px;padding:6px 16px">Test Connection</button>
    </div>
    <!-- Stripe -->
    <div class="cd">
      <div class="ct"><span class="ic ig">&#128179;</span> Stripe Payments</div>
      <p style="font-size:12px;color:var(--t3);margin-bottom:12px">Accept online payments via Stripe Payment Links. No server required.</p>
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
        <label class="toggle"><input type="checkbox" v-model="settings.stripeEnabled"><span class="slider"></span></label>
        <span style="font-size:14px;color:var(--t2)">Enable Stripe Payments</span>
      </div>
      <div v-show="settings.stripeEnabled">
        <div class="fg"><label>Payment Link Base URL</label><input type="text" v-model="settings.stripePaymentLinkBase" placeholder="https://buy.stripe.com/xxxxx"></div>
        <details style="font-size:12px;color:var(--t3)">
          <summary style="cursor:pointer;font-weight:600;color:var(--t2)">How to Create a Payment Link</summary>
          <ol style="padding-left:18px;margin-top:8px;line-height:1.8">
            <li>Log into <strong>dashboard.stripe.com</strong></li>
            <li>Go to <strong>Payment Links</strong> &rarr; create new</li>
            <li>Set pricing to "Customer chooses amount" or fixed price</li>
            <li>Copy the link URL and paste above</li>
            <li>Invoices will include a "Pay Now" button</li>
          </ol>
        </details>
      </div>
    </div>
    <!-- Mailchimp -->
    <div class="cd">
      <div class="ct"><span class="ic ib">&#128231;</span> Mailchimp</div>
      <p style="font-size:12px;color:var(--t3);margin-bottom:12px">Connect Mailchimp for email marketing. Paste your embed form code for client portals.</p>
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
        <label class="toggle"><input type="checkbox" v-model="settings.mailchimpEnabled"><span class="slider"></span></label>
        <span style="font-size:14px;color:var(--t2)">Enable Mailchimp</span>
      </div>
      <div v-show="settings.mailchimpEnabled">
        <div class="fg"><label>Embed Form Code (HTML)</label><textarea v-model="settings.mailchimpEmbedCode" rows="4" placeholder="Paste Mailchimp embed form HTML..."></textarea></div>
      </div>
    </div>
    <!-- Booking Widget -->
    <div class="cd">
      <div class="ct"><span class="ic ior">&#128197;</span> Booking Widget</div>
      <p style="font-size:12px;color:var(--t3);margin-bottom:12px">Generate an embeddable contact form for your website. Submissions sent via EmailJS.</p>
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
        <label class="toggle"><input type="checkbox" v-model="settings.bookingEnabled"><span class="slider"></span></label>
        <span style="font-size:14px;color:var(--t2)">Enable Booking Widget</span>
      </div>
      <div v-show="settings.bookingEnabled">
        <div class="fg"><label>Notification Email</label><input type="text" v-model="settings.bookingNotifyEmail" placeholder="email@company.com"></div>
        <div class="fg"><label>Project Types (comma-separated)</label><input type="text" :value="(settings.bookingProjectTypes||[]).join(', ')" @change="settings.bookingProjectTypes=$event.target.value.split(',').map(s=>s.trim()).filter(Boolean)" placeholder="Garage Floor, Patio, Basement..."></div>
        <button class="btn btn-ghost" onclick="generateBookingWidget()" style="font-size:12px;padding:6px 16px">Generate Widget Code</button>
      </div>
    </div>
  </div>

  <!-- Tab 10: Data -->
  <div v-show="settingsTab==='data'">
    <div class="cd">
      <div class="ct"><span class="ic ig">&#128202;</span> Data Management</div>
      <div id="settingsStats" style="margin-bottom:16px"></div>
      <div class="btn-row">
        <button class="btn btn-primary" onclick="doExport()">Export Data (JSON)</button>
        <button class="btn btn-ghost" onclick="openImport()">Import Data</button>
        <button class="btn btn-danger" onclick="confirmClearAll()">Clear All Data</button>
      </div>
    </div>
  </div>

  <!-- Persistent Save Button -->
  <div class="btn-row" style="margin-top:16px">
    <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
  </div>
</div>
<!-- PROFILE SETUP (first-run) -->
<div class="screen" v-show="nav.screen==='profile-setup'" id="scr-profile-setup">
  <div style="max-width:480px;margin:40px auto;text-align:center">
    <div style="font-size:48px;margin-bottom:12px">&#128736;</div>
    <h2 style="font-size:22px;margin-bottom:4px">Welcome to Coatings Estimator</h2>
    <p style="color:var(--t3);font-size:13px;margin-bottom:28px">Set up your profile to get started. Each dealer gets their own workspace.</p>
    <div class="cd" style="text-align:left">
      <div class="fg"><label>Your Name *</label><input type="text" id="setupName" placeholder="John Smith"></div>
      <div class="g2">
        <div class="fg"><label>Email</label><input type="email" id="setupEmail" placeholder="john@company.com"></div>
        <div class="fg"><label>Phone</label><input type="tel" id="setupPhone" placeholder="(555) 123-4567"></div>
      </div>
      <div class="fg"><label>Company Name *</label><input type="text" id="setupCompany" placeholder="Your Company LLC"></div>
      <div class="g2">
        <div class="fg"><label>City</label><input type="text" id="setupCity" placeholder="City"></div>
        <div class="fg"><label>State</label><input type="text" id="setupState" placeholder="State"></div>
      </div>
      <div class="fg"><label>PIN (optional)</label><input type="password" id="setupPin" placeholder="4-digit PIN for quick login" maxlength="6"></div>
      <button class="btn btn-primary" style="width:100%;margin-top:12px" onclick="createProfile()">Get Started</button>
    </div>
  </div>
</div>

<!-- PROFILE SELECT -->
<div class="screen" v-show="nav.screen==='profile-select'" id="scr-profile-select">
  <div style="max-width:560px;margin:40px auto;text-align:center">
    <div style="font-size:48px;margin-bottom:12px">&#128101;</div>
    <h2 style="font-size:22px;margin-bottom:4px">Select Profile</h2>
    <p style="color:var(--t3);font-size:13px;margin-bottom:28px">Choose your profile to load your workspace.</p>
    <div id="profileCards"></div>
    <button class="btn btn-ghost" style="margin-top:16px" onclick="goProfileSetup()">+ New Profile</button>
  </div>
</div>

</div>
<!-- CALENDAR / DISPATCH -->
<div class="screen" v-show="nav.screen==='calendar'" id="scr-calendar">
  <div class="sh">
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
      <div><h2>Calendar</h2><p>Project schedule &amp; dispatch</p></div>
      <div class="btn-row">
        <button class="btn" :class="calView==='month'?'btn-primary':'btn-ghost'" @click="calView='month';renderCalendar()">Month</button>
        <button class="btn" :class="calView==='week'?'btn-primary':'btn-ghost'" @click="calView='week';renderWeekView()">Week</button>
        <button class="btn" :class="calView==='dispatch'?'btn-primary':'btn-ghost'" @click="calView='dispatch';renderDispatch()">Dispatch</button>
      </div>
    </div>
  </div>

  <!-- Shared Navigation -->
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
    <button class="btn btn-ghost" @click="calNav(-1)">&larr; Prev</button>
    <h3 id="calMonthLabel" style="font-size:16px;font-weight:700"></h3>
    <button class="btn btn-ghost" @click="calNav(1)">Next &rarr;</button>
  </div>

  <!-- ═══════════════════════════════════════════════════════ -->
  <!-- MONTH VIEW                                             -->
  <!-- ═══════════════════════════════════════════════════════ -->
  <div v-show="calView==='month'">
    <div id="calGrid" class="cal-grid"></div>
    <div id="calDayDetail" style="margin-top:16px"></div>
  </div>

  <!-- ═══════════════════════════════════════════════════════ -->
  <!-- WEEK VIEW                                              -->
  <!-- ═══════════════════════════════════════════════════════ -->
  <div v-show="calView==='week'">
    <div class="cd" style="overflow-x:auto">
      <div id="weekGrid" class="cal-grid" style="grid-template-columns:repeat(7,minmax(120px,1fr))"></div>
    </div>
    <div id="weekDayDetail" style="margin-top:16px"></div>
  </div>

  <!-- ═══════════════════════════════════════════════════════ -->
  <!-- DISPATCH BOARD                                         -->
  <!-- ═══════════════════════════════════════════════════════ -->
  <div v-show="calView==='dispatch'">

    <!-- Crew legend -->
    <div id="dispatchCrewLegend" style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px;align-items:center">
      <!-- Rendered by renderDispatch(): color dot + crew name for each crew member -->
    </div>

    <!-- Dispatch grid: time-slotted 7-day columns -->
    <div class="cd" style="overflow-x:auto;padding:0">
      <div id="dispatchGrid" class="dispatch-week"
           @dragover.prevent>
        <!-- Rendered by renderDispatch(): time labels in col 1, day slots in cols 2-8 -->
      </div>
    </div>

    <!-- Unscheduled projects bucket -->
    <div class="cd" style="margin-top:16px">
      <div class="ct"><span class="ic ior">&#128203;</span> Unscheduled Projects</div>
      <div id="dispatchUnscheduled"
           @dragover.prevent
           @drop="dispatchUnschedule($event)"
           style="min-height:48px;display:flex;flex-wrap:wrap;gap:8px;padding:8px 0">
        <!-- Rendered by renderDispatch(): draggable project chips with no start date -->
      </div>
    </div>

    <!-- Dispatch day detail (shows when a slot is clicked) -->
    <div id="dispatchDayDetail" style="margin-top:16px"></div>
  </div>
</div>
<!-- MODALS -->
<div class="modal-overlay" id="confirmModal" onclick="if(event.target===this)closeConfirm()">
  <div class="modal">
    <h3 id="confirmTitle">Confirm</h3>
    <p style="font-size:13px;color:var(--t3);margin-bottom:20px;line-height:1.5" id="confirmMsg"></p>
    <div class="btn-row"><button class="btn btn-danger" id="confirmYes">Delete</button><button class="btn btn-ghost" onclick="closeConfirm()">Cancel</button></div>
  </div>
</div>
<div class="modal-overlay" id="exportModal" onclick="if(event.target===this)closeExport()">
  <div class="modal">
    <h3>Export Data</h3>
    <p style="font-size:13px;color:var(--t3);margin-bottom:20px;line-height:1.5">Download all records as a JSON file for backup or transfer.</p>
    <div class="btn-row"><button class="btn btn-primary" onclick="doExport()">Download</button><button class="btn btn-ghost" onclick="closeExport()">Cancel</button></div>
  </div>
</div>
<div class="modal-overlay" id="importModal" onclick="if(event.target===this)closeImport()">
  <div class="modal">
    <h3>Import Data</h3>
    <p style="font-size:13px;color:var(--t3);margin-bottom:16px;line-height:1.5">Load a previously exported JSON file. This will <strong style="color:var(--comp)">replace</strong> all current data.</p>
    <div class="fg"><input type="file" id="importFile" accept=".json" style="font-size:13px"></div>
    <div class="btn-row"><button class="btn btn-primary" onclick="doImport()">Import</button><button class="btn btn-ghost" onclick="closeImport()">Cancel</button></div>
  </div>
</div>
<div class="modal-overlay" id="paymentModal" onclick="if(event.target===this)closePaymentModal()">
  <div class="modal">
    <h3>Record Payment</h3>
    <div class="fg"><label>Amount</label><input type="number" id="payAmount" min="0" step="0.01" placeholder="0.00"></div>
    <div class="g2">
      <div class="fg"><label>Date</label><input type="date" id="payDate"></div>
      <div class="fg"><label>Method</label><select id="payMethod"><option>Cash</option><option>Check</option><option>Credit Card</option><option>Zelle</option><option>ACH</option><option>Other</option></select></div>
    </div>
    <div class="fg"><label>Note</label><input type="text" id="payNote" placeholder="e.g. Check #1234"></div>
    <div class="btn-row"><button class="btn btn-success" onclick="recordPayment()">Record Payment</button><button class="btn btn-ghost" onclick="closePaymentModal()">Cancel</button></div>
  </div>
</div>

<!-- MOBILE BOTTOM NAV -->
<div class="mobile-bottom-nav">
  <button :class="{active:nav.screen==='home'}" @click="goHome()"><span class="nav-icon">&#127968;</span>Home</button>
  <button :class="{active:nav.screen==='list'}" @click="goFolder('lead',true)"><span class="nav-icon">&#128203;</span>Pipeline</button>
  <button :class="{active:nav.screen==='calendar'}" @click="goCalendar()"><span class="nav-icon">&#128197;</span>Calendar</button>
  <button :class="{active:nav.screen==='reporting'}" @click="goReporting()"><span class="nav-icon">&#128200;</span>Reports</button>
  <button :class="{active:nav.screen==='settings'}" @click="goSettings()"><span class="nav-icon">&#9881;</span>Settings</button>
</div>
</div><!-- /app -->

<!-- Toast notification (outside Vue for simplicity during transition) -->
<div class="toast" id="toast"><div class="tt" id="toastT"></div><div class="tm" id="toastM"></div></div>
<script>
'use strict';

// ═══════════════════════════════════════════════════════════
// PRODUCT DATA
// ═══════════════════════════════════════════════════════════
const PRODUCTS=[
  {id:'c101',sku:'C-101',name:'Rustic Concrete Wood (Exterior)',series:'C-Series',cat:'Rustic & Stone',cost:1.15,low:8.00,mid:14.00},
  {id:'c102',sku:'C-102',name:'Rustic Concrete Wood (Interior)',series:'C-Series',cat:'Rustic & Stone',cost:1.43,low:8.00,mid:14.00},
  {id:'c103',sku:'C-103',name:'Grand Flagstone (Exterior)',series:'C-Series',cat:'Rustic & Stone',cost:1.15,low:8.00,mid:14.00},
  {id:'c104',sku:'C-104',name:'Grand Flagstone (Interior)',series:'C-Series',cat:'Rustic & Stone',cost:1.43,low:8.00,mid:14.00},
  {id:'c105',sku:'C-105',name:'Tuscan Slate (Exterior)',series:'C-Series',cat:'Rustic & Stone',cost:1.15,low:8.00,mid:14.00},
  {id:'c106',sku:'C-106',name:'Tuscan Slate (Interior)',series:'C-Series',cat:'Rustic & Stone',cost:1.43,low:8.00,mid:14.00},
  {id:'m201',sku:'M-201',name:'Metallic Marble Stain Gloss',series:'M-Series',cat:'Metallic & Marble',cost:3.13,low:8.50,mid:15.00},
  {id:'m202',sku:'M-202',name:'Metallic Marble Stain Satin',series:'M-Series',cat:'Metallic & Marble',cost:3.21,low:8.50,mid:15.00},
  {id:'m203',sku:'M-203',name:'Metallic Marble Stain Finish',series:'M-Series',cat:'Metallic & Marble',cost:2.73,low:8.50,mid:15.00},
  {id:'m204',sku:'M-204',name:'Italian Marble Epoxy Finish',series:'M-Series',cat:'Metallic & Marble',cost:2.76,low:9.00,mid:15.00},
  {id:'m205',sku:'M-205',name:'Italian Marble Epoxy Gloss',series:'M-Series',cat:'Metallic & Marble',cost:3.16,low:9.00,mid:15.00},
  {id:'m206',sku:'M-206',name:'Italian Marble Epoxy Satin',series:'M-Series',cat:'Metallic & Marble',cost:3.25,low:9.00,mid:15.00},
  {id:'g301',sku:'G-301',name:'Graniflex Flake Broadcast PP-90',series:'G-Series',cat:'Graniflex',cost:2.59,low:7.00,mid:9.00},
  {id:'g302',sku:'G-302',name:'Graniflex Flake Broadcast Graniseal',series:'G-Series',cat:'Graniflex',cost:2.55,low:7.00,mid:9.00},
  {id:'g303',sku:'G-303',name:'Graniflex Flake Neat Coat',series:'G-Series',cat:'Graniflex',cost:2.09,low:7.00,mid:9.00},
  {id:'g304',sku:'G-304',name:'Graniflex Flake P-Thane',series:'G-Series',cat:'Graniflex',cost:2.40,low:7.00,mid:9.00},
  {id:'g305',sku:'G-305',name:'Graniflex 1-Quartz Broadcast PP-90',series:'G-Series',cat:'Graniflex',cost:2.82,low:7.50,mid:10.00},
  {id:'g306',sku:'G-306',name:'Graniflex 1-Quartz Broadcast Graniseal',series:'G-Series',cat:'Graniflex',cost:2.77,low:7.50,mid:10.00},
  {id:'g307',sku:'G-307',name:'Graniflex 1-Quartz Neat Coat',series:'G-Series',cat:'Graniflex',cost:2.19,low:7.50,mid:10.00},
  {id:'g308',sku:'G-308',name:'Graniflex 1-Quartz P-Thane',series:'G-Series',cat:'Graniflex',cost:2.59,low:7.50,mid:10.00},
  {id:'g309',sku:'G-309',name:'Graniflex 2-Quartz Broadcast PP-90',series:'G-Series',cat:'Graniflex',cost:3.54,low:8.50,mid:12.00},
  {id:'g310',sku:'G-310',name:'Graniflex 2-Quartz Broadcast Graniseal',series:'G-Series',cat:'Graniflex',cost:3.08,low:8.50,mid:12.00},
  {id:'g311',sku:'G-311',name:'Marble-Flex PP-90',series:'G-Series',cat:'Graniflex',cost:2.85,low:8.50,mid:12.00},
  {id:'g312',sku:'G-312',name:'Marble-Flex w/ Solid Poly 90',series:'G-Series',cat:'Graniflex',cost:2.84,low:8.50,mid:12.00},
  {id:'e401',sku:'E-401',name:'Protector-Flake P-Thane',series:'E-Series',cat:'Protector',cost:1.94,low:5.50,mid:7.50},
  {id:'e402',sku:'E-402',name:'Protector-Flake PP-90',series:'E-Series',cat:'Protector',cost:2.13,low:5.50,mid:7.50},
  {id:'e403',sku:'E-403',name:'Protector-Flake Neat Coat',series:'E-Series',cat:'Protector',cost:1.46,low:5.50,mid:7.50},
  {id:'e404',sku:'E-404',name:'Resinous 123 Floor',series:'E-Series',cat:'Protector',cost:1.05,low:3.00,mid:5.00},
  {id:'i501',sku:'I-501',name:'SCP Polish (Chemicals)',series:'I-Series',cat:'Specialty',cost:0.31,low:2.50,mid:9.00},
  {id:'i502',sku:'I-502',name:'Poly-Hard Super-Nova',series:'I-Series',cat:'Specialty',cost:2.85,low:8.00,mid:16.00},
  {id:'i503',sku:'I-503',name:'Poly-Hard Quartz PP-90',series:'I-Series',cat:'Specialty',cost:3.06,low:8.50,mid:16.00},
];
const TOPCOATS=[
  {id:'tc-none',name:'None',cost:0,desc:'No additional top coat',unitPrice:0,coverage:1},
  {id:'ut4451',sku:'UT-4451',name:'Protectorthane (Interior)',cost:0.37,desc:'Interior polyurethane',unitPrice:110.67,coverage:300},
  {id:'tj3113',sku:'TJ-3113',name:'Acrylic Floor Finish',cost:0.02,desc:'Economical acrylic',unitPrice:36.23,coverage:2000},
  {id:'ut4501',sku:'UT-4501',name:'WB 421 Gloss Urethane',cost:0.42,desc:'Water-based high-gloss',unitPrice:126.25,coverage:300},
  {id:'ut4499',sku:'UT-4499',name:'WB 221 Satin Urethane',cost:0.50,desc:'Water-based satin',unitPrice:151.35,coverage:300},
  {id:'en6303',sku:'EN-6303',name:'Epoxy Neat Coat',cost:0.79,desc:'Smooth epoxy finish',unitPrice:78.89,coverage:100},
  {id:'ut4515',sku:'UT-4515',name:'Perfect Poly 90',cost:0.65,desc:'Premium polyaspartic',unitPrice:129.39,coverage:200},
  {id:'ut4304',sku:'UT-4304',name:'Graniseal',cost:1.25,desc:'Graniflex sealer',unitPrice:124.92,coverage:100},
  {id:'ut4463',sku:'UT-4463',name:'Grey Protectorthane',cost:0.59,desc:'Grey-tinted protectorthane',unitPrice:129.79,coverage:220},
  {id:'ut4513',sku:'UT-4513',name:'SLV 90',cost:0.85,desc:'SLV polyaspartic',unitPrice:170.13,coverage:200},
];
const REPAIRS=[
  {id:'si1652',sku:'SI-1652',name:'Quick Patch',cost:0.77,unit:'sqft'},
  {id:'em6018',sku:'EM-6018',name:'Protector-Flex Joint Fill',cost:1.06,unit:'lnft'},
  {id:'mpp2001',sku:'MPP-2001',name:'MPP 80 Joint Fill',cost:2.00,unit:'lnft'},
  {id:'mpp1019',sku:'MPP-1019',name:'Bulk: MPP 80 Joint Fill',cost:0.70,unit:'lnft'},
  {id:'r701',sku:'R-701',name:'LRB/TAV Patch & Joint Fill',cost:1.76,unit:'lnft'},
];
const ADDONS=[
  {id:'a601',sku:'A-601',name:'Surface Preparation / Removal',cost:0.25,low:1.00,mid:3.00,unit:'sqft'},
  {id:'a602',sku:'A-602',name:'LRB Flood Coat',cost:2.34,low:1.50,mid:3.00,unit:'sqft'},
  {id:'a603',sku:'A-603',name:'Penetrating Hydrophobic Sealer',cost:0.17,low:0.50,mid:1.00,unit:'sqft'},
  {id:'a604',sku:'A-604',name:'Hydro-Polish',cost:0.04,low:0.15,mid:0.50,unit:'sqft'},
  {id:'a605',sku:'EC-4203',name:'Easy Cove 4"',cost:6.41,low:13.00,mid:18.00,unit:'lnft'},
  {id:'a606',sku:'EC-4209',name:'Easy Cove 6"',cost:8.61,low:14.00,mid:18.00,unit:'lnft'},
  {id:'a607',sku:'MG-2519',name:'Flooring Logo',cost:17.00,low:40.00,mid:65.00,unit:'each'},
];
const INGREDIENTS={
  'c101':[{name:'CP Texture Mix (2 coats)',sku:'DM-3913',coverage:100,unit:'bag',costPer:29.52},{name:'HD Resin (2 coats)',sku:'DM-5406',coverage:100,unit:'gal',costPer:29.83},{name:'CP Mineral Pigment (2 coats)',sku:'DC-2022',coverage:700,unit:'qt',costPer:31.52},{name:'Acrylic Shield (2 coats)',sku:'SE-2803',coverage:75,unit:'gal',costPer:38.13}],
  'c103':[{name:'CP Texture Mix (2 coats)',sku:'DM-3913',coverage:100,unit:'bag',costPer:29.52},{name:'HD Resin (2 coats)',sku:'DM-5406',coverage:100,unit:'gal',costPer:29.83},{name:'CP Mineral Pigment (2 coats)',sku:'DC-2022',coverage:700,unit:'qt',costPer:31.52},{name:'Acrylic Shield (2 coats)',sku:'SE-2803',coverage:75,unit:'gal',costPer:38.13}],
  'c105':[{name:'CP Texture Mix (2 coats)',sku:'DM-3913',coverage:100,unit:'bag',costPer:29.52},{name:'HD Resin (2 coats)',sku:'DM-5406',coverage:100,unit:'gal',costPer:29.83},{name:'CP Mineral Pigment (2 coats)',sku:'DC-2022',coverage:700,unit:'qt',costPer:31.52},{name:'Acrylic Shield (2 coats)',sku:'SE-2803',coverage:75,unit:'gal',costPer:38.13}],
  'c102':[{name:'CP Texture Mix (2 coats)',sku:'DM-3913',coverage:100,unit:'bag',costPer:29.52},{name:'HD Resin (2 coats)',sku:'DM-5406',coverage:100,unit:'gal',costPer:29.83},{name:'CP Mineral Pigment (2 coats)',sku:'DC-2022',coverage:700,unit:'qt',costPer:31.52},{name:'Epoxy Neat Coat',sku:'EN-6303',coverage:100,unit:'gal',costPer:78.89}],
  'c104':[{name:'CP Texture Mix (2 coats)',sku:'DM-3913',coverage:100,unit:'bag',costPer:29.52},{name:'HD Resin (2 coats)',sku:'DM-5406',coverage:100,unit:'gal',costPer:29.83},{name:'CP Mineral Pigment (2 coats)',sku:'DC-2022',coverage:700,unit:'qt',costPer:31.52},{name:'Epoxy Neat Coat',sku:'EN-6303',coverage:100,unit:'gal',costPer:78.89}],
  'c106':[{name:'CP Texture Mix (2 coats)',sku:'DM-3913',coverage:100,unit:'bag',costPer:29.52},{name:'HD Resin (2 coats)',sku:'DM-5406',coverage:100,unit:'gal',costPer:29.83},{name:'CP Mineral Pigment (2 coats)',sku:'DC-2022',coverage:700,unit:'qt',costPer:31.52},{name:'Epoxy Neat Coat',sku:'EN-6303',coverage:100,unit:'gal',costPer:78.89}],
  'm201':[{name:'Epoxy Neat Coat (base)',sku:'EN-6303',coverage:60,unit:'gal',costPer:78.89},{name:'Epoxy Neat Coat (top)',sku:'EN-6303',coverage:60,unit:'gal',costPer:78.89},{name:'Marble Metallics',sku:'MQ-001',coverage:375,unit:'qt',costPer:29.96},{name:'WB 421 Gloss Urethane',sku:'UT-4501',coverage:300,unit:'gal',costPer:126.25}],
  'm202':[{name:'Epoxy Neat Coat (base)',sku:'EN-6303',coverage:60,unit:'gal',costPer:78.89},{name:'Epoxy Neat Coat (top)',sku:'EN-6303',coverage:60,unit:'gal',costPer:78.89},{name:'Marble Metallics',sku:'MQ-001',coverage:375,unit:'qt',costPer:29.96},{name:'WB 221 Satin Urethane',sku:'UT-4499',coverage:300,unit:'gal',costPer:151.35}],
  'm203':[{name:'Epoxy Neat Coat (base)',sku:'EN-6303',coverage:60,unit:'gal',costPer:78.89},{name:'Epoxy Neat Coat (top)',sku:'EN-6303',coverage:60,unit:'gal',costPer:78.89},{name:'Marble Metallics',sku:'MQ-001',coverage:375,unit:'qt',costPer:29.96},{name:'Acrylic Floor Finish',sku:'TJ-3113',coverage:2000,unit:'gal',costPer:36.23}],
  'm204':[{name:'Epoxy Neat Coat (base)',sku:'EN-6303',coverage:100,unit:'gal',costPer:78.89},{name:'Barricade Color Pak',sku:'SE-2839',coverage:450,unit:'qt',costPer:75.78},{name:'Epoxy Neat Coat (top)',sku:'EN-6303',coverage:80,unit:'gal',costPer:78.89},{name:'Marble Metallics',sku:'MQ-001',coverage:240,unit:'qt',costPer:29.96},{name:'Marble Spray',sku:'MQ-604L',coverage:100,unit:'can',costPer:14.97},{name:'Epoxy Neat Coat (clear)',sku:'EN-6303',coverage:150,unit:'gal',costPer:78.89},{name:'Acrylic Floor Finish',sku:'TJ-3113',coverage:2000,unit:'gal',costPer:36.23}],
  'm205':[{name:'Epoxy Neat Coat (base)',sku:'EN-6303',coverage:100,unit:'gal',costPer:78.89},{name:'Barricade Color Pak',sku:'SE-2839',coverage:450,unit:'qt',costPer:75.78},{name:'Epoxy Neat Coat (top)',sku:'EN-6303',coverage:80,unit:'gal',costPer:78.89},{name:'Marble Metallics',sku:'MQ-001',coverage:240,unit:'qt',costPer:29.96},{name:'Marble Spray',sku:'MQ-604L',coverage:100,unit:'can',costPer:14.97},{name:'Epoxy Neat Coat (clear)',sku:'EN-6303',coverage:150,unit:'gal',costPer:78.89},{name:'WB 421 Gloss Urethane',sku:'UT-4501',coverage:300,unit:'gal',costPer:126.25}],
  'm206':[{name:'Epoxy Neat Coat (base)',sku:'EN-6303',coverage:100,unit:'gal',costPer:78.89},{name:'Barricade Color Pak',sku:'SE-2839',coverage:450,unit:'qt',costPer:75.78},{name:'Epoxy Neat Coat (top)',sku:'EN-6303',coverage:80,unit:'gal',costPer:78.89},{name:'Marble Metallics',sku:'MQ-001',coverage:240,unit:'qt',costPer:29.96},{name:'Marble Spray',sku:'MQ-604L',coverage:100,unit:'can',costPer:14.97},{name:'Epoxy Neat Coat (clear)',sku:'EN-6303',coverage:150,unit:'gal',costPer:78.89},{name:'WB 221 Satin Urethane',sku:'UT-4499',coverage:300,unit:'gal',costPer:151.35}],
  'g301':[{name:'Permaflex (prime)',sku:'PFA-1010',coverage:220,unit:'gal',costPer:99.55},{name:'Permaflex (broadcast)',sku:'PFA-1010',coverage:220,unit:'gal',costPer:99.55},{name:'Stone Blend Flake',sku:'CF-STN1/4',coverage:7,unit:'lb',costPer:2.75},{name:'Perfect Poly 90',sku:'UT-4515',coverage:100,unit:'gal',costPer:129.39}],
  'g302':[{name:'Permaflex (prime)',sku:'PFA-1010',coverage:220,unit:'gal',costPer:99.55},{name:'Permaflex (broadcast)',sku:'PFA-1010',coverage:220,unit:'gal',costPer:99.55},{name:'Stone Blend Flake',sku:'CF-STN1/4',coverage:7,unit:'lb',costPer:2.75},{name:'Graniseal',sku:'UT-4304',coverage:100,unit:'gal',costPer:124.92}],
  'g303':[{name:'Permaflex (prime)',sku:'PFA-1010',coverage:220,unit:'gal',costPer:99.55},{name:'Permaflex (broadcast)',sku:'PFA-1010',coverage:220,unit:'gal',costPer:99.55},{name:'Stone Blend Flake',sku:'CF-STN1/4',coverage:7,unit:'lb',costPer:2.75},{name:'Epoxy Neat Coat',sku:'EN-6303',coverage:100,unit:'gal',costPer:78.89}],
  'g304':[{name:'Permaflex (prime)',sku:'PFA-1010',coverage:220,unit:'gal',costPer:99.55},{name:'Permaflex (broadcast)',sku:'PFA-1010',coverage:220,unit:'gal',costPer:99.55},{name:'Stone Blend Flake',sku:'CF-STN1/4',coverage:7,unit:'lb',costPer:2.75},{name:'Protectorthane',sku:'UT-4451',coverage:100,unit:'gal',costPer:110.67}],
  'g305':[{name:'Permaflex (prime)',sku:'PFA-1010',coverage:220,unit:'gal',costPer:99.55},{name:'Permaflex (broadcast)',sku:'PFA-1010',coverage:220,unit:'gal',costPer:99.55},{name:'Decorative Quartz',sku:'CQ-BLD',coverage:2,unit:'lb',costPer:0.60},{name:'Perfect Poly 90',sku:'UT-4515',coverage:80,unit:'gal',costPer:129.39}],
  'g306':[{name:'Permaflex (prime)',sku:'PFA-1010',coverage:220,unit:'gal',costPer:99.55},{name:'Permaflex (broadcast)',sku:'PFA-1010',coverage:220,unit:'gal',costPer:99.55},{name:'Decorative Quartz',sku:'CQ-BLD',coverage:2,unit:'lb',costPer:0.60},{name:'Graniseal',sku:'UT-4304',coverage:80,unit:'gal',costPer:124.92}],
  'g307':[{name:'Permaflex (prime)',sku:'PFA-1010',coverage:220,unit:'gal',costPer:99.55},{name:'Permaflex (broadcast)',sku:'PFA-1010',coverage:220,unit:'gal',costPer:99.55},{name:'Decorative Quartz',sku:'CQ-BLD',coverage:2,unit:'lb',costPer:0.60},{name:'Epoxy Neat Coat',sku:'EN-6303',coverage:80,unit:'gal',costPer:78.89}],
  'g308':[{name:'Permaflex (prime)',sku:'PFA-1010',coverage:220,unit:'gal',costPer:99.55},{name:'Permaflex (broadcast)',sku:'PFA-1010',coverage:220,unit:'gal',costPer:99.55},{name:'Decorative Quartz',sku:'CQ-BLD',coverage:2,unit:'lb',costPer:0.60},{name:'Protectorthane',sku:'UT-4451',coverage:80,unit:'gal',costPer:110.67}],
  'g309':[{name:'Permaflex (prime)',sku:'PFA-1010',coverage:220,unit:'gal',costPer:99.55},{name:'Permaflex (broadcast)',sku:'PFA-1010',coverage:220,unit:'gal',costPer:99.55},{name:'Decorative Quartz (1st)',sku:'CQ-BLD',coverage:2,unit:'lb',costPer:0.60},{name:'Perfect Poly 90 (intercoat)',sku:'UT-4515',coverage:175,unit:'gal',costPer:129.39},{name:'Decorative Quartz (2nd)',sku:'CQ-BLD',coverage:2,unit:'lb',costPer:0.60},{name:'Perfect Poly 90 (final)',sku:'UT-4515',coverage:100,unit:'gal',costPer:129.39}],
  'g310':[{name:'Permaflex (prime)',sku:'PFA-1010',coverage:220,unit:'gal',costPer:99.55},{name:'Permaflex (broadcast)',sku:'PFA-1010',coverage:220,unit:'gal',costPer:99.55},{name:'Decorative Quartz (1st)',sku:'CQ-BLD',coverage:2,unit:'lb',costPer:0.60},{name:'Perfect Poly 90 (intercoat)',sku:'UT-4515',coverage:175,unit:'gal',costPer:129.39},{name:'Decorative Quartz (2nd)',sku:'CQ-BLD',coverage:2,unit:'lb',costPer:0.60},{name:'Graniseal',sku:'UT-4304',coverage:150,unit:'gal',costPer:124.92}],
  'g311':[{name:'Permaflex (prime)',sku:'PFA-1010',coverage:220,unit:'gal',costPer:99.55},{name:'Permaflex (broadcast)',sku:'PFA-1010',coverage:220,unit:'gal',costPer:99.55},{name:'Marble Spray',sku:'MQ-604L',coverage:100,unit:'can',costPer:14.97},{name:'Perfect Poly 90 (seal)',sku:'UT-4515',coverage:175,unit:'gal',costPer:129.39},{name:'Perfect Poly 90 (topcoat)',sku:'UT-4515',coverage:122,unit:'gal',costPer:129.39}],
  'g312':[{name:'Permaflex (prime)',sku:'PFA-1010',coverage:220,unit:'gal',costPer:99.55},{name:'Permaflex (flex coat)',sku:'PFA-1010',coverage:220,unit:'gal',costPer:99.55},{name:'Perfect Poly 90 (solid)',sku:'UT-4515',coverage:200,unit:'gal',costPer:129.39},{name:'Perfect Poly 90 (design)',sku:'UT-4515',coverage:400,unit:'gal',costPer:129.39},{name:'Marble Spray',sku:'MQ-604L',coverage:100,unit:'can',costPer:14.97},{name:'Perfect Poly 90 (clear)',sku:'UT-4515',coverage:200,unit:'gal',costPer:129.39},{name:'Poly Fusion Color Pak',sku:'UT-4421',coverage:450,unit:'qt',costPer:74.77}],
  'e401':[{name:'Base Coat Epoxy',sku:'EB-6127',coverage:200,unit:'gal',costPer:87.82},{name:'Stone Blend Flake',sku:'CF-STN1/4',coverage:7,unit:'lb',costPer:2.75},{name:'Protectorthane',sku:'UT-4451',coverage:100,unit:'gal',costPer:110.67}],
  'e402':[{name:'Base Coat Epoxy',sku:'EB-6127',coverage:200,unit:'gal',costPer:87.82},{name:'Stone Blend Flake',sku:'CF-STN1/4',coverage:7,unit:'lb',costPer:2.75},{name:'Perfect Poly 90',sku:'UT-4515',coverage:100,unit:'gal',costPer:129.39}],
  'e403':[{name:'Base Coat Epoxy',sku:'EB-6127',coverage:200,unit:'gal',costPer:87.82},{name:'Stone Blend Flake',sku:'CF-STN1/4',coverage:7,unit:'lb',costPer:2.75},{name:'Epoxy Neat Coat',sku:'EN-6303',coverage:125,unit:'gal',costPer:78.89}],
  'e404':[{name:'Base Coat Epoxy',sku:'EB-6127',coverage:220,unit:'gal',costPer:87.82},{name:'Grey Protectorthane (coat 1)',sku:'UT-4463',coverage:400,unit:'gal',costPer:129.79},{name:'Grey Protectorthane (coat 2)',sku:'UT-4463',coverage:400,unit:'gal',costPer:129.79}],
  'i501':[{name:'SCP Cutter',sku:'SCP-6103',coverage:300,unit:'gal',costPer:48.53},{name:'SCP Hardener',sku:'SCP-6107',coverage:400,unit:'gal',costPer:27.04},{name:'Hydro Polish',sku:'SCP-6169',coverage:750,unit:'gal',costPer:26.64},{name:'SCP Sealer',sku:'SCP-6113',coverage:2000,unit:'gal',costPer:85.57}],
  'i502':[{name:'PolyHard',sku:'IC-3018',coverage:60,unit:'kit',costPer:113.88},{name:'Super Nova',sku:'EM-4491',coverage:150,unit:'gal',costPer:143.37}],
  'i503':[{name:'PolyHard',sku:'IC-3018',coverage:60,unit:'kit',costPer:113.88},{name:'Decorative Quartz',sku:'CQ-BLD',coverage:2,unit:'lb',costPer:0.60},{name:'Perfect Poly 90',sku:'UT-4515',coverage:150,unit:'gal',costPer:129.39}],
};

// ── Merged getters (built-in + custom) ───────────────────
function getAllProducts(){return[...PRODUCTS,...(settings&&settings.customProducts||[])]}
function getAllTopcoats(){return[...TOPCOATS,...(settings&&settings.customTopcoats||[])]}
function getAllRepairs(){return[...REPAIRS,...(settings&&settings.customRepairs||[])]}
function getAllAddons(){return[...ADDONS,...(settings&&settings.customAddons||[])]}

// ── Auto-save (debounced) ────────────────────────────────
let _autoSaveTimer=null;
function autoSave(){clearTimeout(_autoSaveTimer);_autoSaveTimer=setTimeout(()=>{saveDB(db)},800)}

const STATUSES=[{id:'lead',label:'Lead',color:'lead'},{id:'estimate',label:'Estimate',color:'est'},{id:'project',label:'Project',color:'proj'},{id:'completed',label:'Completed',color:'comp'}];
const FOLDER_ICONS={lead:'&#9993;',estimate:'&#9997;',project:'&#9874;',completed:'&#10003;'};

// ── Custom Product Categories ──────────────────────────────
let customCat='products';
const CUSTOM_CATS=[
  {id:'products',label:'Products',key:'customProducts'},
  {id:'topcoats',label:'Topcoats',key:'customTopcoats'},
  {id:'repairs',label:'Repairs',key:'customRepairs'},
  {id:'addons',label:'Add-ons',key:'customAddons'}
];

function esc(s){return String(s).replace(/"/g,'&quot;').replace(/</g,'&lt;')}
// ═══════════════════════════════════════════════════════════
// SETTINGS DEFAULTS
// ═══════════════════════════════════════════════════════════
const SETTINGS_DEFAULTS={companyName:'The Concrete Protector',contactName:'',phone:'',email:'',address:'',city:'',state:'',zip:'',companyLogo:'',tagline:'Decorative Concrete Coatings',terms:'This proposal is valid for 30 days from the date shown. A 50% deposit is required to schedule the project. Balance due upon completion. All work carries a manufacturer warranty on materials used. The Concrete Protector guarantees workmanship for a period of one (1) year from date of installation. Customer is responsible for proper maintenance as outlined in care instructions provided at completion.',taxRate:0,paymentTerms:'net30',proposalValidDays:30,warrantyYears:1,warrantyText:'The Concrete Protector guarantees workmanship for a period of one (1) year from date of installation.',depositPercent:50,invoicePrefix:'INV-',invoiceNumberPadding:3,lateFeePercent:0,laborRate:0,targetMargin:0,pdfAccentR:37,pdfAccentG:99,pdfAccentB:235,pdfFontFamily:'helvetica',pdfFilePrefix:'TCP',customProducts:[],customTopcoats:[],customRepairs:[],customAddons:[],emailjsPublicKey:'',emailjsServiceId:'',emailjsTemplateId:'',estimateTemplates:[],tagPresets:['Residential','Commercial','Referral','Repeat','Insurance'],leadSourcePresets:['Website','Google','Facebook','Referral','Home Show','Repeat Customer','Yard Sign','Door Hanger'],crewMembers:[],stripeEnabled:false,stripePaymentLinkBase:'',mailchimpEnabled:false,mailchimpEmbedCode:'',bookingEnabled:false,bookingProjectTypes:['Garage Floor','Patio','Basement','Commercial','Other'],bookingNotifyEmail:'',approvalMessage:''};
function loadSettings(){try{return{...SETTINGS_DEFAULTS,...JSON.parse(localStorage.getItem(getSettingsKey()))}}catch{return{...SETTINGS_DEFAULTS}}}
function saveSettingsData(s){localStorage.setItem(getSettingsKey(),JSON.stringify(s))}
let settings=loadSettings();
// ═══════════════════════════════════════════════════════════
// UTILITIES
// ═══════════════════════════════════════════════════════════
function uid(){return Date.now().toString(36)+Math.random().toString(36).slice(2,8)}
const fmt=v=>'$'+v.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
function timeAgo(d){
  const s=Math.floor((Date.now()-d)/1e3);
  if(s<60)return'just now';if(s<3600)return Math.floor(s/60)+'m ago';
  if(s<86400)return Math.floor(s/3600)+'h ago';if(s<604800)return Math.floor(s/86400)+'d ago';
  return d.toLocaleDateString();
}
function rgbToHex(r,g,b){return'#'+[r,g,b].map(x=>x.toString(16).padStart(2,'0')).join('')}
function hexToRgb(hex){const m=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);return m?{r:parseInt(m[1],16),g:parseInt(m[2],16),b:parseInt(m[3],16)}:{r:37,g:99,b:235}}
// ═══════════════════════════════════════════════════════════
// STATE & PROFILES
// ═══════════════════════════════════════════════════════════

// Profile system
const PROFILES_KEY='ce_profiles';
const ACTIVE_PROFILE_KEY='ce_active_profile';
function getProfiles(){try{return JSON.parse(localStorage.getItem(PROFILES_KEY))||[]}catch{return[]}}
function saveProfiles(p){localStorage.setItem(PROFILES_KEY,JSON.stringify(p))}
function getActiveProfileId(){return localStorage.getItem(ACTIVE_PROFILE_KEY)||'default'}
function setActiveProfileId(id){localStorage.setItem(ACTIVE_PROFILE_KEY,id)}
function getActiveProfile(){return getProfiles().find(p=>p.id===getActiveProfileId())||null}

// Data migration: old keys → profile-scoped keys
function migrateData(){
  const profiles=getProfiles();
  if(profiles.length>0)return;
  const oldDB=localStorage.getItem('ce_database');
  const oldSettings=localStorage.getItem('ce_settings');
  if(!oldDB&&!oldSettings)return;
  const pid=uid();
  let name='Default User',email='',phone='',company='The Concrete Protector';
  try{const s=JSON.parse(oldSettings);name=s.contactName||name;email=s.email||'';phone=s.phone||'';company=s.companyName||company}catch{}
  const profile={id:pid,name,email,phone,company,city:'',state:'',pin:'',createdAt:new Date().toISOString()};
  saveProfiles([profile]);
  setActiveProfileId(pid);
  if(oldDB)localStorage.setItem('ce_database_'+pid,oldDB);
  if(oldSettings)localStorage.setItem('ce_settings_'+pid,oldSettings);
  localStorage.removeItem('ce_database');
  localStorage.removeItem('ce_settings');
}
migrateData();

// Dynamic DB/Settings keys scoped to active profile
function getDBKey(){return'ce_database_'+getActiveProfileId()}
function getSettingsKey(){return'ce_settings_'+getActiveProfileId()}
function loadDB(){try{return JSON.parse(localStorage.getItem(getDBKey()))||{records:[]}}catch{return{records:[]}}}
function saveDB(d){localStorage.setItem(getDBKey(),JSON.stringify(d))}
let db=loadDB();
let nav={screen:'home',folderStatus:null,folderActive:true,recordId:null,estimateId:null,systemId:null,invoiceId:null};
let seriesFilter='All';

// ── Profile Management Functions ─────────────────────────
function goProfileSetup(){
  document.getElementById('sidebar').style.display='none';
  document.querySelector('.hdr').style.display='none';
  showScreen('profile-setup');
}
function goProfileSelect(){
  document.getElementById('sidebar').style.display='none';
  document.querySelector('.hdr').style.display='none';
  renderProfileCards();
  showScreen('profile-select');
}
function showAppChrome(){
  document.getElementById('sidebar').style.display='';
  document.querySelector('.hdr').style.display='';
}
function createProfile(){
  const name=document.getElementById('setupName').value.trim();
  const company=document.getElementById('setupCompany').value.trim();
  if(!name||!company){toast('Required','Name and Company are required.');return}
  const profile={
    id:uid(),name,
    email:document.getElementById('setupEmail').value.trim(),
    phone:document.getElementById('setupPhone').value.trim(),
    company,
    city:document.getElementById('setupCity').value.trim(),
    state:document.getElementById('setupState').value.trim(),
    pin:document.getElementById('setupPin').value.trim(),
    createdAt:new Date().toISOString()
  };
  const profiles=getProfiles();profiles.push(profile);saveProfiles(profiles);
  setActiveProfileId(profile.id);
  const s={...SETTINGS_DEFAULTS,companyName:company,contactName:name,email:profile.email,phone:profile.phone,city:profile.city,state:profile.state};
  saveSettingsData(s);settings=s;
  db={records:[]};saveDB(db);
  showAppChrome();updateProfileBadge();goHome();toast('Welcome','Profile created. Start adding leads!');
}
function switchProfile(pid){
  const profiles=getProfiles();
  const p=profiles.find(x=>x.id===pid);
  if(!p)return;
  if(p.pin){
    const entered=prompt('Enter PIN for '+p.name+':');
    if(entered!==p.pin){toast('Denied','Incorrect PIN.');return}
  }
  setActiveProfileId(pid);
  db=loadDB();settings=loadSettings();initEmailJS();
  showAppChrome();updateProfileBadge();goHome();toast('Switched','Loaded '+p.name+'\'s workspace.');
}
function renderProfileCards(){
  const profiles=getProfiles();
  document.getElementById('profileCards').innerHTML=profiles.map(p=>{
    const ini=(p.name||'??').split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2);
    const active=p.id===getActiveProfileId();
    return'<div style="display:flex;align-items:center;gap:14px;padding:14px 16px;border:1px solid '+(active?'var(--accent)':'var(--brd)')+';border-radius:12px;margin-bottom:10px;cursor:pointer;background:var(--card);transition:border-color .2s" onclick="switchProfile(\''+p.id+'\')" onmouseover="this.style.borderColor=\'var(--accent)\'" onmouseout="this.style.borderColor=\''+(active?'var(--accent)':'var(--brd)')+'\'">'+
      '<div style="width:44px;height:44px;border-radius:10px;background:var(--accent);color:#000;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:15px;flex-shrink:0">'+ini+'</div>'+
      '<div style="text-align:left;flex:1"><div style="font-weight:600;font-size:14px">'+p.name+'</div><div style="font-size:12px;color:var(--t3)">'+p.company+(active?' \u2022 Active':'')+'</div></div>'+
      (active?'<div style="width:8px;height:8px;border-radius:50%;background:var(--success);flex-shrink:0"></div>':'')+
    '</div>'
  }).join('');
}
function updateProfileBadge(){
  const p=getActiveProfile();
  const el=document.getElementById('profileBadge');
  if(!el||!p)return;
  const ini=(p.name||'??').split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2);
  el.innerHTML='<div style="width:32px;height:32px;border-radius:8px;background:var(--accent);color:#000;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:11px;cursor:pointer" onclick="goProfileSelect()" title="Switch Profile ('+p.name+')">'+ini+'</div>';
  const sbTitle=document.querySelector('.sb-title .sub');
  if(sbTitle)sbTitle.textContent=p.company||'Coatings Estimator';
}
function deleteProfile(pid){
  const profiles=getProfiles();
  if(profiles.length<=1){toast('Error','Cannot delete the only profile.');return}
  openConfirm('Delete Profile','Delete this profile and ALL its data? This cannot be undone.',()=>{
    localStorage.removeItem('ce_database_'+pid);
    localStorage.removeItem('ce_settings_'+pid);
    const remaining=profiles.filter(p=>p.id!==pid);
    saveProfiles(remaining);
    if(getActiveProfileId()===pid){
      setActiveProfileId(remaining[0].id);
      db=loadDB();settings=loadSettings();initEmailJS();
    }
    updateProfileBadge();goProfileSelect();toast('Deleted','Profile removed.');
  });
}
// ═══════════════════════════════════════════════════════════
// NAVIGATION
// ═══════════════════════════════════════════════════════════
function showScreen(id){window.scrollTo({top:0,behavior:'smooth'})}
function goHome(){Object.assign(nav,{screen:'home',folderStatus:null,folderActive:true,recordId:null,estimateId:null,systemId:null,invoiceId:null});renderBreadcrumb();renderHome();showScreen('home');updateSidebarActive();closeMobileSidebar()}
function goFolder(s,a){nav.screen='list';nav.folderStatus=s;nav.folderActive=a;nav.recordId=null;nav.estimateId=null;nav.systemId=null;renderBreadcrumb();renderList();showScreen('list');updateSidebarActive();closeMobileSidebar()}
function goRecord(id){nav.screen='record';nav.recordId=id;nav.estimateId=null;nav.systemId=null;renderBreadcrumb();renderRecord();showScreen('record');updateSidebarActive()}
function goEstimate(id){nav.screen='estimate';nav.estimateId=id;nav.systemId=null;renderBreadcrumb();renderEstimate();showScreen('estimate');updateSidebarActive()}
function goSystem(id){nav.screen='system';nav.systemId=id;renderBreadcrumb();renderSystem();showScreen('system');updateSidebarActive()}
function goInvoice(id){nav.screen='invoice';nav.invoiceId=id;renderBreadcrumb();renderInvoice();showScreen('invoice');updateSidebarActive()}
function goReporting(){Object.assign(nav,{screen:'reporting',folderStatus:null,folderActive:true,recordId:null,estimateId:null,systemId:null,invoiceId:null});renderBreadcrumb();renderReporting();showScreen('reporting');updateSidebarActive()}
function goSettings(){Object.assign(nav,{screen:'settings',folderStatus:null,folderActive:true,recordId:null,estimateId:null,systemId:null,invoiceId:null});renderBreadcrumb();renderSettings();showScreen('settings');updateSidebarActive()}
function newRecordFromHeader(){nav.folderStatus='lead';nav.folderActive=true;newRecord()}
let estTab='areas';
function switchEstTab(tab){
  estTab=tab;
  document.querySelectorAll('#estTabs .tab-btn').forEach(b=>b.classList.remove('ac'));
  document.querySelector('#estTabs .tab-btn[onclick*="'+tab+'"]').classList.add('ac');
  document.getElementById('estTabAreas').style.display=tab==='areas'?'':'none';
  document.getElementById('estTabOrderlist').style.display=tab==='orderlist'?'':'none';
  document.getElementById('estTabContract').style.display=tab==='contract'?'':'none';
  document.getElementById('estTabInvoices').style.display=tab==='invoices'?'':'none';
  if(tab==='orderlist')renderOrderList();
  if(tab==='contract')initSignaturePads();
  if(tab==='invoices')renderInvoicesList();
}

function renderBreadcrumb(){
  const el=document.getElementById('breadcrumb');
  let p=['<span onclick="goHome()">Home</span>'];
  if(nav.folderStatus){const st=STATUSES.find(s=>s.id===nav.folderStatus);p.push('<span class="sep">&#8250;</span>','<span onclick="goFolder(\''+nav.folderStatus+'\','+nav.folderActive+')">'+(nav.folderActive?'':'Inactive ')+st.label+'s</span>')}
  if(nav.recordId){const r=db.records.find(r=>r.id===nav.recordId);if(r){p.push('<span class="sep">&#8250;</span>','<span onclick="goRecord(\''+r.id+'\')">'+(r.firstName||r.lastName?r.firstName+' '+r.lastName:'Unnamed').trim()+'</span>')}}
  if(nav.estimateId){const r=db.records.find(r=>r.id===nav.recordId);const e=r?r.estimates.find(e=>e.id===nav.estimateId):null;if(e){p.push('<span class="sep">&#8250;</span>','<span onclick="goEstimate(\''+e.id+'\')">'+(e.name||'Estimate')+'</span>')}}
  if(nav.systemId){const r=db.records.find(r=>r.id===nav.recordId);const e=r?r.estimates.find(e=>e.id===nav.estimateId):null;const s=e?e.systems.find(s=>s.id===nav.systemId):null;if(s)p.push('<span class="sep">&#8250;</span>','<span class="current">'+(s.areaName||'New Area')+'</span>')}
  if(nav.invoiceId){const inv=getInvoiceById(nav.invoiceId);if(inv)p.push('<span class="sep">&#8250;</span>','<span class="current">'+inv.number+'</span>')}
  if(nav.screen==='reporting')p.push('<span class="sep">&#8250;</span>','<span class="current">Reports</span>');
  if(nav.screen==='invoices-all')p.push('<span class="sep">&#8250;</span>','<span class="current">Invoices</span>');
  if(nav.screen==='settings')p.push('<span class="sep">&#8250;</span>','<span class="current">Settings</span>');
  if(nav.screen==='calendar')p.push('<span class="sep">&#8250;</span>','<span class="current">Calendar</span>');
  el.innerHTML=p.join('');
}

// ═══════════════════════════════════════════════════════════
// COST HELPERS
// ═══════════════════════════════════════════════════════════
function calcSysCosts(sys){
  const sqft=sys.sqft||0;
  const sr=sys.sellRate||0;
  const prod=getAllProducts().find(p=>p.id===sys.productId);
  const tc=getAllTopcoats().find(t=>t.id===sys.topcoatId);
  let sellTotal=sqft*sr;
  let costTotal=(prod?prod.cost*sqft:0)+(tc?tc.cost*sqft:0);
  if(sys.repairs){Object.entries(sys.repairs).forEach(([id,r])=>{if(r.on){const def=getAllRepairs().find(x=>x.id===id);if(def){const qty=r.qty||0;costTotal+=def.cost*qty;sellTotal+=((r.sell||0)*qty)}}})}
  if(sys.addons){Object.entries(sys.addons).forEach(([id,a])=>{if(a.on){const def=getAllAddons().find(x=>x.id===id);if(def){const qty=a.qty||0;costTotal+=def.cost*qty;sellTotal+=((a.sell||0)*qty)}}})}
  if(sys.customLineItems){sys.customLineItems.forEach(li=>{sellTotal+=(li.qty||0)*(li.rate||0)})}
  const taxRate=settings.taxRate||0;
  const taxable=sys.taxable!==false;
  const taxAmount=(taxable&&taxRate>0)?(sellTotal*taxRate/100):0;
  return{sell:sellTotal,cost:costTotal,profit:sellTotal-costTotal,margin:sellTotal>0?((sellTotal-costTotal)/sellTotal*100):0,taxAmount,sellWithTax:sellTotal+taxAmount};
}
function calcEstCosts(est){
  let sell=0,cost=0,tax=0;
  est.systems.forEach(sys=>{const c=calcSysCosts(sys);sell+=c.sell;cost+=c.cost;tax+=c.taxAmount});
  return{sell,cost,profit:sell-cost,margin:sell>0?((sell-cost)/sell*100):0,sqft:est.systems.reduce((s,sys)=>s+(sys.sqft||0),0),taxAmount:tax,totalWithTax:sell+tax};
}
function calcRecCosts(rec){
  let sell=0,cost=0,tax=0;
  rec.estimates.forEach(est=>{const c=calcEstCosts(est);sell+=c.sell;cost+=c.cost;tax+=c.taxAmount});
  return{sell,cost,taxAmount:tax,totalWithTax:sell+tax};
}

// ═══════════════════════════════════════════════════════════
// ACTIVITY LOG
// ═══════════════════════════════════════════════════════════
function logActivity(recordId,type,message){
  const rec=db.records.find(r=>r.id===recordId);if(!rec)return;
  if(!rec.activityLog)rec.activityLog=[];
  rec.activityLog.unshift({id:uid(),timestamp:new Date().toISOString(),type,message});
  rec.updatedAt=new Date().toISOString();
}

// ═══════════════════════════════════════════════════════════
// SIDEBAR
// ═══════════════════════════════════════════════════════════
function toggleSidebar(){
  const sb=document.getElementById('sidebar');
  sb.classList.toggle('collapsed');
  document.body.classList.toggle('sb-collapsed');
  const btn=sb.querySelector('.sb-toggle');
  btn.innerHTML=sb.classList.contains('collapsed')?'&#9654;':'&#9664;';
  localStorage.setItem('ce_sidebar_collapsed',sb.classList.contains('collapsed'));
}
function updateSidebarActive(){
  document.querySelectorAll('#sidebar .sb-item').forEach(el=>el.classList.remove('active'));
  let screen=nav.screen;
  if(screen==='list'||screen==='record'||screen==='estimate'||screen==='system'){
    const item=document.querySelector('#sidebar .sb-item[data-screen="'+nav.folderStatus+'"]');
    if(item)item.classList.add('active');
  }else{
    const item=document.querySelector('#sidebar .sb-item[data-screen="'+screen+'"]');
    if(item)item.classList.add('active');
  }
}
function toggleMobileSidebar(){
  const sb=document.getElementById('sidebar');
  sb.classList.toggle('mobile-open');
  document.getElementById('sbOverlay').classList.toggle('active');
}
function closeMobileSidebar(){
  document.getElementById('sidebar').classList.remove('mobile-open');
  document.getElementById('sbOverlay').classList.remove('active');
}
function initSidebar(){
  if(localStorage.getItem('ce_sidebar_collapsed')==='true'){
    document.getElementById('sidebar').classList.add('collapsed');
    document.body.classList.add('sb-collapsed');
    document.querySelector('#sidebar .sb-toggle').innerHTML='&#9654;';
  }
}

// ── Keyboard Shortcuts ──────────────────────────────────────
document.addEventListener('keydown',function(e){
  if(e.key==='Escape'){
    closeConfirm();closeExport();closeImport();closePaymentModal();
    const gs=document.getElementById('globalSearchResults');if(gs)gs.style.display='none';
  }
  if((e.metaKey||e.ctrlKey)&&e.key==='s'){
    e.preventDefault();
    if(nav.screen==='system')saveSystem();
    else if(nav.screen==='estimate')saveEstimate();
    else if(nav.screen==='record')saveRecord();
    else if(nav.screen==='settings')saveSettings();
  }
});
document.addEventListener('click',function(e){
  const gs=document.getElementById('globalSearchResults');
  const gi=document.getElementById('globalSearch');
  if(gs&&gi&&!gs.contains(e.target)&&e.target!==gi)gs.style.display='none';
});
// ═══════════════════════════════════════════════════════════
// HOME
// ═══════════════════════════════════════════════════════════
function renderHome(){
  // Greeting
  const now=new Date();const hour=now.getHours();
  const greeting=hour<12?'Good morning':hour<17?'Good afternoon':'Good evening';
  const dateStr=now.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});
  document.getElementById('homeGreeting').innerHTML='<div style="font-size:13px;color:var(--t3);margin-bottom:4px">'+dateStr+'</div><h2 style="font-size:22px;font-weight:700;letter-spacing:-.5px;margin-bottom:20px">'+greeting+'</h2>';
  // Counts and values
  const c={};const vals={};
  STATUSES.forEach(s=>{c[s.id]={active:0,inactive:0};vals[s.id]=0});
  db.records.forEach(r=>{if(c[r.status]){c[r.status][r.active?'active':'inactive']++;if(r.active)vals[r.status]+=calcRecCosts(r).totalWithTax}});
  // Workflow cards — enhanced with contextual counts
  const todayStr=new Date().toISOString().slice(0,10);
  const newToday=db.records.filter(r=>r.status==='lead'&&r.active&&r.createdAt&&r.createdAt.slice(0,10)===todayStr).length;
  const quotesSent=db.records.filter(r=>r.status==='estimate'&&r.active).reduce((s,r)=>s+r.estimates.filter(e=>e.quoteStatus==='sent').length,0);
  const next7=new Date();next7.setDate(next7.getDate()+7);const next7Str=next7.toISOString().slice(0,10);
  const startingSoon=db.records.filter(r=>r.status==='project'&&r.active&&r.projectStartDate&&r.projectStartDate>=todayStr&&r.projectStartDate<=next7Str).length;
  document.getElementById('workflowCards').innerHTML=
    '<div class="wf-card lead" onclick="goFolder(\'lead\',true)"><div class="wf-num">'+c.lead.active+'</div><div class="wf-label">New Leads</div><div class="wf-links"><div class="wf-link" onclick="event.stopPropagation();goFolder(\'lead\',true)"><span>Active</span><span class="wf-val">'+c.lead.active+'</span></div>'+(newToday?'<div class="wf-link"><span style="color:var(--lead)">New today</span><span class="wf-val" style="color:var(--lead)">'+newToday+'</span></div>':'<div class="wf-link" onclick="event.stopPropagation();goFolder(\'lead\',false)"><span>Archived</span><span class="wf-val">'+c.lead.inactive+'</span></div>')+'</div></div>'+
    '<div class="wf-card est" onclick="goFolder(\'estimate\',true)"><div class="wf-num">'+c.estimate.active+'</div><div class="wf-label">Estimates</div><div class="wf-links"><div class="wf-link"><span>Pipeline</span><span class="wf-val">'+fmt(vals.estimate)+'</span></div>'+(quotesSent?'<div class="wf-link"><span style="color:var(--info)">Quotes sent</span><span class="wf-val" style="color:var(--info)">'+quotesSent+'</span></div>':'<div class="wf-link" onclick="event.stopPropagation();goFolder(\'estimate\',true)"><span>Active</span><span class="wf-val">'+c.estimate.active+'</span></div>')+'</div></div>'+
    '<div class="wf-card proj" onclick="goFolder(\'project\',true)"><div class="wf-num">'+c.project.active+'</div><div class="wf-label">Projects</div><div class="wf-links"><div class="wf-link"><span>Value</span><span class="wf-val">'+fmt(vals.project)+'</span></div>'+(startingSoon?'<div class="wf-link"><span style="color:var(--proj)">Starting soon</span><span class="wf-val" style="color:var(--proj)">'+startingSoon+'</span></div>':'<div class="wf-link" onclick="event.stopPropagation();goFolder(\'project\',true)"><span>Active</span><span class="wf-val">'+c.project.active+'</span></div>')+'</div></div>'+
    '<div class="wf-card comp" onclick="goFolder(\'completed\',true)"><div class="wf-num">'+c.completed.active+'</div><div class="wf-label">Completed</div><div class="wf-links"><div class="wf-link" onclick="event.stopPropagation();invFilter=\'invoiced\';goFolder(\'completed\',true)"><span>Invoiced</span><span class="wf-val">'+db.records.filter(r=>r.status==='completed'&&r.active&&isRecordInvoiced(r)).length+'</span></div><div class="wf-link" onclick="event.stopPropagation();invFilter=\'need\';goFolder(\'completed\',true)"><span style="color:var(--accent)">Need Invoiced</span><span class="wf-val" style="color:var(--accent)">'+db.records.filter(r=>r.status==='completed'&&r.active&&!isRecordInvoiced(r)).length+'</span></div></div></div>';
  // Overdue alert
  const overdueInvs=getAllInvoices().filter(x=>x.invoice.status==='overdue');
  if(overdueInvs.length){
    const overdueTotal=overdueInvs.reduce((s,x)=>s+x.invoice.balance,0);
    document.getElementById('overdueAlert').innerHTML='<div onclick="goAllInvoices()" style="padding:14px 18px;border-radius:12px;border:1px solid rgba(248,113,113,.3);background:rgba(248,113,113,.08);cursor:pointer;margin-bottom:16px;display:flex;align-items:center;gap:12px"><div style="font-size:24px">\u26A0</div><div><div style="font-weight:600;font-size:14px;color:#f87171">'+overdueInvs.length+' Overdue Invoice'+(overdueInvs.length>1?'s':'')+'</div><div style="font-size:12px;color:var(--t3)">'+fmt(overdueTotal)+' outstanding \u2014 click to view</div></div></div>';
  }else{document.getElementById('overdueAlert').innerHTML=''}
  // Recent Activity
  const recent=db.records.slice().sort((a,b)=>new Date(b.updatedAt||b.createdAt)-new Date(a.updatedAt||a.createdAt)).slice(0,6);
  if(recent.length){
    document.getElementById('recentActivity').innerHTML=recent.map(r=>{
      const name=((r.firstName||'')+' '+(r.lastName||'')).trim()||'Unnamed';
      const ago=timeAgo(new Date(r.updatedAt||r.createdAt));
      return'<div class="list-item" onclick="goFolder(\''+r.status+'\','+r.active+');setTimeout(()=>goRecord(\''+r.id+'\'),50)" style="margin-bottom:4px;padding:10px 14px"><div class="li-left"><div class="li-avatar '+r.status+'" style="width:32px;height:32px;font-size:11px;border-radius:8px">'+((r.firstName||'?')[0]+(r.lastName||'?')[0]).toUpperCase()+'</div><div><div class="li-name" style="font-size:13px">'+name+'</div><div class="li-meta">'+ago+'</div></div></div><div class="li-right"><div class="li-badge '+r.status+'">'+r.status+'</div></div></div>'
    }).join('');
  }else{document.getElementById('recentActivity').innerHTML='<div class="empty"><div class="empty-text">No activity yet. Create your first lead!</div></div>'}
  // Follow-ups due
  renderFollowUpSection();
  // Business Performance with Trends
  const activeRecs=db.records.filter(r=>r.active);
  const totalPipeline=activeRecs.reduce((s,r)=>s+calcRecCosts(r).totalWithTax,0);
  const completedRecs=activeRecs.filter(r=>r.status==='completed');
  const totalRevenue=completedRecs.reduce((s,r)=>s+calcRecCosts(r).totalWithTax,0);
  const avgJob=completedRecs.length>0?totalRevenue/completedRecs.length:0;
  // Monthly revenue trend
  const mNow=new Date();const mStart=new Date(mNow.getFullYear(),mNow.getMonth(),1).toISOString().slice(0,10);
  const mPrevStart=new Date(mNow.getFullYear(),mNow.getMonth()-1,1).toISOString().slice(0,10);
  const mPrevEnd=new Date(mNow.getFullYear(),mNow.getMonth(),0).toISOString().slice(0,10);
  const thisMonthRev=completedRecs.filter(r=>r.updatedAt&&r.updatedAt.slice(0,10)>=mStart).reduce((s,r)=>s+calcRecCosts(r).totalWithTax,0);
  const lastMonthRev=completedRecs.filter(r=>r.updatedAt&&r.updatedAt.slice(0,10)>=mPrevStart&&r.updatedAt.slice(0,10)<=mPrevEnd).reduce((s,r)=>s+calcRecCosts(r).totalWithTax,0);
  const revTrend=lastMonthRev>0?Math.round((thisMonthRev-lastMonthRev)/lastMonthRev*100):0;
  const revArrow=revTrend>0?'<span style="color:var(--success);font-size:11px"> &#9650; '+revTrend+'%</span>':revTrend<0?'<span style="color:#f87171;font-size:11px"> &#9660; '+Math.abs(revTrend)+'%</span>':'';
  // Win rate
  const quoteSent=db.records.filter(r=>r.active&&r.estimates.some(e=>e.quoteStatus==='sent'||e.quoteStatus==='approved'||e.quoteStatus==='declined'));
  const approved=db.records.filter(r=>r.active&&r.estimates.some(e=>e.quoteStatus==='approved')).length;
  const declined=db.records.filter(r=>r.active&&r.estimates.some(e=>e.quoteStatus==='declined')).length;
  const winRate=approved+declined>0?Math.round(approved/(approved+declined)*100):0;
  // Avg days to close
  const closedRecs=completedRecs.filter(r=>r.createdAt);
  const avgClose=closedRecs.length>0?Math.round(closedRecs.reduce((s,r)=>{const d=(new Date(r.updatedAt||r.createdAt)-new Date(r.createdAt))/(1000*60*60*24);return s+Math.max(0,d)},0)/closedRecs.length):0;
  document.getElementById('perfCards').innerHTML=
    '<div class="sx hl"><div class="sl">Active Pipeline</div><div class="sv">'+fmt(totalPipeline)+'</div></div>'+
    '<div class="sx"><div class="sl">This Month'+revArrow+'</div><div class="sv" style="color:var(--success)">'+fmt(thisMonthRev)+'</div></div>'+
    '<div class="sx"><div class="sl">Total Revenue</div><div class="sv">'+fmt(totalRevenue)+'</div></div>'+
    '<div class="sx"><div class="sl">Win Rate</div><div class="sv">'+(winRate?winRate+'%':'\u2014')+'</div></div>'+
    '<div class="sx"><div class="sl">Avg Close</div><div class="sv">'+(avgClose?avgClose+' days':'\u2014')+'</div></div>'+
    '<div class="sx"><div class="sl">Avg Job Size</div><div class="sv">'+fmt(avgJob)+'</div></div>';
  // Lead Source breakdown
  const lsData={};
  activeRecs.forEach(r=>{if(r.leadSource){lsData[r.leadSource]=(lsData[r.leadSource]||0)+1}});
  if(Object.keys(lsData).length>0){
    const sorted=Object.entries(lsData).sort((a,b)=>b[1]-a[1]).slice(0,5);
    const maxCount=sorted[0][1];
    document.getElementById('leadSourceChart').innerHTML='<div style="font-size:12px;font-weight:600;color:var(--t3);text-transform:uppercase;letter-spacing:.8px;margin-bottom:10px">Top Lead Sources</div>'+sorted.map(([src,count])=>'<div class="bar-row"><div class="bar-label">'+esc(src)+'</div><div class="bar-track"><div class="bar-fill" style="width:'+Math.round(count/maxCount*100)+'%"></div></div><div class="bar-val">'+count+'</div></div>').join('');
  }else{document.getElementById('leadSourceChart').innerHTML=''}
  // Archived folders (hidden by default)
  document.getElementById('inactiveFolders').innerHTML=STATUSES.map(s=>'<div class="folder '+s.color+' inactive" onclick="goFolder(\''+s.id+'\',false)" style="padding:16px"><div class="f-icon" style="margin-bottom:8px;width:32px;height:32px;font-size:14px">'+FOLDER_ICONS[s.id]+'</div><div class="f-count" style="font-size:20px">'+c[s.id].inactive+'</div><div class="f-label" style="font-size:11px">Inactive '+s.label+'s</div></div>').join('');
}
function toggleArchived(){
  const el=document.getElementById('archivedSection');
  el.style.display=el.style.display==='none'?'block':'none';
}
function globalSearchRender(){
  const q=(document.getElementById('globalSearch').value||'').toLowerCase().trim();
  const box=document.getElementById('globalSearchResults');
  if(!q||q.length<2){box.style.display='none';return}
  const results=db.records.filter(r=>[r.firstName,r.lastName,r.company,r.address,r.city,r.email,r.phone,r.notes].join(' ').toLowerCase().includes(q)).slice(0,8);
  if(!results.length){box.innerHTML='<div style="padding:12px;font-size:12px;color:var(--t4)">No results found.</div>';box.style.display='block';return}
  box.innerHTML=results.map(r=>{
    const name=((r.firstName||'')+' '+(r.lastName||'')).trim()||'Unnamed';
    const ini=((r.firstName||'?')[0]+(r.lastName||'?')[0]).toUpperCase();
    const meta=[r.company,r.city,r.phone].filter(Boolean).join(' \u00b7 ');
    return'<div class="list-item" onclick="document.getElementById(\'globalSearch\').value=\'\';document.getElementById(\'globalSearchResults\').style.display=\'none\';goFolder(\''+r.status+'\','+r.active+');setTimeout(()=>goRecord(\''+r.id+'\'),50)" style="padding:10px 14px;cursor:pointer"><div class="li-left"><div class="li-avatar '+r.status+'" style="width:28px;height:28px;font-size:10px;border-radius:6px">'+ini+'</div><div><div class="li-name" style="font-size:13px">'+name+'</div><div class="li-meta">'+meta+'</div></div></div><div class="li-right"><div class="li-badge '+r.status+'" style="font-size:10px">'+r.status+'</div></div></div>'
  }).join('');
  box.style.display='block';
}

// ═══════════════════════════════════════════════════════════
// LIST
// ═══════════════════════════════════════════════════════════
let invFilter='all';let batchMode=false;let batchSelected=new Set();
function toggleBatchMode(){
  batchMode=!batchMode;batchSelected.clear();
  document.getElementById('batchBar').style.display=batchMode?'':'none';
  document.getElementById('batchToggleBtn').textContent=batchMode?'Cancel':'Select';
  filterList();
}
function toggleBatchItem(id,ev){
  ev.stopPropagation();if(batchSelected.has(id))batchSelected.delete(id);else batchSelected.add(id);
  document.getElementById('batchCount').textContent=batchSelected.size+' selected';
  document.getElementById('bc-'+id).checked=batchSelected.has(id);
}
function batchMoveStatus(){
  if(!batchSelected.size)return;
  const target=document.getElementById('batchStatusTarget').value;
  batchSelected.forEach(id=>{const r=db.records.find(x=>x.id===id);if(r){logActivity(r.id,'status_change','Moved to '+target+' (batch)');r.status=target;r.updatedAt=new Date().toISOString()}});
  saveDB(db);toggleBatchMode();filterList();toast('Batch Update',batchSelected.size+' record(s) moved to '+target+'.');
}
function batchArchive(){
  if(!batchSelected.size)return;
  const n=batchSelected.size;
  batchSelected.forEach(id=>{const r=db.records.find(x=>x.id===id);if(r){r.active=false;r.updatedAt=new Date().toISOString();logActivity(r.id,'archived','Archived (batch)')}});
  saveDB(db);toggleBatchMode();filterList();toast('Archived',n+' record(s) archived.');
}
function batchDelete(){
  if(!batchSelected.size)return;
  const n=batchSelected.size;
  openConfirm('Batch Delete','Permanently delete '+n+' record(s)? This cannot be undone.',()=>{
    batchSelected.forEach(id=>{db.records=db.records.filter(r=>r.id!==id)});
    saveDB(db);toggleBatchMode();filterList();toast('Deleted',n+' record(s) deleted.');
  });
}
function isRecordInvoiced(r){
  if(!r.estimates.length)return false;
  return r.estimates.every(e=>e.invoices&&e.invoices.length>0);
}
function quickInvoiceRecord(recId){
  const rec=db.records.find(r=>r.id===recId);if(!rec)return;
  // Find first estimate without an invoice
  const est=rec.estimates.find(e=>!e.invoices||!e.invoices.length);
  if(!est){goRecord(recId);return}
  // Navigate to the record/estimate and create an invoice
  nav.recordId=recId;nav.folderStatus=rec.status;nav.folderActive=rec.active;nav.estimateId=est.id;
  // Create the invoice automatically
  if(!est.invoices)est.invoices=[];
  const ec=calcEstCosts(est);
  const items=est.systems.map(sys=>{const sc=calcSysCosts(sys);const prod=getAllProducts().find(p=>p.id===sys.productId);return{description:(sys.areaName||'Area')+' \u2014 '+(prod?prod.name:'Custom')+' ('+sys.sqft+' sqft)',qty:1,unit:'ea',rate:sc.sell,amount:sc.sell,taxable:sys.taxable!==false}});
  const termDays={due_on_receipt:0,net15:15,net30:30,net60:60};
  const due=new Date();due.setDate(due.getDate()+(termDays[settings.paymentTerms]||30));
  const inv={id:uid(),number:getNextInvoiceNumber(),createdAt:new Date().toISOString(),dueDate:due.toISOString().slice(0,10),status:'draft',type:'standard',lineItems:items,subtotal:ec.sell,taxRate:settings.taxRate||0,taxAmount:ec.taxAmount,total:ec.sell+ec.taxAmount,depositPercent:null,discountType:'none',discountValue:0,discountAmount:0,payments:[],amountPaid:0,balance:ec.sell+ec.taxAmount,notes:'',sentAt:null};
  est.invoices.push(inv);
  logActivity(rec.id,'invoice_created','Invoice '+inv.number+' created ('+fmt(inv.total)+')');
  saveDB(db);goInvoice(inv.id);toast('Invoice Created',inv.number+' for '+(est.name||'Estimate'));
}
function setInvFilter(f){
  invFilter=f;
  document.querySelectorAll('#invoiceFilterBar .tab-btn').forEach(b=>b.classList.remove('ac'));
  document.querySelector('#invoiceFilterBar .tab-btn[onclick*="\''+f+'\'"]').classList.add('ac');
  filterList();
}
function renderList(){
  const st=STATUSES.find(s=>s.id===nav.folderStatus);
  const prefix=nav.folderActive?'':'Inactive ';
  document.getElementById('listHeader').innerHTML='<h2>'+prefix+st.label+'s</h2><p>'+getListDesc(st.id,nav.folderActive)+'</p>';
  document.getElementById('newLeadBtn').style.display=(nav.folderStatus==='lead'&&nav.folderActive)?'':'none';
  // Show invoice filter bar only for Completed
  const showInvFilter=(nav.folderStatus==='completed'&&nav.folderActive);
  document.getElementById('invoiceFilterBar').style.display=showInvFilter?'':'none';
  if(!showInvFilter)invFilter='all';
  document.getElementById('searchInput').value='';populateTagFilter();filterList();
}
function getListDesc(s,a){if(!a)return'Archived records.';return{lead:'New contacts and inquiries.',estimate:'Leads with quotes ready for review.',project:'Jobs on your calendar.',completed:'Finished jobs.'}[s]||''}
function filterList(){
  const q=(document.getElementById('searchInput').value||'').toLowerCase();
  const tagVal=(document.getElementById('tagFilter')||{}).value||'';
  let items=db.records.filter(r=>r.status===nav.folderStatus&&r.active===nav.folderActive);
  // Apply invoice sub-filter for Completed
  if(nav.folderStatus==='completed'&&invFilter==='invoiced')items=items.filter(r=>isRecordInvoiced(r));
  if(nav.folderStatus==='completed'&&invFilter==='need')items=items.filter(r=>!isRecordInvoiced(r));
  if(tagVal)items=items.filter(r=>(r.tags||[]).includes(tagVal));
  const f=q?items.filter(r=>[r.firstName,r.lastName,r.company,r.address,r.city,r.email,r.phone,r.notes].join(' ').toLowerCase().includes(q)):items;
  if(!f.length){document.getElementById('listItems').innerHTML='<div class="empty"><div class="empty-icon">&#128194;</div><div class="empty-text">'+(invFilter!=='all'?'No records match this filter.':'No records here yet.')+'</div></div>';return}
  document.getElementById('listItems').innerHTML=f.map(r=>{
    const name=(r.firstName||'')+' '+(r.lastName||'');
    const ini=((r.firstName||'?')[0]+(r.lastName||'?')[0]).toUpperCase();
    const ec=r.estimates.length;
    const tot=calcRecCosts(r).totalWithTax;
    const invoiced=isRecordInvoiced(r);
    const invLabel=r.status==='completed'?(invoiced?'<span style="color:var(--success);font-size:11px;margin-left:6px">INVOICED</span>':'<span style="color:var(--accent);font-size:11px;margin-left:6px">NEED INVOICED</span>'):'';
    const meta=[r.company,r.city&&r.state?r.city+', '+r.state:r.city||r.state,ec?ec+' estimate'+(ec>1?'s':''):''].filter(Boolean).join(' \u00b7 ');
    const invoiceBtn=r.status==='completed'&&!invoiced?'<button class="btn btn-primary" onclick="event.stopPropagation();quickInvoiceRecord(\''+r.id+'\')" style="font-size:11px;padding:4px 12px;white-space:nowrap">Invoice</button>':'';
    const batchCb=batchMode?'<input type="checkbox" id="bc-'+r.id+'" '+(batchSelected.has(r.id)?'checked':'')+' onclick="toggleBatchItem(\''+r.id+'\',event)" style="width:18px;height:18px;margin-right:8px;flex-shrink:0;cursor:pointer">':'';
    return'<div class="list-item" onclick="'+(batchMode?'toggleBatchItem(\''+r.id+'\',event)':'goRecord(\''+r.id+'\')')+'"><div class="li-left">'+batchCb+'<div class="li-avatar '+r.status+'">'+ini+'</div><div><div class="li-name">'+name.trim()+invLabel+'</div><div class="li-meta">'+meta+(r.leadSource?' <span style="color:var(--accent);font-size:11px">\u25CF '+esc(r.leadSource)+'</span>':'')+'</div></div></div><div class="li-right" style="display:flex;align-items:center;gap:8px">'+invoiceBtn+(tot>0?'<div class="li-amount">'+fmt(tot)+'</div>':'')+'<div class="li-badge '+r.status+'">'+r.status+'</div></div></div>'
  }).join('');
}

// ═══════════════════════════════════════════════════════════
// RECORD
// ═══════════════════════════════════════════════════════════
function getRecord(){return db.records.find(r=>r.id===nav.recordId)}
function renderRecord(){
  const rec=getRecord();if(!rec){goHome();return}
  const name=((rec.firstName||'')+' '+(rec.lastName||'')).trim()||'New Lead';
  // Stage-aware header
  const recTotal=calcRecCosts(rec);
  let headerSub='';
  if(rec.status==='lead')headerSub='<span class="li-badge lead" style="font-size:10px">New Lead</span>';
  else if(rec.status==='estimate'){const ec=rec.estimates.length;const sent=rec.estimates.filter(e=>e.quoteStatus==='sent').length;headerSub='<span style="font-size:12px;color:var(--t3)">'+ec+' estimate'+(ec!==1?'s':'')+' \u00b7 '+fmt(recTotal.totalWithTax)+(sent?' \u00b7 '+sent+' sent':'')+'</span>'}
  else if(rec.status==='project'){const sd=rec.projectStartDate;const ed=rec.projectEndDate;headerSub=sd?'<span style="font-size:12px;color:var(--t3)">'+new Date(sd+'T12:00').toLocaleDateString('en-US',{month:'short',day:'numeric'})+(ed?' \u2013 '+new Date(ed+'T12:00').toLocaleDateString('en-US',{month:'short',day:'numeric'}):'')+'</span>':'<span style="font-size:12px;color:var(--accent)">Unscheduled</span>'}
  else if(rec.status==='completed'){const inv=isRecordInvoiced(rec);headerSub='<span style="font-size:12px;color:var(--t3)">'+fmt(recTotal.totalWithTax)+(inv?' \u00b7 <span style="color:var(--success)">Invoiced</span>':' \u00b7 <span style="color:var(--accent)">Needs Invoice</span>')+'</span>'}
  document.getElementById('recordHeader').innerHTML='<h2>'+name+'</h2>'+(rec.company?'<p style="color:var(--t3);font-size:13px;margin-bottom:2px">'+rec.company+'</p>':'')+headerSub;
  document.getElementById('statusPills').innerHTML=STATUSES.map(s=>'<button class="status-pill '+s.color+(rec.status===s.id?' active':'')+'" onclick="changeStatus(\''+s.id+'\')">'+s.label+'</button>').join('');
  document.getElementById('recActive').checked=rec.active;
  renderDuplicateWarning();
  // Project details card
  const showProject=rec.status==='project'||rec.status==='completed';
  document.getElementById('projectDetailsCard').style.display=showProject?'':'none';
  if(showProject){document.getElementById('recStartDate').value=rec.projectStartDate||'';document.getElementById('recEndDate').value=rec.projectEndDate||'';document.getElementById('recScheduledTime').value=rec.scheduledTime||'';document.getElementById('recScheduledDuration').value=rec.scheduledDuration||'';const crewSel=document.getElementById('recAssignedCrew');crewSel.innerHTML='<option value="">-- None --</option>'+(settings.crewMembers||[]).map(c=>'<option value="'+c.id+'"'+(rec.assignedCrew===c.id?' selected':'')+'>'+esc(c.name)+'</option>').join('');document.getElementById('recProjectNotes').value=rec.projectNotes||''}
  // Next action bar
  renderNextAction(rec);
  document.getElementById('recFirst').value=rec.firstName||'';
  document.getElementById('recLast').value=rec.lastName||'';
  document.getElementById('recCompany').value=rec.company||'';
  document.getElementById('recEmail').value=rec.email||'';
  document.getElementById('recPhone').value=rec.phone||'';
  document.getElementById('recPhoneType').value=rec.phoneType||'cell';
  document.getElementById('recBestTime').value=rec.bestTimeToCall||'';
  document.getElementById('recAddress').value=rec.address||'';
  document.getElementById('recCity').value=rec.city||'';
  document.getElementById('recState').value=rec.state||'';
  document.getElementById('recZip').value=rec.zip||'';
  document.getElementById('recNotes').value=rec.notes||'';
  // Follow-up
  document.getElementById('recFollowUpDate').value=rec.followUpDate||'';
  document.getElementById('recFollowUpNote').value=rec.followUpNote||'';
  renderFollowUpStatus();renderTagBar();
  // Lead source dropdown
  const lsEl=document.getElementById('recLeadSource');
  if(lsEl){
    const sources=settings.leadSourcePresets||[];
    lsEl.innerHTML='<option value="">-- Select --</option>'+sources.map(s=>'<option value="'+esc(s)+'"'+(rec.leadSource===s?' selected':'')+'>'+esc(s)+'</option>').join('')+((rec.leadSource&&!sources.includes(rec.leadSource))?'<option value="'+esc(rec.leadSource)+'" selected>'+esc(rec.leadSource)+'</option>':'');
  }
  renderEstimatesList(rec);renderActivityLog();renderQuickContactBtns();
}
function renderEstimatesList(rec){
  const cmpBtn=document.getElementById('compareEstBtn');if(cmpBtn)cmpBtn.style.display=rec.estimates.length>=2?'':'none';
  if(!rec.estimates.length){document.getElementById('estimatesList').innerHTML='<div class="empty"><div class="empty-icon">&#9997;</div><div class="empty-text">No estimates yet.</div><button class="btn btn-primary" onclick="newEstimate()" style="margin-top:10px">+ Create Estimate</button></div>';return}
  document.getElementById('estimatesList').innerHTML=rec.estimates.map(est=>{
    const ec=calcEstCosts(est);
    const areas=est.systems.map(s=>s.areaName||'Unnamed').join(', ');
    const hasInv=est.invoices&&est.invoices.length>0;
    const invStatus=rec.status==='completed'?(hasInv?' <span style="color:var(--success);font-size:11px">INVOICED</span>':' <span style="color:var(--accent);font-size:11px">NEEDS INVOICE</span>'):'';
    const invBtn=rec.status==='completed'&&!hasInv&&est.systems.length>0?'<button class="btn btn-primary" onclick="event.stopPropagation();nav.estimateId=\''+est.id+'\';createInvoice(\'standard\')" style="font-size:11px;padding:3px 10px;margin-top:2px">Invoice</button>':'';
    const qs=est.quoteStatus||'draft';
    const qsCol={draft:'color:var(--t4)',sent:'color:#5b9bf5',approved:'color:#34d399',declined:'color:#f87171'};
    const qsLab={draft:'Draft',sent:'Sent',approved:'Approved',declined:'Declined'};
    const qsBadge=rec.status!=='completed'?' <span style="font-size:10px;font-weight:600;'+qsCol[qs]+'">'+qsLab[qs].toUpperCase()+'</span>':'';
    return'<div class="sys-card'+(ec.sell>0?' has-product':'')+'" onclick="goEstimate(\''+est.id+'\')"><div><div class="sys-area">'+(est.name||'Estimate')+qsBadge+invStatus+'</div><div class="sys-detail">'+est.systems.length+' area'+(est.systems.length!==1?'s':'')+' \u00b7 '+ec.sqft.toLocaleString()+' sqft'+(areas?' \u00b7 '+areas:'')+'</div></div><div class="sys-right"><div class="sys-price">'+fmt(ec.totalWithTax)+'</div>'+(ec.cost>0?'<div class="sys-cost">Cost '+fmt(ec.cost)+'</div>':'')+invBtn+'</div></div>'
  }).join('');
}
function autoSaveRecord(){
  const rec=getRecord();if(!rec)return;
  rec.firstName=document.getElementById('recFirst').value.trim();
  rec.lastName=document.getElementById('recLast').value.trim();
  rec.company=document.getElementById('recCompany').value.trim();
  rec.email=document.getElementById('recEmail').value.trim();
  rec.phone=document.getElementById('recPhone').value.trim();
  rec.phoneType=document.getElementById('recPhoneType').value;
  rec.bestTimeToCall=document.getElementById('recBestTime').value.trim();
  rec.address=document.getElementById('recAddress').value.trim();
  rec.city=document.getElementById('recCity').value.trim();
  rec.state=document.getElementById('recState').value.trim();
  rec.zip=document.getElementById('recZip').value.trim();
  rec.notes=document.getElementById('recNotes').value.trim();
  rec.leadSource=document.getElementById('recLeadSource').value;
  rec.updatedAt=new Date().toISOString();
  autoSave();renderDuplicateWarning();
}
function saveRecord(){
  const rec=getRecord();if(!rec)return;
  rec.firstName=document.getElementById('recFirst').value.trim();
  rec.lastName=document.getElementById('recLast').value.trim();
  rec.company=document.getElementById('recCompany').value.trim();
  rec.email=document.getElementById('recEmail').value.trim();
  rec.phone=document.getElementById('recPhone').value.trim();
  rec.phoneType=document.getElementById('recPhoneType').value;
  rec.bestTimeToCall=document.getElementById('recBestTime').value.trim();
  rec.address=document.getElementById('recAddress').value.trim();
  rec.city=document.getElementById('recCity').value.trim();
  rec.state=document.getElementById('recState').value.trim();
  rec.zip=document.getElementById('recZip').value.trim();
  rec.notes=document.getElementById('recNotes').value.trim();
  rec.leadSource=document.getElementById('recLeadSource').value;
  rec.updatedAt=new Date().toISOString();
  saveDB(db);renderBreadcrumb();toast('Saved','Record updated.');
}
function changeStatus(s){const rec=getRecord();if(!rec)return;const label=STATUSES.find(x=>x.id===s).label;logActivity(rec.id,'status_change','Status changed to '+label);rec.status=s;rec.active=true;saveDB(db);nav.folderStatus=s;nav.folderActive=true;renderRecord();renderBreadcrumb();toast('Moved','Now in '+label+'s.');
  // Auto-advance prompts
  if(s==='completed'&&!isRecordInvoiced(rec)&&rec.estimates.some(e=>e.systems.length>0)){setTimeout(()=>openConfirm('Create Invoice?','Job complete! Ready to invoice this project?',()=>{quickInvoiceRecord(rec.id)}),500)}
}
function toggleActive(){const rec=getRecord();if(!rec)return;rec.active=document.getElementById('recActive').checked;logActivity(rec.id,rec.active?'activated':'archived',rec.active?'Record activated':'Record archived');rec.updatedAt=new Date().toISOString();saveDB(db);nav.folderActive=rec.active;renderBreadcrumb();toast(rec.active?'Active':'Archived',rec.active?'Record is active.':'Moved to inactive.')}
function newRecord(){const rec={id:uid(),status:'lead',active:true,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),firstName:'',lastName:'',company:'',email:'',phone:'',phoneType:'cell',bestTimeToCall:'',address:'',city:'',state:'',zip:'',notes:'',estimates:[],activityLog:[],projectStartDate:null,projectEndDate:null,projectNotes:'',scheduledTime:'',scheduledDuration:0,assignedCrew:'',followUpDate:null,followUpNote:'',followUpCompleted:false,tags:[],leadSource:''};db.records.unshift(rec);saveDB(db);goRecord(rec.id);toast('New Lead','Enter contact details.')}
function confirmDeleteRecord(){const rec=getRecord();if(!rec)return;const ec=rec.estimates.length;const ic=rec.estimates.reduce((s,e)=>s+(e.invoices?e.invoices.length:0),0);const msg='Permanently delete this record'+(ec?' with '+ec+' estimate'+(ec>1?'s':''):'')+(ic?' and '+ic+' invoice'+(ic>1?'s':''):'')+' ? You can also Archive it instead.';openConfirm('Delete Record',msg,()=>{_lastDeleted={type:'record',data:JSON.parse(JSON.stringify(rec))};db.records=db.records.filter(r=>r.id!==nav.recordId);saveDB(db);goFolder(nav.folderStatus,nav.folderActive);toast('Deleted','Record removed.',{fn:true})})}

// ── Duplicate Detection ─────────────────────────────────────
function findDuplicates(rec){
  const name=(rec.firstName+rec.lastName).toLowerCase().replace(/\s/g,'');
  return db.records.filter(r=>r.id!==rec.id&&r.active!==false&&(
    (name.length>1&&(r.firstName+r.lastName).toLowerCase().replace(/\s/g,'')===name)||
    (rec.phone&&rec.phone.length>5&&r.phone&&r.phone.replace(/\D/g,'')===rec.phone.replace(/\D/g,''))||
    (rec.email&&rec.email.length>3&&r.email&&r.email.toLowerCase()===rec.email.toLowerCase())
  ));
}
function renderDuplicateWarning(){
  const el=document.getElementById('duplicateWarning');if(!el)return;
  const rec=getRecord();if(!rec){el.innerHTML='';return}
  const dupes=findDuplicates(rec);
  if(!dupes.length){el.innerHTML='';return}
  el.innerHTML=dupes.slice(0,3).map(d=>{
    const dn=((d.firstName||'')+' '+(d.lastName||'')).trim()||'Unnamed';
    return'<div style="display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:rgba(234,179,8,0.08);border:1px solid rgba(234,179,8,0.3);border-radius:10px;margin-bottom:8px;font-size:13px"><div><span style="color:#ca8a04;font-weight:600">Possible duplicate:</span> '+esc(dn)+' <span style="color:var(--t3)">('+d.status+')</span></div><button class="btn btn-ghost" onclick="goFolder(\''+d.status+'\',true);setTimeout(()=>goRecord(\''+d.id+'\'),50)" style="font-size:11px;padding:3px 10px">View</button></div>'
  }).join('');
}

// ── Follow-Up Reminders ─────────────────────────────────────
function saveFollowUp(){
  const rec=getRecord();if(!rec)return;
  rec.followUpDate=document.getElementById('recFollowUpDate').value||null;
  rec.followUpNote=document.getElementById('recFollowUpNote').value.trim();
  rec.updatedAt=new Date().toISOString();autoSave();renderFollowUpStatus()
}
function completeFollowUp(){
  const rec=getRecord();if(!rec)return;
  rec.followUpCompleted=true;rec.followUpDate=null;rec.followUpNote='';
  rec.activityLog=rec.activityLog||[];
  rec.activityLog.unshift({id:uid(),type:'followup',text:'Follow-up completed',timestamp:new Date().toISOString()});
  rec.updatedAt=new Date().toISOString();autoSave();renderRecord()
}
function renderFollowUpStatus(){
  const el=document.getElementById('followUpStatus');if(!el)return;
  const rec=getRecord();if(!rec){el.innerHTML='';return}
  const d=rec.followUpDate;
  if(!d){el.innerHTML='';return}
  const today=new Date().toISOString().slice(0,10);
  const isOverdue=d<today;const isToday=d===today;
  const label=isOverdue?'<span style="color:#f87171;font-weight:600">Overdue</span>':isToday?'<span style="color:#f59e0b;font-weight:600">Due today</span>':'<span style="color:var(--t3)">Due '+new Date(d+'T12:00').toLocaleDateString('en-US',{month:'short',day:'numeric'})+'</span>';
  el.innerHTML='<div style="display:flex;align-items:center;justify-content:space-between">'+label+'<button class="btn btn-success" onclick="completeFollowUp()" style="font-size:11px;padding:3px 10px">Mark Complete</button></div>'
}
function getFollowUpsDue(){
  const today=new Date().toISOString().slice(0,10);
  return db.records.filter(r=>r.active&&r.followUpDate&&!r.followUpCompleted&&r.followUpDate<=today);
}
function renderFollowUpSection(){
  const el=document.getElementById('followUpSection');if(!el)return;
  const due=getFollowUpsDue();
  if(!due.length){el.innerHTML='';return}
  const items=due.sort((a,b)=>a.followUpDate.localeCompare(b.followUpDate)).slice(0,5).map(r=>{
    const name=((r.firstName||'')+' '+(r.lastName||'')).trim()||'Unnamed';
    const note=r.followUpNote?' \u2014 '+esc(r.followUpNote):'';
    const isOverdue=r.followUpDate<new Date().toISOString().slice(0,10);
    return'<div class="list-item" onclick="goFolder(\''+r.status+'\',true);setTimeout(()=>goRecord(\''+r.id+'\'),50)" style="margin-bottom:4px;padding:10px 14px;cursor:pointer"><div class="li-left"><div style="font-size:18px;width:32px;text-align:center">'+(isOverdue?'&#128308;':'&#128276;')+'</div><div><div class="li-name" style="font-size:13px">'+esc(name)+note+'</div><div class="li-meta">'+(isOverdue?'<span style="color:#f87171">Overdue</span>':'Due today')+' \u00b7 '+r.status+'</div></div></div></div>'
  }).join('');
  el.innerHTML='<div style="padding:14px 18px;border-radius:12px;border:1px solid rgba(245,158,11,.3);background:rgba(245,158,11,.06);margin-bottom:16px"><div style="font-weight:600;font-size:14px;color:#f59e0b;margin-bottom:8px">&#128276; '+due.length+' Follow-up'+(due.length>1?'s':'')+' Due</div>'+items+'</div>'
}

// ── Record Tags ─────────────────────────────────────────────
function renderTagBar(){
  const el=document.getElementById('tagBar');if(!el)return;
  const rec=getRecord();if(!rec){el.innerHTML='';return}
  if(!rec.tags)rec.tags=[];
  const chips=rec.tags.map(t=>'<span style="display:inline-flex;align-items:center;gap:4px;padding:3px 10px;background:var(--accent);color:#000;border-radius:6px;font-size:11px;font-weight:600">'+esc(t)+'<span onclick="removeTag(\''+esc(t)+'\')" style="cursor:pointer;font-size:13px;line-height:1;opacity:.7">&times;</span></span>').join('');
  const presets=(settings.tagPresets||[]).filter(t=>!rec.tags.includes(t));
  const addBtn=presets.length?'<select onchange="addTag(this.value);this.value=\'\'" style="font-size:11px;padding:3px 8px;border-radius:6px;border:1px solid var(--brd);background:var(--s3);color:var(--t2)"><option value="">+ Tag</option>'+presets.map(t=>'<option value="'+esc(t)+'">'+esc(t)+'</option>').join('')+'</select>':'';
  el.innerHTML=chips+addBtn;
}
function addTag(tag){
  if(!tag)return;const rec=getRecord();if(!rec)return;
  if(!rec.tags)rec.tags=[];
  if(!rec.tags.includes(tag)){rec.tags.push(tag);rec.updatedAt=new Date().toISOString();autoSave();renderTagBar()}
}
function removeTag(tag){
  const rec=getRecord();if(!rec)return;
  if(!rec.tags)return;
  rec.tags=rec.tags.filter(t=>t!==tag);rec.updatedAt=new Date().toISOString();autoSave();renderTagBar();
}
function populateTagFilter(){
  const sel=document.getElementById('tagFilter');if(!sel)return;
  const allTags=new Set();
  db.records.filter(r=>r.status===nav.folderStatus&&r.active===nav.folderActive).forEach(r=>{(r.tags||[]).forEach(t=>allTags.add(t))});
  const current=sel.value;
  sel.innerHTML='<option value="">All Tags</option>'+[...allTags].sort().map(t=>'<option value="'+esc(t)+'"'+(t===current?' selected':'')+'>'+esc(t)+'</option>').join('');
}

// ── Next Action Bar ─────────────────────────────────────────
function renderNextAction(rec){
  const bar=document.getElementById('nextActionBar');if(!bar)return;
  const estCount=rec.estimates.length;
  const recTotal=calcRecCosts(rec);
  let h='';
  const btnP=(label,fn)=>'<button class="btn btn-primary" onclick="'+fn+'" style="font-size:13px;padding:8px 18px">'+label+'</button>';
  const btnG=(label,fn)=>'<button class="btn btn-ghost" onclick="'+fn+'" style="font-size:12px;padding:6px 14px">'+label+'</button>';
  if(rec.status==='lead'){
    if(!estCount)h='<div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">'+btnP('Create Estimate \u2192','newEstimate()')+'<span style="font-size:12px;color:var(--t3)">Create an estimate to start quoting this lead.</span></div>';
    else h='<div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap"><span style="font-size:12px;color:var(--t3)">'+estCount+' estimate'+(estCount!==1?'s':'')+' \u00b7 '+fmt(recTotal.totalWithTax)+'</span>'+btnP('Move to Estimates \u2192',"changeStatus('estimate')")+btnG('Add Estimate','newEstimate()')+'</div>';
  }else if(rec.status==='estimate'){
    const withAreas=rec.estimates.filter(e=>e.systems.length>0).length;
    const sent=rec.estimates.filter(e=>e.quoteStatus==='sent').length;
    const approved=rec.estimates.filter(e=>e.quoteStatus==='approved').length;
    if(!withAreas)h='<div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">'+btnP('Add Areas to Estimate \u2192',"goEstimate('"+rec.estimates[0].id+"')")+'<span style="font-size:12px;color:var(--t3)">Add areas and systems to build your quote.</span></div>';
    else if(approved>0)h='<div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap"><span style="font-size:12px;color:var(--success);font-weight:600">\u2713 '+approved+' quote'+(approved!==1?'s':'')+' approved</span>'+btnP('Move to Project \u2192',"changeStatus('project')")+btnG('Email Quote','emailProposal()')+btnG('PDF Proposal','generateProposal()')+'</div>';
    else if(sent>0)h='<div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap"><span style="font-size:12px;color:var(--info);font-weight:500">'+sent+' quote'+(sent!==1?'s':'')+' sent \u2014 awaiting response</span>'+btnP('Move to Project \u2192',"changeStatus('project')")+btnG('Send Reminder','emailProposal()')+'</div>';
    else h='<div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">'+btnP('Email Quote','emailProposal()')+btnG('PDF Proposal','generateProposal()')+btnG('Text Quote','textProposal()')+btnG('Move to Project \u2192',"changeStatus('project')")+'</div>';
  }else if(rec.status==='project'){
    const sd=rec.projectStartDate;const ed=rec.projectEndDate;
    if(!sd)h='<div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">'+btnP('Set Project Dates \u2191',"document.getElementById('recStartDate').focus()")+'<span style="font-size:12px;color:var(--t3)">Set start and end dates for scheduling.</span></div>';
    else h='<div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap"><span style="font-size:12px;color:var(--t3)">'+new Date(sd+'T12:00').toLocaleDateString('en-US',{month:'short',day:'numeric'})+(ed?' \u2013 '+new Date(ed+'T12:00').toLocaleDateString('en-US',{month:'short',day:'numeric'}):'')+'</span>'+btnP('Mark Complete \u2192',"changeStatus('completed')")+btnG('Back to Estimate \u2192',"changeStatus('estimate')")+'</div>';
  }else if(rec.status==='completed'){
    const invoiced=isRecordInvoiced(rec);
    const allInvs=[];rec.estimates.forEach(e=>{if(e.invoices)e.invoices.forEach(i=>allInvs.push(i))});
    const unpaid=allInvs.filter(i=>i.status!=='paid');
    const totalPaid=allInvs.reduce((s,i)=>s+(i.amountPaid||0),0);
    if(!invoiced)h='<div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">'+btnP('Invoice This Job \u2192',"quickInvoiceRecord('"+rec.id+"')")+'<span style="font-size:12px;color:var(--t3)">Create an invoice to collect payment.</span></div>';
    else if(unpaid.length)h='<div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap"><span style="font-size:12px;color:var(--accent);font-weight:500">'+unpaid.length+' invoice'+(unpaid.length!==1?'s':'')+' outstanding \u2014 '+fmt(unpaid.reduce((s,i)=>s+i.balance,0))+' due</span>'+btnG('View Invoices',"goEstimate('"+rec.estimates[0].id+"');setTimeout(()=>switchEstTab('invoices'),50)")+'</div>';
    else h='<div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap"><span style="font-size:12px;color:var(--success);font-weight:600">\u2713 Fully paid \u2014 '+fmt(totalPaid)+' collected</span></div>';
  }
  bar.innerHTML=h?'<div style="padding:12px 16px;border-radius:10px;background:var(--s2);border:1px solid var(--b1)">'+h+'</div>':'';
}

// ── Project Dates ───────────────────────────────────────────
function saveProjectDates(){
  const rec=getRecord();if(!rec)return;
  rec.projectStartDate=document.getElementById('recStartDate').value||null;
  rec.projectEndDate=document.getElementById('recEndDate').value||null;
  rec.scheduledTime=document.getElementById('recScheduledTime').value||'';
  rec.scheduledDuration=parseFloat(document.getElementById('recScheduledDuration').value)||0;
  rec.assignedCrew=document.getElementById('recAssignedCrew').value||'';
  rec.projectNotes=document.getElementById('recProjectNotes').value.trim();
  rec.updatedAt=new Date().toISOString();
  saveDB(db);renderNextAction(rec);
}

// ── Quote Status ────────────────────────────────────────────
function approveQuote(estId){
  const rec=getRecord();if(!rec)return;
  const est=rec.estimates.find(e=>e.id===estId);if(!est)return;
  est.quoteStatus='approved';est.quoteApprovedAt=new Date().toISOString();
  logActivity(rec.id,'quote_approved','Quote "'+est.name+'" approved');
  saveDB(db);
  if(nav.screen==='estimate')renderEstimate();else renderRecord();
  if(rec.status==='estimate'){
    openConfirm('Move to Project?','Quote approved! Ready to move this to Projects?',()=>{changeStatus('project')});
  }
}
function declineQuote(estId){
  const rec=getRecord();if(!rec)return;
  const est=rec.estimates.find(e=>e.id===estId);if(!est)return;
  est.quoteStatus='declined';
  logActivity(rec.id,'quote_declined','Quote "'+est.name+'" declined');
  saveDB(db);
  if(nav.screen==='estimate')renderEstimate();else renderRecord();
  toast('Declined','Quote marked as declined.');
}// ═══════════════════════════════════════════════════════════
// ESTIMATE
// ═══════════════════════════════════════════════════════════
function getEstimate(){const rec=getRecord();return rec?rec.estimates.find(e=>e.id===nav.estimateId):null}
function renderEstimate(){
  const est=getEstimate();const rec=getRecord();if(!est||!rec){goRecord(nav.recordId);return}
  const rn=((rec.firstName||'')+' '+(rec.lastName||'')).trim()||'Client';
  document.getElementById('estNameInput').value=est.name||'';
  document.getElementById('estSubline').textContent=rn;
  // Quote status badge + approve/decline buttons
  const qs=est.quoteStatus||'draft';
  const qsColors={draft:'background:var(--s3);color:var(--t3)',sent:'background:rgba(91,155,245,.15);color:#5b9bf5',approved:'background:rgba(52,211,153,.15);color:#34d399',declined:'background:rgba(248,113,113,.15);color:#f87171'};
  const qsLabels={draft:'Draft',sent:'Sent',approved:'Approved',declined:'Declined'};
  let qsBadgeHtml='<span style="display:inline-block;font-size:11px;font-weight:600;padding:3px 10px;border-radius:6px;'+qsColors[qs]+'">'+qsLabels[qs]+'</span>';
  if(qs==='sent')qsBadgeHtml+=' <button class="btn btn-success" onclick="approveQuote(\''+est.id+'\')" style="font-size:11px;padding:3px 10px;margin-left:6px">Client Approved \u2713</button><button class="btn btn-danger" onclick="declineQuote(\''+est.id+'\')" style="font-size:11px;padding:3px 10px;margin-left:4px">Declined \u2717</button>';
  else if(qs==='draft'&&est.systems.length>0)qsBadgeHtml+=' <span style="font-size:11px;color:var(--t4);margin-left:6px">Ready to send?</span>';
  document.getElementById('quoteStatusBadge').innerHTML=qsBadgeHtml;
  estTab='areas';switchEstTab('areas');
  const ec=calcEstCosts(est);
  let etbRight='';
  if(ec.taxAmount>0){etbRight='<div class="est-total-amount">'+fmt(ec.totalWithTax)+'</div><div class="est-total-detail">Subtotal '+fmt(ec.sell)+' + Tax '+fmt(ec.taxAmount)+'</div><div class="est-total-detail">Cost '+fmt(ec.cost)+' \u00b7 Margin '+ec.margin.toFixed(1)+'%</div>'}
  else{etbRight='<div class="est-total-amount">'+fmt(ec.sell)+'</div><div class="est-total-detail">Cost '+fmt(ec.cost)+' \u00b7 Margin '+ec.margin.toFixed(1)+'%</div>'}
  document.getElementById('estTotalBar').innerHTML='<div><div class="est-total-left">Estimate Total</div><div class="est-total-detail">'+est.systems.length+' area'+(est.systems.length!==1?'s':'')+' \u00b7 '+ec.sqft.toLocaleString()+' sqft</div></div><div style="text-align:right">'+etbRight+'</div>';
  if(!est.systems.length){document.getElementById('systemsList').innerHTML='<div class="empty"><div class="empty-icon">&#9874;</div><div class="empty-text">No areas yet.</div><button class="btn btn-primary" onclick="newSystem()" style="margin-top:10px">+ Add Area</button></div>';return}
  document.getElementById('systemsList').innerHTML=est.systems.map((sys,i)=>{
    const sc=calcSysCosts(sys);
    const prod=getAllProducts().find(p=>p.id===sys.productId);
    const d=[sys.sqft?sys.sqft.toLocaleString()+' sqft':'',prod?prod.name:'No system',sys.sellRate?'$'+sys.sellRate.toFixed(2)+'/sqft':''].filter(Boolean).join(' \u00b7 ');
    return'<div class="sys-card'+(prod?' has-product':'')+'" onclick="goSystem(\''+sys.id+'\')"><div><div class="sys-area">'+(sys.areaName||'Area '+(i+1))+'</div><div class="sys-detail">'+d+'</div></div><div class="sys-right"><div class="sys-price">'+fmt(sc.sell)+'</div>'+(sc.cost>0?'<div class="sys-cost">Cost '+fmt(sc.cost)+'</div>':'')+'</div></div>'
  }).join('');
}
function updateEstName(){const est=getEstimate();if(est){est.name=document.getElementById('estNameInput').value.trim();autoSave()}}
function newEstimate(){
  const rec=getRecord();if(!rec)return;saveRecord();
  const tpls=settings.estimateTemplates||[];
  if(tpls.length){showTemplatePickerModal(rec);return}
  createBlankEstimate(rec);
}
function createBlankEstimate(rec,templateSystems){
  const c=rec.estimates.length+1;const est={id:uid(),name:'Estimate #'+c,createdAt:new Date().toISOString(),systems:templateSystems?JSON.parse(JSON.stringify(templateSystems)):[],quoteStatus:'draft',quoteSentAt:null,quoteApprovedAt:null};
  rec.estimates.push(est);logActivity(rec.id,'estimate_created','Estimate \''+est.name+'\' created');rec.updatedAt=new Date().toISOString();
  if(rec.status==='lead'){rec.status='estimate';nav.folderStatus='estimate'}
  saveDB(db);goEstimate(est.id);toast('Created',templateSystems?'Created from template with '+templateSystems.length+' area(s).':'Add areas to start quoting.');
}
function showTemplatePickerModal(rec){
  const tpls=settings.estimateTemplates||[];
  const items=tpls.map((t,i)=>'<div onclick="closeConfirm();createBlankEstimate(getRecord(),settings.estimateTemplates['+i+'].systems)" style="padding:14px 16px;background:var(--s3);border-radius:10px;margin-bottom:8px;cursor:pointer;border:1px solid var(--brd);transition:border-color .15s" onmouseover="this.style.borderColor=\'var(--accent)\'" onmouseout="this.style.borderColor=\'var(--brd)\'"><div style="font-weight:600;font-size:14px;color:var(--t1)">'+esc(t.name)+'</div><div style="font-size:12px;color:var(--t3);margin-top:2px">'+t.systems.length+' area'+(t.systems.length!==1?'s':'')+'</div></div>').join('');
  const modal=document.getElementById('confirmModal');
  modal.querySelector('.modal-card').innerHTML='<div style="padding:20px"><h3 style="font-size:16px;font-weight:700;margin-bottom:4px">New Estimate</h3><p style="font-size:13px;color:var(--t3);margin-bottom:16px">Start blank or use a template</p><div onclick="closeConfirm();createBlankEstimate(getRecord())" style="padding:14px 16px;background:var(--s3);border-radius:10px;margin-bottom:12px;cursor:pointer;border:2px solid var(--accent)"><div style="font-weight:600;font-size:14px;color:var(--accent)">+ Start Blank</div><div style="font-size:12px;color:var(--t3);margin-top:2px">Empty estimate — add areas manually</div></div><div style="font-size:12px;font-weight:600;color:var(--t3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">Or choose a template</div>'+items+'</div>';
  modal.classList.add('active');
}
function saveEstimate(){
  saveDB(db);
  // Button feedback
  const btn=document.getElementById('estSaveBtn');
  btn.textContent='\u2713 Saved!';btn.style.opacity='0.7';btn.disabled=true;
  setTimeout(()=>{btn.textContent='Save';btn.style.opacity='';btn.disabled=false},1500);
  // Show next-step actions
  const est=getEstimate();const ec=calcEstCosts(est);
  const hasAreas=est&&est.systems.length>0;
  const hasInvoice=est&&est.invoices&&est.invoices.length>0;
  let actions='<div style="display:flex;gap:8px;flex-wrap:wrap;padding:10px 0;align-items:center"><span style="font-size:12px;color:var(--success);font-weight:600">\u2713 Saved</span>';
  if(hasAreas)actions+='<button class="btn btn-primary" onclick="generateProposal()" style="font-size:12px;padding:6px 14px">Generate Proposal</button>';
  if(hasAreas)actions+='<button class="btn btn-ghost" onclick="emailProposal()" style="font-size:12px;padding:6px 14px">Email Proposal</button>';
  if(hasAreas&&!hasInvoice)actions+='<button class="btn btn-ghost" onclick="switchEstTab(\'invoices\')" style="font-size:12px;padding:6px 14px">Create Invoice</button>';
  actions+='<button class="btn btn-ghost" onclick="goRecord(nav.recordId)" style="font-size:12px;padding:6px 14px">Back to Record</button>';
  actions+='</div>';
  const el=document.getElementById('estSavedActions');
  el.innerHTML=actions;el.style.display='';
  setTimeout(()=>{el.style.display='none'},8000);
  toast('Saved','Estimate saved.');
}
function confirmDeleteEstimate(){const rec=getRecord();if(!rec)return;const est=getEstimate();const eName=(est||{}).name||'Estimate';openConfirm('Delete Estimate','Delete this estimate and all areas?',()=>{if(est)_lastDeleted={type:'estimate',data:JSON.parse(JSON.stringify(est)),parentId:rec.id};logActivity(rec.id,'estimate_deleted','Estimate \''+eName+'\' deleted');rec.estimates=rec.estimates.filter(e=>e.id!==nav.estimateId);rec.updatedAt=new Date().toISOString();saveDB(db);goRecord(nav.recordId);toast('Deleted','Estimate removed.',{fn:true})})}

// ═══════════════════════════════════════════════════════════
// SYSTEM EDITOR
// ═══════════════════════════════════════════════════════════
function getSystem(){const est=getEstimate();return est?est.systems.find(s=>s.id===nav.systemId):null}
function renderSystem(){
  const sys=getSystem();if(!sys){goEstimate(nav.estimateId);return}
  // Initialize repairs/addons if missing
  if(!sys.repairs){sys.repairs={}}
  if(!sys.addons){sys.addons={}}
  document.getElementById('sysHeader').innerHTML='<h2>'+(sys.areaName||'New Area')+'</h2><p>Select a product system and set your sell rate.</p>';
  document.getElementById('sysArea').value=sys.areaName||'';
  document.getElementById('sysLength').value=sys.length||0;
  document.getElementById('sysWidth').value=sys.width||1;
  document.getElementById('sysSqft').value=sys.sqft||0;
  document.getElementById('sysSellRate').value=sys.sellRate||0;
  document.getElementById('sysNotes').value=sys.notes||'';
  document.getElementById('sysTaxable').checked=sys.taxable!==false;
  seriesFilter='All';renderSeriesFilter();renderProductList(sys);renderTopcoatList(sys);renderRepairList(sys);renderAddonList(sys);calcSystem();
  renderLineItems();
}
function renderSeriesFilter(){const s=['All','C-Series','M-Series','G-Series','E-Series','I-Series'];if(settings.customProducts&&settings.customProducts.length)s.push('Custom');document.getElementById('seriesFilter').innerHTML=s.map(x=>'<button class="sf-btn'+(x===seriesFilter?' ac':'')+'" onclick="setSeriesFilter(\''+x+'\')">'+x+'</button>').join('')}
function setSeriesFilter(s){seriesFilter=s;renderSeriesFilter();const sys=getSystem();if(sys)renderProductList(sys)}
function renderProductList(sys){
  const ps=seriesFilter==='All'?getAllProducts():getAllProducts().filter(p=>p.series===seriesFilter);
  document.getElementById('prodList').innerHTML=ps.map(p=>{const sel=sys.productId===p.id;return'<div class="prod-option'+(sel?' sel':'')+'" onclick="selectProduct(\''+p.id+'\')"><div><div class="prod-name">'+p.name+'</div><div class="prod-sku">'+p.sku+' \u00b7 '+p.cat+'</div></div><div class="prod-prices"><div class="cost">'+fmt(p.cost)+'/sf</div><div class="sell">Sell '+fmt(p.low)+'\u2013'+fmt(p.mid)+'</div></div></div>'}).join('');
}
function renderTopcoatList(sys){
  document.getElementById('tcList').innerHTML=getAllTopcoats().map(t=>{const sel=(sys.topcoatId||'tc-none')===t.id;return'<div class="prod-option'+(sel?' sel':'')+'" onclick="selectTopcoat(\''+t.id+'\')"><div><div class="prod-name">'+t.name+'</div>'+(t.desc?'<div class="prod-sku">'+t.desc+'</div>':'')+'</div><div class="prod-prices"><div class="cost">'+(t.cost>0?fmt(t.cost)+'/sf':'\u2014')+'</div></div></div>'}).join('');
}
function selectProduct(id){const sys=getSystem();if(!sys)return;sys.productId=id;const p=getAllProducts().find(p=>p.id===id);if(p&&!sys.sellRate){sys.sellRate=p.low;document.getElementById('sysSellRate').value=p.low.toFixed(2)}renderProductList(sys);calcSystem()}
function selectTopcoat(id){const sys=getSystem();if(!sys)return;sys.topcoatId=id==='tc-none'?null:id;renderTopcoatList(sys);calcSystem()}
function calcSystem(sqm){
  const sys=getSystem();if(!sys)return;
  const l=parseFloat(document.getElementById('sysLength').value)||0;
  const w=parseFloat(document.getElementById('sysWidth').value)||0;
  let sq=sqm?(parseFloat(document.getElementById('sysSqft').value)||0):(l*w);
  if(!sqm)document.getElementById('sysSqft').value=sq;
  const sr=parseFloat(document.getElementById('sysSellRate').value)||0;
  sys.areaName=document.getElementById('sysArea').value.trim();sys.length=l;sys.width=w;sys.sqft=sq;sys.sellRate=sr;sys.notes=document.getElementById('sysNotes').value.trim();
  sys.taxable=document.getElementById('sysTaxable').checked;
  const sc=calcSysCosts(sys);
  document.getElementById('sysPrice').textContent=fmt(sc.sellWithTax);
  let statsHtml='<div class="sx hl"><div class="sl">Total Price</div><div class="sv">'+fmt(sc.sell)+'</div></div>';
  if(sc.taxAmount>0){statsHtml+='<div class="sx"><div class="sl">Tax ('+settings.taxRate+'%)</div><div class="sv">'+fmt(sc.taxAmount)+'</div></div><div class="sx hl"><div class="sl">Price + Tax</div><div class="sv" style="color:var(--accent)">'+fmt(sc.sellWithTax)+'</div></div>'}
  statsHtml+='<div class="sx"><div class="sl">Material Cost</div><div class="sv" style="color:var(--comp)">'+fmt(sc.cost)+'</div></div><div class="sx"><div class="sl">Gross Profit</div><div class="sv" style="color:var(--success)">'+fmt(sc.profit)+'</div></div><div class="sx"><div class="sl">Margin</div><div class="sv" style="color:'+(sc.margin>=50?'var(--success)':sc.margin>=30?'var(--accent)':'var(--comp)')+'">'+sc.margin.toFixed(1)+'%</div></div>';
  document.getElementById('sysStats').innerHTML=statsHtml;
  autoSave();
}
function renderRepairList(sys){
  document.getElementById('repairList').innerHTML=getAllRepairs().map(r=>{
    const d=sys.repairs[r.id]||{on:false,qty:0,sell:0};
    return'<div class="ra-row'+(d.on?' on':'')+'">'+
      '<div class="ra-toggle"><input type="checkbox"'+(d.on?' checked':'')+' onchange="toggleRepair(\''+r.id+'\',this.checked)"></div>'+
      '<div class="ra-info"><div class="ra-name">'+r.name+'</div><div class="ra-sku">'+r.sku+' \u00b7 Cost '+fmt(r.cost)+'/'+r.unit+'</div></div>'+
      '<div class="ra-fields"'+(d.on?'':' style="opacity:.3;pointer-events:none"')+'>'+
        '<input type="number" value="'+(d.qty||0)+'" min="0" step="1" placeholder="Qty" onchange="updateRepair(\''+r.id+'\',\'qty\',this.value)">'+
        '<div class="ra-unit">'+r.unit+'</div>'+
        '<input type="number" value="'+(d.sell||0)+'" min="0" step="0.01" placeholder="Sell" onchange="updateRepair(\''+r.id+'\',\'sell\',this.value)">'+
        '<div class="ra-unit">$/'+r.unit+'</div>'+
      '</div>'+
      '<div class="ra-cost">'+fmt((d.sell||0)*(d.qty||0))+'</div>'+
    '</div>'
  }).join('');
}
function toggleRepair(id,on){
  const sys=getSystem();if(!sys)return;
  if(!sys.repairs[id])sys.repairs[id]={on:false,qty:0,sell:0};
  sys.repairs[id].on=on;
  renderRepairList(sys);calcSystem();
}
function updateRepair(id,field,val){
  const sys=getSystem();if(!sys)return;
  if(!sys.repairs[id])sys.repairs[id]={on:true,qty:0,sell:0};
  sys.repairs[id][field]=parseFloat(val)||0;
  renderRepairList(sys);calcSystem();
}
function renderAddonList(sys){
  document.getElementById('addonList').innerHTML=getAllAddons().map(a=>{
    const d=sys.addons[a.id]||{on:false,qty:0,sell:a.low};
    return'<div class="ra-row'+(d.on?' on':'')+'">'+
      '<div class="ra-toggle"><input type="checkbox"'+(d.on?' checked':'')+' onchange="toggleAddon(\''+a.id+'\',this.checked)"></div>'+
      '<div class="ra-info"><div class="ra-name">'+a.name+'</div><div class="ra-sku">'+a.sku+' \u00b7 Cost '+fmt(a.cost)+'/'+a.unit+' \u00b7 Sell '+fmt(a.low)+'\u2013'+fmt(a.mid)+'</div></div>'+
      '<div class="ra-fields"'+(d.on?'':' style="opacity:.3;pointer-events:none"')+'>'+
        '<input type="number" value="'+(d.qty||0)+'" min="0" step="1" placeholder="Qty" onchange="updateAddon(\''+a.id+'\',\'qty\',this.value)">'+
        '<div class="ra-unit">'+a.unit+'</div>'+
        '<input type="number" value="'+(d.sell||a.low)+'" min="0" step="0.01" placeholder="Sell" onchange="updateAddon(\''+a.id+'\',\'sell\',this.value)">'+
        '<div class="ra-unit">$/'+a.unit+'</div>'+
      '</div>'+
      '<div class="ra-cost">'+fmt((d.sell||0)*(d.qty||0))+'</div>'+
    '</div>'
  }).join('');
}
function toggleAddon(id,on){
  const sys=getSystem();if(!sys)return;
  const def=getAllAddons().find(a=>a.id===id);
  if(!sys.addons[id])sys.addons[id]={on:false,qty:0,sell:def?def.low:0};
  sys.addons[id].on=on;
  // Auto-fill qty with sqft for sqft-based add-ons
  if(on&&def&&def.unit==='sqft'&&!sys.addons[id].qty)sys.addons[id].qty=sys.sqft||0;
  renderAddonList(sys);calcSystem();
}
function updateAddon(id,field,val){
  const sys=getSystem();if(!sys)return;
  const def=getAllAddons().find(a=>a.id===id);
  if(!sys.addons[id])sys.addons[id]={on:true,qty:0,sell:def?def.low:0};
  sys.addons[id][field]=parseFloat(val)||0;
  renderAddonList(sys);calcSystem();
}
function saveSystem(){calcSystem();saveDB(db);renderBreadcrumb();toast('Saved','Area saved.')}
function newSystem(){const est=getEstimate();if(!est)return;const sys={id:uid(),areaName:'',length:0,width:0,sqft:0,productId:null,sellRate:0,topcoatId:null,notes:'',taxable:true,repairs:{},addons:{}};est.systems.push(sys);if(nav.recordId)logActivity(nav.recordId,'area_added','Area added to \''+est.name+'\'');saveDB(db);goSystem(sys.id)}
function confirmDeleteSystem(){const est=getEstimate();if(!est)return;const sys=getSystem();const aName=(sys||{}).areaName||'Area';openConfirm('Remove Area','Remove this area from the estimate?',()=>{if(sys)_lastDeleted={type:'system',data:JSON.parse(JSON.stringify(sys)),parentId:nav.estimateId,recordId:nav.recordId};if(nav.recordId)logActivity(nav.recordId,'area_removed','Area \''+aName+'\' removed from \''+est.name+'\'');est.systems=est.systems.filter(s=>s.id!==nav.systemId);saveDB(db);goEstimate(nav.estimateId);toast('Removed','Area removed.',{fn:true})})}
function duplicateSystem(){
  const est=getEstimate();const sys=getSystem();if(!est||!sys)return;
  const dup=JSON.parse(JSON.stringify(sys));dup.id=uid();dup.areaName=(sys.areaName||'Area')+' (Copy)';
  est.systems.push(dup);if(nav.recordId)logActivity(nav.recordId,'area_duplicated','Area "'+sys.areaName+'" duplicated');
  saveDB(db);goSystem(dup.id);toast('Duplicated','Area copied. Edit as needed.');
}
function duplicateEstimate(){
  const rec=getRecord();const est=getEstimate();if(!rec||!est)return;
  const dup=JSON.parse(JSON.stringify(est));dup.id=uid();dup.name=(est.name||'Estimate')+' (Copy)';dup.createdAt=new Date().toISOString();dup.quoteStatus='draft';dup.quoteSentAt=null;dup.quoteApprovedAt=null;
  if(dup.invoices)dup.invoices=[];
  dup.systems.forEach(s=>{s.id=uid()});
  rec.estimates.push(dup);logActivity(rec.id,'estimate_duplicated','Estimate "'+est.name+'" duplicated');
  rec.updatedAt=new Date().toISOString();saveDB(db);goEstimate(dup.id);toast('Duplicated','Estimate copied. Edit as needed.');
}

// ═══════════════════════════════════════════════════════════
// CUSTOM LINE ITEMS
// ═══════════════════════════════════════════════════════════
function renderLineItems(){
  const sys=getSystem();if(!sys)return;
  const el=document.getElementById('lineItemsList');if(!el)return;
  const items=sys.customLineItems||[];
  if(!items.length){el.innerHTML='<div style="font-size:12px;color:var(--t4);padding:8px 0">No custom items. Add charges like stencil work, custom colors, or misc fees.</div>';return}
  el.innerHTML=items.map((item,i)=>
    '<div style="padding:10px 14px;border:1px solid var(--b1);border-radius:8px;background:var(--s1);margin-bottom:6px">'+
      '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">'+
        '<span style="font-weight:600;font-size:13px;color:var(--t1)">'+(item.description||'Line Item')+'</span>'+
        '<button class="btn btn-danger" onclick="removeSysLineItem('+i+')" style="font-size:11px;padding:2px 8px">Remove</button>'+
      '</div>'+
      '<div class="g3" style="gap:8px">'+
        '<div class="fg" style="margin-bottom:0"><label style="font-size:11px">Description</label><input type="text" value="'+esc(item.description||'')+'" onchange="updateSysLineItem('+i+',\'description\',this.value)" style="font-size:13px;padding:8px"></div>'+
        '<div class="fg" style="margin-bottom:0"><label style="font-size:11px">Qty</label><input type="number" value="'+(item.qty||0)+'" min="0" step="1" onchange="updateSysLineItem('+i+',\'qty\',parseFloat(this.value)||0)" style="font-size:13px;padding:8px"></div>'+
        '<div class="fg" style="margin-bottom:0"><label style="font-size:11px">Unit</label><select onchange="updateSysLineItem('+i+',\'unit\',this.value)" style="font-size:13px;padding:8px"><option value="each"'+(item.unit==='each'?' selected':'')+'>each</option><option value="sqft"'+(item.unit==='sqft'?' selected':'')+'>sqft</option><option value="lnft"'+(item.unit==='lnft'?' selected':'')+'>lnft</option><option value="hr"'+(item.unit==='hr'?' selected':'')+'>hr</option></select></div>'+
      '</div>'+
      '<div class="g3" style="gap:8px;margin-top:6px">'+
        '<div class="fg" style="margin-bottom:0"><label style="font-size:11px">Rate ($)</label><input type="number" value="'+(item.rate||0)+'" min="0" step="0.01" onchange="updateSysLineItem('+i+',\'rate\',parseFloat(this.value)||0)" style="font-size:13px;padding:8px"></div>'+
        '<div class="fg" style="margin-bottom:0"><label style="font-size:11px">Total</label><div style="padding:8px;font-family:\'JetBrains Mono\',monospace;font-size:14px;font-weight:600;color:var(--accent)">'+fmt((item.qty||0)*(item.rate||0))+'</div></div>'+
        '<div class="fg" style="margin-bottom:0"><label style="font-size:11px">Taxable</label><div style="padding:8px"><input type="checkbox" '+(item.taxable!==false?'checked':'')+' onchange="updateSysLineItem('+i+',\'taxable\',this.checked)"></div></div>'+
      '</div>'+
    '</div>'
  ).join('');
}

function addSysLineItem(){
  const sys=getSystem();if(!sys)return;
  if(!sys.customLineItems)sys.customLineItems=[];
  sys.customLineItems.push({id:'cli-'+uid(),description:'',qty:1,unit:'each',rate:0,taxable:true});
  autoSave();renderLineItems();calcSystem();
}

function updateSysLineItem(idx,field,val){
  const sys=getSystem();if(!sys)return;
  const items=sys.customLineItems;if(!items||!items[idx])return;
  items[idx][field]=val;
  autoSave();renderLineItems();calcSystem();
}

function removeSysLineItem(idx){
  const sys=getSystem();if(!sys)return;
  const items=sys.customLineItems;if(!items||!items[idx])return;
  items.splice(idx,1);
  autoSave();renderLineItems();calcSystem();
}

// ═══════════════════════════════════════════════════════════
// MODALS / TOAST / IMPORT-EXPORT
// ═══════════════════════════════════════════════════════════
function openConfirm(t,m,fn){document.getElementById('confirmTitle').textContent=t;document.getElementById('confirmMsg').textContent=m;document.getElementById('confirmYes').onclick=()=>{closeConfirm();fn()};document.getElementById('confirmModal').classList.add('active')}
function closeConfirm(){document.getElementById('confirmModal').classList.remove('active')}
function openExport(){document.getElementById('exportModal').classList.add('active')}
function closeExport(){document.getElementById('exportModal').classList.remove('active')}
function openImport(){document.getElementById('importModal').classList.add('active')}
function closeImport(){document.getElementById('importModal').classList.remove('active')}
let _lastDeleted=null;let _toastTimer=null;
function toast(t,m,undoOpt){
  const el=document.getElementById('toast');document.getElementById('toastT').textContent=t;
  const mEl=document.getElementById('toastM');
  if(undoOpt&&undoOpt.fn){mEl.innerHTML=esc(m)+' <a href="#" onclick="event.preventDefault();undoLastDelete()" style="color:var(--accent);font-weight:600;text-decoration:underline;margin-left:8px">Undo</a>'}
  else{mEl.textContent=m}
  el.classList.add('show');clearTimeout(_toastTimer);_toastTimer=setTimeout(()=>{el.classList.remove('show');if(_lastDeleted)_lastDeleted=null},undoOpt?8000:3000);
}
function undoLastDelete(){
  if(!_lastDeleted){toast('Nothing to Undo','');return}
  const d=_lastDeleted;_lastDeleted=null;
  if(d.type==='record'){db.records.push(d.data);saveDB(db);goFolder(nav.folderStatus||'lead',true);toast('Restored','Record restored.')}
  else if(d.type==='estimate'){const rec=db.records.find(r=>r.id===d.parentId);if(rec){rec.estimates.push(d.data);saveDB(db);goRecord(d.parentId);toast('Restored','Estimate restored.')}}
  else if(d.type==='system'){const rec=db.records.find(r=>r.id===d.recordId);const est=rec?rec.estimates.find(e=>e.id===d.parentId):null;if(est){est.systems.push(d.data);saveDB(db);goEstimate(d.parentId);toast('Restored','Area restored.')}}
}
function doExport(){const b=new Blob([JSON.stringify(db,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='coatings-estimator-'+new Date().toISOString().slice(0,10)+'.json';a.click();closeExport();toast('Exported','Download started.')}
function doImport(){const f=document.getElementById('importFile').files[0];if(!f){toast('Error','Select a file.');return}const r=new FileReader();r.onload=e=>{try{const d=JSON.parse(e.target.result);if(d.records&&Array.isArray(d.records)){db=d;saveDB(db);closeImport();goHome();toast('Imported',db.records.length+' records loaded.')}else{toast('Error','Invalid format.')}}catch{toast('Error','Could not parse file.')}};r.readAsText(f)}

// ═══════════════════════════════════════════════════════════
// ORDER LIST (Phase 2 — Ingredient Intelligence)
// ═══════════════════════════════════════════════════════════
function getSystemIngredients(sys){
  const items=[];
  const sqft=sys.sqft||0;
  if(!sqft)return items;
  // Product system ingredients
  const ings=INGREDIENTS[sys.productId];
  if(ings){ings.forEach(ing=>{
    const unitsNeeded=Math.ceil(sqft/ing.coverage);
    items.push({name:ing.name,sku:ing.sku,qty:unitsNeeded,unit:ing.unit,costPer:ing.costPer,totalCost:unitsNeeded*ing.costPer,source:'system',area:sys.areaName||'Unnamed'});
  })}
  // Top coat (uses real coverage rates from YEILD tab)
  const tc=getAllTopcoats().find(t=>t.id===sys.topcoatId);
  if(tc&&tc.cost>0){const tcCov=tc.coverage||200;const tcQty=Math.ceil(sqft/tcCov);const tcUnit=tc.unitPrice||0;items.push({name:tc.name,sku:tc.sku||'',qty:tcQty,unit:'gal',costPer:tcUnit,totalCost:tcQty*tcUnit,source:'topcoat',area:sys.areaName||'Unnamed'})}
  // Repairs
  if(sys.repairs){Object.entries(sys.repairs).forEach(([id,r])=>{if(r.on&&r.qty>0){const def=getAllRepairs().find(x=>x.id===id);if(def)items.push({name:def.name,sku:def.sku,qty:r.qty,unit:def.unit,costPer:def.cost,totalCost:def.cost*r.qty,source:'repair',area:sys.areaName||'Unnamed'})}})}
  // Add-ons
  if(sys.addons){Object.entries(sys.addons).forEach(([id,a])=>{if(a.on&&a.qty>0){const def=getAllAddons().find(x=>x.id===id);if(def)items.push({name:def.name,sku:def.sku,qty:a.qty,unit:def.unit,costPer:def.cost,totalCost:def.cost*a.qty,source:'addon',area:sys.areaName||'Unnamed'})}})}
  // Custom Line Items
  if(sys.customLineItems){sys.customLineItems.forEach(li=>{if(li.description){const amt=(li.qty||0)*(li.rate||0);items.push({name:li.description,sku:'',qty:li.qty||0,unit:li.unit||'each',costPer:li.rate||0,totalCost:amt,source:'custom',area:sys.areaName||'Unnamed'})}})}
  return items;
}
function renderOrderList(){
  const est=getEstimate();if(!est){return}
  if(!est.systems.length){document.getElementById('orderListContent').innerHTML='<div class="empty"><div class="empty-icon">&#9776;</div><div class="empty-text">Add areas with products to see the order list.</div></div>';return}
  // Collect all ingredients grouped by area
  let allItems=[];let totalCost=0;
  est.systems.forEach(sys=>{const items=getSystemIngredients(sys);allItems.push({area:sys.areaName||'Unnamed',sqft:sys.sqft,items});items.forEach(i=>totalCost+=i.totalCost)});
  // Aggregate duplicate items
  const agg={};allItems.forEach(g=>g.items.forEach(i=>{const k=i.sku||i.name;if(!agg[k])agg[k]={...i,qty:0,totalCost:0};agg[k].qty+=i.qty;agg[k].totalCost+=i.totalCost}));
  let html='<div style="margin-bottom:16px"><strong style="font-size:14px">By Area</strong></div><table class="ol-table">';
  html+='<tr><th>Item</th><th>SKU</th><th class="right">Qty</th><th>Unit</th><th class="right">Unit Cost</th><th class="right">Total</th></tr>';
  allItems.forEach(g=>{
    html+='<tr class="group-hdr"><td colspan="6">'+g.area+' \u2014 '+g.sqft.toLocaleString()+' sqft</td></tr>';
    g.items.forEach(i=>{html+='<tr><td>'+i.name+'</td><td class="mono">'+i.sku+'</td><td class="right mono">'+i.qty+'</td><td>'+i.unit+'</td><td class="right mono">'+fmt(i.costPer)+'</td><td class="right mono accent">'+fmt(i.totalCost)+'</td></tr>'});
  });
  html+='<tr class="ol-total"><td colspan="5">Total Material Cost</td><td class="right mono accent">'+fmt(totalCost)+'</td></tr></table>';
  // Aggregated purchase list
  html+='<div style="margin:24px 0 16px"><strong style="font-size:14px">Consolidated Purchase List</strong></div><table class="ol-table">';
  html+='<tr><th>Item</th><th>SKU</th><th class="right">Total Qty</th><th>Unit</th><th class="right">Est. Cost</th></tr>';
  Object.values(agg).sort((a,b)=>a.name.localeCompare(b.name)).forEach(i=>{html+='<tr><td>'+i.name+'</td><td class="mono">'+i.sku+'</td><td class="right mono">'+i.qty+'</td><td>'+i.unit+'</td><td class="right mono accent">'+fmt(i.totalCost)+'</td></tr>'});
  html+='<tr class="ol-total"><td colspan="4">Total</td><td class="right mono accent">'+fmt(totalCost)+'</td></tr></table>';
  document.getElementById('orderListContent').innerHTML=html;
}// ═══════════════════════════════════════════════════════════
// INVOICING
// ═══════════════════════════════════════════════════════════
function getNextInvoiceNumber(){
  let n=parseInt(localStorage.getItem('ce_inv_num_'+getActiveProfileId()))||0;
  n++;localStorage.setItem('ce_inv_num_'+getActiveProfileId(),n);
  return(settings.invoicePrefix||'INV-')+String(n).padStart(settings.invoiceNumberPadding||3,'0');
}
function getInvoiceById(invId){
  for(const r of db.records){for(const e of r.estimates){if(!e.invoices)continue;const inv=e.invoices.find(i=>i.id===invId);if(inv)return inv}}return null;
}
function getAllInvoices(){
  const all=[];
  db.records.forEach(r=>r.estimates.forEach(e=>{if(e.invoices)e.invoices.forEach(inv=>{all.push({invoice:inv,estimate:e,record:r})})}));
  return all;
}
function createInvoice(type){
  const est=getEstimate();const rec=getRecord();if(!est||!rec)return;
  if(!est.invoices)est.invoices=[];
  const ec=calcEstCosts(est);
  const depositPct=type==='deposit'?(settings.depositPercent!=null?settings.depositPercent:50):null;
  const lineTotal=depositPct?ec.sell*(depositPct/100):ec.sell;
  const taxAmt=depositPct?ec.taxAmount*(depositPct/100):ec.taxAmount;
  const items=type==='deposit'?[{description:'Deposit ('+depositPct+'%) for '+est.name,qty:1,unit:'ea',rate:lineTotal,amount:lineTotal,taxable:true}]:
    est.systems.map(sys=>{const sc=calcSysCosts(sys);const prod=getAllProducts().find(p=>p.id===sys.productId);return{description:(sys.areaName||'Area')+' — '+(prod?prod.name:'Custom')+' ('+sys.sqft+' sqft)',qty:1,unit:'ea',rate:sc.sell,amount:sc.sell,taxable:sys.taxable!==false}});
  const termDays={due_on_receipt:0,net15:15,net30:30,net60:60};
  const due=new Date();due.setDate(due.getDate()+(termDays[settings.paymentTerms]||30));
  const inv={
    id:uid(),number:getNextInvoiceNumber(),createdAt:new Date().toISOString(),
    dueDate:due.toISOString().slice(0,10),
    status:'draft',type:type==='deposit'?'deposit':'standard',
    lineItems:items,subtotal:lineTotal,taxRate:settings.taxRate||0,taxAmount:taxAmt,
    total:lineTotal+taxAmt,depositPercent:depositPct,
    discountType:'none',discountValue:0,discountAmount:0,
    payments:[],amountPaid:0,balance:lineTotal+taxAmt,
    notes:'',sentAt:null
  };
  est.invoices.push(inv);
  logActivity(rec.id,'invoice_created','Invoice '+inv.number+' created ('+fmt(inv.total)+')');
  saveDB(db);goInvoice(inv.id);toast('Invoice Created',inv.number);
}
function renderInvoicesList(){
  const est=getEstimate();if(!est)return;
  if(!est.invoices||!est.invoices.length){document.getElementById('invoicesList').innerHTML='<div class="empty"><div class="empty-icon">&#128179;</div><div class="empty-text">No invoices yet. Create one from this estimate.</div></div>';return}
  checkOverdueInvoices();
  document.getElementById('invoicesList').innerHTML=est.invoices.map(inv=>{
    const statusColors={draft:'var(--t3)',sent:'var(--accent)',partial:'var(--accent)',paid:'var(--success)',overdue:'var(--comp)'};
    return'<div class="sys-card has-product" onclick="goInvoice(\''+inv.id+'\')"><div><div class="sys-area">'+inv.number+'</div><div class="sys-detail">'+inv.type+' \u00b7 '+(inv.dueDate||'No due date')+' \u00b7 <span style="color:'+(statusColors[inv.status]||'var(--t3)')+'">'+inv.status.toUpperCase()+'</span></div></div><div class="sys-right"><div class="sys-price">'+fmt(inv.total)+'</div>'+(inv.balance>0&&inv.balance<inv.total?'<div class="sys-cost">Balance '+fmt(inv.balance)+'</div>':'')+'</div></div>'
  }).join('');
}
function renderInvoice(){
  const inv=getInvoiceById(nav.invoiceId);if(!inv){goEstimate(nav.estimateId);return}
  const rec=getRecord();
  const rn=rec?((rec.firstName||'')+' '+(rec.lastName||'')).trim()||'Client':'Client';
  document.getElementById('invNumber').textContent=inv.number;
  const statusColors={draft:'lead',sent:'est',partial:'est',paid:'comp',overdue:'proj'};
  document.getElementById('invStatusBadge').className='li-badge '+(statusColors[inv.status]||'');
  document.getElementById('invStatusBadge').textContent=inv.status.toUpperCase();
  const created=inv.createdAt?new Date(inv.createdAt).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}):'';
  const sent=inv.sentAt?'Sent '+new Date(inv.sentAt).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}):'';
  document.getElementById('invSubline').textContent=rn+(rec&&rec.company?' \u2014 '+rec.company:'')+(inv.type==='deposit'?' \u2014 Deposit':'')+(created?' \u00b7 Created '+created:'')+(sent?' \u00b7 '+sent:'');
  // From / To
  const fromLines=[(settings.companyName||''),(settings.contactName||''),(settings.address||''),([settings.city,settings.state,settings.zip].filter(Boolean).join(', ')),(settings.phone||''),(settings.email||'')].filter(Boolean);
  const toLines=[rn,(rec&&rec.company?rec.company:''),(rec&&rec.address?rec.address:''),([rec&&rec.city,rec&&rec.state,rec&&rec.zip].filter(Boolean).join(', ')),(rec&&rec.phone?rec.phone:''),(rec&&rec.email?rec.email:'')].filter(Boolean);
  document.getElementById('invFrom').innerHTML=fromLines.join('<br>');
  document.getElementById('invTo').innerHTML=toLines.join('<br>');
  document.getElementById('invDueDate').value=inv.dueDate||'';
  document.getElementById('invType').textContent=inv.type==='deposit'?'Deposit ('+inv.depositPercent+'%)':'Standard';
  document.getElementById('invStatus').innerHTML='<span style="color:'+(inv.status==='paid'?'var(--success)':inv.status==='overdue'?'var(--comp)':'var(--t1)')+'">'+inv.status.charAt(0).toUpperCase()+inv.status.slice(1)+'</span>';
  document.getElementById('invNotes').value=inv.notes||'';
  // Action buttons by status
  let btns='<button class="btn btn-primary" onclick="generateInvoicePDF()">Download PDF</button>';
  if(inv.status!=='paid'){
    btns+='<button class="btn btn-ghost" onclick="emailInvoice()">Email</button>';
    btns+='<button class="btn btn-ghost" onclick="textInvoice()">Text</button>';
  }
  if(inv.status==='draft'){
    btns+='<button class="btn btn-ghost" onclick="markInvoiceSent()">Mark Sent</button>';
    btns+='<button class="btn btn-danger" onclick="deleteInvoice()">Delete</button>';
  }
  if(inv.status!=='paid'&&inv.status!=='draft'){
    btns+='<button class="btn btn-success" onclick="openPaymentModal()">Record Payment</button>';
    btns+='<button class="btn btn-ghost" onclick="markInvoicePaid()">Mark Paid</button>';
    btns+='<button class="btn btn-ghost" onclick="sendInvoiceReminder()">Reminder</button>';
  }
  document.getElementById('invActions').innerHTML=btns;
  // Editable line items
  renderInvoiceLineItems();
  // Discount
  renderInvoiceDiscount();
  // Totals
  renderInvoiceTotals();
  // Payments
  if(inv.payments.length){
    let payHtml='<table style="width:100%;font-size:13px;border-collapse:collapse"><tr style="border-bottom:1px solid var(--b1)"><th style="text-align:left;padding:6px 4px;color:var(--t3);font-weight:500">Date</th><th style="text-align:left;padding:6px 4px;color:var(--t3);font-weight:500">Method</th><th style="text-align:right;padding:6px 4px;color:var(--t3);font-weight:500">Amount</th></tr>';
    inv.payments.forEach(pay=>{payHtml+='<tr style="border-bottom:1px solid var(--b1)"><td style="padding:8px 4px">'+pay.date+'</td><td style="padding:8px 4px">'+pay.method+(pay.note?' \u2014 '+pay.note:'')+'</td><td style="text-align:right;padding:8px 4px;font-family:monospace;color:var(--success)">'+fmt(pay.amount)+'</td></tr>'});
    payHtml+='</table>';
    document.getElementById('invPayments').innerHTML=payHtml;
  }else{document.getElementById('invPayments').innerHTML='<div class="empty"><div class="empty-text">No payments recorded yet.</div></div>'}
  // Balance
  document.getElementById('invBalance').innerHTML='<div class="sx"><div class="sl">Total Paid</div><div class="sv" style="color:var(--success)">'+fmt(inv.amountPaid)+'</div></div><div class="sx hl"><div class="sl">Balance Due</div><div class="sv" style="color:'+(inv.balance>0?'var(--comp)':'var(--success)')+'">'+fmt(inv.balance)+'</div></div>';
  // Stripe pay button
  renderStripePayButton();
}
function renderInvoiceLineItems(){
  const inv=getInvoiceById(nav.invoiceId);if(!inv)return;
  const editable=inv.status==='draft';
  let h='<table style="width:100%;font-size:13px;border-collapse:collapse">';
  h+='<tr style="border-bottom:1px solid var(--b1)"><th style="text-align:left;padding:6px 4px;color:var(--t3);font-weight:500">Description</th><th style="text-align:right;padding:6px 4px;color:var(--t3);font-weight:500;width:65px">Qty</th><th style="text-align:right;padding:6px 4px;color:var(--t3);font-weight:500;width:85px">Rate</th><th style="text-align:right;padding:6px 4px;color:var(--t3);font-weight:500;width:85px">Amount</th>'+(editable?'<th style="width:32px"></th>':'')+'</tr>';
  inv.lineItems.forEach((li,i)=>{
    if(editable){
      h+='<tr style="border-bottom:1px solid var(--b1)"><td style="padding:4px 2px"><input type="text" value="'+li.description.replace(/"/g,'&quot;')+'" onchange="updateLineItem('+i+',\'description\',this.value)" style="width:100%;font-size:12px;padding:4px 6px;background:var(--s2);border:1px solid var(--b1);color:var(--t1);border-radius:4px"></td>';
      h+='<td style="padding:4px 2px"><input type="number" value="'+li.qty+'" min="0" step="1" onchange="updateLineItem('+i+',\'qty\',this.value)" style="width:100%;text-align:right;font-size:12px;padding:4px 6px;background:var(--s2);border:1px solid var(--b1);color:var(--t1);border-radius:4px"></td>';
      h+='<td style="padding:4px 2px"><input type="number" value="'+li.rate.toFixed(2)+'" min="0" step="0.01" onchange="updateLineItem('+i+',\'rate\',this.value)" style="width:100%;text-align:right;font-size:12px;padding:4px 6px;background:var(--s2);border:1px solid var(--b1);color:var(--t1);border-radius:4px"></td>';
      h+='<td style="text-align:right;padding:8px 4px;font-family:monospace">'+fmt(li.amount)+'</td>';
      h+='<td style="text-align:center"><button onclick="removeLineItem('+i+')" style="background:none;border:none;color:var(--comp);cursor:pointer;font-size:16px;padding:4px" title="Remove">&times;</button></td></tr>';
    }else{
      h+='<tr style="border-bottom:1px solid var(--b1)"><td style="padding:8px 4px">'+li.description+(li.taxable&&inv.taxRate>0?' <span style="font-size:10px;color:var(--t3)">T</span>':'')+'</td><td style="text-align:right;padding:8px 4px">'+li.qty+'</td><td style="text-align:right;padding:8px 4px;font-family:monospace">'+fmt(li.rate)+'</td><td style="text-align:right;padding:8px 4px;font-family:monospace">'+fmt(li.amount)+'</td></tr>';
    }
  });
  h+='</table>';
  document.getElementById('invLineItems').innerHTML=h;
}
function updateLineItem(idx,field,val){
  const inv=getInvoiceById(nav.invoiceId);if(!inv||!inv.lineItems[idx])return;
  const li=inv.lineItems[idx];
  if(field==='description')li.description=val;
  else if(field==='qty'){li.qty=parseFloat(val)||0;li.amount=li.qty*li.rate}
  else if(field==='rate'){li.rate=parseFloat(val)||0;li.amount=li.qty*li.rate}
  recalcInvoiceTotals();renderInvoiceLineItems();renderInvoiceTotals();
}
function addLineItem(){
  const inv=getInvoiceById(nav.invoiceId);if(!inv)return;
  inv.lineItems.push({description:'Custom item',qty:1,unit:'ea',rate:0,amount:0,taxable:true});
  recalcInvoiceTotals();renderInvoiceLineItems();renderInvoiceTotals();
}
function removeLineItem(idx){
  const inv=getInvoiceById(nav.invoiceId);if(!inv)return;
  inv.lineItems.splice(idx,1);
  recalcInvoiceTotals();renderInvoiceLineItems();renderInvoiceTotals();
}
function recalcInvoiceTotals(){
  const inv=getInvoiceById(nav.invoiceId);if(!inv)return;
  const rawSubtotal=inv.lineItems.reduce((s,li)=>s+li.amount,0);
  if(inv.discountType==='percent')inv.discountAmount=rawSubtotal*(inv.discountValue/100);
  else if(inv.discountType==='flat')inv.discountAmount=Math.min(inv.discountValue,rawSubtotal);
  else inv.discountAmount=0;
  inv.subtotal=rawSubtotal-inv.discountAmount;
  inv.taxAmount=inv.lineItems.filter(li=>li.taxable).reduce((s,li)=>s+li.amount,0)*(inv.taxRate/100);
  if(inv.discountAmount>0&&inv.discountType==='percent')inv.taxAmount=inv.taxAmount*(1-inv.discountValue/100);
  inv.total=inv.subtotal+inv.taxAmount;
  inv.balance=Math.max(0,inv.total-inv.amountPaid);
  if(inv.balance<=0&&inv.amountPaid>0)inv.status='paid';
  saveDB(db);
}
function renderInvoiceDiscount(){
  const inv=getInvoiceById(nav.invoiceId);if(!inv)return;
  const el=document.getElementById('invDiscount');
  if(inv.status!=='draft'){el.style.display=inv.discountAmount>0?'':'none';if(inv.discountAmount>0)el.innerHTML='<div style="display:flex;justify-content:space-between;padding:4px 0;font-size:13px;color:var(--t2)"><span>Discount'+(inv.discountType==='percent'?' ('+inv.discountValue+'%)':'')+'</span><span style="color:var(--success)">-'+fmt(inv.discountAmount)+'</span></div>';return}
  el.style.display='';
  el.innerHTML='<div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap"><label style="font-size:12px;color:var(--t3);white-space:nowrap">Discount</label><select onchange="updateInvoiceDiscount(\'type\',this.value)" style="font-size:12px;padding:4px 8px;background:var(--s2);border:1px solid var(--b1);color:var(--t1);border-radius:4px"><option value="none"'+(inv.discountType==='none'?' selected':'')+'>None</option><option value="percent"'+(inv.discountType==='percent'?' selected':'')+'>%</option><option value="flat"'+(inv.discountType==='flat'?' selected':'')+'>$</option></select>'+(inv.discountType!=='none'?'<input type="number" value="'+inv.discountValue+'" min="0" step="0.01" onchange="updateInvoiceDiscount(\'value\',this.value)" style="width:80px;font-size:12px;padding:4px 8px;text-align:right;background:var(--s2);border:1px solid var(--b1);color:var(--t1);border-radius:4px"><span style="font-size:12px;color:var(--success)">-'+fmt(inv.discountAmount)+'</span>':'')+'</div>';
}
function updateInvoiceDiscount(field,val){
  const inv=getInvoiceById(nav.invoiceId);if(!inv)return;
  if(field==='type'){inv.discountType=val;if(val==='none'){inv.discountValue=0;inv.discountAmount=0}}
  else if(field==='value')inv.discountValue=parseFloat(val)||0;
  recalcInvoiceTotals();renderInvoiceDiscount();renderInvoiceTotals();
}
function renderInvoiceTotals(){
  const inv=getInvoiceById(nav.invoiceId);if(!inv)return;
  const rawSub=inv.lineItems.reduce((s,li)=>s+li.amount,0);
  let h='<div class="sx"><div class="sl">Subtotal</div><div class="sv">'+fmt(rawSub)+'</div></div>';
  if(inv.discountAmount>0)h+='<div class="sx"><div class="sl">Discount</div><div class="sv" style="color:var(--success)">-'+fmt(inv.discountAmount)+'</div></div>';
  if(inv.taxAmount>0)h+='<div class="sx"><div class="sl">Tax ('+inv.taxRate+'%)</div><div class="sv">'+fmt(inv.taxAmount)+'</div></div>';
  h+='<div class="sx hl"><div class="sl">Total</div><div class="sv" style="color:var(--accent)">'+fmt(inv.total)+'</div></div>';
  document.getElementById('invTotals').innerHTML=h;
}
function updateInvoiceField(field,val){const inv=getInvoiceById(nav.invoiceId);if(!inv)return;inv[field]=val;saveDB(db)}
function markInvoiceSent(){
  const inv=getInvoiceById(nav.invoiceId);if(!inv)return;
  inv.status='sent';inv.sentAt=new Date().toISOString();
  if(nav.recordId)logActivity(nav.recordId,'invoice_sent','Invoice '+inv.number+' marked as sent');
  saveDB(db);renderInvoice();toast('Sent','Invoice marked as sent.');
}
function markInvoicePaid(){
  const inv=getInvoiceById(nav.invoiceId);if(!inv||inv.balance<=0)return;
  const amt=inv.balance;
  inv.payments.push({id:uid(),date:new Date().toISOString().slice(0,10),amount:amt,method:'Manual',note:'Marked as paid'});
  inv.amountPaid=(inv.amountPaid||0)+amt;inv.balance=0;inv.status='paid';
  if(nav.recordId)logActivity(nav.recordId,'payment_received','Payment of '+fmt(amt)+' received for '+inv.number+' (marked paid)');
  saveDB(db);renderInvoice();
  const rec=getRecord();if(rec&&isRecordInvoiced(rec)){const allPaid=rec.estimates.every(e=>!e.invoices||e.invoices.every(i=>i.status==='paid'));if(allPaid)toast('Paid in Full','\u2713 All invoices paid!');else toast('Paid',inv.number+' marked as paid.')}else toast('Paid',inv.number+' marked as paid.');
}
function deleteInvoice(){
  const inv=getInvoiceById(nav.invoiceId);if(!inv||inv.status!=='draft')return;
  openConfirm('Delete Invoice','Delete '+inv.number+'? This cannot be undone.',()=>{
    const est=getEstimate();if(!est||!est.invoices)return;
    est.invoices=est.invoices.filter(i=>i.id!==inv.id);
    if(nav.recordId)logActivity(nav.recordId,'invoice_deleted','Invoice '+inv.number+' deleted');
    saveDB(db);goEstimate(nav.estimateId);switchEstTab('invoices');toast('Deleted',inv.number+' removed.');
  });
}
function openPaymentModal(){
  document.getElementById('payAmount').value='';
  document.getElementById('payDate').value=new Date().toISOString().slice(0,10);
  document.getElementById('payNote').value='';
  document.getElementById('paymentModal').classList.add('active');
}
function closePaymentModal(){document.getElementById('paymentModal').classList.remove('active')}
function recordPayment(){
  const inv=getInvoiceById(nav.invoiceId);if(!inv)return;
  const amt=parseFloat(document.getElementById('payAmount').value)||0;
  if(amt<=0){toast('Error','Enter a payment amount.');return}
  const pay={id:uid(),date:document.getElementById('payDate').value,amount:amt,method:document.getElementById('payMethod').value,note:document.getElementById('payNote').value.trim()};
  inv.payments.push(pay);
  inv.amountPaid=(inv.amountPaid||0)+amt;
  inv.balance=inv.total-inv.amountPaid;
  if(inv.balance<=0){inv.status='paid';inv.balance=0}
  else if(inv.amountPaid>0)inv.status='partial';
  if(nav.recordId)logActivity(nav.recordId,'payment_received','Payment of '+fmt(amt)+' received for '+inv.number);
  closePaymentModal();saveDB(db);renderInvoice();
  if(inv.status==='paid'){const rec=getRecord();if(rec&&isRecordInvoiced(rec)){const allPaid=rec.estimates.every(e=>!e.invoices||e.invoices.every(i=>i.status==='paid'));if(allPaid){toast('Paid in Full','\u2713 All invoices paid!');return}}}
  toast('Payment Recorded',fmt(amt)+' applied to '+inv.number);
}
function checkOverdueInvoices(){
  const now=new Date().toISOString().slice(0,10);
  db.records.forEach(r=>r.estimates.forEach(e=>{if(e.invoices)e.invoices.forEach(inv=>{if(inv.status==='sent'&&inv.dueDate&&inv.dueDate<now)inv.status='overdue'})}));
}
function generateInvoicePDF(returnBase64){
  const inv=getInvoiceById(nav.invoiceId);const rec=getRecord();const est=getEstimate();
  if(!inv||!rec){toast('Error','Invoice not found.');return null}
  if(typeof window.jspdf==='undefined'){toast('Error','PDF library not loaded.');return null}
  const{jsPDF}=window.jspdf;const doc=new jsPDF();
  const pw=doc.internal.pageSize.getWidth();
  const rn=((rec.firstName||'')+' '+(rec.lastName||'')).trim()||'Client';
  const today=new Date().toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'});
  const ar=settings.pdfAccentR||37,ag=settings.pdfAccentG||99,ab=settings.pdfAccentB||235;
  const pf=settings.pdfFontFamily||'helvetica';
  // Header
  doc.setFillColor(ar,ag,ab);doc.rect(0,0,pw,32,'F');
  doc.setTextColor(0);doc.setFontSize(20);doc.setFont(pf,'bold');
  doc.text('INVOICE',14,16);
  doc.setFontSize(10);doc.setFont(pf,'normal');
  doc.text(settings.companyName||'The Concrete Protector',14,24);
  doc.setFontSize(9);doc.text(inv.number,pw-14,12,{align:'right'});
  doc.text('Date: '+today,pw-14,18,{align:'right'});
  doc.text('Due: '+(inv.dueDate||'N/A'),pw-14,24,{align:'right'});
  if(settings.companyLogo){try{doc.addImage(settings.companyLogo,'PNG',pw-54,4,40,24)}catch(e){}}
  // From / Bill To
  let y=44;doc.setTextColor(80);doc.setFontSize(9);doc.setFont(pf,'bold');doc.text('FROM:',14,y);doc.text('BILL TO:',110,y);
  y+=6;doc.setFont(pf,'normal');doc.setTextColor(30);doc.setFontSize(10);
  doc.text(settings.companyName||'',14,y);doc.text(rn,110,y);y+=5;
  if(settings.contactName)doc.text(settings.contactName,14,y);if(rec.company)doc.text(rec.company,110,y);y+=5;
  if(settings.address)doc.text(settings.address,14,y);if(rec.address)doc.text(rec.address,110,y);y+=5;
  const fromLoc=[settings.city,settings.state,settings.zip].filter(Boolean).join(', ');
  const toLoc=[rec.city,rec.state,rec.zip].filter(Boolean).join(', ');
  if(fromLoc)doc.text(fromLoc,14,y);if(toLoc)doc.text(toLoc,110,y);y+=5;
  if(settings.phone)doc.text(settings.phone,14,y);if(rec.phone)doc.text(rec.phone,110,y);y+=5;
  if(settings.email)doc.text(settings.email,14,y);if(rec.email)doc.text(rec.email,110,y);y+=10;
  // Line items table
  doc.setFillColor(240,240,240);doc.rect(14,y,pw-28,8,'F');
  doc.setFontSize(9);doc.setFont(pf,'bold');doc.setTextColor(80);
  doc.text('Description',16,y+6);doc.text('Qty',130,y+6,{align:'right'});doc.text('Rate',155,y+6,{align:'right'});doc.text('Amount',pw-16,y+6,{align:'right'});y+=12;
  doc.setFont(pf,'normal');doc.setTextColor(30);doc.setFontSize(10);
  inv.lineItems.forEach(li=>{
    if(y>260){doc.addPage();y=20}
    const desc=li.description.length>55?li.description.substring(0,52)+'...':li.description;
    doc.text(desc,16,y);
    doc.text(String(li.qty),130,y,{align:'right'});
    doc.text(fmt(li.rate),155,y,{align:'right'});
    doc.setFont(pf,'bold');doc.text(fmt(li.amount),pw-16,y,{align:'right'});doc.setFont(pf,'normal');
    y+=7;doc.setDrawColor(230);doc.line(14,y-2,pw-14,y-2);y+=3;
  });
  // Totals
  y+=4;doc.setFontSize(10);doc.setTextColor(80);
  const rawSub=inv.lineItems.reduce((s,li)=>s+li.amount,0);
  doc.text('Subtotal:',140,y);doc.text(fmt(rawSub),pw-16,y,{align:'right'});y+=6;
  if(inv.discountAmount>0){doc.text('Discount'+(inv.discountType==='percent'?' ('+inv.discountValue+'%)':'')+':',140,y);doc.text('-'+fmt(inv.discountAmount),pw-16,y,{align:'right'});y+=6}
  if(inv.taxAmount>0){doc.text('Tax ('+inv.taxRate+'%):',140,y);doc.text(fmt(inv.taxAmount),pw-16,y,{align:'right'});y+=6}
  doc.setFillColor(ar,ag,ab);doc.rect(120,y-4,pw-134,10,'F');
  doc.setFontSize(12);doc.setFont(pf,'bold');doc.setTextColor(0);
  doc.text('TOTAL:',122,y+3);doc.text(fmt(inv.total),pw-16,y+3,{align:'right'});y+=14;
  // Payments
  if(inv.payments.length){
    doc.setFontSize(10);doc.setFont(pf,'bold');doc.setTextColor(30);doc.text('Payments Received:',14,y);y+=7;
    doc.setFont(pf,'normal');doc.setFontSize(9);
    inv.payments.forEach(p=>{doc.text(p.date+' — '+p.method+': '+fmt(p.amount)+(p.note?' ('+p.note+')':''),16,y);y+=5});
    y+=4;
  }
  // Balance due
  if(inv.balance>0){
    doc.setFillColor(30,30,30);doc.rect(120,y-4,pw-134,10,'F');
    doc.setFontSize(12);doc.setFont(pf,'bold');doc.setTextColor(ar,ag,ab);
    doc.text('BALANCE DUE:',122,y+3);doc.text(fmt(inv.balance),pw-16,y+3,{align:'right'});y+=14;
  }else{
    doc.setFontSize(11);doc.setFont(pf,'bold');doc.setTextColor(34,197,94);
    doc.text('PAID IN FULL',pw/2,y+3,{align:'center'});y+=14;
  }
  // Notes
  if(inv.notes){y+=4;doc.setTextColor(80);doc.setFontSize(9);doc.setFont(pf,'bold');doc.text('Notes:',14,y);y+=5;doc.setFont(pf,'normal');doc.setFontSize(8);doc.splitTextToSize(inv.notes,pw-28).forEach(l=>{doc.text(l,14,y);y+=4})}
  // Payment terms & Footer
  const termLabels={due_on_receipt:'Due on Receipt',net15:'Net 15',net30:'Net 30',net60:'Net 60'};
  y+=4;doc.setFontSize(9);doc.setTextColor(80);doc.setFont(pf,'normal');
  doc.text('Payment Terms: '+(termLabels[settings.paymentTerms]||'Net 30'),14,y);y+=10;
  doc.setFontSize(7);doc.setTextColor(160);
  doc.text('Generated by Coatings Estimator \u2014 '+(settings.companyName||'The Concrete Protector'),pw/2,y,{align:'center'});
  const fn='Invoice-'+inv.number+'-'+rn.replace(/\s+/g,'-')+'.pdf';
  if(returnBase64){return{base64:doc.output('datauristring').split(',')[1],filename:fn}}
  doc.save(fn);if(nav.recordId)logActivity(nav.recordId,'invoice_pdf','Invoice '+inv.number+' PDF generated');saveDB(db);toast('Invoice PDF',fn);
}
function goAllInvoices(){
  Object.assign(nav,{screen:'invoices-all',folderStatus:null,folderActive:true,recordId:null,estimateId:null,systemId:null,invoiceId:null});
  renderBreadcrumb();renderAllInvoices();showScreen('invoices-all');updateSidebarActive();closeMobileSidebar();
}
function renderAllInvoices(){
  checkOverdueInvoices();
  const all=getAllInvoices().sort((a,b)=>new Date(b.invoice.createdAt)-new Date(a.invoice.createdAt));
  const el=document.getElementById('allInvoicesList');if(!el)return;
  const unpaid=all.filter(x=>x.invoice.balance>0);
  const totalUnpaid=unpaid.reduce((s,x)=>s+x.invoice.balance,0);
  const totalPaid=all.reduce((s,x)=>s+x.invoice.amountPaid,0);
  document.getElementById('invSummary').innerHTML=
    '<div class="sx hl"><div class="sl">Total Outstanding</div><div class="sv" style="color:var(--comp)">'+fmt(totalUnpaid)+'</div></div>'+
    '<div class="sx"><div class="sl">Total Collected</div><div class="sv" style="color:var(--success)">'+fmt(totalPaid)+'</div></div>'+
    '<div class="sx"><div class="sl">Invoices</div><div class="sv">'+all.length+'</div></div>';
  if(!all.length){el.innerHTML='<div class="empty"><div class="empty-icon">&#128179;</div><div class="empty-text">No invoices created yet.</div></div>';return}
  el.innerHTML=all.map(({invoice:inv,record:r})=>{
    const name=((r.firstName||'')+' '+(r.lastName||'')).trim()||'Client';
    const statusColors={draft:'var(--t3)',sent:'var(--accent)',partial:'var(--accent)',paid:'var(--success)',overdue:'var(--comp)'};
    return'<div class="list-item" onclick="nav.recordId=\''+r.id+'\';nav.folderStatus=\''+r.status+'\';nav.folderActive='+r.active+';nav.estimateId=\''+r.estimates.find(e=>e.invoices&&e.invoices.some(i=>i.id===inv.id)).id+'\';goInvoice(\''+inv.id+'\')"><div class="li-left"><div class="li-avatar '+(inv.status==='paid'?'comp':inv.status==='overdue'?'proj':'est')+'">'+inv.number.slice(-3)+'</div><div><div class="li-name">'+inv.number+' — '+name+'</div><div class="li-meta">'+inv.type+' \u00b7 Due: '+(inv.dueDate||'N/A')+' \u00b7 <span style="color:'+(statusColors[inv.status]||'var(--t3)')+'">'+inv.status.toUpperCase()+'</span></div></div></div><div class="li-right"><div class="li-amount">'+fmt(inv.total)+'</div>'+(inv.balance>0&&inv.balance<inv.total?'<div class="li-meta">Bal: '+fmt(inv.balance)+'</div>':'')+'</div></div>'
  }).join('');
  // Update sidebar badge
  const badge=document.getElementById('invBadge');
  if(badge)badge.textContent=unpaid.length>0?'('+unpaid.length+')':'';
}
function updateInvoiceBadge(){
  const unpaid=getAllInvoices().filter(x=>x.invoice.balance>0);
  const badge=document.getElementById('invBadge');
  if(badge)badge.textContent=unpaid.length>0?'('+unpaid.length+')':'';
}// ═══════════════════════════════════════════════════════════
// PDF PROPOSAL (Phase 3)
// ═══════════════════════════════════════════════════════════
function generateProposal(returnBase64){
  const rec=getRecord();const est=getEstimate();
  if(!rec||!est){toast('Error','No estimate to generate.');return null}
  if(typeof window.jspdf==='undefined'){toast('Error','PDF library not loaded. Check internet connection.');return null}
  const{jsPDF}=window.jspdf;
  const doc=new jsPDF();
  const pw=doc.internal.pageSize.getWidth();
  const rn=((rec.firstName||'')+' '+(rec.lastName||'')).trim()||'Client';
  const ec=calcEstCosts(est);
  const today=new Date().toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'});
  const ar=settings.pdfAccentR||37,ag=settings.pdfAccentG||99,ab=settings.pdfAccentB||235;
  const pf=settings.pdfFontFamily||'helvetica';
  // Header bar
  const compName=settings.companyName||'The Concrete Protector';
  const compTag=settings.tagline||'Decorative Concrete Coatings Proposal';
  doc.setFillColor(ar,ag,ab);doc.rect(0,0,pw,32,'F');
  doc.setTextColor(0);doc.setFontSize(20);doc.setFont(pf,'bold');
  doc.text(compName,14,16);
  doc.setFontSize(10);doc.setFont(pf,'normal');
  doc.text(compTag,14,24);
  doc.setFontSize(9);doc.text(today,pw-14,16,{align:'right'});
  doc.text((est.name||'Estimate'),pw-14,24,{align:'right'});
  if(settings.companyLogo){try{doc.addImage(settings.companyLogo,'PNG',pw-54,4,40,24)}catch(e){}}
  // Client info
  let y=44;doc.setTextColor(60);doc.setFontSize(12);doc.setFont(pf,'bold');doc.text('Prepared For:',14,y);
  y+=7;doc.setFont(pf,'normal');doc.setFontSize(11);doc.setTextColor(30);
  doc.text(rn,14,y);y+=6;
  if(rec.company){doc.text(rec.company,14,y);y+=6}
  if(rec.address){doc.text(rec.address,14,y);y+=6}
  const loc=[rec.city,rec.state,rec.zip].filter(Boolean).join(', ');
  if(loc){doc.text(loc,14,y);y+=6}
  if(rec.phone){doc.text(rec.phone,14,y);y+=6}
  if(rec.email){doc.text(rec.email,14,y);y+=6}
  // Area table
  y+=8;doc.setFillColor(240,240,240);doc.rect(14,y,pw-28,8,'F');
  doc.setFontSize(9);doc.setFont(pf,'bold');doc.setTextColor(80);
  doc.text('Area',16,y+6);doc.text('System',70,y+6);doc.text('Sqft',120,y+6,{align:'right'});
  doc.text('$/Sqft',145,y+6,{align:'right'});doc.text('Price',pw-16,y+6,{align:'right'});
  y+=12;doc.setFont(pf,'normal');doc.setTextColor(30);
  est.systems.forEach((sys,i)=>{
    if(y>260){doc.addPage();y=20}
    const prod=getAllProducts().find(p=>p.id===sys.productId);
    const sc=calcSysCosts(sys);
    doc.setFontSize(10);
    doc.text(sys.areaName||'Area '+(i+1),16,y);
    doc.text(prod?prod.name:'—',70,y);
    doc.text((sys.sqft||0).toLocaleString(),120,y,{align:'right'});
    doc.text('$'+(sys.sellRate||0).toFixed(2),145,y,{align:'right'});
    doc.setFont(pf,'bold');doc.text(fmt(sc.sell),pw-16,y,{align:'right'});doc.setFont(pf,'normal');
    y+=7;
    // Line items for repairs/addons
    const extras=[];
    if(sys.repairs){Object.entries(sys.repairs).forEach(([id,r])=>{if(r.on&&r.qty>0){const def=getAllRepairs().find(x=>x.id===id);if(def)extras.push('  '+def.name+': '+r.qty+' '+def.unit+' @ $'+(r.sell||0).toFixed(2))}})}
    if(sys.addons){Object.entries(sys.addons).forEach(([id,a])=>{if(a.on&&a.qty>0){const def=getAllAddons().find(x=>x.id===id);if(def)extras.push('  '+def.name+': '+a.qty+' '+def.unit+' @ $'+(a.sell||0).toFixed(2))}})}
    if(extras.length){doc.setFontSize(8);doc.setTextColor(120);extras.forEach(ex=>{doc.text(ex,18,y);y+=5});doc.setTextColor(30)}
    doc.setDrawColor(230);doc.line(14,y-2,pw-14,y-2);y+=3;
  });
  // Total
  y+=4;
  if(ec.taxAmount>0){
    doc.setFontSize(10);doc.setFont(pf,'normal');doc.setTextColor(80);
    doc.text('Subtotal:',130,y+2);doc.text(fmt(ec.sell),pw-16,y+2,{align:'right'});y+=8;
    doc.text('Tax ('+(settings.taxRate||0)+'%):',130,y+2);doc.text(fmt(ec.taxAmount),pw-16,y+2,{align:'right'});y+=8;
  }
  doc.setFillColor(ar,ag,ab);doc.rect(100,y-5,pw-114,10,'F');
  doc.setFontSize(12);doc.setFont(pf,'bold');doc.setTextColor(0);
  doc.text('TOTAL:',102,y+2);doc.text(fmt(ec.taxAmount>0?ec.totalWithTax:ec.sell),pw-16,y+2,{align:'right'});
  // Terms
  y+=20;doc.setTextColor(80);doc.setFontSize(9);doc.setFont(pf,'bold');
  doc.text('Terms & Conditions',14,y);y+=6;doc.setFont(pf,'normal');doc.setFontSize(8);
  const terms=document.getElementById('contractTerms')?document.getElementById('contractTerms').value:(settings.terms||'Proposal valid for 30 days. 50% deposit required to schedule.');
  const tlines=doc.splitTextToSize(terms,pw-28);
  tlines.forEach(l=>{if(y>280){doc.addPage();y=20}doc.text(l,14,y);y+=4});
  // Signature lines
  y+=12;if(y>250){doc.addPage();y=20}
  doc.setDrawColor(180);doc.setLineWidth(0.5);
  doc.line(14,y,90,y);doc.line(110,y,pw-14,y);
  y+=5;doc.setFontSize(8);doc.text('Contractor Signature / Date',14,y);doc.text('Customer Signature / Date',110,y);
  // Footer
  y+=12;doc.setFontSize(7);doc.setTextColor(160);
  doc.text('Generated by Coatings Estimator \u2014 '+(settings.companyName||'The Concrete Protector'),pw/2,y,{align:'center'});
  const fn=(settings.pdfFilePrefix||'TCP')+'-Proposal-'+rn.replace(/\s+/g,'-')+'-'+new Date().toISOString().slice(0,10)+'.pdf';
  if(returnBase64){return{base64:doc.output('datauristring').split(',')[1],filename:fn}}
  doc.save(fn);if(nav.recordId)logActivity(nav.recordId,'proposal_generated','Proposal PDF generated for \''+est.name+'\'');
  if(!est.quoteStatus||est.quoteStatus==='draft'){est.quoteStatus='sent';est.quoteSentAt=new Date().toISOString()}
  saveDB(db);toast('Proposal Saved',fn);
}

// ═══════════════════════════════════════════════════════════
// CONTRACT / SIGNATURE (Phase 3)
// ═══════════════════════════════════════════════════════════
const sigPads={};
function initSignaturePads(){
  ['sigContractor','sigCustomer'].forEach(id=>{
    if(sigPads[id])return;
    const canvas=document.getElementById(id);if(!canvas)return;
    const ctx=canvas.getContext('2d');
    canvas.width=canvas.offsetWidth*2;canvas.height=canvas.offsetHeight*2;
    ctx.scale(2,2);ctx.strokeStyle='#fafafa';ctx.lineWidth=2;ctx.lineCap='round';ctx.lineJoin='round';
    let drawing=false;let lx=0,ly=0;
    function getPos(e){const r=canvas.getBoundingClientRect();const t=e.touches?e.touches[0]:e;return{x:t.clientX-r.left,y:t.clientY-r.top}}
    canvas.addEventListener('mousedown',e=>{drawing=true;const p=getPos(e);lx=p.x;ly=p.y});
    canvas.addEventListener('mousemove',e=>{if(!drawing)return;const p=getPos(e);ctx.beginPath();ctx.moveTo(lx,ly);ctx.lineTo(p.x,p.y);ctx.stroke();lx=p.x;ly=p.y});
    canvas.addEventListener('mouseup',()=>drawing=false);
    canvas.addEventListener('mouseleave',()=>drawing=false);
    canvas.addEventListener('touchstart',e=>{e.preventDefault();drawing=true;const p=getPos(e);lx=p.x;ly=p.y},{passive:false});
    canvas.addEventListener('touchmove',e=>{e.preventDefault();if(!drawing)return;const p=getPos(e);ctx.beginPath();ctx.moveTo(lx,ly);ctx.lineTo(p.x,p.y);ctx.stroke();lx=p.x;ly=p.y},{passive:false});
    canvas.addEventListener('touchend',()=>drawing=false);
    sigPads[id]={canvas,ctx};
  });
}
function clearSig(id){
  const pad=sigPads[id];
  if(pad){pad.ctx.clearRect(0,0,pad.canvas.width/2,pad.canvas.height/2)}
  else{const c=document.getElementById(id);if(c){const x=c.getContext('2d');x.clearRect(0,0,c.width,c.height)}}
}
function generateContract(){
  const rec=getRecord();const est=getEstimate();
  if(!rec||!est){toast('Error','No estimate selected.');return}
  if(typeof window.jspdf==='undefined'){toast('Error','PDF library not loaded.');return}
  const{jsPDF}=window.jspdf;const doc=new jsPDF();
  const pw=doc.internal.pageSize.getWidth();
  const rn=((rec.firstName||'')+' '+(rec.lastName||'')).trim()||'Client';
  const ec=calcEstCosts(est);
  const today=new Date().toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'});
  const ar=settings.pdfAccentR||37,ag=settings.pdfAccentG||99,ab=settings.pdfAccentB||235;
  const pf=settings.pdfFontFamily||'helvetica';
  // Header
  doc.setFillColor(30,30,30);doc.rect(0,0,pw,28,'F');
  doc.setTextColor(ar,ag,ab);doc.setFontSize(18);doc.setFont(pf,'bold');
  doc.text('SERVICE CONTRACT',14,14);
  doc.setFontSize(10);doc.setTextColor(200,200,200);doc.setFont(pf,'normal');
  doc.text(settings.companyName||'The Concrete Protector',14,22);doc.text(today,pw-14,14,{align:'right'});
  // Parties
  let y=40;doc.setTextColor(30);doc.setFontSize(11);doc.setFont(pf,'bold');
  doc.text('Client:',14,y);doc.setFont(pf,'normal');doc.text(rn+(rec.company?' \u2014 '+rec.company:''),50,y);
  y+=7;const addr=[rec.address,[rec.city,rec.state,rec.zip].filter(Boolean).join(', ')].filter(Boolean).join(', ');
  if(addr){doc.setFontSize(10);doc.text(addr,50,y);y+=7}
  // Scope table
  y+=6;doc.setFontSize(11);doc.setFont(pf,'bold');doc.text('Scope of Work',14,y);y+=8;
  doc.setFillColor(245,245,245);doc.rect(14,y-4,pw-28,8,'F');
  doc.setFontSize(9);doc.setTextColor(80);doc.text('Area',16,y+2);doc.text('System',70,y+2);
  doc.text('Sqft',130,y+2,{align:'right'});doc.text('Price',pw-16,y+2,{align:'right'});y+=10;
  doc.setFont(pf,'normal');doc.setTextColor(30);
  est.systems.forEach((sys,i)=>{
    const prod=getAllProducts().find(p=>p.id===sys.productId);const sc=calcSysCosts(sys);
    doc.text(sys.areaName||'Area '+(i+1),16,y);doc.text(prod?prod.name:'\u2014',70,y);
    doc.text((sys.sqft||0).toLocaleString(),130,y,{align:'right'});
    doc.setFont(pf,'bold');doc.text(fmt(sc.sell),pw-16,y,{align:'right'});doc.setFont(pf,'normal');y+=7
  });
  y+=2;
  if(ec.taxAmount>0){
    doc.setFontSize(10);doc.setFont(pf,'normal');doc.setTextColor(80);
    doc.text('Subtotal:',130,y);doc.text(fmt(ec.sell),pw-16,y,{align:'right'});y+=7;
    doc.text('Tax ('+(settings.taxRate||0)+'%):',130,y);doc.text(fmt(ec.taxAmount),pw-16,y,{align:'right'});y+=7;
    doc.setTextColor(30);
  }
  doc.setDrawColor(ar,ag,ab);doc.setLineWidth(1);doc.line(100,y,pw-14,y);y+=6;
  doc.setFontSize(13);doc.setFont(pf,'bold');doc.text('Contract Total: '+fmt(ec.taxAmount>0?ec.totalWithTax:ec.sell),pw-16,y,{align:'right'});
  // Terms
  y+=14;doc.setFontSize(10);doc.text('Terms & Conditions',14,y);y+=7;
  doc.setFont(pf,'normal');doc.setFontSize(8);doc.setTextColor(60);
  const terms=document.getElementById('contractTerms').value;
  doc.splitTextToSize(terms,pw-28).forEach(l=>{if(y>265){doc.addPage();y=20}doc.text(l,14,y);y+=4});
  // Signatures
  y+=10;if(y>230){doc.addPage();y=20}
  doc.setTextColor(30);doc.setFontSize(10);doc.setFont(pf,'bold');doc.text('Signatures',14,y);y+=10;
  ['sigContractor','sigCustomer'].forEach((id,i)=>{
    const c=document.getElementById(id);
    if(c){try{const img=c.toDataURL('image/png');doc.addImage(img,i===0?14:110,y,75,28)}catch(e){}}
  });
  y+=32;doc.setDrawColor(180);doc.setLineWidth(0.5);
  doc.line(14,y,90,y);doc.line(110,y,pw-14,y);y+=5;
  doc.setFontSize(8);doc.setFont(pf,'normal');doc.setTextColor(100);
  doc.text('Contractor Signature / Date',14,y);doc.text('Customer Signature / Date',110,y);
  y+=10;doc.setFontSize(7);doc.setTextColor(160);
  doc.text('Generated by Coatings Estimator \u2014 '+(settings.companyName||'The Concrete Protector'),pw/2,y,{align:'center'});
  const fn=(settings.pdfFilePrefix||'TCP')+'-Contract-'+rn.replace(/\s+/g,'-')+'-'+new Date().toISOString().slice(0,10)+'.pdf';
  doc.save(fn);if(nav.recordId)logActivity(nav.recordId,'contract_generated','Contract PDF generated for \''+est.name+'\'');saveDB(db);toast('Contract Saved',fn);
}// ═══════════════════════════════════════════════════════════
// EMAIL / TEXT COMMUNICATION
// ═══════════════════════════════════════════════════════════
function emailProposal(){
  const rec=getRecord();const est=getEstimate();if(!rec||!est)return;
  const to=rec.email||'';
  const rn=((rec.firstName||'')+' '+(rec.lastName||'')).trim()||'Client';
  const subj='Proposal from '+(settings.companyName||'The Concrete Protector')+' - '+(est.name||'Estimate');
  const ec=calcEstCosts(est);
  const body='Hi '+(rec.firstName||'')+',\n\nHere is our proposal for '+(est.name||'your project')+'.\n\nEstimate Total: '+fmt(ec.totalWithTax)+'\n\nPlease let us know if you have any questions!\n\nThank you,\n'+(settings.contactName||settings.companyName||'');
  // EmailJS: send with PDF attachment
  if(isEmailJSReady()){
    if(!to){toast('No Email','Add an email address to this record first.');return}
    const pdf=generateProposal(true);
    if(!pdf)return;
    toast('Sending...','Emailing proposal to '+to);
    emailjs.send(settings.emailjsServiceId,settings.emailjsTemplateId,{
      to_email:to,to_name:rn,from_name:settings.contactName||settings.companyName||'The Concrete Protector',
      reply_to:settings.email||'',subject:subj,message:body,
      attachment:pdf.base64,attachment_name:pdf.filename
    }).then(function(){
      toast('Email Sent','Proposal sent to '+to+' with PDF.');
      logActivity(rec.id,'email_sent','Proposal emailed to '+to+' via EmailJS');
      if(!est.quoteStatus||est.quoteStatus==='draft'){est.quoteStatus='sent';est.quoteSentAt=new Date().toISOString()}
      saveDB(db);if(nav.screen==='estimate')renderEstimate();if(nav.screen==='record')renderRecord();
    },function(err){
      toast('Email Failed',(err&&err.text)||'Could not send. Check EmailJS settings.');
    });
  }else{
    // Fallback: download PDF + mailto
    generateProposal();
    setTimeout(function(){window.open('mailto:'+encodeURIComponent(to)+'?subject='+encodeURIComponent(subj)+'&body='+encodeURIComponent(body))},300);
    logActivity(rec.id,'email_sent','Proposal email opened for '+(to||'(no email)'));
    if(!est.quoteStatus||est.quoteStatus==='draft'){est.quoteStatus='sent';est.quoteSentAt=new Date().toISOString()}
    saveDB(db);toast('PDF Downloaded','Attach the downloaded PDF to your email.');
  }
}
function textProposal(){
  const rec=getRecord();const est=getEstimate();if(!rec||!est)return;
  const ec=calcEstCosts(est);
  const body='Hi '+(rec.firstName||'')+', here is your quote from '+(settings.companyName||'The Concrete Protector')+' for '+(est.name||'your project')+': '+fmt(ec.totalWithTax)+'. Let me know if you have any questions! - '+(settings.contactName||'');
  window.open('sms:'+(rec.phone||'')+'?body='+encodeURIComponent(body));
  logActivity(rec.id,'text_sent','Proposal texted to '+(rec.phone||'(no phone)'));
  if(!est.quoteStatus||est.quoteStatus==='draft'){est.quoteStatus='sent';est.quoteSentAt=new Date().toISOString()}
  saveDB(db);
  if(rec.status==='estimate')toast('Quote Sent','Move to Project when approved.');
}
function emailInvoice(){
  const inv=getInvoiceById(nav.invoiceId);const rec=getRecord();if(!inv||!rec)return;
  const to=rec.email||'';
  const rn=((rec.firstName||'')+' '+(rec.lastName||'')).trim()||'Client';
  const subj='Invoice '+inv.number+' from '+(settings.companyName||'The Concrete Protector');
  const body='Hi '+(rec.firstName||'')+',\n\nHere are the details for Invoice '+inv.number+'.\n\nAmount: '+fmt(inv.total)+'\nDue Date: '+(inv.dueDate?new Date(inv.dueDate+'T12:00').toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'}):'N/A')+'\nBalance Due: '+fmt(inv.balance)+'\n\nPlease let us know if you have any questions.\n\nThank you,\n'+(settings.contactName||settings.companyName||'');
  if(isEmailJSReady()){
    if(!to){toast('No Email','Add an email address to this record first.');return}
    const pdf=generateInvoicePDF(true);
    if(!pdf)return;
    toast('Sending...','Emailing invoice to '+to);
    emailjs.send(settings.emailjsServiceId,settings.emailjsTemplateId,{
      to_email:to,to_name:rn,from_name:settings.contactName||settings.companyName||'The Concrete Protector',
      reply_to:settings.email||'',subject:subj,message:body,
      attachment:pdf.base64,attachment_name:pdf.filename
    }).then(function(){
      toast('Email Sent','Invoice sent to '+to+' with PDF.');
      logActivity(rec.id,'email_sent','Invoice '+inv.number+' emailed to '+to+' via EmailJS');saveDB(db);
    },function(err){
      toast('Email Failed',(err&&err.text)||'Could not send. Check EmailJS settings.');
    });
  }else{
    generateInvoicePDF();
    setTimeout(function(){window.open('mailto:'+encodeURIComponent(to)+'?subject='+encodeURIComponent(subj)+'&body='+encodeURIComponent(body))},300);
    logActivity(rec.id,'email_sent','Invoice '+inv.number+' email opened for '+(to||'(no email)'));saveDB(db);
    toast('PDF Downloaded','Attach the downloaded PDF to your email.');
  }
}
function textInvoice(){
  const inv=getInvoiceById(nav.invoiceId);const rec=getRecord();if(!inv||!rec)return;
  const body='Invoice '+inv.number+' \u2014 '+fmt(inv.balance)+' due '+(inv.dueDate||'N/A')+'. From '+(settings.companyName||'The Concrete Protector');
  window.open('sms:'+(rec.phone||'')+'?body='+encodeURIComponent(body));
  logActivity(rec.id,'invoice_texted','Invoice '+inv.number+' texted to '+(rec.phone||'(no phone)'));saveDB(db);
}
function sendInvoiceReminder(){
  const inv=getInvoiceById(nav.invoiceId);const rec=getRecord();if(!inv||!rec)return;
  const to=rec.email||'';
  const subj='Reminder: Invoice '+inv.number+' \u2014 '+fmt(inv.balance)+' due '+(inv.dueDate||'N/A');
  const body='Hi '+(rec.firstName||'')+',\n\nThis is a friendly reminder that Invoice '+inv.number+' for '+fmt(inv.total)+' has a remaining balance of '+fmt(inv.balance)+'.\n\nDue Date: '+(inv.dueDate||'N/A')+'\n\nPlease let us know if you have any questions.\n\nThank you,\n'+(settings.contactName||settings.companyName||'');
  window.open('mailto:'+encodeURIComponent(to)+'?subject='+encodeURIComponent(subj)+'&body='+encodeURIComponent(body));
  logActivity(rec.id,'reminder_sent','Reminder sent for '+inv.number+' to '+(rec.email||'(no email)'));saveDB(db);
  toast('Reminder','Reminder email opened.');
}
function quickEmail(){
  const rec=getRecord();if(!rec)return;
  window.open('mailto:'+(rec.email||''));
}
function quickText(){
  const rec=getRecord();if(!rec)return;
  window.open('sms:'+(rec.phone||''));
}
function quickCall(){
  const rec=getRecord();if(!rec)return;
  window.open('tel:'+(rec.phone||''));
}
function renderQuickContactBtns(){
  const rec=getRecord();if(!rec)return;
  const el=document.getElementById('quickContactBtns');if(!el)return;
  let btns='';
  if(rec.email)btns+='<button class="btn btn-ghost" onclick="quickEmail()" style="font-size:12px">&#9993; Email</button>';
  if(rec.phone)btns+='<button class="btn btn-ghost" onclick="quickText()" style="font-size:12px">&#128172; Text</button>';
  if(rec.phone)btns+='<button class="btn btn-ghost" onclick="quickCall()" style="font-size:12px">&#128222; Call</button>';
  el.innerHTML=btns;
}// ═══════════════════════════════════════════════════════════
// SETTINGS
// ═══════════════════════════════════════════════════════════
let settingsTab = 'company';

function renderSettings(){
  // v-model handles simple form fields. Render only dynamic content.
  renderCustomCatTabs();renderCustomItems();
  renderTemplateList();
  renderEmailjsStatus();
  renderSettingsStats();
  renderLeadSources();
  renderCrewList();
  // PDF color picker (not v-model — needs hex conversion)
  const ci=document.getElementById('setPdfAccentColor');
  if(ci)ci.value=rgbToHex(settings.pdfAccentR||37,settings.pdfAccentG||99,settings.pdfAccentB||235);
  const pe=document.getElementById('pdfColorPreview');
  if(pe)pe.style.background='rgb('+(settings.pdfAccentR||37)+','+(settings.pdfAccentG||99)+','+(settings.pdfAccentB||235)+')';
}

function saveSettings(){
  // v-model keeps settings in sync. Validate numerics and persist.
  if(isNaN(settings.taxRate))settings.taxRate=0;
  if(isNaN(settings.depositPercent))settings.depositPercent=50;
  if(isNaN(settings.lateFeePercent))settings.lateFeePercent=0;
  if(isNaN(settings.proposalValidDays))settings.proposalValidDays=30;
  if(isNaN(settings.warrantyYears))settings.warrantyYears=1;
  if(isNaN(settings.invoiceNumberPadding))settings.invoiceNumberPadding=3;
  if(isNaN(settings.laborRate))settings.laborRate=0;
  if(isNaN(settings.targetMargin))settings.targetMargin=0;
  if(!settings.invoicePrefix)settings.invoicePrefix='INV-';
  if(!settings.pdfFilePrefix)settings.pdfFilePrefix='TCP';
  if(!settings.pdfFontFamily)settings.pdfFontFamily='helvetica';
  // PDF accent color from color picker
  const ci=document.getElementById('setPdfAccentColor');
  if(ci){const rgb=hexToRgb(ci.value);settings.pdfAccentR=rgb.r;settings.pdfAccentG=rgb.g;settings.pdfAccentB=rgb.b}
  // EmailJS init
  if(settings.emailjsPublicKey&&typeof emailjs!=='undefined'){emailjs.init(settings.emailjsPublicKey)}
  saveSettingsData(settings);toast('Saved','Settings updated.');
}

function confirmClearAll(){openConfirm('Clear All Data','This will permanently delete ALL records, estimates, and settings. This cannot be undone.',()=>{db.records=[];saveDB(db);Object.assign(settings,SETTINGS_DEFAULTS);saveSettingsData(settings);goHome();toast('Cleared','All data removed.')})}

// ── EmailJS Integration ──────────────────────────────────────
function isEmailJSReady(){return typeof emailjs!=='undefined'&&settings.emailjsPublicKey&&settings.emailjsServiceId&&settings.emailjsTemplateId}
function initEmailJS(){if(settings.emailjsPublicKey&&typeof emailjs!=='undefined'){try{emailjs.init(settings.emailjsPublicKey)}catch(e){}}}
function renderEmailjsStatus(){
  const el=document.getElementById('emailjsStatus');if(!el)return;
  if(isEmailJSReady()){
    el.innerHTML='<div style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.3);border-radius:8px;font-size:12px;color:#22c55e"><span style="font-size:16px">&#10003;</span> EmailJS connected &mdash; emails send with PDF attachments automatically.</div>';
  }else if(settings.emailjsPublicKey||settings.emailjsServiceId||settings.emailjsTemplateId){
    el.innerHTML='<div style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:rgba(251,191,36,0.1);border:1px solid rgba(251,191,36,0.3);border-radius:8px;font-size:12px;color:#fbbf24"><span style="font-size:16px">&#9888;</span> Incomplete &mdash; fill in all three fields.</div>';
  }else{
    el.innerHTML='<div style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:rgba(127,127,140,0.1);border:1px solid rgba(127,127,140,0.2);border-radius:8px;font-size:12px;color:var(--t3)"><span style="font-size:16px">&#9993;</span> Not configured &mdash; emails use your default mail app.</div>';
  }
}
function testEmailJS(){
  if(!isEmailJSReady()){toast('Incomplete','Fill in all EmailJS fields and save first.');return}
  const testEmail=settings.email||prompt('Enter your email to send a test:');
  if(!testEmail)return;
  toast('Sending...','Sending test email to '+testEmail);
  emailjs.send(settings.emailjsServiceId,settings.emailjsTemplateId,{
    to_email:testEmail,to_name:settings.contactName||'Test',from_name:settings.companyName||'Coatings Estimator',
    reply_to:settings.email||'',subject:'Coatings Estimator - Test Email',
    message:'This is a test email from Coatings Estimator. If you received this, EmailJS is working correctly!'
  }).then(function(){toast('Test Passed','Check your inbox at '+testEmail)},
    function(err){toast('Test Failed',(err&&err.text)||'Check your EmailJS settings.')});
}

// ── Custom Products & Services ──────────────────────────────
// customCat and CUSTOM_CATS defined in data.js
function renderCustomCatTabs(){
  const el=document.getElementById('customCatTabs');if(!el)return;
  el.innerHTML=CUSTOM_CATS.map(c=>
    '<button class="tab-btn'+(customCat===c.id?' ac':'')+'" onclick="customCat=\''+c.id+'\';renderCustomCatTabs();renderCustomItems()">'+c.label+' ('+(settings[c.key]||[]).length+')</button>'
  ).join('');
}
function renderCustomItems(){
  const el=document.getElementById('customItemsList');if(!el)return;
  const cat=CUSTOM_CATS.find(c=>c.id===customCat);if(!cat)return;
  const items=settings[cat.key]||[];
  if(!items.length){el.innerHTML='<div style="font-size:12px;color:var(--t4);padding:8px 0">No custom '+cat.label.toLowerCase()+' yet.</div>';return}
  el.innerHTML=items.map((item,i)=>{
    const isProduct=customCat==='products';const isTopcoat=customCat==='topcoats';const isRepair=customCat==='repairs';
    let fields='<div class="g2"><div class="fg"><label>Name</label><input type="text" value="'+esc(item.name)+'" onchange="updateCustomItem('+i+',\'name\',this.value)"></div><div class="fg"><label>SKU</label><input type="text" value="'+esc(item.sku||'')+'" onchange="updateCustomItem('+i+',\'sku\',this.value)"></div></div>';
    fields+='<div class="g2"><div class="fg"><label>Material Cost ($/'+((isRepair||customCat==='addons')?item.unit||'unit':'sqft')+')</label><input type="number" step="0.01" min="0" value="'+(item.cost||0)+'" onchange="updateCustomItem('+i+',\'cost\',parseFloat(this.value)||0)"></div>';
    if(isProduct||customCat==='addons')fields+='<div class="fg"><label>Sell Low ($)</label><input type="number" step="0.01" min="0" value="'+(item.low||0)+'" onchange="updateCustomItem('+i+',\'low\',parseFloat(this.value)||0)"></div></div><div class="g2"><div class="fg"><label>Sell Mid ($)</label><input type="number" step="0.01" min="0" value="'+(item.mid||0)+'" onchange="updateCustomItem('+i+',\'mid\',parseFloat(this.value)||0)"></div>';
    if(isProduct)fields+='<div class="fg"><label>Category</label><input type="text" value="'+esc(item.cat||'Custom')+'" onchange="updateCustomItem('+i+',\'cat\',this.value)"></div></div>';
    else if(customCat==='addons')fields+='<div class="fg"><label>Unit</label><select onchange="updateCustomItem('+i+',\'unit\',this.value)"><option value="sqft"'+(item.unit==='sqft'?' selected':'')+'>sqft</option><option value="lnft"'+(item.unit==='lnft'?' selected':'')+'>lnft</option><option value="each"'+(item.unit==='each'?' selected':'')+'>each</option></select></div></div>';
    if(isTopcoat)fields+='<div class="fg"><label>Description</label><input type="text" value="'+esc(item.desc||'')+'" onchange="updateCustomItem('+i+',\'desc\',this.value)"></div></div><div class="g2"><div class="fg"><label>Unit Price ($)</label><input type="number" step="0.01" min="0" value="'+(item.unitPrice||0)+'" onchange="updateCustomItem('+i+',\'unitPrice\',parseFloat(this.value)||0)"></div><div class="fg"><label>Coverage (sqft/unit)</label><input type="number" step="1" min="1" value="'+(item.coverage||1)+'" onchange="updateCustomItem('+i+',\'coverage\',parseFloat(this.value)||1)"></div></div>';
    if(isRepair)fields+='<div class="fg"><label>Unit</label><select onchange="updateCustomItem('+i+',\'unit\',this.value)"><option value="sqft"'+(item.unit==='sqft'?' selected':'')+'>sqft</option><option value="lnft"'+(item.unit==='lnft'?' selected':'')+'>lnft</option><option value="each"'+(item.unit==='each'?' selected':'')+'>each</option></select></div></div>';
    return'<div style="padding:12px;border:1px solid var(--b1);border-radius:10px;background:var(--s2);margin-bottom:8px"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="font-weight:600;font-size:13px;color:var(--t1)">'+(item.name||'New Item')+'</span><button class="btn btn-danger" onclick="deleteCustomItem('+i+')" style="font-size:11px;padding:3px 10px">Delete</button></div>'+fields+'</div>';
  }).join('');
}
// esc() defined in data.js
function addCustomItem(){
  const cat=CUSTOM_CATS.find(c=>c.id===customCat);if(!cat)return;
  if(!settings[cat.key])settings[cat.key]=[];
  const id='custom-'+uid();
  if(customCat==='products')settings[cat.key].push({id,sku:'',name:'',series:'Custom',cat:'Custom',cost:0,low:0,mid:0});
  else if(customCat==='topcoats')settings[cat.key].push({id,sku:'',name:'',cost:0,desc:'',unitPrice:0,coverage:1});
  else if(customCat==='repairs')settings[cat.key].push({id,sku:'',name:'',cost:0,unit:'sqft'});
  else if(customCat==='addons')settings[cat.key].push({id,sku:'',name:'',cost:0,low:0,mid:0,unit:'sqft'});
  saveSettingsData(settings);renderCustomCatTabs();renderCustomItems();
}
function updateCustomItem(idx,field,val){
  const cat=CUSTOM_CATS.find(c=>c.id===customCat);if(!cat)return;
  const items=settings[cat.key];if(!items||!items[idx])return;
  items[idx][field]=val;saveSettingsData(settings);renderCustomCatTabs();
}
function deleteCustomItem(idx){
  const cat=CUSTOM_CATS.find(c=>c.id===customCat);if(!cat)return;
  const items=settings[cat.key];if(!items||!items[idx])return;
  openConfirm('Delete Item','Remove "'+items[idx].name+'" from custom '+cat.label.toLowerCase()+'?',()=>{
    items.splice(idx,1);saveSettingsData(settings);renderCustomCatTabs();renderCustomItems();toast('Deleted','Custom item removed.');
  });
}

// ── Estimate Templates ──────────────────────────────────────
function renderTemplateList(){
  const el=document.getElementById('templateList');if(!el)return;
  const tpls=settings.estimateTemplates||[];
  if(!tpls.length){el.innerHTML='<div style="font-size:12px;color:var(--t4);padding:8px 0">No templates saved yet.</div>';return}
  el.innerHTML=tpls.map((t,i)=>'<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:var(--s3);border-radius:8px;margin-bottom:6px"><div><div style="font-weight:600;font-size:14px;color:var(--t1)">'+esc(t.name)+'</div><div style="font-size:12px;color:var(--t3)">'+t.systems.length+' area'+(t.systems.length!==1?'s':'')+'</div></div><button class="btn btn-ghost" onclick="deleteTemplate('+i+')" style="font-size:11px;padding:3px 10px;color:var(--danger)">Delete</button></div>').join('');
}
function deleteTemplate(idx){
  const tpls=settings.estimateTemplates||[];if(!tpls[idx])return;
  openConfirm('Delete Template','Remove "'+tpls[idx].name+'"?',()=>{tpls.splice(idx,1);saveSettingsData(settings);renderTemplateList();toast('Deleted','Template removed.')});
}
function saveAsTemplate(){
  const est=getEstimate();if(!est||!est.systems.length){toast('No Systems','Add at least one area before saving as template.');return}
  const name=prompt('Template name:',est.name||'');if(!name)return;
  if(!settings.estimateTemplates)settings.estimateTemplates=[];
  const sysCopy=JSON.parse(JSON.stringify(est.systems));
  settings.estimateTemplates.push({id:'tpl-'+uid(),name:name,systems:sysCopy});
  saveSettingsData(settings);toast('Template Saved','"'+name+'" saved with '+sysCopy.length+' area(s).');
}

// ── Lead Sources ──────────────────────────────────────────
function renderLeadSources(){
  const el=document.getElementById('leadSourceList');if(!el)return;
  const sources=settings.leadSourcePresets||[];
  if(!sources.length){el.innerHTML='<div style="font-size:12px;color:var(--t4);padding:8px 0">No lead sources configured. Add some below.</div>';return}
  el.innerHTML=sources.map((s,i)=>
    '<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:var(--s3);border-radius:8px;margin-bottom:4px">'+
      '<span style="font-size:14px;color:var(--t1)">'+esc(s)+'</span>'+
      '<button class="btn btn-ghost" onclick="removeLeadSource('+i+')" style="font-size:11px;padding:3px 10px;color:var(--danger)">Remove</button>'+
    '</div>'
  ).join('');
}
function addLeadSource(){
  const input=document.getElementById('newLeadSource');
  const val=input.value.trim();
  if(!val)return;
  if(!settings.leadSourcePresets)settings.leadSourcePresets=[];
  if(settings.leadSourcePresets.includes(val)){toast('Duplicate','That lead source already exists.');return}
  settings.leadSourcePresets.push(val);
  input.value='';
  saveSettingsData(settings);renderLeadSources();
  toast('Added','"'+val+'" added to lead sources.');
}
function removeLeadSource(idx){
  const sources=settings.leadSourcePresets;
  if(!sources||!sources[idx])return;
  const name=sources[idx];
  sources.splice(idx,1);
  saveSettingsData(settings);renderLeadSources();
  toast('Removed','"'+name+'" removed.');
}

// ── Team / Crew ──────────────────────────────────────────
function renderCrewList(){
  const el=document.getElementById('crewList');if(!el)return;
  const crew=settings.crewMembers||[];
  if(!crew.length){el.innerHTML='<div style="font-size:12px;color:var(--t4);padding:8px 0">No crew members yet. Add your team below.</div>';return}
  el.innerHTML=crew.map((m,i)=>
    '<div style="padding:12px;border:1px solid var(--b1);border-radius:10px;background:var(--s2);margin-bottom:8px">'+
      '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">'+
        '<div style="display:flex;align-items:center;gap:8px"><div style="width:12px;height:12px;border-radius:50%;background:'+(m.color||'#3b82f6')+'"></div><span style="font-weight:600;font-size:14px;color:var(--t1)">'+esc(m.name||'New Member')+'</span></div>'+
        '<button class="btn btn-danger" onclick="removeCrewMember('+i+')" style="font-size:11px;padding:3px 10px">Remove</button>'+
      '</div>'+
      '<div class="g2">'+
        '<div class="fg"><label>Name</label><input type="text" value="'+esc(m.name||'')+'" onchange="updateCrewMember('+i+',\'name\',this.value)"></div>'+
        '<div class="fg"><label>Role</label><input type="text" value="'+esc(m.role||'')+'" onchange="updateCrewMember('+i+',\'role\',this.value)" placeholder="e.g. Installer, Lead"></div>'+
      '</div>'+
      '<div class="g2">'+
        '<div class="fg"><label>Phone</label><input type="tel" value="'+esc(m.phone||'')+'" onchange="updateCrewMember('+i+',\'phone\',this.value)" placeholder="(555) 123-4567"></div>'+
        '<div class="fg"><label>Color</label><input type="color" value="'+(m.color||'#3b82f6')+'" onchange="updateCrewMember('+i+',\'color\',this.value)" style="width:48px;height:36px;padding:2px;cursor:pointer;border:1px solid var(--b1);border-radius:6px"></div>'+
      '</div>'+
    '</div>'
  ).join('');
}
function addCrewMember(){
  if(!settings.crewMembers)settings.crewMembers=[];
  settings.crewMembers.push({id:'crew-'+uid(),name:'',color:'#3b82f6',phone:'',role:''});
  saveSettingsData(settings);renderCrewList();
}
function updateCrewMember(idx,field,val){
  const crew=settings.crewMembers;if(!crew||!crew[idx])return;
  crew[idx][field]=val;saveSettingsData(settings);renderCrewList();
}
function removeCrewMember(idx){
  const crew=settings.crewMembers;if(!crew||!crew[idx])return;
  openConfirm('Remove Crew Member','Remove "'+(crew[idx].name||'this member')+'" from the team?',()=>{
    crew.splice(idx,1);saveSettingsData(settings);renderCrewList();toast('Removed','Crew member removed.');
  });
}

// ── Data Stats ──────────────────────────────────────────
function renderSettingsStats(){
  const el=document.getElementById('settingsStats');if(!el)return;
  const totalRecs=db.records.length;
  const totalEsts=db.records.reduce((sum,r)=>sum+r.estimates.length,0);
  const totalSqft=db.records.reduce((sum,r)=>sum+r.estimates.reduce((s2,e)=>s2+e.systems.reduce((s3,sys)=>s3+(sys.sqft||0),0),0),0);
  el.innerHTML='<div class="sg"><div class="sx"><div class="sl">Records</div><div class="sv">'+totalRecs+'</div></div>'+
    '<div class="sx"><div class="sl">Estimates</div><div class="sv">'+totalEsts+'</div></div>'+
    '<div class="sx"><div class="sl">Total Sqft</div><div class="sv">'+totalSqft.toLocaleString()+'</div></div></div>';
}

// ── Estimate Comparison ─────────────────────────────────────
function showEstimateComparison(){
  const rec=getRecord();if(!rec||rec.estimates.length<2)return;
  const ests=rec.estimates;
  const cols=ests.map(est=>{
    const ec=calcEstCosts(est);
    const areas=est.systems.map(s=>(s.areaName||'Unnamed')+' ('+s.sqft+' sqft)').join('<br>');
    const products=est.systems.map(s=>{const p=getAllProducts().find(x=>x.id===s.productId);return p?p.name:'Custom'}).join('<br>');
    const qs=est.quoteStatus||'draft';
    const margin=ec.sell>0?Math.round((ec.sell-ec.cost)/ec.sell*100):0;
    return'<div style="flex:1;min-width:200px;padding:16px;background:var(--s3);border-radius:12px;border:1px solid var(--brd)">'+
      '<div style="font-weight:700;font-size:15px;margin-bottom:12px;color:var(--t1)">'+(est.name||'Estimate')+'</div>'+
      '<div style="font-size:12px;text-transform:uppercase;font-weight:600;color:var(--t4);margin-bottom:4px">Status</div><div style="font-size:14px;margin-bottom:12px">'+qs.charAt(0).toUpperCase()+qs.slice(1)+'</div>'+
      '<div style="font-size:12px;text-transform:uppercase;font-weight:600;color:var(--t4);margin-bottom:4px">Areas ('+est.systems.length+')</div><div style="font-size:13px;margin-bottom:12px;line-height:1.5">'+areas+'</div>'+
      '<div style="font-size:12px;text-transform:uppercase;font-weight:600;color:var(--t4);margin-bottom:4px">Products</div><div style="font-size:13px;margin-bottom:12px;line-height:1.5">'+products+'</div>'+
      '<div style="font-size:12px;text-transform:uppercase;font-weight:600;color:var(--t4);margin-bottom:4px">Total Sqft</div><div style="font-size:14px;margin-bottom:12px">'+ec.sqft.toLocaleString()+'</div>'+
      '<div style="font-size:12px;text-transform:uppercase;font-weight:600;color:var(--t4);margin-bottom:4px">Price</div><div style="font-size:18px;font-weight:700;color:var(--accent);margin-bottom:8px">'+fmt(ec.totalWithTax)+'</div>'+
      (ec.cost>0?'<div style="font-size:12px;text-transform:uppercase;font-weight:600;color:var(--t4);margin-bottom:4px">Cost / Margin</div><div style="font-size:14px;margin-bottom:8px">'+fmt(ec.cost)+' <span style="color:var(--success)">('+margin+'%)</span></div>':'')+
      '<div style="font-size:12px;text-transform:uppercase;font-weight:600;color:var(--t4);margin-bottom:4px">$/sqft</div><div style="font-size:14px">'+(ec.sqft>0?'$'+(ec.sell/ec.sqft).toFixed(2):'\u2014')+'</div>'+
    '</div>'
  }).join('');
  const prices=ests.map(e=>calcEstCosts(e).totalWithTax);
  const delta=Math.max(...prices)-Math.min(...prices);
  const deltaLine=ests.length>=2?'<div style="text-align:center;padding:12px;font-size:13px;color:var(--t3)">Price difference: <strong>'+fmt(delta)+'</strong></div>':'';
  const modal=document.getElementById('confirmModal');
  modal.querySelector('.modal-card').innerHTML='<div style="padding:20px"><h3 style="font-size:16px;font-weight:700;margin-bottom:4px">Estimate Comparison</h3><p style="font-size:13px;color:var(--t3);margin-bottom:16px">Side-by-side view of all estimates</p>'+deltaLine+'<div style="display:flex;gap:12px;overflow-x:auto;padding-bottom:8px">'+cols+'</div><div style="text-align:right;margin-top:16px"><button class="btn btn-ghost" onclick="closeConfirm()">Close</button></div></div>';
  modal.classList.add('active');
}

// ── Settings Helpers ──────────────────────────────────────
// rgbToHex() and hexToRgb() defined in utils.js
function handleLogoUpload(event){
  const file=event.target.files[0];if(!file)return;
  if(file.size>500000){toast('Too Large','Logo must be under 500KB.');event.target.value='';return}
  const reader=new FileReader();
  reader.onload=function(e){settings.companyLogo=e.target.result;saveSettingsData(settings);toast('Logo Saved','Company logo updated.')};
  reader.readAsDataURL(file);
}
function clearLogo(){settings.companyLogo='';saveSettingsData(settings);document.getElementById('setLogo').value='';toast('Logo Removed','Company logo cleared.')}
function updateInvoicePreview(){}
function updateColorPreview(){
  const ci=document.getElementById('setPdfAccentColor');if(!ci)return;
  const hex=ci.value;const rgb=hexToRgb(hex);
  settings.pdfAccentR=rgb.r;settings.pdfAccentG=rgb.g;settings.pdfAccentB=rgb.b;
  const pe=document.getElementById('pdfColorPreview');
  if(pe)pe.style.background='rgb('+rgb.r+','+rgb.g+','+rgb.b+')';
}

// ── Booking Widget Generator ──────────────────────────────
function generateBookingWidget(){
  if(!isEmailJSReady()){toast('EmailJS Required','Configure EmailJS in the Email section first.');return}
  const types=(settings.bookingProjectTypes||[]).map(t=>"'"+t.replace(/'/g,"\\'")+"'").join(',');
  const code='<!-- Coatings Estimator Booking Widget -->\n<div id="ce-booking-widget"></div>\n<script>\n(function(){\n  var c=document.getElementById("ce-booking-widget");\n  c.innerHTML=\'<form id="ce-book" style="max-width:500px;font-family:system-ui,sans-serif">'+
    '<h3 style="margin:0 0 16px;font-size:20px">Request a Free Estimate</h3>'+
    '<div style="margin-bottom:12px"><label style="display:block;font-size:13px;font-weight:600;margin-bottom:4px">Name *</label><input name="name" required style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px"></div>'+
    '<div style="margin-bottom:12px"><label style="display:block;font-size:13px;font-weight:600;margin-bottom:4px">Email *</label><input name="email" type="email" required style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px"></div>'+
    '<div style="margin-bottom:12px"><label style="display:block;font-size:13px;font-weight:600;margin-bottom:4px">Phone</label><input name="phone" type="tel" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px"></div>'+
    '<div style="margin-bottom:12px"><label style="display:block;font-size:13px;font-weight:600;margin-bottom:4px">Project Type</label><select name="type" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px"><option value="">Select...</option>\'+['+types+'].map(function(t){return \'<option>\'+t+\'</option>\'}).join(\'\')+\'</select></div>'+
    '<div style="margin-bottom:12px"><label style="display:block;font-size:13px;font-weight:600;margin-bottom:4px">Notes</label><textarea name="notes" rows="3" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px;resize:vertical"></textarea></div>'+
    '<button type="submit" style="background:#2563eb;color:#fff;border:none;padding:12px 24px;border-radius:6px;font-size:15px;font-weight:600;cursor:pointer;width:100%">Submit Request</button>'+
    '</form>\';\n})();\n</script>';
  // Show in modal
  const modal=document.getElementById('confirmModal');
  modal.querySelector('.modal-card').innerHTML='<div style="padding:20px"><h3 style="font-size:16px;font-weight:700;margin-bottom:4px">Booking Widget Code</h3><p style="font-size:13px;color:var(--t3);margin-bottom:12px">Copy and paste this into your website HTML.</p><textarea id="widgetCode" style="width:100%;height:200px;font-family:monospace;font-size:12px;padding:12px;background:var(--s1);border:1px solid var(--b1);border-radius:8px;color:var(--t1);resize:vertical" readonly>'+esc(code)+'</textarea><div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end"><button class="btn btn-primary" onclick="document.getElementById(\'widgetCode\').select();document.execCommand(\'copy\');toast(\'Copied\',\'Widget code copied to clipboard.\')">Copy Code</button><button class="btn btn-ghost" onclick="closeConfirm()">Close</button></div></div>';
  modal.classList.add('active');
}
// ═══════════════════════════════════════════════════════════
// CALENDAR / WEEK VIEW / DISPATCH BOARD
// ═══════════════════════════════════════════════════════════
let calYear=new Date().getFullYear();let calMonth=new Date().getMonth();let calSelectedDay=null;
let calView='month'; // 'month' | 'week' | 'dispatch'

// ── Navigation ──────────────────────────────────────────
function goCalendar(){
  Object.assign(nav,{screen:'calendar',folderStatus:null,folderActive:true,recordId:null,estimateId:null,systemId:null,invoiceId:null});
  showScreen('calendar');renderBreadcrumb();
  renderCalendarView();
  updateSidebarActive();closeMobileSidebar();
}

function setCalView(v){
  calView=v;
  renderCalendarView();
}

function renderCalendarView(){
  if(calView==='week') renderWeekView();
  else if(calView==='dispatch') renderDispatch();
  else renderCalendar();
}

function calNav(dir){
  if(calView==='month'){
    calMonth+=dir;
    if(calMonth>11){calMonth=0;calYear++}
    if(calMonth<0){calMonth=11;calYear--}
    calSelectedDay=null;
    renderCalendar();
  } else {
    // Week and dispatch: navigate by week
    const base=calSelectedDay
      ? new Date(calYear,calMonth,calSelectedDay)
      : new Date();
    base.setDate(base.getDate()+(dir*7));
    calYear=base.getFullYear();
    calMonth=base.getMonth();
    calSelectedDay=base.getDate();
    if(calView==='week') renderWeekView();
    else renderDispatch();
  }
}

// ── Helpers ─────────────────────────────────────────────
function getProjectsForDate(dateStr){
  return db.records.filter(r=>r.active&&(r.status==='project'||r.status==='completed')&&r.projectStartDate&&(
    (r.projectStartDate<=dateStr&&(r.projectEndDate||r.projectStartDate)>=dateStr)||
    (!r.projectEndDate&&r.projectStartDate===dateStr)
  ));
}
function getFollowUpsForDate(dateStr){return db.records.filter(r=>r.active&&r.followUpDate===dateStr&&!r.followUpCompleted)}

function getWeekDates(baseDate){
  const d=new Date(baseDate);
  const day=d.getDay(); // 0=Sun
  const sun=new Date(d);
  sun.setDate(d.getDate()-day);
  const dates=[];
  for(let i=0;i<7;i++){
    const dd=new Date(sun);
    dd.setDate(sun.getDate()+i);
    dates.push(dd.getFullYear()+'-'+String(dd.getMonth()+1).padStart(2,'0')+'-'+String(dd.getDate()).padStart(2,'0'));
  }
  return dates;
}

function getCrewColor(crewId){
  const crew=(settings.crewMembers||[]).find(c=>c.id===crewId);
  return crew?crew.color:'#6b7280';
}
function getCrewName(crewId){
  const crew=(settings.crewMembers||[]).find(c=>c.id===crewId);
  return crew?crew.name:'Unassigned';
}
function getCrewInitials(crewId){
  const name=getCrewName(crewId);
  if(name==='Unassigned') return '?';
  const parts=name.trim().split(/\s+/);
  return (parts[0][0]+(parts.length>1?parts[parts.length-1][0]:'')).toUpperCase();
}

function formatTimeLabel(hour){
  const h=hour%12||12;
  const ampm=hour<12?'AM':'PM';
  return h+' '+ampm;
}

function recName(r){
  return ((r.firstName||'')+' '+(r.lastName||'')).trim()||'Unnamed';
}

// ═══════════════════════════════════════════════════════════
// MONTH VIEW (original renderCalendar — unchanged logic)
// ═══════════════════════════════════════════════════════════
function renderCalendar(){
  const label=new Date(calYear,calMonth).toLocaleDateString('en-US',{month:'long',year:'numeric'});
  document.getElementById('calMonthLabel').textContent=label;
  const firstDay=new Date(calYear,calMonth,1).getDay();
  const daysInMonth=new Date(calYear,calMonth+1,0).getDate();
  const todayStr=new Date().toISOString().slice(0,10);
  // Day headers
  let html=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map(d=>'<div class="cal-hdr">'+d+'</div>').join('');
  // Empty cells before month starts
  for(let i=0;i<firstDay;i++)html+='<div class="cal-cell other-month"></div>';
  // Day cells
  for(let d=1;d<=daysInMonth;d++){
    const ds=calYear+'-'+String(calMonth+1).padStart(2,'0')+'-'+String(d).padStart(2,'0');
    const projs=getProjectsForDate(ds);
    const fups=getFollowUpsForDate(ds);
    const isToday=ds===todayStr;
    const isSel=calSelectedDay===d;
    const cls='cal-cell'+(isToday?' today':'')+(isSel?' selected':'');
    let dots='';
    if(projs.length) dots+='<span class="cal-dot project"></span>';
    if(fups.length) dots+='<span class="cal-dot followup"></span>';
    html+='<div class="'+cls+'" onclick="calSelectDay('+d+')">'+
      '<div class="cal-day">'+d+'</div>'+
      (dots?'<div class="cal-dots">'+dots+'</div>':'')+
      (projs.length?'<div style="font-size:9px;color:var(--t3);margin-top:2px">'+projs.length+'</div>':'')+
    '</div>';
  }
  document.getElementById('calGrid').innerHTML=html;
  if(calSelectedDay)calShowDay(calSelectedDay);
  else document.getElementById('calDayDetail').innerHTML='';
}

function calSelectDay(d){calSelectedDay=d;renderCalendarView()}
function calShowDay(d){
  const ds=calYear+'-'+String(calMonth+1).padStart(2,'0')+'-'+String(d).padStart(2,'0');
  const dateLabel=new Date(ds+'T12:00').toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});
  const projs=getProjectsForDate(ds);
  const fups=getFollowUpsForDate(ds);
  let html='<div class="cd"><div class="ct"><span class="ic ig">&#128197;</span> '+dateLabel+'</div>';
  if(projs.length){
    html+='<div style="font-size:12px;font-weight:600;color:var(--t3);margin-bottom:6px">PROJECTS</div>';
    html+=projs.map(r=>{
      const name=recName(r);
      return'<div class="list-item" onclick="goFolder(\''+r.status+'\',true);setTimeout(()=>goRecord(\''+r.id+'\'),50)" style="margin-bottom:4px;padding:10px 14px;cursor:pointer"><div class="li-left"><div class="li-avatar '+r.status+'" style="width:28px;height:28px;font-size:10px;border-radius:6px">'+((r.firstName||'?')[0]+(r.lastName||'?')[0]).toUpperCase()+'</div><div><div class="li-name" style="font-size:13px">'+esc(name)+'</div><div class="li-meta">'+(r.company||'')+' \u00b7 '+fmt(calcRecCosts(r).totalWithTax)+'</div></div></div></div>'
    }).join('');
  }
  if(fups.length){
    html+='<div style="font-size:12px;font-weight:600;color:var(--t3);margin:12px 0 6px">FOLLOW-UPS</div>';
    html+=fups.map(r=>{
      const name=recName(r);
      return'<div class="list-item" onclick="goFolder(\''+r.status+'\',true);setTimeout(()=>goRecord(\''+r.id+'\'),50)" style="margin-bottom:4px;padding:10px 14px;cursor:pointer"><div class="li-left"><div style="font-size:16px;width:28px;text-align:center">&#128276;</div><div><div class="li-name" style="font-size:13px">'+esc(name)+'</div><div class="li-meta">'+(r.followUpNote||'Follow-up')+'</div></div></div></div>'
    }).join('');
  }
  if(!projs.length&&!fups.length)html+='<div style="font-size:13px;color:var(--t4);padding:8px 0">Nothing scheduled for this day.</div>';
  html+='</div>';
  document.getElementById('calDayDetail').innerHTML=html;
}

// ═══════════════════════════════════════════════════════════
// WEEK VIEW
// ═══════════════════════════════════════════════════════════
function renderWeekView(){
  const baseDate=calSelectedDay
    ? new Date(calYear,calMonth,calSelectedDay)
    : new Date();
  const dates=getWeekDates(baseDate);
  const todayStr=new Date().toISOString().slice(0,10);

  // Update label — show week range
  const startD=new Date(dates[0]+'T12:00');
  const endD=new Date(dates[6]+'T12:00');
  const startLabel=startD.toLocaleDateString('en-US',{month:'short',day:'numeric'});
  const endLabel=endD.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
  document.getElementById('calMonthLabel').textContent=startLabel+' \u2013 '+endLabel;

  const dayNames=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

  // Build header
  let html='';
  for(let i=0;i<7;i++){
    const d=new Date(dates[i]+'T12:00');
    const dayNum=d.getDate();
    const isToday=dates[i]===todayStr;
    html+='<div class="cal-hdr" style="padding:10px 4px">'+
      '<div style="font-size:10px;text-transform:uppercase;letter-spacing:.5px">'+dayNames[i]+'</div>'+
      '<div style="font-size:18px;font-weight:'+(isToday?'700':'500')+';color:'+(isToday?'var(--accent)':'var(--t1)')+';margin-top:2px">'+dayNum+'</div>'+
    '</div>';
  }

  // Build day columns
  for(let i=0;i<7;i++){
    const ds=dates[i];
    const isToday=ds===todayStr;
    const projs=getProjectsForDate(ds);
    const fups=getFollowUpsForDate(ds);

    html+='<div class="cal-cell'+(isToday?' today':'')+'" style="min-height:120px;padding:8px;vertical-align:top" onclick="calSelectedDay='+new Date(ds+'T12:00').getDate()+'">';

    // Project cards
    projs.forEach(r=>{
      const name=recName(r);
      const crewColor=r.assignedCrew?getCrewColor(r.assignedCrew):'var(--proj)';
      const crewInit=r.assignedCrew?getCrewInitials(r.assignedCrew):'';
      const timeStr=r.scheduledTime||'';
      html+='<div class="dispatch-item" onclick="event.stopPropagation();goFolder(\''+r.status+'\',true);setTimeout(()=>goRecord(\''+r.id+'\'),50)" style="background:'+crewColor+'22;border-left:3px solid '+crewColor+';color:var(--t1);margin-bottom:4px;padding:6px 8px">'+
        (timeStr?'<div style="font-size:9px;color:var(--t3);font-weight:600">'+timeStr+'</div>':'')+
        '<div style="font-size:11px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+esc(name)+'</div>'+
        '<div style="font-size:10px;color:var(--t3);display:flex;justify-content:space-between;align-items:center">'+
          '<span>'+(r.company?esc(r.company):'')+'</span>'+
          (crewInit?'<span style="background:'+crewColor+';color:#fff;border-radius:50%;width:18px;height:18px;display:inline-flex;align-items:center;justify-content:center;font-size:8px;font-weight:700">'+crewInit+'</span>':'')+
        '</div>'+
      '</div>';
    });

    // Follow-up badges
    fups.forEach(r=>{
      const name=recName(r);
      html+='<div onclick="event.stopPropagation();goFolder(\''+r.status+'\',true);setTimeout(()=>goRecord(\''+r.id+'\'),50)" style="font-size:10px;padding:4px 6px;background:#fef3c7;border-left:3px solid #f59e0b;border-radius:4px;margin-bottom:3px;cursor:pointer;color:var(--t1)">'+
        '<span style="font-size:10px">&#128276;</span> '+esc(name)+
      '</div>';
    });

    if(!projs.length&&!fups.length){
      html+='<div style="font-size:10px;color:var(--t4);padding:8px 0;text-align:center">-</div>';
    }
    html+='</div>';
  }

  document.getElementById('weekGrid').innerHTML=html;
}

// ═══════════════════════════════════════════════════════════
// DISPATCH BOARD
// ═══════════════════════════════════════════════════════════
function renderDispatch(){
  const baseDate=calSelectedDay
    ? new Date(calYear,calMonth,calSelectedDay)
    : new Date();
  const dates=getWeekDates(baseDate);
  const todayStr=new Date().toISOString().slice(0,10);

  // Update label
  const startD=new Date(dates[0]+'T12:00');
  const endD=new Date(dates[6]+'T12:00');
  const startLabel=startD.toLocaleDateString('en-US',{month:'short',day:'numeric'});
  const endLabel=endD.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
  document.getElementById('calMonthLabel').textContent=startLabel+' \u2013 '+endLabel;

  // ── Crew legend ──
  const crew=settings.crewMembers||[];
  let legendHtml='<span style="font-size:11px;font-weight:600;color:var(--t3);margin-right:4px">CREW:</span>';
  if(crew.length){
    legendHtml+=crew.map(c=>
      '<span style="display:inline-flex;align-items:center;gap:4px;font-size:12px;color:var(--t2);padding:3px 8px;background:var(--s2);border-radius:20px">'+
        '<span style="width:10px;height:10px;border-radius:50%;background:'+c.color+'"></span>'+
        esc(c.name||'Unnamed')+
      '</span>'
    ).join('');
  } else {
    legendHtml+='<span style="font-size:11px;color:var(--t4)">No crew members. Add them in Settings &rarr; Team.</span>';
  }
  document.getElementById('dispatchCrewLegend').innerHTML=legendHtml;

  // ── Dispatch time grid ──
  const startHour=6;
  const endHour=18; // 6 PM
  const dayNames=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

  let html='';

  // Header row: empty corner + 7 day headers
  html+='<div class="dispatch-time" style="font-weight:700;font-size:11px;color:var(--t3)"></div>';
  for(let i=0;i<7;i++){
    const d=new Date(dates[i]+'T12:00');
    const dayNum=d.getDate();
    const isToday=dates[i]===todayStr;
    html+='<div class="dispatch-time" style="padding:8px 4px;font-weight:600;font-size:11px">'+
      '<div style="text-transform:uppercase;letter-spacing:.5px;font-size:9px">'+dayNames[i]+'</div>'+
      '<div style="font-size:16px;font-weight:'+(isToday?'700':'500')+';color:'+(isToday?'var(--accent)':'var(--t1)')+';margin-top:1px">'+dayNum+'</div>'+
    '</div>';
  }

  // Build a lookup: dateStr -> hour -> [records]
  const slotMap={};
  dates.forEach(ds=>{
    slotMap[ds]={};
    const projs=getProjectsForDate(ds);
    projs.forEach(r=>{
      const time=r.scheduledTime||'';
      const hour=time?parseInt(time.split(':')[0],10):-1;
      if(hour>=startHour&&hour<endHour){
        if(!slotMap[ds][hour]) slotMap[ds][hour]=[];
        slotMap[ds][hour].push(r);
      } else {
        // No scheduled time or outside range — place at top (startHour)
        if(!slotMap[ds][startHour]) slotMap[ds][startHour]=[];
        slotMap[ds][startHour].push(r);
      }
    });
  });

  // Time rows
  for(let h=startHour;h<endHour;h++){
    const timeStr=String(h).padStart(2,'0')+':00';
    // Time label
    html+='<div class="dispatch-time">'+formatTimeLabel(h)+'</div>';
    // 7 day slots
    for(let i=0;i<7;i++){
      const ds=dates[i];
      const recs=slotMap[ds]&&slotMap[ds][h]?slotMap[ds][h]:[];
      html+='<div class="dispatch-slot" '+
        'ondragover="event.preventDefault();this.classList.add(\'dragover\')" '+
        'ondragleave="this.classList.remove(\'dragover\')" '+
        'ondrop="dispatchDrop(event,\''+ds+'\',\''+timeStr+'\')" '+
        'data-date="'+ds+'" data-time="'+timeStr+'">';

      recs.forEach(r=>{
        const name=recName(r);
        const crewColor=r.assignedCrew?getCrewColor(r.assignedCrew):'#6b7280';
        const crewInit=r.assignedCrew?getCrewInitials(r.assignedCrew):'?';
        const dur=r.scheduledDuration||1;
        const heightPx=Math.max(dur*40-4, 36); // scale height by duration

        html+='<div class="dispatch-item" '+
          'draggable="true" '+
          'ondragstart="dispatchDragStart(event,\''+r.id+'\')" '+
          'onclick="goFolder(\''+r.status+'\',true);setTimeout(()=>goRecord(\''+r.id+'\'),50)" '+
          'style="background:'+crewColor+'20;border-left:3px solid '+crewColor+';color:var(--t1);min-height:'+heightPx+'px;display:flex;flex-direction:column;justify-content:center" '+
          'title="'+esc(name)+' \u2014 '+getCrewName(r.assignedCrew||'')+' \u2014 '+dur+'h">'+
          '<div style="display:flex;justify-content:space-between;align-items:center">'+
            '<span style="font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc(name)+'</span>'+
            '<span style="background:'+crewColor+';color:#fff;border-radius:50%;width:18px;height:18px;display:inline-flex;align-items:center;justify-content:center;font-size:8px;font-weight:700;flex-shrink:0;margin-left:4px">'+crewInit+'</span>'+
          '</div>'+
          (r.company?'<div style="font-size:9px;color:var(--t3);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc(r.company)+'</div>':'')+
          '<div style="font-size:9px;color:var(--t4)">'+dur+'h'+
            (r.assignedCrew?' \u00b7 '+esc(getCrewName(r.assignedCrew)):'')+
          '</div>'+
        '</div>';
      });

      html+='</div>';
    }
  }

  document.getElementById('dispatchGrid').innerHTML=html;

  // ── Unscheduled projects ──
  renderUnscheduled();
}

// ═══════════════════════════════════════════════════════════
// UNSCHEDULED BUCKET
// ═══════════════════════════════════════════════════════════
function renderUnscheduled(){
  const unscheduled=db.records.filter(r=>r.active&&r.status==='project'&&!r.projectStartDate);
  const el=document.getElementById('dispatchUnscheduled');
  if(!el) return;

  if(!unscheduled.length){
    el.innerHTML='<div style="font-size:12px;color:var(--t4);padding:8px 0;width:100%">All projects are scheduled.</div>';
    return;
  }

  let html='';
  unscheduled.forEach(r=>{
    const name=recName(r);
    const crewColor=r.assignedCrew?getCrewColor(r.assignedCrew):'#6b7280';
    const crewInit=r.assignedCrew?getCrewInitials(r.assignedCrew):'?';
    html+='<div class="dispatch-item" '+
      'draggable="true" '+
      'ondragstart="dispatchDragStart(event,\''+r.id+'\')" '+
      'onclick="goFolder(\''+r.status+'\',true);setTimeout(()=>goRecord(\''+r.id+'\'),50)" '+
      'style="background:'+crewColor+'15;border-left:3px solid '+crewColor+';color:var(--t1);padding:8px 12px;cursor:grab;min-width:140px" '+
      'title="'+esc(name)+'">'+
      '<div style="display:flex;align-items:center;gap:6px">'+
        '<span style="background:'+crewColor+';color:#fff;border-radius:50%;width:20px;height:20px;display:inline-flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;flex-shrink:0">'+crewInit+'</span>'+
        '<div>'+
          '<div style="font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:140px">'+esc(name)+'</div>'+
          (r.company?'<div style="font-size:10px;color:var(--t3)">'+esc(r.company)+'</div>':'')+
        '</div>'+
      '</div>'+
    '</div>';
  });

  el.innerHTML=html;
}

// ═══════════════════════════════════════════════════════════
// DRAG & DROP
// ═══════════════════════════════════════════════════════════
function dispatchDragStart(event,recId){
  event.dataTransfer.setData('text/plain',recId);
  event.dataTransfer.effectAllowed='move';
  // Add a subtle opacity to the dragged element
  if(event.target&&event.target.classList) event.target.style.opacity='0.5';
  // Restore opacity after drag ends
  event.target.addEventListener('dragend',function(){this.style.opacity='1'},{once:true});
}

function dispatchDrop(event,dateStr,timeStr){
  event.preventDefault();
  event.stopPropagation();
  // Remove dragover highlight
  if(event.currentTarget) event.currentTarget.classList.remove('dragover');

  const recId=event.dataTransfer.getData('text/plain');
  if(!recId) return;

  const rec=db.records.find(r=>r.id===recId);
  if(!rec) return;

  // Update record scheduling
  rec.projectStartDate=dateStr;
  rec.scheduledTime=timeStr;

  // If not already a project, change status
  if(rec.status!=='project'&&rec.status!=='completed'){
    rec.status='project';
  }

  autoSave();
  toast('Scheduled',recName(rec)+' moved to '+new Date(dateStr+'T12:00').toLocaleDateString('en-US',{month:'short',day:'numeric'})+' at '+timeStr);
  renderDispatch();
}

function dispatchUnschedule(event){
  event.preventDefault();
  event.stopPropagation();
  if(event.currentTarget) event.currentTarget.classList.remove('dragover');

  const recId=event.dataTransfer.getData('text/plain');
  if(!recId) return;

  const rec=db.records.find(r=>r.id===recId);
  if(!rec) return;

  // Remove scheduling
  rec.projectStartDate='';
  rec.scheduledTime='';

  autoSave();
  toast('Unscheduled',recName(rec)+' moved to unscheduled.');
  renderDispatch();
}

// ═══════════════════════════════════════════════════════════
// CREW ASSIGNMENT
// ═══════════════════════════════════════════════════════════
function assignCrew(recId,crewId){
  const rec=db.records.find(r=>r.id===recId);
  if(!rec) return;
  rec.assignedCrew=crewId;
  autoSave();
  // Re-render the active view
  renderCalendarView();
}
// ═══════════════════════════════════════════════════════════
// REPORTING (Phase 5)
// ═══════════════════════════════════════════════════════════
function renderReporting(){
  const active=db.records.filter(r=>r.active);
  const completed=active.filter(r=>r.status==='completed');
  const projects=active.filter(r=>r.status==='project');
  const estimates=active.filter(r=>r.status==='estimate');
  const leads=active.filter(r=>r.status==='lead');
  let totalRevenue=0,totalPipeline=0,totalSqft=0,jobCount=completed.length;
  completed.forEach(r=>{const c=calcRecCosts(r);totalRevenue+=c.totalWithTax});
  active.forEach(r=>{const c=calcRecCosts(r);totalPipeline+=c.totalWithTax;r.estimates.forEach(e=>e.systems.forEach(s=>totalSqft+=s.sqft||0))});
  const avgJob=jobCount>0?totalRevenue/jobCount:0;
  document.getElementById('rptCards').innerHTML=
    '<div class="rpt-card"><div class="rl">Completed Revenue</div><div class="rv">'+fmt(totalRevenue)+'</div><div class="rs">'+jobCount+' completed job'+(jobCount!==1?'s':'')+'</div></div>'+
    '<div class="rpt-card"><div class="rl">Active Pipeline</div><div class="rv">'+fmt(totalPipeline)+'</div><div class="rs">'+active.length+' active record'+(active.length!==1?'s':'')+'</div></div>'+
    '<div class="rpt-card"><div class="rl">Avg Job Size</div><div class="rv">'+fmt(avgJob)+'</div><div class="rs">based on completed</div></div>'+
    '<div class="rpt-card"><div class="rl">Total Sqft Quoted</div><div class="rv">'+totalSqft.toLocaleString()+'</div><div class="rs">across all estimates</div></div>';
  // Top systems
  const sysCounts={};
  db.records.forEach(r=>r.estimates.forEach(e=>e.systems.forEach(s=>{if(s.productId){const p=getAllProducts().find(p=>p.id===s.productId);if(p){if(!sysCounts[p.name])sysCounts[p.name]={count:0,sqft:0,revenue:0};sysCounts[p.name].count++;sysCounts[p.name].sqft+=s.sqft||0;sysCounts[p.name].revenue+=(s.sqft||0)*(s.sellRate||0)}}})));
  const topSys=Object.entries(sysCounts).sort((a,b)=>b[1].count-a[1].count).slice(0,8);
  const maxCount=topSys.length?topSys[0][1].count:1;
  if(topSys.length){
    document.getElementById('rptTopSystems').innerHTML='<div class="bar-chart">'+topSys.map(([name,d])=>
      '<div class="bar-row"><div class="bar-label">'+name+'</div><div class="bar-track"><div class="bar-fill" style="width:'+((d.count/maxCount)*100)+'%"></div></div><div class="bar-val">'+d.count+'x</div></div>'
    ).join('')+'</div>';
  }else{document.getElementById('rptTopSystems').innerHTML='<div class="empty"><div class="empty-text">No systems used yet.</div></div>'}
  // Pipeline breakdown
  const stages=[{label:'Leads',items:leads,color:'var(--lead)'},{label:'Estimates',items:estimates,color:'var(--est)'},{label:'Projects',items:projects,color:'var(--proj)'},{label:'Completed',items:completed,color:'var(--comp)'}];
  const maxStage=Math.max(...stages.map(s=>s.items.length),1);
  document.getElementById('rptPipelineBreakdown').innerHTML='<div class="bar-chart">'+stages.map(s=>{
    const val=s.items.reduce((sum,r)=>sum+calcRecCosts(r).totalWithTax,0);
    return'<div class="bar-row"><div class="bar-label">'+s.label+' ('+s.items.length+')</div><div class="bar-track"><div class="bar-fill" style="width:'+((s.items.length/maxStage)*100)+'%;background:'+s.color+'"></div></div><div class="bar-val">'+fmt(val)+'</div></div>'
  }).join('')+'</div>';
  // Accounts Receivable & Aging
  checkOverdueInvoices();
  const allInv=getAllInvoices();
  const totalOutstanding=allInv.reduce((s,x)=>s+x.invoice.balance,0);
  const totalOverdue=allInv.filter(x=>x.invoice.status==='overdue').reduce((s,x)=>s+x.invoice.balance,0);
  const totalCollected=allInv.reduce((s,x)=>s+x.invoice.amountPaid,0);
  document.getElementById('rptAR').innerHTML=
    '<div class="sx hl"><div class="sl">Total Outstanding</div><div class="sv" style="color:var(--comp)">'+fmt(totalOutstanding)+'</div></div>'+
    '<div class="sx"><div class="sl">Overdue</div><div class="sv" style="color:var(--comp)">'+fmt(totalOverdue)+'</div></div>'+
    '<div class="sx"><div class="sl">Total Collected</div><div class="sv" style="color:var(--success)">'+fmt(totalCollected)+'</div></div>';
  // Aging table
  const unpaidInv=allInv.filter(x=>x.invoice.balance>0).sort((a,b)=>new Date(a.invoice.dueDate||0)-new Date(b.invoice.dueDate||0));
  const buckets={current:0,d30:0,d60:0,d90:0,d90plus:0};
  const now=new Date();
  unpaidInv.forEach(x=>{const due=new Date(x.invoice.dueDate);const days=Math.floor((now-due)/86400000);if(days<0)buckets.current+=x.invoice.balance;else if(days<=30)buckets.d30+=x.invoice.balance;else if(days<=60)buckets.d60+=x.invoice.balance;else if(days<=90)buckets.d90+=x.invoice.balance;else buckets.d90plus+=x.invoice.balance});
  if(unpaidInv.length){
    let agHtml='<div class="sg" style="margin-bottom:12px"><div class="sx"><div class="sl">Current</div><div class="sv">'+fmt(buckets.current)+'</div></div><div class="sx"><div class="sl">1-30 Days</div><div class="sv">'+fmt(buckets.d30)+'</div></div><div class="sx"><div class="sl">31-60 Days</div><div class="sv">'+fmt(buckets.d60)+'</div></div><div class="sx"><div class="sl">61-90 Days</div><div class="sv" style="color:var(--accent)">'+fmt(buckets.d90)+'</div></div><div class="sx"><div class="sl">90+ Days</div><div class="sv" style="color:var(--comp)">'+fmt(buckets.d90plus)+'</div></div></div>';
    agHtml+='<table style="width:100%;font-size:12px;border-collapse:collapse"><tr style="border-bottom:1px solid var(--brd)"><th style="text-align:left;padding:6px 4px;color:var(--t3);font-weight:500">Client</th><th style="text-align:left;padding:6px 4px;color:var(--t3);font-weight:500">Invoice</th><th style="text-align:right;padding:6px 4px;color:var(--t3);font-weight:500">Balance</th><th style="text-align:left;padding:6px 4px;color:var(--t3);font-weight:500">Due</th><th style="text-align:right;padding:6px 4px;color:var(--t3);font-weight:500">Days</th><th style="text-align:left;padding:6px 4px;color:var(--t3);font-weight:500">Status</th></tr>';
    unpaidInv.forEach(({invoice:inv,record:r})=>{
      const name=((r.firstName||'')+' '+(r.lastName||'')).trim()||'Client';
      const days=Math.max(0,Math.floor((now-new Date(inv.dueDate))/86400000));
      const color=inv.status==='overdue'?'var(--comp)':days>30?'var(--accent)':'var(--t1)';
      agHtml+='<tr style="border-bottom:1px solid var(--brd)"><td style="padding:8px 4px">'+name+'</td><td style="padding:8px 4px">'+inv.number+'</td><td style="text-align:right;padding:8px 4px;font-family:monospace;color:var(--comp)">'+fmt(inv.balance)+'</td><td style="padding:8px 4px">'+(inv.dueDate||'N/A')+'</td><td style="text-align:right;padding:8px 4px;color:'+color+'">'+days+'</td><td style="padding:8px 4px"><span style="color:'+color+'">'+inv.status.toUpperCase()+'</span></td></tr>';
    });
    agHtml+='</table>';
    document.getElementById('rptAging').innerHTML=agHtml;
  }else{document.getElementById('rptAging').innerHTML='<div class="empty"><div class="empty-text">No outstanding invoices.</div></div>'}
  // Recent activity
  const recent=db.records.slice().sort((a,b)=>new Date(b.updatedAt)-new Date(a.updatedAt)).slice(0,6);
  if(recent.length){
    document.getElementById('rptRecent').innerHTML=recent.map(r=>{
      const name=((r.firstName||'')+' '+(r.lastName||'')).trim()||'Unnamed';
      const ago=timeAgo(new Date(r.updatedAt));
      return'<div class="list-item" onclick="goFolder(\''+r.status+'\','+r.active+');setTimeout(()=>goRecord(\''+r.id+'\'),50)" style="margin-bottom:4px"><div class="li-left"><div class="li-avatar '+r.status+'">'+((r.firstName||'?')[0]+(r.lastName||'?')[0]).toUpperCase()+'</div><div><div class="li-name">'+name+'</div><div class="li-meta">'+ago+'</div></div></div><div class="li-right"><div class="li-badge '+r.status+'">'+r.status+'</div></div></div>'
    }).join('');
  }else{document.getElementById('rptRecent').innerHTML='<div class="empty"><div class="empty-text">No activity yet.</div></div>'}
}
// timeAgo() defined in utils.js

// ═══════════════════════════════════════════════════════════
// REPORTING EXPORTS
// ═══════════════════════════════════════════════════════════

function exportReportCSV(){
  const active=db.records.filter(r=>r.active);
  if(!active.length){toast('No Data','No active records to export.');return}
  const headers=['Name','Company','Status','Lead Source','Created Date','Estimate Total','Tags','Follow-Up Date','Scheduled Date','Assigned Crew'];
  const csvQ=v=>{
    if(v==null)v='';
    v=String(v);
    if(v.indexOf('"')!==-1)v=v.replace(/"/g,'""');
    if(v.indexOf(',')!==-1||v.indexOf('"')!==-1||v.indexOf('\n')!==-1)v='"'+v+'"';
    return v;
  };
  const rows=[headers.map(csvQ).join(',')];
  active.forEach(r=>{
    const name=((r.firstName||'')+' '+(r.lastName||'')).trim();
    const company=r.company||'';
    const status=r.status||'';
    const leadSource=r.leadSource||'';
    const created=r.createdAt?r.createdAt.slice(0,10):'';
    const costs=calcRecCosts(r);
    const total=costs.totalWithTax||0;
    const tags=(r.tags||[]).join('; ');
    const followUp=r.followUpDate||'';
    const scheduled=r.scheduledDate||'';
    const crewId=r.assignedCrew||'';
    let crewName='';
    if(crewId&&settings.crewMembers){
      const cm=settings.crewMembers.find(c=>c.id===crewId);
      if(cm)crewName=cm.name;
    }
    rows.push([name,company,status,leadSource,created,total.toFixed(2),tags,followUp,scheduled,crewName].map(csvQ).join(','));
  });
  const csv=rows.join('\r\n');
  const today=new Date().toISOString().slice(0,10);
  const filename='pipeline-export-'+today+'.csv';
  const blob=new Blob([csv],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;a.download=filename;a.click();
  URL.revokeObjectURL(url);
  toast('Exported','CSV downloaded with '+active.length+' records.');
}

function exportReportPDF(){
  const active=db.records.filter(r=>r.active);
  if(!active.length){toast('No Data','No active records to export.');return}
  const doc=new jspdf.jsPDF();
  const acR=settings.pdfAccentR||37,acG=settings.pdfAccentG||99,acB=settings.pdfAccentB||235;
  const today=new Date().toISOString().slice(0,10);
  const companyName=settings.companyName||'Company';
  const prefix=settings.pdfFilePrefix||'CE';
  // Title bar
  doc.setFillColor(acR,acG,acB);
  doc.rect(0,0,210,28,'F');
  doc.setTextColor(255,255,255);
  doc.setFontSize(18);
  doc.setFont(undefined,'bold');
  doc.text(companyName+' Pipeline Report',14,14);
  doc.setFontSize(10);
  doc.setFont(undefined,'normal');
  doc.text('Generated: '+today,14,22);
  // Summary section
  let y=38;
  doc.setTextColor(40,40,40);
  doc.setFontSize(14);
  doc.setFont(undefined,'bold');
  doc.text('Summary',14,y);y+=8;
  const completed=active.filter(r=>r.status==='completed');
  let totalRevenue=0;completed.forEach(r=>{totalRevenue+=calcRecCosts(r).totalWithTax});
  let totalPipeline=0;active.forEach(r=>{totalPipeline+=calcRecCosts(r).totalWithTax});
  const avgJob=completed.length>0?totalRevenue/completed.length:0;
  doc.setFontSize(10);
  doc.setFont(undefined,'normal');
  const summaryLines=[
    'Total Active Records: '+active.length,
    'Completed Revenue: '+fmt(totalRevenue),
    'Pipeline Value: '+fmt(totalPipeline),
    'Average Job Size: '+fmt(avgJob)
  ];
  summaryLines.forEach(line=>{doc.text(line,14,y);y+=6});
  // Pipeline breakdown table
  y+=6;
  doc.setFontSize(14);
  doc.setFont(undefined,'bold');
  doc.text('Pipeline Breakdown',14,y);y+=8;
  const leads=active.filter(r=>r.status==='lead');
  const estimates=active.filter(r=>r.status==='estimate');
  const projects=active.filter(r=>r.status==='project');
  const stages=[
    {label:'Leads',items:leads},
    {label:'Estimates',items:estimates},
    {label:'Projects',items:projects},
    {label:'Completed',items:completed}
  ];
  // Table header
  doc.setFillColor(acR,acG,acB);
  doc.setTextColor(255,255,255);
  doc.setFontSize(9);
  doc.setFont(undefined,'bold');
  doc.rect(14,y-4,180,7,'F');
  doc.text('Status',16,y);
  doc.text('Count',90,y);
  doc.text('Value',140,y);
  y+=7;
  doc.setTextColor(40,40,40);
  doc.setFont(undefined,'normal');
  stages.forEach((s,i)=>{
    const val=s.items.reduce((sum,r)=>sum+calcRecCosts(r).totalWithTax,0);
    if(i%2===0){doc.setFillColor(245,247,250);doc.rect(14,y-4,180,7,'F')}
    doc.text(s.label,16,y);
    doc.text(String(s.items.length),90,y);
    doc.text(fmt(val),140,y);
    y+=7;
  });
  // Top systems table
  y+=6;
  if(y>250){doc.addPage();y=20}
  doc.setFontSize(14);
  doc.setFont(undefined,'bold');
  doc.text('Top Systems',14,y);y+=8;
  const sysCounts={};
  db.records.forEach(r=>r.estimates.forEach(e=>e.systems.forEach(s=>{
    if(s.productId){
      const p=getAllProducts().find(p=>p.id===s.productId);
      if(p){
        if(!sysCounts[p.name])sysCounts[p.name]={count:0,sqft:0,revenue:0};
        sysCounts[p.name].count++;
        sysCounts[p.name].sqft+=s.sqft||0;
        sysCounts[p.name].revenue+=(s.sqft||0)*(s.sellRate||0);
      }
    }
  })));
  const topSys=Object.entries(sysCounts).sort((a,b)=>b[1].count-a[1].count).slice(0,10);
  if(topSys.length){
    doc.setFillColor(acR,acG,acB);
    doc.setTextColor(255,255,255);
    doc.setFontSize(9);
    doc.setFont(undefined,'bold');
    doc.rect(14,y-4,180,7,'F');
    doc.text('System Name',16,y);
    doc.text('Count',100,y);
    doc.text('Sqft',125,y);
    doc.text('Revenue',155,y);
    y+=7;
    doc.setTextColor(40,40,40);
    doc.setFont(undefined,'normal');
    topSys.forEach(([name,d],i)=>{
      if(y>280){doc.addPage();y=20}
      if(i%2===0){doc.setFillColor(245,247,250);doc.rect(14,y-4,180,7,'F')}
      const displayName=name.length>35?name.slice(0,33)+'...':name;
      doc.text(displayName,16,y);
      doc.text(String(d.count),100,y);
      doc.text(d.sqft.toLocaleString(),125,y);
      doc.text(fmt(d.revenue),155,y);
      y+=7;
    });
  }else{
    doc.setFontSize(10);doc.setFont(undefined,'normal');
    doc.text('No systems data yet.',14,y);
  }
  const filename=prefix+'-Report-'+today+'.pdf';
  doc.save(filename);
  toast('Exported','PDF report downloaded.');
}// ═══════════════════════════════════════════════════════════
// INTEGRATIONS — Stripe, Mailchimp, Booking
// ═══════════════════════════════════════════════════════════

// ── Stripe Payment Link ──────────────────────────────────
function getStripePaymentLink(inv,rec){
  if(!settings.stripeEnabled||!settings.stripePaymentLinkBase)return'';
  const base=settings.stripePaymentLinkBase;
  const params=[];
  if(rec&&rec.email)params.push('prefilled_email='+encodeURIComponent(rec.email));
  if(inv&&inv.number)params.push('client_reference_id='+encodeURIComponent(inv.number));
  return base+(params.length?'?'+params.join('&'):'');
}

function renderStripePayButton(){
  const el=document.getElementById('stripePayBtn');if(!el)return;
  if(!settings.stripeEnabled||!settings.stripePaymentLinkBase){el.innerHTML='';return}
  const inv=getInvoiceById(nav.invoiceId);if(!inv||inv.status==='paid'){el.innerHTML='';return}
  const rec=getRecord();
  const link=getStripePaymentLink(inv,rec);
  el.innerHTML='<a href="'+esc(link)+'" target="_blank" class="btn btn-primary" style="text-decoration:none;display:inline-flex;align-items:center;gap:6px">&#128179; Pay Online</a>';
}
// ═══════════════════════════════════════════════════════════
// SIGNATURES — helpers for estimate approval flow
// ═══════════════════════════════════════════════════════════
// The <signature-pad> Vue component is in components.js.
// The contract signature pads (canvas-based) are in pdf.js.
// This file contains the approval signature storage helpers.

function saveApprovalSignature(estId,sigDataURL){
  const est=db.records.reduce((found,r)=>{if(found)return found;return r.estimates.find(e=>e.id===estId)},null);
  if(!est)return;
  est.approvalSignature=sigDataURL;
  est.approvalDate=new Date().toISOString();
  est.quoteStatus='approved';
  autoSave();
}
// ═══════════════════════════════════════════════════════════
// CLIENT PORTAL & ONLINE APPROVAL
// ═══════════════════════════════════════════════════════════
// Generates self-contained HTML files for:
// 1. Online estimate approval (with signature capture)
// 2. Client portal (estimates overview + payment links)

function generateApprovalPage(){
  const rec=getRecord();const est=getEstimate();
  if(!rec||!est){toast('Error','No estimate selected.');return}
  const rn=((rec.firstName||'')+' '+(rec.lastName||'')).trim()||'Client';
  const ec=calcEstCosts(est);
  const accentR=settings.pdfAccentR||37,accentG=settings.pdfAccentG||99,accentB=settings.pdfAccentB||235;
  const accent='rgb('+accentR+','+accentG+','+accentB+')';
  const logo=settings.companyLogo?'<img src="'+settings.companyLogo+'" style="max-height:50px;max-width:180px;margin-bottom:12px">':'';
  const areas=est.systems.map(s=>{
    const sc=calcSysCosts(s);
    const prod=getAllProducts().find(p=>p.id===s.productId);
    return'<tr><td style="padding:10px 12px;border-bottom:1px solid #e5e7eb">'+esc(s.areaName||'Area')+'</td>'+
      '<td style="padding:10px 12px;border-bottom:1px solid #e5e7eb">'+(prod?esc(prod.name):'Custom')+'</td>'+
      '<td style="padding:10px 12px;border-bottom:1px solid #e5e7eb;text-align:right">'+(s.sqft||0).toLocaleString()+' sqft</td>'+
      '<td style="padding:10px 12px;border-bottom:1px solid #e5e7eb;text-align:right;font-weight:600">'+fmt(sc.sellWithTax)+'</td></tr>'
  }).join('');
  const approvalMsg=settings.approvalMessage||'Please review the estimate below. If everything looks good, sign and click Approve.';
  const html='<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Estimate Approval - '+(est.name||'Estimate')+'</title>'+
    '<style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:system-ui,-apple-system,sans-serif;background:#f3f4f6;color:#1f2937;padding:24px}'+
    '.container{max-width:700px;margin:0 auto;background:#fff;border-radius:16px;box-shadow:0 4px 24px rgba(0,0,0,.08);overflow:hidden}'+
    '.header{background:'+accent+';color:#fff;padding:28px 32px}.header h1{font-size:20px;font-weight:700;margin-bottom:4px}.header p{font-size:14px;opacity:.85}'+
    '.body{padding:28px 32px}table{width:100%;border-collapse:collapse;margin:16px 0}th{text-align:left;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:#6b7280;padding:8px 12px;border-bottom:2px solid #e5e7eb}'+
    '.total{font-size:28px;font-weight:700;color:'+accent+';text-align:right;padding:16px 0;border-top:2px solid '+accent+'}'+
    '.sig-area{margin:24px 0;padding:20px;border:2px dashed #d1d5db;border-radius:12px;text-align:center}'+
    'canvas{border:1px solid #d1d5db;border-radius:8px;cursor:crosshair;touch-action:none;background:#fafafa}'+
    '.btn{display:inline-block;padding:14px 32px;border-radius:10px;font-size:16px;font-weight:600;border:none;cursor:pointer;margin:4px}'+
    '.btn-approve{background:'+accent+';color:#fff}.btn-approve:hover{filter:brightness(1.1)}'+
    '.btn-decline{background:#fee2e2;color:#ef4444}.btn-clear{background:#f3f4f6;color:#6b7280;font-size:13px;padding:8px 16px}'+
    '.confirmed{display:none;text-align:center;padding:40px}.confirmed h2{color:#22c55e;font-size:24px;margin-bottom:8px}'+
    '.terms{font-size:12px;color:#9ca3af;margin-top:16px;line-height:1.6}'+
    '</style></head><body><div class="container"><div class="header">'+logo+'<h1>'+(settings.companyName||'Estimate')+'</h1><p>Estimate for '+esc(rn)+'</p></div>'+
    '<div class="body" id="reviewSection"><p style="font-size:14px;color:#6b7280;margin-bottom:16px">'+esc(approvalMsg)+'</p>'+
    '<h3 style="font-size:16px;font-weight:600;margin-bottom:8px">'+(est.name||'Estimate')+'</h3>'+
    '<table><thead><tr><th>Area</th><th>System</th><th style="text-align:right">Size</th><th style="text-align:right">Price</th></tr></thead><tbody>'+areas+'</tbody></table>'+
    '<div class="total">Total: '+fmt(ec.totalWithTax)+'</div>'+
    (settings.terms?'<div class="terms"><strong>Terms & Conditions:</strong><br>'+esc(settings.terms)+'</div>':'')+
    '<div class="sig-area"><p style="font-size:13px;color:#6b7280;margin-bottom:8px">Sign below to approve</p>'+
    '<canvas id="sigCanvas" width="600" height="150"></canvas><br>'+
    '<button class="btn btn-clear" onclick="clearSig()">Clear Signature</button></div>'+
    '<div style="text-align:center;margin-top:16px">'+
    '<button class="btn btn-approve" onclick="approve()">Approve Estimate</button> '+
    '<button class="btn btn-decline" onclick="decline()">Decline</button></div></div>'+
    '<div class="confirmed" id="confirmedSection"><div style="font-size:48px;margin-bottom:12px">&#10004;</div><h2>Estimate Approved!</h2>'+
    '<p style="color:#6b7280">Confirmation Code: <strong id="confCode"></strong></p>'+
    '<p style="color:#9ca3af;font-size:13px;margin-top:8px">Please screenshot or save this page for your records.</p></div>'+
    '</div><script>'+
    'var c=document.getElementById("sigCanvas"),ctx=c.getContext("2d"),drawing=false,lx=0,ly=0;'+
    'ctx.strokeStyle="#1f2937";ctx.lineWidth=2;ctx.lineCap="round";'+
    'function gp(e){var r=c.getBoundingClientRect(),t=e.touches?e.touches[0]:e;return{x:t.clientX-r.left,y:t.clientY-r.top}}'+
    'c.addEventListener("mousedown",function(e){drawing=true;var p=gp(e);lx=p.x;ly=p.y});'+
    'c.addEventListener("mousemove",function(e){if(!drawing)return;var p=gp(e);ctx.beginPath();ctx.moveTo(lx,ly);ctx.lineTo(p.x,p.y);ctx.stroke();lx=p.x;ly=p.y});'+
    'c.addEventListener("mouseup",function(){drawing=false});c.addEventListener("mouseleave",function(){drawing=false});'+
    'c.addEventListener("touchstart",function(e){e.preventDefault();drawing=true;var p=gp(e);lx=p.x;ly=p.y},{passive:false});'+
    'c.addEventListener("touchmove",function(e){e.preventDefault();if(!drawing)return;var p=gp(e);ctx.beginPath();ctx.moveTo(lx,ly);ctx.lineTo(p.x,p.y);ctx.stroke();lx=p.x;ly=p.y},{passive:false});'+
    'c.addEventListener("touchend",function(){drawing=false});'+
    'function clearSig(){ctx.clearRect(0,0,c.width,c.height)}'+
    'function approve(){var code=Math.random().toString(36).substr(2,8).toUpperCase();document.getElementById("confCode").textContent=code;document.getElementById("reviewSection").style.display="none";document.getElementById("confirmedSection").style.display="block"}'+
    'function decline(){if(confirm("Are you sure you want to decline this estimate?")){document.getElementById("reviewSection").innerHTML="<div style=\\"text-align:center;padding:40px\\"><div style=\\"font-size:48px;margin-bottom:12px\\">&#10006;</div><h2 style=\\"color:#ef4444\\">Estimate Declined</h2><p style=\\"color:#6b7280;margin-top:8px\\">The contractor has been notified.</p></div>"}}'+
    '<\/script></body></html>';
  // Download as HTML file
  const blob=new Blob([html],{type:'text/html'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=(settings.pdfFilePrefix||'TCP')+'-Approval-'+esc(rn).replace(/\s+/g,'-')+'.html';
  a.click();URL.revokeObjectURL(a.href);
  toast('Downloaded','Approval page ready to send to client.');
  logActivity(rec.id,'approval_sent','Estimate approval page generated for '+(est.name||'Estimate'));
}

function generateClientPortal(){
  const rec=getRecord();
  if(!rec){toast('Error','No record selected.');return}
  const rn=((rec.firstName||'')+' '+(rec.lastName||'')).trim()||'Client';
  const accentR=settings.pdfAccentR||37,accentG=settings.pdfAccentG||99,accentB=settings.pdfAccentB||235;
  const accent='rgb('+accentR+','+accentG+','+accentB+')';
  const logo=settings.companyLogo?'<img src="'+settings.companyLogo+'" style="max-height:50px;max-width:180px;margin-bottom:12px">':'';
  // Estimates
  let estHTML='';
  rec.estimates.forEach(est=>{
    const ec=calcEstCosts(est);
    const qs=est.quoteStatus||'draft';
    const qsLabel={draft:'Draft',sent:'Sent',approved:'Approved',declined:'Declined'};
    const qsColor={draft:'#9ca3af',sent:'#3b82f6',approved:'#22c55e',declined:'#ef4444'};
    estHTML+='<div style="border:1px solid #e5e7eb;border-radius:12px;padding:20px;margin-bottom:12px">'+
      '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">'+
        '<h3 style="font-size:16px;font-weight:600">'+(est.name||'Estimate')+'</h3>'+
        '<span style="font-size:12px;font-weight:600;color:'+qsColor[qs]+';text-transform:uppercase">'+qsLabel[qs]+'</span>'+
      '</div>'+
      '<div style="font-size:14px;color:#6b7280;margin-bottom:8px">'+est.systems.length+' area'+(est.systems.length!==1?'s':'')+' &middot; '+ec.sqft.toLocaleString()+' sqft</div>'+
      '<div style="font-size:24px;font-weight:700;color:'+accent+'">'+fmt(ec.totalWithTax)+'</div>'+
    '</div>';
  });
  // Invoices
  let invHTML='';
  const allInvs=rec.estimates.reduce((arr,est)=>{if(est.invoices)est.invoices.forEach(inv=>arr.push({inv,est}));return arr},[]);
  if(allInvs.length){
    allInvs.forEach(({inv})=>{
      const statusColor={draft:'#9ca3af',sent:'#3b82f6',paid:'#22c55e',partial:'#f59e0b',overdue:'#ef4444'};
      invHTML+='<div style="display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border:1px solid #e5e7eb;border-radius:10px;margin-bottom:8px">'+
        '<div><div style="font-weight:600;font-size:14px">'+esc(inv.number||'Invoice')+'</div>'+
        '<div style="font-size:12px;color:#6b7280">'+new Date(inv.date||inv.createdAt).toLocaleDateString()+'</div></div>'+
        '<div style="text-align:right"><div style="font-weight:600;color:'+accent+'">'+fmt(inv.total||0)+'</div>'+
        '<div style="font-size:12px;font-weight:600;color:'+(statusColor[inv.status]||'#9ca3af')+'">'+(inv.status||'draft').toUpperCase()+'</div></div>'+
      '</div>';
    });
  }
  // Stripe payment link
  const paymentBtn=settings.stripeEnabled&&settings.stripePaymentLinkBase?
    '<a href="'+esc(settings.stripePaymentLinkBase)+'?client_reference_id='+encodeURIComponent(rec.id)+'&prefilled_email='+encodeURIComponent(rec.email||'')+'" target="_blank" style="display:inline-block;padding:14px 32px;background:'+accent+';color:#fff;border-radius:10px;text-decoration:none;font-weight:600;font-size:16px;margin-top:16px">Pay Now</a>':'';

  const html='<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">'+
    '<title>Client Portal - '+esc(rn)+'</title>'+
    '<style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:system-ui,-apple-system,sans-serif;background:#f3f4f6;color:#1f2937;padding:24px}'+
    '.container{max-width:700px;margin:0 auto;background:#fff;border-radius:16px;box-shadow:0 4px 24px rgba(0,0,0,.08);overflow:hidden}'+
    '.header{background:'+accent+';color:#fff;padding:28px 32px}.header h1{font-size:20px;font-weight:700;margin-bottom:4px}.header p{font-size:14px;opacity:.85}'+
    '.body{padding:28px 32px}h2{font-size:18px;font-weight:600;margin-bottom:16px;padding-bottom:8px;border-bottom:2px solid #f3f4f6}'+
    '.footer{padding:20px 32px;background:#f9fafb;text-align:center;font-size:12px;color:#9ca3af}'+
    '</style></head><body><div class="container"><div class="header">'+logo+
    '<h1>'+(settings.companyName||'Client Portal')+'</h1>'+
    '<p>Project details for '+esc(rn)+'</p></div>'+
    '<div class="body">'+
    (rec.address?'<div style="font-size:14px;color:#6b7280;margin-bottom:20px">'+esc(rec.address)+(rec.city?', '+esc(rec.city):'')+(rec.state?' '+esc(rec.state):'')+(rec.zip?' '+esc(rec.zip):'')+'</div>':'')+
    (estHTML?'<h2>Estimates</h2>'+estHTML:'')+
    (invHTML?'<h2 style="margin-top:24px">Invoices</h2>'+invHTML:'')+
    (paymentBtn?'<div style="text-align:center;margin-top:24px">'+paymentBtn+'</div>':'')+
    '</div><div class="footer">&copy; '+(new Date().getFullYear())+' '+(settings.companyName||'')+(settings.phone?' &middot; '+esc(settings.phone):'')+(settings.email?' &middot; '+esc(settings.email):'')+'</div>'+
    '</div></body></html>';
  const blob=new Blob([html],{type:'text/html'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=(settings.pdfFilePrefix||'TCP')+'-Portal-'+esc(rn).replace(/\s+/g,'-')+'.html';
  a.click();URL.revokeObjectURL(a.href);
  toast('Downloaded','Client portal ready to send.');
  logActivity(rec.id,'portal_sent','Client portal generated');
}
// ═══════════════════════════════════════════════════════════
// VUE 3 APP — Bootstrap
// ═══════════════════════════════════════════════════════════
// Phase 1: Wrap global state in Vue.reactive() so existing
// vanilla functions continue to work while state becomes
// reactive. Mount happens during screen conversion (Task 5).
// Auto-save stays with the existing debounced autoSave().

// Make global state reactive — existing code keeps working
// because reactive proxies are transparent to reads/writes
db = Vue.reactive(db);
nav = Vue.reactive(nav);
settings = Vue.reactive(settings);

// Create the Vue app instance (not mounted yet)
// Components will be registered via ceApp.component() in Tasks 4-5
// Mount via ceApp.mount('#app') when templates are converted
const ceApp = Vue.createApp({
  data(){
    return {
      db,
      nav,
      settings,
      seriesFilter,
      estTab,
      calYear,
      calMonth,
      calSelectedDay,
      calView,
      settingsTab:'company',
      batchMode:false,
      batchSelected:new Set(),
      invFilter:'all'
    }
  },
  computed:{
    currentProfile(){return getActiveProfile()},
    isOnline(){return navigator.onLine},
    currentScreen(){return this.nav.screen},
    activeRecords(){return this.db.records.filter(r=>r.active)},
    monthRevenue(){
      return this.db.records.filter(r=>r.active&&r.status==='completed')
        .reduce((sum,r)=>sum+calcRecCosts(r).totalWithTax,0)
    },
    followUpsDue(){
      const today=new Date().toISOString().slice(0,10);
      return this.db.records.filter(r=>r.active&&r.followUpDate&&!r.followUpCompleted&&r.followUpDate<=today)
    },
    pipelineByStatus(){
      const out={};
      STATUSES.forEach(s=>{out[s.id]=this.db.records.filter(r=>r.active&&r.status===s.id)});
      return out
    }
  },
  methods:{
    // Bridge to existing global functions — allows Vue templates to call them
    goHome,goFolder,goRecord,goEstimate,goSystem,goInvoice,goReporting,goSettings,goCalendar,
    goProfileSetup,goProfileSelect,
    showScreen,toggleSidebar,toggleMobileSidebar,closeMobileSidebar,
    newRecord,newRecordFromHeader,saveRecord,confirmDeleteRecord,
    newEstimate,saveEstimate,confirmDeleteEstimate,
    newSystem,saveSystem,confirmDeleteSystem,duplicateSystem,duplicateEstimate,
    changeStatus,toggleActive,
    generateProposal,generateContract,emailProposal,emailInvoice,textProposal,
    openConfirm,closeConfirm,openExport,closeExport,openImport,closeImport,
    toast,fmt,esc,uid,timeAgo,
    calcSysCosts,calcEstCosts,calcRecCosts,
    renderBreadcrumb,renderHome,renderList,renderRecord,renderEstimate,renderSystem,renderInvoice,
    renderSettings,saveSettings,renderReporting,exportReportCSV,exportReportPDF,renderCalendar,
    renderCalendarView,renderWeekView,renderDispatch,renderUnscheduled,
    setCalView,dispatchDrop,dispatchUnschedule,dispatchDragStart,assignCrew,
    updateProfileBadge,filterList,
    // Settings tab switching (needs Vue reactivity for v-show)
    switchSettingsTab(tab){
      this.settingsTab=tab;
      this.$nextTick(()=>{
        if(tab==='products'){renderCustomCatTabs();renderCustomItems()}
        else if(tab==='templates'){renderTemplateList()}
        else if(tab==='integrations'){renderEmailjsStatus()}
        else if(tab==='data'){renderSettingsStats()}
        else if(tab==='leadsources'){renderLeadSources()}
        else if(tab==='team'){renderCrewList()}
        else if(tab==='pdf'){
          const ci=document.getElementById('setPdfAccentColor');
          if(ci)ci.value=rgbToHex(settings.pdfAccentR||37,settings.pdfAccentG||99,settings.pdfAccentB||235);
          const pe=document.getElementById('pdfColorPreview');
          if(pe)pe.style.background='rgb('+(settings.pdfAccentR||37)+','+(settings.pdfAccentG||99)+','+(settings.pdfAccentB||235)+')';
        }
      });
    },
    addLeadSource,removeLeadSource,addCrewMember,updateCrewMember,removeCrewMember,
    handleLogoUpload,clearLogo,updateColorPreview,generateBookingWidget,
    // New features: custom line items, signatures, approval, portal, integrations
    addSysLineItem,updateSysLineItem,removeSysLineItem,renderLineItems,
    generateApprovalPage,generateClientPortal,saveApprovalSignature,
    renderStripePayButton,getStripePaymentLink
  }
});
// ═══════════════════════════════════════════════════════════
// VUE COMPONENTS — Reusable UI Building Blocks
// ═══════════════════════════════════════════════════════════

// ── Card Section ────────────────────────────────────────────
// Usage: <card-section title="Company" subtitle="Your info">...content...</card-section>
ceApp.component('card-section',{
  props:{title:String,subtitle:String,icon:String,collapsible:{type:Boolean,default:false}},
  data(){return{collapsed:false}},
  template:`
    <div class="cd">
      <div class="ct" :style="collapsible?'cursor:pointer':''" @click="collapsible&&(collapsed=!collapsed)">
        <span v-if="icon" class="ic ig">{{icon}}</span>
        <span>{{title}}</span>
        <span v-if="subtitle" style="font-size:12px;color:var(--t3);font-weight:400;margin-left:8px">{{subtitle}}</span>
        <span v-if="collapsible" style="margin-left:auto;font-size:14px;color:var(--t4)">{{collapsed?'&#9654;':'&#9660;'}}</span>
      </div>
      <div v-show="!collapsed" class="cb"><slot></slot></div>
    </div>
  `
});

// ── Stat Card ───────────────────────────────────────────────
// Usage: <stat-card label="Revenue" :value="'$12,500'" trend="up" />
ceApp.component('stat-card',{
  props:{label:String,value:[String,Number],trend:String,color:String},
  template:`
    <div class="kpi-card" :style="color?'border-left:3px solid '+color:''">
      <div class="kl">{{label}}</div>
      <div class="kv" :style="color?'color:'+color:''">{{value}}</div>
      <div v-if="trend" class="kt" :class="trend">
        {{trend==='up'?'&#9650;':trend==='down'?'&#9660;':'&#9679;'}}
      </div>
    </div>
  `
});

// ── Status Badge ────────────────────────────────────────────
// Usage: <status-badge status="lead" /> or <status-badge status="project" :active="true" @click="..." />
ceApp.component('status-badge',{
  props:{status:String,active:{type:Boolean,default:false},clickable:{type:Boolean,default:false}},
  computed:{
    statusObj(){return STATUSES.find(s=>s.id===this.status)||{label:this.status,color:''}},
  },
  template:`
    <button v-if="clickable" class="status-pill" :class="[statusObj.color,{active}]" @click="$emit('click')">
      {{statusObj.label}}
    </button>
    <span v-else class="li-badge" :class="status">{{statusObj.label}}</span>
  `
});

// ── Tag Chip ────────────────────────────────────────────────
// Usage: <tag-chip label="Residential" @remove="removeTag('Residential')" />
ceApp.component('tag-chip',{
  props:{label:String,removable:{type:Boolean,default:true}},
  template:`
    <span style="display:inline-flex;align-items:center;gap:4px;padding:3px 10px;background:var(--accent);color:#000;border-radius:6px;font-size:11px;font-weight:600">
      {{label}}
      <span v-if="removable" @click.stop="$emit('remove')" style="cursor:pointer;font-size:13px;line-height:1;opacity:.7">&times;</span>
    </span>
  `
});

// ── Form Field ──────────────────────────────────────────────
// Usage: <form-field label="First Name" help="Required">
//          <input v-model="rec.firstName">
//        </form-field>
ceApp.component('form-field',{
  props:{label:String,help:String,required:{type:Boolean,default:false}},
  template:`
    <div class="fg">
      <label>{{label}}<span v-if="required" style="color:var(--danger);margin-left:2px">*</span></label>
      <slot></slot>
      <div v-if="help" style="font-size:11px;color:var(--t4);margin-top:2px">{{help}}</div>
    </div>
  `
});

// ── Action Bar ──────────────────────────────────────────────
// Usage: <action-bar><button class="btn btn-primary">Save</button></action-bar>
ceApp.component('action-bar',{
  template:`
    <div class="btn-row" style="display:flex;gap:8px;flex-wrap:wrap;padding:12px 0">
      <slot></slot>
    </div>
  `
});

// ── Empty State ─────────────────────────────────────────────
// Usage: <empty-state icon="📋" message="No estimates yet." action="Create Estimate" @action="newEstimate()" />
ceApp.component('empty-state',{
  props:{icon:{type:String,default:'📂'},message:String,action:String},
  template:`
    <div class="empty">
      <div class="empty-icon">{{icon}}</div>
      <div class="empty-text">{{message}}</div>
      <button v-if="action" class="btn btn-primary" @click="$emit('action')" style="margin-top:10px">{{action}}</button>
    </div>
  `
});

// ── Signature Pad ───────────────────────────────────────────
// Usage: <signature-pad ref="sig" width="400" height="150" label="Customer Signature" />
ceApp.component('signature-pad',{
  props:{width:{type:Number,default:400},height:{type:Number,default:150},label:{type:String,default:'Signature'}},
  data(){return{drawing:false,ctx:null,hasSignature:false}},
  mounted(){
    const c=this.$refs.canvas;
    this.ctx=c.getContext('2d');
    this.ctx.strokeStyle='#000';this.ctx.lineWidth=2;this.ctx.lineCap='round';
  },
  methods:{
    start(e){
      this.drawing=true;
      const r=this.$refs.canvas.getBoundingClientRect();
      const x=(e.clientX||e.touches[0].clientX)-r.left;
      const y=(e.clientY||e.touches[0].clientY)-r.top;
      this.ctx.beginPath();this.ctx.moveTo(x,y);
    },
    draw(e){
      if(!this.drawing)return;
      e.preventDefault();
      const r=this.$refs.canvas.getBoundingClientRect();
      const x=(e.clientX||(e.touches&&e.touches[0].clientX))-r.left;
      const y=(e.clientY||(e.touches&&e.touches[0].clientY))-r.top;
      this.ctx.lineTo(x,y);this.ctx.stroke();this.hasSignature=true;
    },
    stop(){this.drawing=false},
    clear(){this.ctx.clearRect(0,0,this.width,this.height);this.hasSignature=false;this.$emit('clear')},
    toDataURL(){return this.hasSignature?this.$refs.canvas.toDataURL('image/png'):null}
  },
  template:`
    <div style="margin-bottom:12px">
      <div style="font-size:12px;font-weight:600;color:var(--t3);margin-bottom:4px">{{label}}</div>
      <canvas ref="canvas" :width="width" :height="height"
        @mousedown="start" @mousemove="draw" @mouseup="stop" @mouseleave="stop"
        @touchstart.prevent="start" @touchmove.prevent="draw" @touchend="stop"
        style="border:1px solid var(--brd);border-radius:8px;background:#fff;cursor:crosshair;touch-action:none;max-width:100%">
      </canvas>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:4px">
        <span style="font-size:11px;color:var(--t4)">Draw your signature above</span>
        <button class="btn btn-ghost" @click="clear" style="font-size:11px;padding:3px 10px">Clear</button>
      </div>
    </div>
  `
});

// ── Confirm Modal ───────────────────────────────────────────
// Usage: <confirm-modal ref="confirm" />
// Call: this.$refs.confirm.show('Title','Message',callback)
ceApp.component('confirm-modal',{
  data(){return{active:false,title:'',message:'',onConfirm:null}},
  methods:{
    show(t,m,fn){this.title=t;this.message=m;this.onConfirm=fn;this.active=true},
    confirm(){this.active=false;if(this.onConfirm)this.onConfirm()},
    cancel(){this.active=false}
  },
  template:`
    <div class="modal-overlay" :class="{active}" @click.self="cancel">
      <div class="modal-card">
        <div class="modal-body">
          <h3 style="font-size:16px;font-weight:700;margin-bottom:8px">{{title}}</h3>
          <p style="font-size:14px;color:var(--t2);line-height:1.5">{{message}}</p>
          <div class="btn-row" style="margin-top:16px;display:flex;gap:8px;justify-content:flex-end">
            <button class="btn btn-ghost" @click="cancel">Cancel</button>
            <button class="btn btn-danger" @click="confirm">Confirm</button>
          </div>
        </div>
      </div>
    </div>
  `
});

// ── Toast Notification ──────────────────────────────────────
// Usage: <toast-notification ref="toast" />
// Call: this.$refs.toast.show('Title','Message')
ceApp.component('toast-notification',{
  data(){return{visible:false,title:'',message:'',timer:null,undoFn:null}},
  methods:{
    show(t,m,undoOpt){
      this.title=t;this.message=m;
      this.undoFn=undoOpt&&undoOpt.fn?undoOpt.fn:null;
      this.visible=true;
      clearTimeout(this.timer);
      this.timer=setTimeout(()=>{this.visible=false},undoOpt?8000:3000);
    },
    undo(){if(this.undoFn){this.undoFn();this.visible=false}}
  },
  template:`
    <div class="toast" :class="{show:visible}">
      <div class="tt">{{title}}</div>
      <div class="tm">
        {{message}}
        <a v-if="undoFn" href="#" @click.prevent="undo" style="color:var(--accent);font-weight:600;text-decoration:underline;margin-left:8px">Undo</a>
      </div>
    </div>
  `
});

// ── Date Picker ─────────────────────────────────────────────
// Usage: <date-picker v-model="rec.followUpDate" label="Follow-up Date" />
ceApp.component('date-picker',{
  props:{modelValue:String,label:String,clearable:{type:Boolean,default:true}},
  emits:['update:modelValue'],
  template:`
    <div class="fg">
      <label v-if="label">{{label}}</label>
      <div style="display:flex;gap:6px;align-items:center">
        <input type="date" :value="modelValue" @input="$emit('update:modelValue',$event.target.value)" style="flex:1">
        <button v-if="clearable&&modelValue" class="btn btn-ghost" @click="$emit('update:modelValue','')" style="font-size:11px;padding:4px 8px">&times;</button>
      </div>
    </div>
  `
});
// ═══════════════════════════════════════════════════════════
// OFFLINE INDICATOR
// ═══════════════════════════════════════════════════════════
function updateOnlineStatus(){
  const dot=document.getElementById('offlineDot');if(!dot)return;
  if(navigator.onLine){dot.style.display='none'}
  else{dot.style.display='flex'}
}
window.addEventListener('online',()=>{updateOnlineStatus();toast('Online','Connection restored.')});
window.addEventListener('offline',()=>{updateOnlineStatus();toast('Offline','No internet. Data saves locally.')});

// ═══════════════════════════════════════════════════════════
// MOUNT VUE APP
// ═══════════════════════════════════════════════════════════
const vm = ceApp.mount('#app');

// ═══════════════════════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════════════════════
initSidebar();initEmailJS();updateOnlineStatus();
if(getProfiles().length===0){
  goProfileSetup();
}else{
  updateProfileBadge();checkOverdueInvoices();saveDB(db);updateInvoiceBadge();renderHome();renderBreadcrumb();updateSidebarActive();
}
</script>
</body>
</html>
